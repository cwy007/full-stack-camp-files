
<style>
  .frame {
      margin-left: 30px;
      margin-right: 30px;
  }

  h1, h2, h3, h4, h5, h6 {
      font-weight: normal;
  }

  .view-count {
      float: right;
      margin-top: -54px;
      color: #9B9B9B;
  }

  .markdown h2, .markdown h3, .markdown h4 {
      text-align: left;
      font-weight: 800;
      font-size: 16px !important;
      line-height: 100%;
      margin: 0;
      color: #555;
      margin-top: 16px;
      margin-bottom: 16px;
      border-bottom: 1px solid #eee;
      padding-bottom: 5px;
  }

    .markdown .figure-code figcaption {
      background-color: #e6e6e6;

      font: 100%/2.25 Monaco, Menlo, Consolas, 'Courier New', monospace;
      text-indent: 10.5px;

      -moz-border-radius: 0.25em 0.25em 0 0;
      -webkit-border-radius: 0.25em;
      border-radius: 0.25em 0.25em 0 0;
      -moz-box-shadow: inset 0 0 0 1px #d9d9d9;
      -webkit-box-shadow: inset 0 0 0 1px #d9d9d9;
      box-shadow: inset 0 0 0 1px #d9d9d9;
  }

  .markdown {
      position: relative;
      line-height: 1.8em;
      font-size: 14px;
      text-overflow: ellipsis;
      word-wrap: break-word;
      font-family: 'PT Serif', Georgia, Times, 'Times New Roman', serif !important;
  }

  .markdown ol li, .markdown ul li {
      line-height: 1.6em;
      padding: 2px 0;
      color: #333;
      font-size: 16px;
  }

  .markdown .figure-code {
      margin: 20px 0;
  }

  .post-content {
      padding-top: 5px;
      padding-bottom: 5px;
  }

  .markdown code {
      background-color: #ececec;
      color: #d14;
      font-size: 85%;
      text-shadow: 0 1px 0 rgba(255,255,255,0.9);
      border: 1px solid #d9d9d9;
      padding: 0.15em 0.3em;
  }

  div {
      display: block;
  }

  .markdown figure.code pre {
      background-color: #ffffcc !important;
  }

  .code .gi {
      color: #859900;
      line-height: 1.2em;
  }

  .code .err {
      color: #93A1A1;
  }

  .markdown a:link, .markdown a:visited {
      color: #0069D6 !important;
      text-decoration: none !important;
  }

  .markdown p {
      font-size: 16px;
      line-height: 1.5em;
  }

  .markdown blockquote {
      margin-left: 0 !important;
      margin-right: 0 !important;
      padding: 12px;
      border-left: 5px solid #50AF51;
      background-color: #F3F8F3;
      clear: both;
      display: block;
  }

  .markdown blockquote>*:first-child {
      margin-top: 0 !important;
  }

  .markdown blockquote>*:last-child {
      margin-bottom: 0 !important;
  }

  .markdown blockquote p {
      color: #222;
  }

  * {
      outline: none !important;
  }

  a:active, a:hover, a:link, a:visited {
      text-decoration: none;
  }

  pre {
      margin: 0;
  }

  .markdown img {
      vertical-align: top;
      max-width:100%;
      height:auto;
  }

  h1 a {
    color: #071A52;
  }

  h4 {
    color: #734488;
  }

  hr {
    border-color: #DEDEDE;
    border-width: 0.8px;
    margin-bottom: auto;
  }

  .end {
    height: 400px;
  }

  .end img {
    clear: both;
    display: block;
    margin: 10px auto;
  }

  .end p {
    text-align: center;
    font-size: 2.5em;
    margin: 60px auto 100px;
    color: #ddd;
  }
</style>
<div class='frame'><h1>
      1-1 商店技术架构
    </h1><h4>所属章节：1-教材介绍</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>这一课商店网站，你将会学到至少以下的主题：</p>

<ul>
<li>购物车设计</li>
<li>结帐订单</li>
<li>第三方整合</li>
<li>代码重构</li>
</ul>

<p>熟练掌握这个课程的主题后，能够让你在未来写出绝大多数的网站功能。</p>

<p>技术议题包含：</p>

<ul>
<li>Model 设计原则</li>
<li>自定义 before_action</li>
<li>自定义 Routing </li>
<li>validation</li>
<li>session 操作</li>
<li>find_by 操作</li>
<li>where / order</li>
<li>巢状表单</li>
<li>State Machine</li>
<li>ActiveJob</li>
<li>Mailer</li>
<li>Partial / Helper</li>
</ul>

    </div>
  </div></div><div class='frame'><h1>
      2-1 拆解任务
    </h1><h4>所属章节：2-拆解任务</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>这一课，我们要做的是搭建一个简单的商店网站，请仿照上一课招聘网站时的便利贴方法。</p>

<ul>
<li>写下 7-10 件你觉得「商店」必备的组块功能</li>
<li>整理出目的群组</li>
<li>按照 Must Have / Should Have / Could Have / Nice to Have 整理出一张图</li>
</ul>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/uIrTDgxASW6LTygqgiqv_n0Jt4S2bQ4asSmMWU2SH_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-12-30%20%E4%B8%8B%E5%8D%885.30.29.png" title=""></figure></p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/81YZBHOQM2SxUE9QZwR5_oM2ZxEZNSDqXiHrO9soe_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-12-30%20%E4%B8%8B%E5%8D%885.35.53.png" title=""></figure></p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ysFIw29CTWLPGeugGea3_uklTnDQTQky23JnMYSmW_WechatIMG3.jpeg" title=""></figure></p>

    </div>
  </div></div><div class='frame'><h1>
      2-2 找出系统核心组件与角色
    </h1><h4>所属章节：2-拆解任务</h4><hr><div class="post group">
    <div class="post-content markdown">
      <h2>Must Have / Should Have / Could Have / Nice to Have</h2>
<p>当书写过一轮功能之后，会发现最后留下的 Must Have / Should Have 中，最核心的功能应该会剩下以下几部分：</p>

<ul>
<li>购买机制 - 消费者购买商品，放入购物车</li>
<li>结帐机制 - 消费者将购物车中的商品，结帐生成订单</li>
<li>上架机制 - 商家上架物品，设定开卖</li>
<li>配送机制 - 商家针对订单配送 </li>
</ul>

<p>整个系统有两个核心角色：</p>

<ul>
<li>消费者</li>
<li>商家</li>
</ul>

    </div>
  </div></div><div class='frame'><h1>
      2-3 User Story（商家）
    </h1><h4>所属章节：2-拆解任务</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>在这一课，我们要请各位拿出</p>

<ul>
<li>一本全白的笔记本</li>
<li>一支蓝笔</li>
<li>一支绿笔</li>
</ul>

<p>跟着我这样做。</p>

<p>（ 请千万不要跳过这个步骤。我们需要各位真的也照着写下来，才会记住这个方法）</p>

<p>把第一版用户故事写下来。 （请跟着照抄，如图所示）</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/hdYVw0wQ5akWfMLeBODA_WechatIMG5.jpeg" title=""></figure></p>

    </div>
  </div></div><div class='frame'><h1>
      2-4 User Story（消费者）
    </h1><h4>所属章节：2-拆解任务</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>把第一版用户故事写下来。 （请跟着照抄，如图所示）</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/22qYWdKfS8GXejFtZUAj_WechatIMG4.jpeg" title=""></figure></p>

    </div>
  </div></div><div class='frame'><h1>
      2-5 User Story（订单部分）
    </h1><h4>所属章节：2-拆解任务</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>把第一版用户故事写下来。 （请跟着照抄，如图所示）</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Uh8wDEDiRB22EbIdKFvY_WechatIMG6.jpeg" title=""></figure></p>

    </div>
  </div></div><div class='frame'><h1>
      3-1 将手稿转为 User Story （后台）
    </h1><h4>所属章节：3-后台</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>然后我们可以把第一张手稿转成 User Story</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/nuiFpEQNS0jckYqHA51R_WechatIMG5.jpeg" title=""></figure></p>
<h3>User Story 用户故事（后台）</h3>
<p>身为商家（管理者），我要能够在后台上架我的商品，并设定能够贩卖</p>

<ul>
<li>身为商家，我要能够登入后台

<ul>
<li>整个商店网站分为两种权限：admin (商家=管理者) / user （消费者）</li>
<li>商家可以登入 /admin 后台</li>
</ul>
</li>
<li>身为商家，我要能够登入后台上架商品

<ul>
<li>后台上架网址必须要是 /admin/products</li>
<li>商品的内容分为商品名称、描述、价格、库存</li>
<li>商品要能够设定是否能上架贩卖</li>
<li>商品必须要有商品图片</li>
</ul>
</li>
</ul>
<h3>总结</h3>
<p>有没有似曾相似的感觉？相信做过招聘网站的各位肯定会开始觉得自己能够挣扎解出来。</p>

<p>所以这一周，我们希望在这一个章节，各位能够尽量的独立做出这个模块的作业。</p>

    </div>
  </div></div><div class='frame'><h1>
      3-2 Fork 教学
    </h1><h4>所属章节：3-后台</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>这一节我们要请各位同学先 Fork 商店的这个专案</p>
<h3>Step 1: Fork 专案</h3>
<p>到 <a href="https://github.com/quanzhanying/jdstore" rel="nofollow" target="_blank">https://github.com/quanzhanying/jdstore</a>  去 Fork 专案：<br>
<figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/m0QA7MzJR8imdCEFDwPL_Snip20170116_4.png" title=""></figure></p>
<h3>Step 2: 检查 ID</h3>
<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/yEzTai5SaeBxjkLgh0lg_Snip20170116_6.png" title=""></figure></p>
<h3>Step 3: Clone url</h3>
<p>点选 「Clone or Download」按钮，取得自己的 url，并复制到剪贴簿</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/HRBDErIJTPJufoy3eic3_Snip20170116_7.png" title=""></figure></p>
<h3>Step 4 : 在本地跑起来</h3>
<ul>
<li>clone 到本地</li>
<li>复制 database.yml.example</li>
<li>git checkout EPIC-1</li>
</ul>

<p>跑起来</p>

<p><code>git clone git@github.com:XXXXX/jdstore.git</code><br>
<code>cd jdstore</code><br>
<code>cp config/database.yml.example config/database.yml</code><br>
<code>bundle check</code><br>
<code>bundle install</code><br>
<code>git checkout -b EPIC-1</code><br>
<code>rails s</code></p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/w1AUOlFzSUaQGnbdc9v8_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-01-11%20%E4%B8%8B%E5%8D%8810.24.27.png" title=""></figure></p>

    </div>
  </div></div><div class='frame'><h1>
      3-3 商店网站 - 实作提示 Part 1
    </h1><h4>所属章节：3-后台</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>我们这一周所要实做的内容如下：</p>

<ul>
<li>身为商家，我要能够登入后台

<ul>
<li>整个商店网站分为两种权限：admin (商家=管理者) / user （消费者）</li>
<li>商家可以登入 /admin 后台</li>
</ul>
</li>
<li>身为商家，我要能够登入后台上架商品

<ul>
<li>后台上架网址必须要是 /admin/products</li>
<li>商品的内容分为商品名称、描述、价格、库存</li>
<li>商品要能够设定是否能上架贩卖</li>
<li>商品必须要有商品图片</li>
</ul>
</li>
</ul>
<h2>提示</h2>
<h3>我们可以从后台网址设计开始</h3>
<ul>
<li>身为管理者，要能够登入后台上架商品 (这时候还不需要设计权限问题）</li>
<li>后台上架网址必须要是 /admin/products</li>
</ul>

<p>所以网址最后要是：</p>

<p><a href="http://localhost:3000/admin/products" rel="nofollow" target="_blank">http://localhost:3000/admin/products</a></p>

<ul>
<li>rails g controller admin/products</li>
<li>设定 namespace routing</li>
</ul>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/a2XNaiMeSbudJ0h121IP_380-1.png" title=""></figure></p>
<h3>接着设计 Product Model</h3>
<ul>
<li>商品 ( Product ) 的内容分为商品名称、描述、价格、库存 </li>
<li>rails g model product title:string  description:text price:integer quantity:integer </li>
</ul>
<h3>再来设计商品上架的 CRUD</h3>
<ul>
<li><a href="http://localhost:3000/admin/products/new" rel="nofollow" target="_blank">http://localhost:3000/admin/products/new</a></li>
</ul>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/jrBtL3mFT1OFjZvSgqtA_380-2.png" title=""></figure></p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/tUFiXa9QwqlHdze2GPNQ_380-3.png" title=""></figure></p>
<h3>商品必须要有图片</h3>
<ul>
<li>carrierwave</li>
<li>（稍后再做）</li>
</ul>

    </div>
  </div></div><div class='frame'><h1>
      3-4 商店网站 - 实作提示 Part 2
    </h1><h4>所属章节：3-后台</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>我们这一周所要实做的内容如下：</p>

<ul>
<li>身为商家，我要能够登入后台

<ul>
<li>整个商店网站分为两种权限：admin (商家=管理者) / user （消费者）</li>
<li>商家可以登入 /admin 后台</li>
</ul>
</li>
<li>身为商家，我要能够登入后台上架商品

<ul>
<li>后台上架网址必须要是 /admin/products</li>
<li>商品的内容分为商品名称、描述、价格、库存</li>
<li>商品要能够设定是否能上架贩卖</li>
<li>商品必须要有商品图片</li>
</ul>
</li>
</ul>

<p>接着我们要为后台加入权限判定设计</p>
<h2>提示</h2>
<h3>先设计使用者必须要先登入后才能存取后台</h3>
<ul>
<li>登入必须要安装 devise</li>
<li>在 admin/products_controller.rb 加入 before_action 强制进行「登入验证」</li>
</ul>

<p><figure><img src="https://ww1.sinaimg.cn/large/006tNc79gy1fck8c336eej317y0c0tak.jpg" title=""></figure></p>

<p>然后我们在浏览器测试存取  <a href="http://localhost:3000/admin/products/new" rel="nofollow" target="_blank">http://localhost:3000/admin/products/new</a>　是否强制验证</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/CgOfwZg9QriBCeuklvJb_381-2.png" title=""></figure></p>
<h3>再限制登入后台的使用者必须是 admin</h3>
<ul>
<li>在 admin/products_controller.rb 中加入 before_action 强制进行「admin 验证」</li>
</ul>

<p><figure><img src="https://ww3.sinaimg.cn/large/006tNc79gy1fck8cdemckj31680cstav.jpg" title=""></figure></p>

<ul>
<li>在 application_controller 中设计一个 admin_required 的验证式 </li>
</ul>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Ez7qjSNlQti1zfLZuwbe_381-4.png" title=""></figure></p>

<p>这段代码的意思是 current_user 如果不是 admin 的话，进入后台后会被直接重导到首页。</p>

<p>但如果这时候打开　<a href="http://localhost:3000/admin/products/new" rel="nofollow" target="_blank">http://localhost:3000/admin/products/new</a>，会出现以下报错画面。</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/FzBnoC5WRc20zQrfhfCJ_381-5.png" title=""></figure></p>

<p>这个错误是指系统不知道 <code>admin?</code> 在 User model 中代表什么意思。</p>
<h3>所以我们去 User model 里设计 admin? 的判断式</h3>
<ul>
<li>修改 app/models/user.rb</li>
<li>加入 <code>admin?</code> 这个判断式</li>
<li>我们暂时使用 <code>is_admin</code> 这个 boolean 值（ true / false）作为是否是 admin 的判断</li>
<li><strong>rails g migration add_is_admin_to_user</strong></li>
</ul>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/zPM4ikERRy1rFZHNzJn9_381-6.png" title=""></figure></p>
<h3>测试 Admin 是否真能进后台</h3>
<h4>进 <code>rails c</code> 生成一个 admin user</h4>
<p>步骤：</p>

<blockquote>
<p>rails c</p>
</blockquote>

<p>输入</p>

<blockquote>
<p>u = User.new(email: "<a encode="hex" href="mailto:xx@xx.com">xx@xx.com</a>", password: "12345678", password_confirmation: "12345678")<br>
u.save<br>
u.is_admin = true<br>
u.save <br>
exit</p>
</blockquote>
<h4>使用 admin user开启 Chrome「无痕模式」登入后台</h4>
<ul>
<li>登入后台 <a href="http://localhost:3000/admin/products/new" rel="nofollow" target="_blank">http://localhost:3000/admin/products/new</a>
</li>
</ul>

    </div>
  </div></div><div class='frame'><h1>
      3-5 商店网站 - 实作提示 Part 3
    </h1><h4>所属章节：3-后台</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>我们这一周所要实做的内容如下：</p>

<ul>
<li>身为商家，我要能够登入后台

<ul>
<li>整个商店网站分为两种权限：admin (商家=管理者) / user （消费者）</li>
<li>商家可以登入 /admin 后台</li>
</ul>
</li>
<li>身为商家，我要能够登入后台上架商品

<ul>
<li>后台上架网址必须要是 /admin/products</li>
<li>商品的内容分为商品名称、描述、价格、库存</li>
<li>商品要能够设定是否能上架贩卖</li>
<li>商品必须要有商品图片</li>
</ul>
</li>
</ul>

<p>接着我们要为后台加入上传图片功能</p>
<h2>步骤</h2>
<h3>安装 Carrierwave</h3>
<figure class="figure-code code"><figcaption><span>Gemfile
</span></figcaption><div class="highlight"><pre>  <span class="n">gem</span> <span class="s2">"carrierwave"</span>
  <span class="n">gem</span> <span class="s2">"mini_magick"</span>
</pre></div>
</figure>
<h3>新增 image 栏位</h3>
<p><code>rails g migration add_image_to_product</code></p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/obsZ5kIKTxmNAtM8zfaQ_382-1.png" title=""></figure></p>
<h3>新增 image uploader</h3>
<p><code>rails g uploader image</code></p>
<h3>订制图片尺寸</h3>
<p>修改 uploader 订制尺寸</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/gX3OFIBkR2mlixkbnGuT_382-2.png" title=""></figure></p>
<h3>挂上 ImageUploader</h3>
<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/quijJeyfQD3V7Uqnqiv9_382-3.png" title=""></figure></p>

    </div>
  </div></div><div class='frame'><h1>
      3-6 最后成果
    </h1><h4>所属章节：3-后台</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>我们希望下次上课前，同学的实做部分，做到这个进度：</p>
<h3>首页（商品列表）</h3>
<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/IWzbFr4tQgiNVcBRNG12_383-1.png" title=""></figure></p>
<h3>内页（商品页面）</h3>
<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/wCkS1k40Q7O2h9nfkC51_383-2.png" title=""></figure></p>
<h3>小结</h3>
<p>下周，我们会从这个进度开始讲解购物车如何实做。</p>

    </div>
  </div></div><div class='frame'><h1>
      4-1 Step 0 - 基础建设
    </h1><h4>所属章节：4-后台（解答）</h4><hr><div class="post group">
    <div class="post-content markdown">
      <h2>Part 1 Fork 专案</h2>
<h3>Step 1. fork专案</h3>
<p>到 <a href="https://github.com/quanzhanying/jdstore" rel="nofollow" target="_blank">https://github.com/quanzhanying/jdstore</a> 去Fork专案</p>

<ul>
<li>clone 到本地</li>
<li>复制 database.yml.example</li>
<li>git checkout -b EPIC-1</li>
<li>跑起来</li>
</ul>

<figure class="figure-code code"><div class="highlight"><pre>git clone git@github.com:XXXXX/jdstore.git
cd jdstore
cp config/database.yml.example config/database.yml
bundle check
bundle install
git checkout -b EPIC-1
rails s
</pre></div>
</figure>

<p><br></p>
<h2>Part 2 安装 Bootstrap</h2>
<h3>Step 1. 挂上 bootstrap-sass 这个 gem</h3>
<figure class="figure-code code"><figcaption><span>Gemfile
</span></figcaption><div class="highlight"><pre><span class="n">gem</span> <span class="s1">'bootstrap-sass'</span>
</pre></div>
</figure>

<p><br></p>
<h3>Step 2. bundle install</h3>
<p>执行 <code>bundle install</code></p>

<p>(注意：修改完 Gemfile 都要执行 bundle install）</p>

<p><br></p>
<h3>Step 3. 将 Bootstrap 的 CSS 套件装进专案里面</h3>
<p>在终端输入</p>

<p><code>mv app/assets/stylesheets/application.css app/assets/stylesheets/application.scss</code></p>

<p>然后修改 app/assets/stylesheets/application.scss 档案，在最后加入以下两行</p>

<figure class="figure-code code"><figcaption><span>app/assets/stylesheets/application.scss
</span></figcaption><div class="highlight"><pre><span class="cm">/*
 * ...(一堆注解)
 *= require_tree .
 *= require_self
 */</span>

<span class="o">+</span> <span class="o">@</span><span class="nt">import</span> <span class="s2">"bootstrap-sprockets"</span><span class="p">;</span>
<span class="o">+</span> <span class="o">@</span><span class="nt">import</span> <span class="s2">"bootstrap"</span><span class="p">;</span>
</pre></div>
</figure>

<p><br></p>
<h3>Step 4. 将变更 commit 进 git 里面</h3>
<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "add bootstrap to project"
</pre></div>
</figure>

<p><br></p>
<h2>Part 3 修改样式</h2>
<h3>Step 1. 新增 app/views/common 资料夹</h3>
<p><code>mkdir app/views/common</code></p>

<p><br></p>
<h3>Step 2. 新增 navbar</h3>
<p><code>touch app/views/common/_navbar.html.erb</code></p>

<p>填入</p>

<figure class="figure-code code"><figcaption><span>app/views/common/_navbar.html.erb
</span></figcaption><div class="highlight"><pre><span class="nt">&lt;nav</span> <span class="na">class=</span><span class="s">"navbar navbar-default"</span> <span class="na">role=</span><span class="s">"navigation"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container-fluid"</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- Brand and toggle get grouped for better mobile display --&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"navbar-header"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"navbar-brand"</span> <span class="na">href=</span><span class="s">"/"</span><span class="nt">&gt;</span>JDStore <span class="nt">&lt;/a&gt;</span>
        <span class="nt">&lt;/div&gt;</span>

        <span class="c">&lt;!-- Collect the nav links, forms, and other content for toggling --&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"collapse navbar-collapse"</span> <span class="na">id=</span><span class="s">"bs-example-navbar-collapse-1"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav navbar-nav navbar-right"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">"登入"</span><span class="p">,</span> <span class="s1">'#'</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;/ul&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
        <span class="c">&lt;!-- /.navbar-collapse --&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="c">&lt;!-- /.container-fluid --&gt;</span>
<span class="nt">&lt;/nav&gt;</span>

</pre></div>
</figure>

<p><br></p>
<h3>Step 3. 新增 footer</h3>
<p><code>touch app/views/common/_footer.html.erb</code></p>

<p>填入</p>

<figure class="figure-code code"><figcaption><span>app/views/common/_footer.html.erb
</span></figcaption><div class="highlight"><pre><span class="nt">&lt;footer</span> <span class="na">class=</span><span class="s">"container"</span> <span class="na">style=</span><span class="s">"margin-top: 100px;"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"text-center"</span><span class="nt">&gt;</span>Copyright ©2017 JDStore
        <span class="nt">&lt;br&gt;</span>Design by yourname
        
    <span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;/footer&gt;</span>

</pre></div>
</figure>

<p><br></p>
<h3>Step 4. 修改全域 HTML 样式 application.html.erb</h3>
<figure class="figure-code code"><figcaption><span>app/views/layouts/application.html.erb
</span></figcaption><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;title&gt;</span>JDStore <span class="nt">&lt;/title&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">csrf_meta_tags</span> <span class="cp">%&gt;</span>

        <span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span>    <span class="s1">'application'</span><span class="p">,</span> <span class="ss">media: </span><span class="s1">'all'</span><span class="p">,</span> <span class="s1">'data-turbolinks-track'</span><span class="p">:</span> <span class="s1">'reload'</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s1">'application'</span><span class="p">,</span> <span class="s1">'data-turbolinks-track'</span><span class="p">:</span> <span class="s1">'reload'</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/head&gt;</span>

    <span class="nt">&lt;body&gt;</span>

        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container-fluid"</span><span class="nt">&gt;</span>
            <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s2">"common/navbar"</span> <span class="cp">%&gt;</span>
            <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/div&gt;</span>

        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s2">"common/footer"</span> <span class="cp">%&gt;</span>

    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>

</pre></div>
</figure>

<p><br></p>
<h3>Step 5. 产生一个新的空 Hello World 页面 （放在 welcome#index)</h3>
<p><code>rails g controller welcome</code></p>

<ul>
<li>新增一个 welcome controller</li>
</ul>

<p><code>touch app/views/welcome/index.html.erb</code></p>

<ul>
<li>新增一个空的 HelloWorld 页面</li>
</ul>

<p>填入</p>

<figure class="figure-code code"><figcaption><span>app/views/welcome/index.html.erb
</span></figcaption><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span> Hello World! <span class="nt">&lt;/h1&gt;</span>
</pre></div>
</figure>

<p><br></p>
<h3>Step 6. 将首页指到 welcome 下的 index.html.erb 页面</h3>
<p>修改 <code>config/routes.rb</code>，改成以下内容</p>

<figure class="figure-code code"><figcaption><span>config/routes.rb
</span></figcaption><div class="highlight"><pre><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">root</span> <span class="s1">'welcome#index'</span>
<span class="k">end</span>
</pre></div>
</figure>

<p><br></p>
<h3>Step 7. git 进度存档</h3>
<p><code>git add .</code><br>
<code>git commit -m "add bootstrap html"</code></p>
<h3>Step 8. 重开 Rails Server</h3>
<p><code>rails s</code></p>

<p><br></p>
<h2>Part 4 增加 flash 功能</h2>
<h3>Step 1. 将 Boostrap 的 js 提示套件 bootstrap/alert “挂”进专案里面</h3>
<p>在 <code>requre_tree</code> 上加入一行 <code>//= require bootstrap/alert</code></p>

<figure class="figure-code code"><figcaption><span>app/assets/javascripts/application.js
</span></figcaption><div class="highlight"><pre>... (一堆注解)
//= require jquery
//= require jquery_ujs
//= require turbolinks
<span class="gi">+//= require bootstrap/alert
</span><span class="err">//= require_tree .
</span></pre></div>
</figure>

<p><br></p>
<h3>Step 2. 新增 app/views/common/_flashes.html.erb</h3>
<p><code>touch app/views/common/_flashes.html.erb</code></p>

<p>填入</p>

<figure class="figure-code code"><figcaption><span>app/views/common/_flashes.html.erb
</span></figcaption><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">flash</span><span class="p">.</span><span class="nf">any?</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="n">user_facing_flashes</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"alert alert-dismissable alert-</span><span class="cp">&lt;%=</span> <span class="n">flash_class</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">"close"</span> <span class="na">data-dismiss=</span><span class="s">"alert"</span><span class="nt">&gt;</span>×<span class="nt">&lt;/button&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">value</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</figure>

<p><br></p>
<h3>Step 3. 加入 app/helpers/flashes_helper.rb</h3>
<p><code>touch app/helpers/flashes_helper.rb</code></p>

<p>填入以下内容：</p>

<figure class="figure-code code"><figcaption><span>app/helpers/flashes_helper.rb
</span></figcaption><div class="highlight"><pre><span class="k">module</span> <span class="nn">FlashesHelper</span>
  <span class="no">FLASH_CLASSES</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">alert: </span><span class="s2">"danger"</span><span class="p">,</span> <span class="ss">notice: </span><span class="s2">"success"</span><span class="p">,</span> <span class="ss">warning: </span><span class="s2">"warning"</span><span class="p">}.</span><span class="nf">freeze</span>

  <span class="k">def</span> <span class="nf">flash_class</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="no">FLASH_CLASSES</span><span class="p">.</span><span class="nf">fetch</span> <span class="n">key</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">,</span> <span class="n">key</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">user_facing_flashes</span>
    <span class="n">flash</span><span class="p">.</span><span class="nf">to_hash</span><span class="p">.</span><span class="nf">slice</span> <span class="s2">"alert"</span><span class="p">,</span> <span class="s2">"notice"</span><span class="p">,</span><span class="s2">"warning"</span> 
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</figure>

<p><br></p>
<h3>Step 4. 在 application.html.erb 内加入 flash 这个 partial</h3>
<p>在 <code>&lt;%= yield %&gt;</code> 前加入 <code>&lt;%= render "common/flashes" %&gt;</code></p>

<figure class="figure-code code"><figcaption><span>app/views/layouts/application.html.erb
</span></figcaption><div class="highlight"><pre>  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s2">"common/flashes"</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
</pre></div>
</figure>

<p><br></p>
<h3>Step 5. git 存档</h3>
<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "add bootstrap flash function"
</pre></div>
</figure>
<h3>Step 6: 测试 flash helper 的功能</h3>
<p>加入 <code>flash[:notice] = "早安！你好！"</code>。你应该可以看到系统跳出“绿色”提示窗。</p>

<figure class="figure-code code"><figcaption><span>app/controllers/welcome_controller.rb
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">WelcomeController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="n">flash</span><span class="p">[</span><span class="ss">:notice</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"早安！你好！"</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</figure>

<p><br></p>
<h2>Part 5 安装 Devise</h2>
<h3>Step 1: 安装登入系统</h3>
<p>Devise 是一个 Rails 内热门的 gem，专门用来快速实作“登入系统”。在这一节我们会用 devise 实作登入功能。</p>

<p>Gemfile 新增一行 <code>gem 'devise'</code></p>

<figure class="figure-code code"><figcaption><span>Gemfile
</span></figcaption><div class="highlight"><pre><span class="n">gem</span> <span class="s1">'devise'</span>
</pre></div>
</figure>

<p>然后执行</p>

<figure class="figure-code code"><div class="highlight"><pre>bundle install
</pre></div>
</figure>

<p><br></p>
<h3>Step 2 : 产生会员系统的必要档案</h3>
<p>执行</p>

<figure class="figure-code code"><div class="highlight"><pre>rails g devise:install
rails g devise user
rake db:migrate
</pre></div>
</figure>

<p>重启<code>rails s</code></p>

<p><br></p>
<h3>Step 3: 修改 app/views/common/_navbar.html.erb</h3>
<figure class="figure-code code"><figcaption><span>app/views/common/_navbar.html.erb
</span></figcaption><div class="highlight"><pre><span class="gd">-                &lt;li&gt; &lt;%= link_to("登入", '#') %&gt;   &lt;/li&gt;
</span><span class="gi">+                &lt;% if !current_user %&gt;
+                  &lt;li&gt;&lt;%= link_to("注册", new_user_registration_path) %&gt; &lt;/li&gt;
+                  &lt;li&gt;&lt;%= link_to("登入", new_user_session_path) %&gt;&lt;/li&gt;
+                &lt;% else %&gt;
+                  &lt;li class="dropdown"&gt;
+                    &lt;a href="#" class="dropdown-toggle" data-toggle="dropdown"&gt;
+                        Hi!, &lt;%= current_user.email %&gt;
+                        &lt;b class="caret"&gt;&lt;/b&gt;
+                    &lt;/a&gt;
+                    &lt;ul class="dropdown-menu"&gt;
+                        &lt;li&gt; &lt;%= link_to("登出", destroy_user_session_path, method: :delete) %&gt; &lt;/li&gt;
+                    &lt;/ul&gt;
+                  &lt;/li&gt;
</span><span class="err">+                &lt;% end %&gt;
</span></pre></div>
</figure>

<p><br></p>
<h3>Step 4: 修改 app/assets/javascripts/application.js</h3>
<p>加入一行 <code>//= require bootstrap/dropdown</code></p>

<figure class="figure-code code"><figcaption><span>app/assets/javascripts/application.js
</span></figcaption><div class="highlight"><pre>//= require bootstrap/alert
<span class="err">+ //= require bootstrap/dropdown
</span></pre></div>
</figure>

<p>成果应该会是这样的效果。<br>
<figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/xeLBMLRfQdKd3lQzhyjf_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-09-14%20%E4%B8%8B%E5%8D%882.07.34.png" title=""></figure></p>

<p><br></p>
<h3>Step 5: git 储存</h3>
<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "user can login/logout/signup"
</pre></div>
</figure>

<p><br></p>
<h2>Part 6 安装 SimpleForm</h2>
<h3>Step 1. 使用 SimpleForm 简化</h3>
<p>首先我们要来安装 simple_form</p>

<p>打开 Gemfile，然后新增一行 <code>gem 'simple_form'</code></p>

<figure class="figure-code code"><figcaption><span>Gemfile
</span></figcaption><div class="highlight"><pre>
<span class="n">gem</span> <span class="s1">'bootstrap-sass'</span>
<span class="n">gem</span> <span class="s1">'devise'</span>
<span class="o">+</span> <span class="n">gem</span> <span class="s1">'simple_form'</span>
</pre></div>
</figure>

<p>然后执行 </p>

<figure class="figure-code code"><div class="highlight"><pre>bundle install
</pre></div>
</figure>

<p>安装 gem。</p>

<p><br></p>
<h3>Step 2. 安装 simple_form for bootstrap 的设定</h3>
<p>执行：</p>

<figure class="figure-code code"><div class="highlight"><pre>rails generate simple_form:install --bootstrap
</pre></div>
</figure>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/qhG8fT0yICTvwdE71igI_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-07-11%20%E4%B8%8B%E5%8D%885.45.42.png" title=""></figure></p>

<p>然后重开 rails server（ <code>ctrl+c</code> 然后 <code>rails s</code>）</p>

<p><br></p>
<h3>Step 3. git 存档</h3>
<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "install simpleform with bootstrap"
</pre></div>
</figure>

<p><br></p>
<h2>Part 7 安装 font-awesome-rails</h2>
<h3>Step 1. 挂上font-awesome-rails</h3>
<figure class="figure-code code"><figcaption><span>Gemfile
</span></figcaption><div class="highlight"><pre><span class="n">gem</span> <span class="s1">'devise'</span>
<span class="n">gem</span> <span class="s1">'simple_form'</span>
<span class="o">+</span> <span class="n">gem</span> <span class="s1">'font-awesome-rails'</span>
</pre></div>
</figure>

<p><br></p>
<h3>Step 2. bundle install</h3>
<p>执行 <code>bundle install</code></p>

<p>重启<code>rails s</code></p>
<h3>Step 3. 将 font-awesome装进专案里面</h3>
<figure class="figure-code code"><figcaption><span>app/assets/stylesheets/application.scss
</span></figcaption><div class="highlight"><pre><span class="k">@import</span> <span class="s2">"font-awesome"</span><span class="p">;</span>
</pre></div>
</figure>

<p><br></p>
<h3>Step 4. 修改 app/views/common/_navbar.html.erb</h3>
<figure class="figure-code code"><figcaption><span>app/views/common/_navbar.html.erb
</span></figcaption><div class="highlight"><pre>             &lt;% if !current_user %&gt;
               &lt;li&gt;&lt;%= link_to("注册", new_user_registration_path) %&gt; &lt;/li&gt;
<span class="gd">-                  &lt;li&gt;&lt;%= link_to("登入", new_user_session_path) %&gt;&lt;/li&gt;
</span><span class="gi">+                  &lt;li&gt;&lt;%= link_to(content_tag(:i, '登入', class: 'fa fa-sign-in'), new_user_session_path) %&gt;&lt;/li&gt;
</span>             &lt;% else %&gt;
               &lt;li class="dropdown"&gt;
                 &lt;a href="#" class="dropdown-toggle" data-toggle="dropdown"&gt;
                     Hi!, &lt;%= current_user.email %&gt;
                     &lt;b class="caret"&gt;&lt;/b&gt;
                 &lt;/a&gt;
                 &lt;ul class="dropdown-menu"&gt;
<span class="gd">-                        &lt;li&gt; &lt;%= link_to("登出", destroy_user_session_path, method: :delete) %&gt; &lt;/li&gt;
</span><span class="gi">+                        &lt;li&gt; &lt;%= link_to(content_tag(:i, '登出', class: 'fa fa-sign-out'), destroy_user_session_path, method: :delete) %&gt; &lt;/li&gt;
</span>                 &lt;/ul&gt;
               &lt;/li&gt;
<span class="err">             &lt;% end %&gt;
</span></pre></div>
</figure>

<p>登入、登出旁会出现新图标<br>
<figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/SSB4lxneTfymXrHnua61_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-09-14%20%E4%B8%8B%E5%8D%882.37.15.png" title=""></figure></p>

<p><br></p>
<h3>Step 5. git存档</h3>
<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "install font-awesome-rails"
</pre></div>
</figure> 
<h2>效果动图</h2>
<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/hcaGc4vuSeKB52T5YdHa_jdstore-epic1.gif" title=""></figure></p>

    </div>
  </div></div><div class='frame'><h1>
      4-2 STORY 1 - 上架后台 CRUD
    </h1><h4>所属章节：4-后台（解答）</h4><hr><div class="post group">
    <div class="post-content markdown">
      <h2>目标</h2>
<ul>
<li>使用者必须要是 admin 才能登入 <a href="http://localhost:3000/admin/products">http://localhost:3000/admin/products</a>
</li>
<li>商品栏位必须要有 title, description, quantity, price</li>
<li>admin 后台 products 完整的 CRUD</li>
</ul>

<p><br></p>
<h3>Step 0:</h3>
<p><code>git checkout -b story1</code></p>

<p><br></p>
<h3>Step 1: 建立 controller admin/products</h3>
<p><code>rails g controller admin::products</code></p>

<p><br></p>
<h3>Step 2: 设定 admin/products 的 routes</h3>
<figure class="figure-code code"><figcaption><span>config/routes.rb
</span></figcaption><div class="highlight"><pre><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
<span class="o">+</span> <span class="n">namespace</span> <span class="ss">:admin</span> <span class="k">do</span>
<span class="o">+</span>   <span class="n">resources</span> <span class="ss">:products</span>
<span class="o">+</span> <span class="k">end</span>

<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</figure>

<p>输入<code>rake routes</code>可以看到新增了路径<br>
<figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/zxGXArDMRgG0HQjQ5x9a_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-09-13%20%E4%B8%8B%E5%8D%883.16.51.png" title=""></figure></p>

<p><br></p>
<h3>Step 3: 建立 model product</h3>
<p><code>rails g model product title:string description:text quantity:integer price:integer</code></p>

<p><code>rake db:migrate</code></p>

<p><br></p>
<h3>Step 4: 实作后台新增商品</h3>
<figure class="figure-code code"><figcaption><span>app/controllers/admin/products_controller.rb
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">Admin</span><span class="o">::</span><span class="no">ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">new</span>
    <span class="vi">@product</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@product</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">product_params</span><span class="p">)</span>

    <span class="k">if</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">save</span>
      <span class="n">redirect_to</span> <span class="n">admin_products_path</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="ss">:new</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">product_params</span>
    <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:product</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="ss">:description</span><span class="p">,</span> <span class="ss">:quantity</span><span class="p">,</span> <span class="ss">:price</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</figure>

<p><br></p>
<h3>Step 5: 新增商品页面</h3>
<p><code>touch app/views/admin/products/new.html.erb</code></p>

<figure class="figure-code code"><figcaption><span>app/views/admin/products/new.html.erb
</span></figcaption><div class="highlight"><pre><span class="nt">&lt;h2&gt;</span> New Product <span class="nt">&lt;/h2&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">simple_form_for</span> <span class="p">[</span><span class="ss">:admin</span><span class="p">,</span> <span class="vi">@product</span><span class="p">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>

  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"group"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">input</span> <span class="ss">:title</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"group"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">input</span> <span class="ss">:description</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"group"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">input</span> <span class="ss">:quantity</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"group"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">input</span> <span class="ss">:price</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">submit</span> <span class="s2">"Submit"</span><span class="p">,</span> <span class="ss">data: </span><span class="p">{</span> <span class="ss">disable_with: </span><span class="s2">"Submitting..."</span> <span class="p">}</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</figure>

<p><a href="http://localhost:3000/admin/products/new" rel="nofollow" target="_blank">http://localhost:3000/admin/products/new</a></p>

<p>新增几个 product 试试看。</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/QjTKV6aLQ8KoFg0jDAQT_step5.png" title=""></figure></p>

<p><br></p>
<h3>Step 6: 实作后台index action</h3>
<figure class="figure-code code"><figcaption><span>app/controllers/admin/products_contoller.rb
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">Admin</span><span class="o">::</span><span class="no">ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
<span class="o">+</span> <span class="k">def</span> <span class="nf">index</span>
<span class="o">+</span>   <span class="vi">@products</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">all</span>
<span class="o">+</span> <span class="k">end</span>

  <span class="k">def</span> <span class="nf">new</span>
    <span class="vi">@product</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">new</span>
  <span class="k">end</span>

<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</figure>

<p><br></p>
<h3>Step 7: 新增index页面</h3>
<p><code>touch app/views/admin/products/index.html.erb</code></p>

<figure class="figure-code code"><figcaption><span>app/views/admin/products/index.html.erb
</span></figcaption><div class="highlight"><pre><span class="nt">&lt;ul&gt;</span>
  <span class="cp">&lt;%</span> <span class="vi">@products</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product</span><span class="o">|</span> <span class="cp">%&gt;</span>

    <span class="nt">&lt;li&gt;</span> <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="n">product</span><span class="p">.</span><span class="nf">title</span><span class="p">,</span> <span class="n">admin_product_path</span><span class="p">(</span><span class="n">product</span><span class="p">))</span> <span class="cp">%&gt;</span> <span class="nt">&lt;/li&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>
</pre></div>
</figure>

<p>新增商品后可以看到新增的商品页面</p>

<p><a href="http://localhost:3000/admin/products" rel="nofollow" target="_blank">http://localhost:3000/admin/products</a></p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/uDf3Roi2StampV4sMHhu_step7.png" title=""></figure></p>

<p><br></p>
<h3>Step 8: 实作后台商品修改</h3>
<h4>修改 admin/products_controller.rb</h4>
<figure class="figure-code code"><figcaption><span>app/controllers/admin/products_controller.rb
</span></figcaption><div class="highlight"><pre><span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">new</span>
    <span class="vi">@product</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">new</span>
  <span class="k">end</span>

<span class="o">+</span> <span class="k">def</span> <span class="nf">edit</span>
<span class="o">+</span>   <span class="vi">@product</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
<span class="o">+</span> <span class="k">end</span>

<span class="o">+</span> <span class="k">def</span> <span class="nf">update</span>
<span class="o">+</span>   <span class="vi">@product</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>

<span class="o">+</span>   <span class="k">if</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">product_params</span><span class="p">)</span>
<span class="o">+</span>     <span class="n">redirect_to</span> <span class="n">admin_products_path</span>
<span class="o">+</span>   <span class="k">else</span>
<span class="o">+</span>     <span class="n">render</span> <span class="ss">:edit</span>
<span class="o">+</span>   <span class="k">end</span>
<span class="o">+</span> <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@product</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">product_params</span><span class="p">)</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
</pre></div>
</figure>

<p><br></p>
<h3>Step 9: 新增修改页面</h3>
<p><code>touch app/views/admin/products/edit.html.erb</code></p>

<figure class="figure-code code"><figcaption><span>app/views/admin/products/edit.html.erb
</span></figcaption><div class="highlight"><pre><span class="nt">&lt;h2&gt;</span> Edit Product <span class="nt">&lt;/h2&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">simple_form_for</span> <span class="p">[</span><span class="ss">:admin</span><span class="p">,</span> <span class="vi">@product</span><span class="p">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>

  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"group"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">input</span> <span class="ss">:title</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"group"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">input</span> <span class="ss">:description</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"group"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">input</span> <span class="ss">:quantity</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"group"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">input</span> <span class="ss">:price</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">submit</span> <span class="s2">"Submit"</span><span class="p">,</span> <span class="ss">data: </span><span class="p">{</span> <span class="ss">disable_with: </span><span class="s2">"Submitting..."</span> <span class="p">}</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</figure>

<p>测试看看<br>
<a href="http://localhost:3000/admin/products/1/edit" rel="nofollow" target="_blank">http://localhost:3000/admin/products/1/edit</a><br>
(/product/XXX/edit 若有多笔资料, XXX可以替换为其他数字)</p>

<p><br></p>
<h3>Step 10: git 存档</h3>
<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "implement backend CRUD"
</pre></div>
</figure>
<h2>效果动图</h2>
<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/31RcJJwjQcSTx6CyNDZH_jdstore-posts:216.gif" title=""></figure></p>

    </div>
  </div></div><div class='frame'><h1>
      4-3 STORY 2 - admin 可以登录后台 
    </h1><h4>所属章节：4-后台（解答）</h4><hr><div class="post group">
    <div class="post-content markdown">
      <h2>目标</h2>
<ul>
<li>管理者（商家）必须先登录网站才能进入（商店）后台</li>
<li>管理者必须有 admin 权限才能进入后台</li>
</ul>

<p><br></p>
<h3>Step 0:</h3>
<figure class="figure-code code"><div class="highlight"><pre>git checkout -b story2
</pre></div>
</figure>

<p><br></p>
<h3>Step 1: 必须要先登入才能进入</h3>
<figure class="figure-code code"><figcaption><span>app/controllers/admin/products_controller.rb
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">Admin</span><span class="o">::</span><span class="no">ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

<span class="o">+</span> <span class="n">before_action</span> <span class="ss">:authenticate_user!</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@products</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">all</span>
  <span class="k">end</span>

<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
</pre></div>
</figure>
<h4>在浏览器测试是否强制验证</h4>
<p><a href="http://localhost:3000/admin/products/new" rel="nofollow" target="_blank">http://localhost:3000/admin/products/new</a></p>

<p><br></p>
<h3>Step 2: 必须要有 admin 权限才能进入</h3>
<figure class="figure-code code"><figcaption><span>app/controllers/admin/products_controller.rb
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">Admin</span><span class="o">::</span><span class="no">ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="n">before_action</span> <span class="ss">:authenticate_user!</span>
<span class="o">+</span> <span class="n">before_action</span> <span class="ss">:admin_required</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@products</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">all</span>
  <span class="k">end</span>

<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
</pre></div>
</figure>

<p><br></p>
<h3>Step 3: 建立 admin 判断式</h3>
<figure class="figure-code code"><figcaption><span>app/controllers/application_controller.rb
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="c1"># Prevent CSRF attacks by raising an exception.
</span>
  <span class="c1"># For APIs, you may want to use :null_session instead.
</span>
  <span class="n">protect_from_forgery</span> <span class="ss">with: :exception</span>

<span class="o">+</span> <span class="k">def</span> <span class="nf">admin_required</span>
<span class="o">+</span>   <span class="k">if</span> <span class="o">!</span><span class="n">current_user</span><span class="p">.</span><span class="nf">admin?</span>
<span class="o">+</span>     <span class="n">redirect_to</span> <span class="s2">"/"</span><span class="p">,</span> <span class="ss">alert: </span><span class="s2">"You are not admin."</span>
<span class="o">+</span>   <span class="k">end</span>
<span class="o">+</span> <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</figure>

<p><br></p>
<h3>Step 4: 加入 admin? 判断式</h3>
<figure class="figure-code code"><figcaption><span>app/models/user.rb
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># Include default devise modules. Others available are:
</span>
  <span class="c1"># :confirmable, :lockable, :timeoutable and :omniauthable
</span>
  <span class="n">devise</span> <span class="ss">:database_authenticatable</span><span class="p">,</span> <span class="ss">:registerable</span><span class="p">,</span>
         <span class="ss">:recoverable</span><span class="p">,</span> <span class="ss">:rememberable</span><span class="p">,</span> <span class="ss">:trackable</span><span class="p">,</span> <span class="ss">:validatable</span>

<span class="o">+</span> <span class="k">def</span> <span class="nf">admin?</span>
<span class="o">+</span>   <span class="n">is_admin</span>
<span class="o">+</span> <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</figure>

<p><br></p>
<h3>Step 5: 新增 is_admin 栏位(boolean)</h3>
<p><code>rails g migration add_is_admin_to_user</code></p>

<p>修改里面的档案</p>

<figure class="figure-code code"><figcaption><span>db/migrate/xxx(一堆数字)_add_is_admin_to_user.rb
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddIsAdminToUser</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mi">5</span><span class="o">.</span><span class="mi">0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
<span class="o">+</span>   <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:is_admin</span><span class="p">,</span> <span class="ss">:boolean</span><span class="p">,</span> <span class="ss">default: </span><span class="kp">false</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</figure>

<p>执行<code>rake db:migrate</code><br>
重开rails server</p>
<h4>测试admin是否能进后台</h4>
<p>存取<br>
<a href="http://localhost:3000/admin/products/new" rel="nofollow" target="_blank">http://localhost:3000/admin/products/new</a></p>

<p><br></p>
<h3>Step 6: 在 rails console 操作新增一个 admin 使用者</h3>
<p><code>rails c</code></p>

<p><code>u = User.new(email: "admin@test.com", password: "123456", password_confirmation: "123456")</code><br>
<code>u.save</code><br>
<code>u.is_admin = true</code><br>
<code>u.save</code></p>
<h4>再次测试admin是否能进后台</h4>
<p>存取<br>
<a href="http://localhost:3000/admin/products/new" rel="nofollow" target="_blank">http://localhost:3000/admin/products/new</a></p>

<p><br></p>
<h3>Step 7: 新增一个 user 种子档</h3>
<figure class="figure-code code"><figcaption><span>db/seeds.rb
</span></figcaption><div class="highlight"><pre><span class="n">u</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span>
<span class="n">u</span><span class="p">.</span><span class="nf">email</span> <span class="o">=</span> <span class="s2">"admin@test.com"</span>           <span class="c1"># 可以改成自己的 email
</span>
<span class="n">u</span><span class="p">.</span><span class="nf">password</span> <span class="o">=</span> <span class="s2">"123456"</span>                <span class="c1"># 最少要六码
</span>
<span class="n">u</span><span class="p">.</span><span class="nf">password_confirmation</span> <span class="o">=</span> <span class="s2">"123456"</span>   <span class="c1"># 最少要六码
</span>
<span class="n">u</span><span class="p">.</span><span class="nf">is_admin</span> <span class="o">=</span> <span class="kp">true</span>
<span class="n">u</span><span class="p">.</span><span class="nf">save</span>
</pre></div>
</figure>

<p>然后 <code>rake db:seed</code> 即可自动建一个有 admin 权限的帐号</p>
<h4>补充: 日后资料库设定 ( migrate ) 重建时发生错误时的 bug fix</h4>
<p><code>rake db:reset</code></p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/W9pyYgUSL2TsAwaDp0LL_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-09-13%20%E4%B8%8B%E5%8D%884.01.55.png" title=""></figure></p>

<p><br></p>
<h3>Step 8: 建立后台 layout</h3>
<h4>建立 layout: admin</h4>
<figure class="figure-code code"><figcaption><span>app/controllers/admin/products_controller.rb
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">Admin</span><span class="o">::</span><span class="no">ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

<span class="o">+</span> <span class="n">layout</span> <span class="s2">"admin"</span>

  <span class="n">before_action</span> <span class="ss">:authenticate_user!</span>
  <span class="n">before_action</span> <span class="ss">:admin_required</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>

</pre></div>
</figure>

<p><code>touch app/views/layouts/admin.html.erb</code></p>

<figure class="figure-code code"><figcaption><span>app/views/layouts/admin.html.erb
</span></figcaption><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;title&gt;</span>JDstore 后台<span class="nt">&lt;/title&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span>    <span class="s1">'application'</span><span class="p">,</span> <span class="ss">media: </span><span class="s1">'all'</span><span class="p">,</span> <span class="s1">'data-turbolinks-track'</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s1">'application'</span><span class="p">,</span> <span class="s1">'data-turbolinks-track'</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">csrf_meta_tags</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s2">"common/navbar"</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-2"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav nav-pills nav-stacked"</span> <span class="na">style=</span><span class="s">"max-width: 300px;"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;li&gt;</span> <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">"Products"</span><span class="p">,</span> <span class="n">admin_products_path</span><span class="p">)</span> <span class="cp">%&gt;</span> <span class="nt">&lt;/li&gt;</span>
        <span class="nt">&lt;/ul&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-10"</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</figure>

<p>完成</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/z0KB4QaCTNa3827WnCcP_step9.png" title=""></figure></p>

<p><br></p>
<h3>Step 9: git 存档</h3>
<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "only admin can access backend panel"
</pre></div>
</figure>
<h2>效果动图</h2>
<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/gS4UUJKbStSJ1AYFzJbd_jdstore-posts:218.gif" title=""></figure></p>

    </div>
  </div></div><div class='frame'><h1>
      4-4 STORY 3 - 上传图片
    </h1><h4>所属章节：4-后台（解答）</h4><hr><div class="post group">
    <div class="post-content markdown">
      <h2>目标</h2>
<ul>
<li>可以上传图片</li>
<li>设定 localhost:3000 为商品首页</li>
<li>商品内页展示</li>
</ul>

<p><br></p>
<h3>Step 0:</h3>
<figure class="figure-code code"><div class="highlight"><pre>git checkout -b story3
</pre></div>
</figure>

<p><br></p>
<h3>Step 1: 安装carrierwave and mini_magick</h3>
<figure class="figure-code code"><figcaption><span>Gemfile
</span></figcaption><div class="highlight"><pre><span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
<span class="n">gem</span> <span class="s1">'font-awesome-rails'</span>

<span class="o">+</span> <span class="n">gem</span> <span class="s1">'carrierwave'</span>

<span class="o">+</span> <span class="n">gem</span> <span class="s1">'mini_magick'</span>

<span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>

</pre></div>
</figure>

<p><code>bundle install</code></p>

<p><code>rails g uploader image</code></p>

<p><code>重开 rails s</code></p>

<p><br></p>
<h3>Step 2: 在product新增image栏位</h3>
<p><code>rails g migration add_image_to_product</code></p>

<figure class="figure-code code"><figcaption><span>db/migrate/XXX(一堆数字)_add_image_to_product.rb
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddImageToProduct</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mi">5</span><span class="o">.</span><span class="mi">0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
<span class="o">+</span>   <span class="n">add_column</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:image</span><span class="p">,</span> <span class="ss">:string</span>
  <span class="k">end</span>
<span class="k">end</span>

</pre></div>
</figure>

<p><code>rake db:migrate</code></p>

<p><br></p>
<h3>Step 3: 挂上 image uploader</h3>
<figure class="figure-code code"><figcaption><span>app/models/product.rb
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="o">+</span> <span class="n">mount_uploader</span> <span class="ss">:image</span><span class="p">,</span> <span class="no">ImageUploader</span>
<span class="k">end</span>
</pre></div>
</figure>

<p><br></p>
<h3>Step 4: 设定图片上传后裁切的尺寸</h3>
<figure class="figure-code code"><figcaption><span>app/uploaders/image_uploader.rb
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">ImageUploader</span> <span class="o">&lt;</span> <span class="no">CarrierWave</span><span class="o">::</span><span class="no">Uploader</span><span class="o">::</span><span class="no">Base</span>

  <span class="c1"># Include RMagick or MiniMagick support:
</span>
  <span class="c1"># include CarrierWave::RMagick
</span>
<span class="o">-</span> <span class="c1"># include CarrierWave::MiniMagick
</span>
<span class="o">+</span> <span class="kp">include</span> <span class="no">CarrierWave</span><span class="o">::</span><span class="no">MiniMagick</span>

  <span class="c1"># Choose what kind of storage to use for this uploader:
</span>
  <span class="n">storage</span> <span class="ss">:file</span>
  <span class="c1"># storage :fog
</span>

  <span class="c1"># Override the directory where uploaded files will be stored.
</span>
  <span class="c1"># This is a sensible default for uploaders that are meant to be mounted:
</span>
  <span class="k">def</span> <span class="nf">store_dir</span>
    <span class="s2">"uploads/</span><span class="si">#{</span><span class="n">model</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">to_s</span><span class="p">.</span><span class="nf">underscore</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">mounted_as</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">model</span><span class="p">.</span><span class="nf">id</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>

<span class="o">+</span> <span class="n">process</span> <span class="ss">resize_to_fit: </span><span class="p">[</span><span class="mi">800</span><span class="p">,</span> <span class="mi">800</span><span class="p">]</span>

<span class="o">+</span> <span class="n">version</span> <span class="ss">:thumb</span> <span class="k">do</span>
<span class="o">+</span>   <span class="n">process</span> <span class="ss">resize_to_fill: </span><span class="p">[</span><span class="mi">200</span><span class="p">,</span><span class="mi">200</span><span class="p">]</span>
<span class="o">+</span> <span class="k">end</span>

<span class="o">+</span> <span class="n">version</span> <span class="ss">:medium</span> <span class="k">do</span>
<span class="o">+</span>   <span class="n">process</span> <span class="ss">resize_to_fill: </span><span class="p">[</span><span class="mi">400</span><span class="p">,</span><span class="mi">400</span><span class="p">]</span>
<span class="o">+</span> <span class="k">end</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
</pre></div>
</figure>

<p><br></p>
<h3>Step 5: 新增商品时可以上传商品照片</h3>
<figure class="figure-code code"><figcaption><span>app/controllers/admin/products_controller.rb
</span></figcaption><div class="highlight"><pre><span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
   <span class="k">def</span> <span class="nf">new</span>
     <span class="vi">@product</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">new</span>
   <span class="k">end</span>
   
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>

   <span class="k">def</span> <span class="nf">product_params</span>
<span class="o">-</span>    <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:product</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="ss">:description</span><span class="p">,</span> <span class="ss">:quantity</span><span class="p">,</span> <span class="ss">:price</span><span class="p">)</span>
<span class="o">+</span>    <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:product</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="ss">:description</span><span class="p">,</span> <span class="ss">:quantity</span><span class="p">,</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">:image</span><span class="p">)</span>
   <span class="k">end</span>

<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
</pre></div>
</figure>

<figure class="figure-code code"><figcaption><span>app/views/admin/products/new.html.erb
</span></figcaption><div class="highlight"><pre>...(略)
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"group"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">input</span> <span class="ss">:price</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  
+ <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"group"</span><span class="nt">&gt;</span>
+   <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">input</span> <span class="ss">:image</span><span class="p">,</span> <span class="ss">as: :file</span> <span class="cp">%&gt;</span>
+ <span class="nt">&lt;/div&gt;</span>

  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">submit</span> <span class="s2">"Submit"</span><span class="p">,</span> <span class="ss">data: </span><span class="p">{</span> <span class="ss">disable_with: </span><span class="s2">"Submitting..."</span> <span class="p">}</span> <span class="cp">%&gt;</span>
...(略)
</pre></div>
</figure>

<p><br></p>
<h3>Step 6: 商品修改页也能修改图片</h3>
<figure class="figure-code code"><figcaption><span>app/views/admin/products/edit.html.erb
</span></figcaption><div class="highlight"><pre>...(略)
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"group"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">input</span> <span class="ss">:price</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

+ <span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">image</span><span class="p">.</span><span class="nf">present?</span> <span class="cp">%&gt;</span>
+   <span class="nt">&lt;span&gt;</span>目前商品图<span class="nt">&lt;/span&gt;</span> <span class="nt">&lt;br&gt;</span>
+   <span class="cp">&lt;%=</span> <span class="n">image_tag</span><span class="p">(</span><span class="vi">@product</span><span class="p">.</span><span class="nf">image</span><span class="p">.</span><span class="nf">thumb</span><span class="p">.</span><span class="nf">url</span><span class="p">)</span> <span class="cp">%&gt;</span>
+ <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

+ <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"group"</span><span class="nt">&gt;</span>
+   <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">input</span> <span class="ss">:image</span><span class="p">,</span> <span class="ss">as: :file</span> <span class="cp">%&gt;</span>
+ <span class="nt">&lt;/div&gt;</span>

  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">submit</span> <span class="s2">"Submit"</span><span class="p">,</span> <span class="ss">data: </span><span class="p">{</span> <span class="ss">disable_with: </span><span class="s2">"Submitting..."</span> <span class="p">}</span> <span class="cp">%&gt;</span>
...(略)
</pre></div>
</figure>

<p><br></p>
<h3>Step 7: 将 uploads 资料夹放入 .gitignore</h3>
<p>由于我们实作的图片上传功能，会将图片档案存在 public/uploads/xxx 的资料夹里面<br>
我们不希望这些档案放进 git，所以要像 database.yml 一样将整个资料夹放入 .gitignore 里面</p>

<figure class="figure-code code"><figcaption><span>.gitignore
</span></figcaption><div class="highlight"><pre>...(略)
config/database.yml
<span class="err">+ public/uploads
</span></pre></div>
</figure>
<h4>git存档</h4>
<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "implement image upload"
</pre></div>
</figure>

<p><br></p>
<h3>Step 8: 前台 products#show, products#index 实作</h3>
<p><code>rails g controller products</code></p>
<h4>建立 products/index</h4>
<figure class="figure-code code"><figcaption><span>app/controllers/products_controller.rb
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
<span class="o">+</span> <span class="k">def</span> <span class="nf">index</span>
<span class="o">+</span>   <span class="vi">@products</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">all</span>
<span class="o">+</span> <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</figure>

<p><code>touch app/views/products/index.html.erb</code></p>

<figure class="figure-code code"><figcaption><span>app/views/products/index.html.erb
</span></figcaption><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%</span> <span class="vi">@products</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-xs-6 col-md-3"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">product_path</span><span class="p">(</span><span class="n">product</span><span class="p">)</span> <span class="k">do</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">product</span><span class="p">.</span><span class="nf">image</span><span class="p">.</span><span class="nf">present?</span> <span class="cp">%&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">image_tag</span><span class="p">(</span><span class="n">product</span><span class="p">.</span><span class="nf">image</span><span class="p">.</span><span class="nf">thumb</span><span class="p">.</span><span class="nf">url</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"thumbnail"</span><span class="p">)</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">image_tag</span><span class="p">(</span><span class="s2">"http://placehold.it/200x200&amp;text=No Pic"</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"thumbnail"</span><span class="p">)</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">product</span><span class="p">.</span><span class="nf">title</span> <span class="cp">%&gt;</span> ￥ <span class="cp">&lt;%=</span> <span class="n">product</span><span class="p">.</span><span class="nf">price</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</figure>
<h4>修改首页路径</h4>
<figure class="figure-code code"><figcaption><span>config/routes.rb
</span></figcaption><div class="highlight"><pre><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
<span class="o">-</span> <span class="n">root</span> <span class="s1">'welcome#index'</span>
<span class="o">+</span> <span class="n">root</span> <span class="s1">'products#index'</span>  
  <span class="n">devise_for</span> <span class="ss">:users</span>
  <span class="n">namespace</span> <span class="ss">:admin</span> <span class="k">do</span>
    <span class="n">resources</span> <span class="ss">:products</span>
  <span class="k">end</span>

<span class="o">+</span> <span class="n">resources</span> <span class="ss">:products</span>

<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
</pre></div>
</figure>
<h4>建立 products/show</h4>
<figure class="figure-code code"><figcaption><span>app/controllers/products_controller.rb
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@products</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">all</span>
  <span class="k">end</span>
  
<span class="o">+</span> <span class="k">def</span> <span class="nf">show</span>
<span class="o">+</span>   <span class="vi">@product</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
<span class="o">+</span> <span class="k">end</span>
<span class="k">end</span>

</pre></div>
</figure>

<p><code>touch app/views/products/show.html.erb</code></p>

<figure class="figure-code code"><figcaption><span>app/views/products/show.html.erb
</span></figcaption><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-6"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">image</span><span class="p">.</span><span class="nf">present?</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">image_tag</span><span class="p">(</span><span class="vi">@product</span><span class="p">.</span><span class="nf">image</span><span class="p">.</span><span class="nf">medium</span><span class="p">.</span><span class="nf">url</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"thumbnail"</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">image_tag</span><span class="p">(</span><span class="s2">"http://placehold.it/400x400&amp;text=No Pic"</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"thumbnail"</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-6"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h2&gt;</span> <span class="cp">&lt;%=</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">title</span> <span class="cp">%&gt;</span> <span class="nt">&lt;/h2&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">"height:100px;"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;p&gt;</span>
        <span class="cp">&lt;%=</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">description</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div&gt;</span> 数量 : <span class="cp">&lt;%=</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">quantity</span> <span class="cp">%&gt;</span> <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"product-price"</span><span class="nt">&gt;</span> ￥ <span class="cp">&lt;%=</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">price</span> <span class="cp">%&gt;</span> <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"pull-right"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">"加入购物车"</span><span class="p">,</span> <span class="s2">"#"</span><span class="p">,</span> <span class="ss">:class</span> <span class="o">=&gt;</span> <span class="s2">"btn btn-danger btn-lg"</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</figure>
<h4>在navbar加上product链接</h4>
<figure class="figure-code code"><figcaption><span>app/views/common/_navbar.html.erb
</span></figcaption><div class="highlight"><pre>...(略)
    <span class="c">&lt;!-- Collect the nav links, forms, and other content for toggling --&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"collapse navbar-collapse"</span> <span class="na">id=</span><span class="s">"bs-example-navbar-collapse-1"</span><span class="nt">&gt;</span>
+     <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav navbar-nav"</span><span class="nt">&gt;</span>
+       <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"active"</span><span class="nt">&gt;</span>
+         <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">"Products"</span><span class="p">,</span> <span class="n">products_path</span><span class="p">)</span> <span class="cp">%&gt;</span>
+       <span class="nt">&lt;/li&gt;</span>
+     <span class="nt">&lt;/ul&gt;</span>
...(略)
</pre></div>
</figure>
<h4>git存档</h4>
<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "implement product show"
</pre></div>
</figure>

<p><br></p>
<h3>Step 9: 重构后台商品列表</h3>
<p>将 app/views/admin/products/index.html.erb 换成以下的 code</p>

<figure class="figure-code code"><figcaption><span>app/views/admin/products/index.html.erb
</span></figcaption><div class="highlight"><pre><span class="nt">&lt;h2&gt;</span> Product List <span class="nt">&lt;/h2&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"pull-right"</span> <span class="na">style=</span><span class="s">"padding-bottom: 20px;"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">"新增产品"</span><span class="p">,</span> <span class="n">new_admin_product_path</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"btn btn-primary btn-sm"</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">"table table-bordered"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;thead&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
      <span class="nt">&lt;th&gt;</span>#<span class="nt">&lt;/th&gt;</span>
      <span class="nt">&lt;th</span> <span class="na">width=</span><span class="s">"220"</span><span class="nt">&gt;</span>Product Pic<span class="nt">&lt;/th&gt;</span>
      <span class="nt">&lt;th&gt;</span>Name<span class="nt">&lt;/th&gt;</span>
      <span class="nt">&lt;th&gt;</span>Price<span class="nt">&lt;/th&gt;</span>
      <span class="nt">&lt;th</span> <span class="na">width=</span><span class="s">"100"</span><span class="nt">&gt;</span> Options<span class="nt">&lt;/th&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
  <span class="nt">&lt;/thead&gt;</span>
  <span class="nt">&lt;tbody&gt;</span>
    <span class="cp">&lt;%</span> <span class="vi">@products</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;td&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">product</span><span class="p">.</span><span class="nf">id</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">product_path</span><span class="p">(</span><span class="n">product</span><span class="p">)</span> <span class="k">do</span> <span class="cp">%&gt;</span>
            <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">product</span><span class="p">.</span><span class="nf">image</span><span class="p">.</span><span class="nf">present?</span> <span class="cp">%&gt;</span>
              <span class="cp">&lt;%=</span> <span class="n">image_tag</span><span class="p">(</span><span class="n">product</span><span class="p">.</span><span class="nf">image</span><span class="p">.</span><span class="nf">thumb</span><span class="p">.</span><span class="nf">url</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"thumbnail"</span><span class="p">)</span> <span class="cp">%&gt;</span>
            <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
              <span class="cp">&lt;%=</span> <span class="n">image_tag</span><span class="p">(</span><span class="s2">"http://placehold.it/200x200&amp;text=No Pic"</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"thumbnail"</span><span class="p">)</span> <span class="cp">%&gt;</span>
            <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">product</span><span class="p">.</span><span class="nf">title</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">product</span><span class="p">.</span><span class="nf">price</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">"Edit"</span><span class="p">,</span> <span class="n">edit_admin_product_path</span><span class="p">(</span><span class="n">product</span><span class="p">))</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/td&gt;</span>
      <span class="nt">&lt;/tr&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/tbody&gt;</span>
<span class="nt">&lt;/table&gt;</span>

</pre></div>
</figure>

<p>完成</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/L3NIs9WgTeWXR6DP5Zwz_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-09-13%20%E4%B8%8B%E5%8D%888.21.09.png" title=""></figure></p>
<h4>navbar 的下拉选单放入后台链接</h4>
<figure class="figure-code code"><figcaption><span>app/views/common/_navbar.html.erb
</span></figcaption><div class="highlight"><pre>...(略)
          <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"dropdown"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"#"</span> <span class="na">class=</span><span class="s">"dropdown-toggle"</span> <span class="na">data-toggle=</span><span class="s">"dropdown"</span><span class="nt">&gt;</span>
              Hi!, <span class="cp">&lt;%=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">email</span> <span class="cp">%&gt;</span>
              <span class="nt">&lt;b</span> <span class="na">class=</span><span class="s">"caret"</span><span class="nt">&gt;&lt;/b&gt;</span>
            <span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"dropdown-menu"</span><span class="nt">&gt;</span>
+             <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">admin?</span> <span class="cp">%&gt;</span>
+               <span class="nt">&lt;li&gt;</span>
+                 <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">"Admin 选单"</span><span class="p">,</span> <span class="n">admin_products_path</span> <span class="p">)</span> <span class="cp">%&gt;</span>
+               <span class="nt">&lt;/li&gt;</span>
+             <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
              <span class="nt">&lt;li&gt;</span>
                <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="n">content_tag</span><span class="p">(</span><span class="ss">:i</span><span class="p">,</span> <span class="s1">'登出'</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'fa fa-sign-out'</span><span class="p">),</span> <span class="n">destroy_user_session_path</span><span class="p">,</span> <span class="ss">method: :delete</span><span class="p">)</span> <span class="cp">%&gt;</span>
              <span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;/ul&gt;</span>
          <span class="nt">&lt;/li&gt;</span>
...(略)

</pre></div>
</figure>

<p><br></p>
<h4>git存档</h4>
<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "change admin/product backend panel"
</pre></div>
</figure>
<h2>效果动图</h2>
<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/gSiJZ1aORw6IENlStTN2_jdstore-posts:207.gif" title=""></figure></p>

    </div>
  </div></div><div class='frame'><h1>
      5-1 购物车实做
    </h1><h4>所属章节：5-购物车实做</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>这一章节我们会实做的是找到商品之后</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/zGex3sDsRlezCvod3peA_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-01%20%E4%B8%8B%E5%8D%883.20.50.png" title=""></figure></p>

<p>加到购物车</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/FAyO00gsTwCa0AKVTObI_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-01%20%E4%B8%8B%E5%8D%883.21.03.png" title=""></figure></p>

<p>然后可以生成购物明细</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/30xu0O2SsmEDpOQgHkhM_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-01%20%E4%B8%8B%E5%8D%883.21.12.png" title=""></figure></p>

<p>并在确定购物明细后，对订单结帐付款</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/DH7pSH1fTsOAT065cRp7_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-01%20%E4%B8%8B%E5%8D%883.22.52.png" title=""></figure></p>

    </div>
  </div></div><div class='frame'><h1>
      从新手到胜任者
    </h1><h4>所属章节：5-购物车实做</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>主讲人：<br>
xdite老师</p>

<p>概要：</p>

<ul>
<li>德雷福斯模型</li>
<li>学习编程需要经历的各个阶段</li>
</ul>

<p>提示：<br>
需要科学上网才可以正常观看本视频<br>
如果画面模糊请到右下角设置中将画质调整为720p<br>
<br></p>

    </div>
      <script src="//fast.wistia.com/embed/medias/rn0tbgjk8v.jsonp" async></script>
<script src="//fast.wistia.com/assets/external/E-v1.js" async></script>
<div class="player-bg">
    <div class="loading-tips">
        <button class="btn btn-default btn-lg">
            <i class="fa fa-spinner fa-spin"></i>
        </button>
        <p>视频文件正在加载，请确保已经打开VPN</p>
    </div>
    <div class="wistia_responsive_padding" style="padding:56.25% 0 0 0;position:relative;">
        <div class="wistia_responsive_wrapper" style="height:100%;left:0;position:absolute;top:0;width:100%;">
            <div class="wistia_embed wistia_async_rn0tbgjk8v videoFoam=true" style="height:100%;width:100%"> </div>
            <script>
                window._wq = window._wq || [];
                _wq.push({ id: "rn0tbgjk8v", onReady: function(video) {
                    window.wistia_video = video;
                        window.wistia_video.time("1020.377532");
                    var url = "/user_wistia_position_records/update_position";
                    var post_id = "679"; 
                    setInterval(function(){                        
                        if (wistia_video.state() === "playing") {
                            var data = {
                                position: wistia_video.time(),
                                post_id: post_id 
                            };                            
                            $.post(url, data);
                        }                        
                    }, 5000);
                }});
            </script>            
        </div>
    </div>
</div>

  </div></div><div class='frame'><h1>
      5-2 Step 1 : 建立加入购物车的 action 
    </h1><h4>所属章节：5-购物车实做</h4><hr><div class="post group">
    <div class="post-content markdown">
      <h2>目标</h2>
<p>这一节的目标是为了实做加入购物车的按钮，可以点击一下「加入购物车」的按钮，就将货品加入购物车</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/zGex3sDsRlezCvod3peA_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-01%20%E4%B8%8B%E5%8D%883.20.50.png" title=""></figure></p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/93TowhpCRC2Ki4XLy62P_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-05%20%E4%B8%8B%E5%8D%881.01.07.png" title=""></figure></p>
<h3>Step 0</h3>
<figure class="figure-code code"><div class="highlight"><pre>git checkout -b story4
</pre></div>
</figure>
<h3>Step 1</h3>
<p>实作一个「加入购物车」的按钮：</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/jji4tLMdTSSrQFFXMAyu_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-05%20%E4%B8%8B%E5%8D%881.02.34.png" title=""></figure></p>

<p>修改 <code>app/views/products/show.html.erb</code></p>

<figure class="figure-code code"><figcaption><span>app/views/products/show.html.erb 
</span></figcaption><div class="highlight"><pre>-  <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">"加入购物车"</span><span class="p">,</span> <span class="s2">"#"</span><span class="p">,</span> <span class="ss">:class</span> <span class="o">=&gt;</span> <span class="s2">"btn btn-primary btn-lg btn-danger"</span><span class="p">)</span> <span class="cp">%&gt;</span>
+  <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">"加入购物车"</span><span class="p">,</span> <span class="n">add_to_cart_product_path</span><span class="p">(</span><span class="vi">@product</span><span class="p">),</span> <span class="ss">:method</span> <span class="o">=&gt;</span> <span class="ss">:post</span><span class="p">,</span> <span class="ss">:class</span> <span class="o">=&gt;</span> <span class="s2">"btn btn-primary btn-lg btn-danger"</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div>
</figure>

<p>然后修改 <code>app/controllers/products_controller.rb</code> 加入 <code>add_to_cart action</code></p>

<figure class="figure-code code"><figcaption><span>app/controllers/products_controller.rb 
</span></figcaption><div class="highlight"><pre><span class="o">+</span>  <span class="k">def</span> <span class="nf">add_to_cart</span>
<span class="o">+</span>    <span class="vi">@product</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
<span class="o">+</span>    <span class="n">redirect_to</span> <span class="ss">:back</span>
<span class="o">+</span>    <span class="n">flash</span><span class="p">[</span><span class="ss">:notice</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"测试加入购物车"</span>
<span class="o">+</span>  <span class="k">end</span>
</pre></div>
</figure>

<p>修改 <code>config/routes.rb</code></p>

<figure class="figure-code code"><figcaption><span>config/routes.rb
</span></figcaption><div class="highlight"><pre><span class="n">root</span> <span class="s1">'products#index'</span>
<span class="n">devise_for</span> <span class="ss">:users</span>
  
  <span class="n">namespace</span> <span class="ss">:admin</span> <span class="k">do</span>
   <span class="n">resources</span> <span class="ss">:products</span>
  <span class="k">end</span>
  
<span class="o">-</span>  <span class="n">resources</span> <span class="ss">:products</span>
<span class="o">+</span>  <span class="n">resources</span> <span class="ss">:products</span> <span class="k">do</span>
<span class="o">+</span>    <span class="n">member</span> <span class="k">do</span>
<span class="o">+</span>      <span class="n">post</span> <span class="ss">:add_to_cart</span>
<span class="o">+</span>    <span class="k">end</span>
<span class="o">+</span>  <span class="k">end</span>

<span class="k">end</span>
</pre></div>
</figure>

<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "add add_to_cart button"
</pre></div>
</figure>
<h2>成果</h2>
<p>如果此步成功的话，点击「加入购物车」按钮之后，你应该可以见到绿色的Flash显示「测试加入购物车」。</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/UugW6TqFQLSPiukfmoMJ_jdstore-posts:221.gif" title=""></figure></p>

    </div>
  </div></div><div class='frame'><h1>
      5-3 Step 2: 购物车设计 Part 1
    </h1><h4>所属章节：5-购物车实做</h4><hr><div class="post group">
    <div class="post-content markdown">
      <h2>目标</h2>
<p>我们的最终目标，是要将 <code>app/controllers/products_controller.rb</code> 中的<code>add_to_cart</code> 里面，加入一行 <code>current_cart.add_product_to_cart(@product)</code> 完成加入购物车的任务。</p>

<figure class="figure-code code"><figcaption><span>app/controllers/products_controller.rb 
</span></figcaption><div class="highlight"><pre>  <span class="k">def</span> <span class="nf">add_to_cart</span>
    <span class="vi">@product</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="n">current_cart</span><span class="p">.</span><span class="nf">add_product_to_cart</span><span class="p">(</span><span class="vi">@product</span><span class="p">)</span>
    <span class="n">redirect_to</span> <span class="ss">:back</span>
  <span class="k">end</span>
</pre></div>
</figure>

<p>简单来说，我们要设计一台购物车 cart（ Model），这个购物车里面要能够执行 add_product_to_cart 这个方法，把商品加到购物车里。</p>
<h2>解说</h2>
<p>这一部份会比较难，所以我们会试着使用图解来解释如何设计 model。首先我们要来讲解购物车是如何被设计出来的</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/4d0sVOoQsiv5YWJOdlA0_iPhone%20image%20on%202017-02-01%20at%2015-51-37.jpeg" title=""></figure></p>

<p>这里有一台购物车。购物车里面有：苹果x 3，西瓜x2，柳橙 x5。</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/wD98QqOKTWunyDJCqSsq_iPhone%20image%20on%202017-02-01%20at%2015-58-35.jpeg" title=""></figure></p>

<p>购物车呢，可以有无限多格。所以你可以理解成为 <code>Cart</code> has_many <code>CartItem</code></p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/j4TTGtN1SWueFylWfmO7_iPhone%20image%20on%202017-02-01%20at%2016-03-46.jpeg" title=""></figure></p>

<p><code>CartItem</code> 里面记载了两份资讯 <code>product</code>（哪一种物品） 与 <code>quantity</code>　（数量是多少）</p>
<h2>步骤：</h2>
<p>接下来我们就可以来产生与设计 Model</p>
<h3>Step 1：产生 Cart 与 CartItem 两个 model</h3>
<figure class="figure-code code"><div class="highlight"><pre>rails g model cart
</pre></div>
</figure>

<figure class="figure-code code"><div class="highlight"><pre>rails g model cart_item
</pre></div>
</figure>
<h3>Step 2：修改 CartItem 的 migration</h3>
<figure class="figure-code code"><figcaption><span>db/migrate/XXX(一堆数字)_create_cart_items.rb 
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">CreateCartItems</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mi">5</span><span class="o">.</span><span class="mi">0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:cart_items</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
<span class="o">+</span>      <span class="n">t</span><span class="p">.</span><span class="nf">integer</span> <span class="ss">:cart_id</span>
<span class="o">+</span>      <span class="n">t</span><span class="p">.</span><span class="nf">integer</span> <span class="ss">:product_id</span>
<span class="o">+</span>      <span class="n">t</span><span class="p">.</span><span class="nf">integer</span> <span class="ss">:quantity</span><span class="p">,</span> <span class="ss">default: </span><span class="mi">1</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</figure>

<p>然后</p>

<figure class="figure-code code"><div class="highlight"><pre>rake db:migrate
</pre></div>
</figure>
<h3>Step 3   修改 Cart</h3>
<figure class="figure-code code"><figcaption><span>app/models/cart.rb 
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">Cart</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="o">+</span>  <span class="n">has_many</span> <span class="ss">:cart_items</span>
<span class="o">+</span>  <span class="n">has_many</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">through: :cart_items</span><span class="p">,</span> <span class="ss">source: :product</span>
<span class="k">end</span>
</pre></div>
</figure>
<h3>Step 4  修改 CartItem</h3>
<figure class="figure-code code"><figcaption><span>app/models/cart_item.rb 
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">CartItem</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="o">+</span>  <span class="n">belongs_to</span> <span class="ss">:cart</span>
<span class="o">+</span>  <span class="n">belongs_to</span> <span class="ss">:product</span>
<span class="k">end</span>
</pre></div>
</figure>
<h3>Step 5 实做 add_product_to_cart</h3>
<figure class="figure-code code"><figcaption><span>app/models/cart.rb 
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">Cart</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:cart_items</span>
  <span class="n">has_many</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">through: :cart_items</span><span class="p">,</span> <span class="ss">source: :product</span>

<span class="o">+</span>  <span class="k">def</span> <span class="nf">add_product_to_cart</span><span class="p">(</span><span class="n">product</span><span class="p">)</span>
<span class="o">+</span>    <span class="n">ci</span> <span class="o">=</span> <span class="n">cart_items</span><span class="p">.</span><span class="nf">build</span>
<span class="o">+</span>    <span class="n">ci</span><span class="p">.</span><span class="nf">product</span> <span class="o">=</span> <span class="n">product</span>
<span class="o">+</span>    <span class="n">ci</span><span class="p">.</span><span class="nf">quantity</span> <span class="o">=</span> <span class="mi">1</span>
<span class="o">+</span>    <span class="n">ci</span><span class="p">.</span><span class="nf">save</span>
<span class="o">+</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</figure>

<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "implement add_product_to_cart function"
</pre></div>
</figure>
<h2>　结果</h2>
<p>这样我们就完成了 <code>current_cart.add_product_to_cart(@product)</code>  的一半，可以执行 <code>cart.add_product_to_cart(product)</code> 这个动作。</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/7KjTKvOzRsSjqj6sWKLD_jdstore-posts:222.gif" title=""></figure></p>

    </div>
  </div></div><div class='frame'><h1>
      5-4 Step 3: 购物车设计 Part 2
    </h1><h4>所属章节：5-购物车实做</h4><hr><div class="post group">
    <div class="post-content markdown">
      <h2>目标</h2>
<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/MwF3Qu9FSNy4u0rY4QKI_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-01%20%E4%B8%8B%E5%8D%884.20.57.png" title=""></figure></p>

<p>我们的目的是为了每个进店的客户（不管是否有登入，都准备一台购物车）。<br>
然后消费者随时可以察看购物车的产品数量。</p>
<h2>步骤</h2>
<h3>Step 1 : 显示购物车内物品数量</h3>
<p>修改 <code>app/views/common/_navbar.html.erb</code><br>
加入</p>

<figure class="figure-code code"><figcaption><span>app/views/common/_navbar.html.erb 
</span></figcaption><div class="highlight"><pre><span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav navbar-nav navbar-right"</span><span class="nt">&gt;</span>
+ <span class="nt">&lt;li&gt;</span>
+    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"#"</span> <span class="k">do</span>  <span class="cp">%&gt;</span>
+       购物车 <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"fa fa-shopping-cart"</span><span class="nt">&gt;</span> <span class="nt">&lt;/i&gt;</span> ( <span class="cp">&lt;%=</span> <span class="n">current_cart</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">count</span> <span class="cp">%&gt;</span> )
+    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
+ <span class="nt">&lt;/li&gt;</span>

  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="o">!</span><span class="n">current_user</span> <span class="cp">%&gt;</span>
</pre></div>
</figure>
<h3>Step 2 : 加入购物车代码</h3>
<p>修改 <code>app/controllers/application_controller.rb</code></p>

<figure class="figure-code code"><figcaption><span>app/controllers/application_controller.rb 
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>

 <span class="c1"># ...略
</span>


<span class="o">+</span>  <span class="n">helper_method</span> <span class="ss">:current_cart</span>

<span class="o">+</span>  <span class="k">def</span> <span class="nf">current_cart</span>
<span class="o">+</span>    <span class="vi">@current_cart</span> <span class="o">||=</span> <span class="n">find_cart</span>
<span class="o">+</span>  <span class="k">end</span>

<span class="o">+</span>  <span class="kp">private</span>

<span class="o">+</span>  <span class="k">def</span> <span class="nf">find_cart</span>
<span class="o">+</span>    <span class="n">cart</span> <span class="o">=</span> <span class="no">Cart</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">id: </span><span class="n">session</span><span class="p">[</span><span class="ss">:cart_id</span><span class="p">])</span>
<span class="o">+</span>    <span class="k">if</span> <span class="n">cart</span><span class="p">.</span><span class="nf">blank?</span>
<span class="o">+</span>      <span class="n">cart</span> <span class="o">=</span> <span class="no">Cart</span><span class="p">.</span><span class="nf">create</span>
<span class="o">+</span>    <span class="k">end</span>
<span class="o">+</span>    <span class="n">session</span><span class="p">[</span><span class="ss">:cart_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">cart</span><span class="p">.</span><span class="nf">id</span>
<span class="o">+</span>    <span class="k">return</span> <span class="n">cart</span>
<span class="o">+</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</figure>
<h3>Step 3 : 加入 current_cart.add_product_to_cart(@product)</h3>
<p>修改 <code>app/controllers/products_controller.rb</code></p>

<figure class="figure-code code"><figcaption><span>app/controllers/products_controller.rb 
</span></figcaption><div class="highlight"><pre>  <span class="k">def</span> <span class="nf">add_to_cart</span>
    <span class="vi">@product</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
<span class="o">-</span>    <span class="n">redirect_to</span> <span class="ss">:back</span>
<span class="o">-</span>    <span class="n">flash</span><span class="p">[</span><span class="ss">:notice</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"测试加入购物车"</span>

<span class="o">+</span>    <span class="n">current_cart</span><span class="p">.</span><span class="nf">add_product_to_cart</span><span class="p">(</span><span class="vi">@product</span><span class="p">)</span>
<span class="o">+</span>    <span class="n">flash</span><span class="p">[</span><span class="ss">:notice</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"成功加入购物车"</span>
<span class="o">+</span>    <span class="n">redirect_to</span> <span class="ss">:back</span>
  <span class="k">end</span>
</pre></div>
</figure>

<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "implement current_cart function"
</pre></div>
</figure>
<h2>结果</h2>
<p>各位可以按下「加入购物车」的按钮，去看看购物车里的数字从 0 变成 1 。</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/dp7KoXFGTyMOUPFWZHec_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-05%20%E4%B8%8B%E5%8D%881.22.10.png" title=""></figure></p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/cLg8JduSTugGYgWBwZ0w_jdstore-posts:416.gif" title=""></figure></p>
<h2>解说</h2>
<ul>
<li>这部分代码目前对各位来说，是有相当难度的，我们不期待各位读到这一章时，能瞬间理解</li>
<li>不能够理解目前也没关系，只要当作是一段能让购物车「动起来」的代码就行</li>
<li>即便如此，我还是会尽量为各位解释</li>
</ul>
<h3>在 View 里面如何显示购物车内容数量 (helper_method)</h3>
<figure class="figure-code code"><figcaption><span>app/views/common/_navbar.html.erb 
</span></figcaption><div class="highlight"><pre><span class="nt">&lt;li&gt;</span>
   <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"#"</span> <span class="k">do</span>  <span class="cp">%&gt;</span>
      购物车 <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"fa fa-shopping-cart"</span><span class="nt">&gt;</span> <span class="nt">&lt;/i&gt;</span> ( <span class="cp">&lt;%=</span> <span class="n">current_cart</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">count</span> <span class="cp">%&gt;</span> )
   <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div>
</figure>

<p>在 view 里面，我们可以透过 <code>current_cart.products.count</code> 拿到购物车内的物品数量。<br>
但是呢 <code>current_cart</code> 其实原本是一个 controller 内的 method，我们为了要在 view 里面要可以存取它。<br>
所以，我们得在 <code>applications_controller.rb</code> 宣告他是 helper_method，才能直接存取。</p>

<figure class="figure-code code"><figcaption><span>app/controller/applications_controller.rb 
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>

 <span class="c1"># ...略
</span>
  <span class="n">helper_method</span> <span class="ss">:current_cart</span>
</pre></div>
</figure>
<h3>current_cart 如何运作</h3>
<p>购物车的构造是这样的：</p>

<figure class="figure-code code"><figcaption><span>app/controllers/application_controller.rb 
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>

 <span class="c1"># ...略
</span>


  <span class="n">helper_method</span> <span class="ss">:current_cart</span>

  <span class="k">def</span> <span class="nf">current_cart</span>
    <span class="vi">@current_cart</span> <span class="o">||=</span> <span class="n">find_cart</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">find_cart</span>
    <span class="n">cart</span> <span class="o">=</span> <span class="no">Cart</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">id: </span><span class="n">session</span><span class="p">[</span><span class="ss">:cart_id</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">cart</span><span class="p">.</span><span class="nf">blank?</span>
      <span class="n">cart</span> <span class="o">=</span> <span class="no">Cart</span><span class="p">.</span><span class="nf">create</span>
    <span class="k">end</span>
    <span class="n">session</span><span class="p">[</span><span class="ss">:cart_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">cart</span><span class="p">.</span><span class="nf">id</span>
    <span class="k">return</span> <span class="n">cart</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</figure>
<h4>||= 是什么</h4>
<p>首先我们来解释 <code>||=</code> 是什么。</p>

<p><code>a ||= b</code> 等于 <code>a = a || b</code>。意思是如果 a 是 nil 的话。 a 会被赋予　b 值。见下范例</p>

<figure class="figure-code code"><div class="highlight"><pre>a = nil
b = 20
a ||= b

</pre></div>
</figure>

<p>a 会是多少？答案是<code>20</code></p>

<p>所以</p>

<figure class="figure-code code"><div class="highlight"><pre>  def current_cart
    @current_cart ||= find_cart
  end
</pre></div>
</figure>

<p>意思就是 <code>@current_cart</code> 是 <code>nil</code> 时会呼叫 <code>find_cart</code> 这个函式去判断消费者现在使用的是哪一台车。</p>
<h4>find_cart 如何运作</h4>
<figure class="figure-code code"><div class="highlight"><pre>  def find_cart
    cart = Cart.find_by(id: session[:cart_id])
    if cart.blank?
      cart = Cart.create
    end
    session[:cart_id] = cart.id
    return cart
  end
</pre></div>
</figure>  

<ul>
<li>在每个人进店时，都会有一块电子感应卡，叫做 session，所以你的电子感应卡上面记录了你拿了哪台车 <code>cart_id</code> </li>
<li>所以呢，每个人「现在的车」 <code>current_cart</code> 就是透过这样的方式去存取的。</li>
<li>万一你的车丢失了没有关系。<code>if cart.blank?</code> 发现你的车不见了，会再给你一台车。重新登记上去。</li>
</ul>

    </div>
  </div></div><div class='frame'><h1>
      5-5 Step 4 : 显示购物车明细
    </h1><h4>所属章节：5-购物车实做</h4><hr><div class="post group">
    <div class="post-content markdown">
      <h2>目标</h2>
<p>按下购物车按钮时，可以看到购物明细</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/MqZhzK9YSTKOnWRd3Ll8_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-01%20%E4%B8%8B%E5%8D%883.21.12.png" title=""></figure></p>
<h2>步骤</h2>
<h3>Step 1 : 新增 carts controller</h3>
<p><code>rails g controller carts</code></p>

<p><br></p>
<h3>Step 2:</h3>
<p>修改 <code>config/routes.rb</code></p>

<p>加入</p>

<figure class="figure-code code"><figcaption><span>config/routes.rb
</span></figcaption><div class="highlight"><pre><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
<span class="o">+</span>  <span class="n">resources</span> <span class="ss">:carts</span>
<span class="k">end</span>
</pre></div>
</figure>

<p>修改 <code>app/views/common/_navbar.html.erb</code> 让购物车实际可按</p>

<figure class="figure-code code"><figcaption><span>app/views/common/_navbar.html.erb 
</span></figcaption><div class="highlight"><pre><span class="nt">&lt;li&gt;</span>
-  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"#"</span> <span class="k">do</span>  <span class="cp">%&gt;</span>
+  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">carts_path</span> <span class="k">do</span>  <span class="cp">%&gt;</span>
     购物车 <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"fa fa-shopping-cart"</span><span class="nt">&gt;</span> <span class="nt">&lt;/i&gt;</span> ( <span class="cp">&lt;%=</span> <span class="n">current_cart</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">count</span> <span class="cp">%&gt;</span> )
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div>
</figure>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/dp7KoXFGTyMOUPFWZHec_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-05%20%E4%B8%8B%E5%8D%881.22.10.png" title=""></figure></p>

<p><br></p>
<h4>Step 3: 实作购物明细：</h4>
<p><code>touch app/views/carts/index.html.erb</code></p>

<figure class="figure-code code"><figcaption><span>app/views/carts/index.html.erb 
</span></figcaption><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-12"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;h2&gt;</span> 购物车 <span class="nt">&lt;/h2&gt;</span>

    <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">"table table-bordered"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;thead&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
          <span class="nt">&lt;th</span> <span class="na">colspan=</span><span class="s">"2"</span><span class="nt">&gt;</span>商品资讯<span class="nt">&lt;/th&gt;</span>
          <span class="nt">&lt;th&gt;</span>单价<span class="nt">&lt;/th&gt;</span>
          <span class="nt">&lt;th&gt;</span>数量<span class="nt">&lt;/th&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
      <span class="nt">&lt;/thead&gt;</span>
      <span class="nt">&lt;tbody&gt;</span>

        <span class="cp">&lt;%</span> <span class="n">current_cart</span><span class="p">.</span><span class="nf">cart_items</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">cart_item</span><span class="o">|</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;td&gt;</span>
              <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">product_path</span><span class="p">(</span><span class="n">cart_item</span><span class="p">.</span><span class="nf">product</span><span class="p">)</span> <span class="k">do</span> <span class="cp">%&gt;</span>
                <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">cart_item</span><span class="p">.</span><span class="nf">product</span><span class="p">.</span><span class="nf">image</span><span class="p">.</span><span class="nf">present?</span> <span class="cp">%&gt;</span>
                  <span class="cp">&lt;%=</span> <span class="n">image_tag</span><span class="p">(</span><span class="n">cart_item</span><span class="p">.</span><span class="nf">product</span><span class="p">.</span><span class="nf">image</span><span class="p">.</span><span class="nf">thumb</span><span class="p">.</span><span class="nf">url</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"thumbnail"</span><span class="p">)</span> <span class="cp">%&gt;</span>
                <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
                  <span class="cp">&lt;%=</span> <span class="n">image_tag</span><span class="p">(</span><span class="s2">"http://placehold.it/200x200&amp;text=No Pic"</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"thumbnail"</span><span class="p">)</span> <span class="cp">%&gt;</span>
                <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
              <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;</span>
              <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="n">cart_item</span><span class="p">.</span><span class="nf">product</span><span class="p">.</span><span class="nf">title</span><span class="p">,</span> <span class="n">product_path</span><span class="p">(</span><span class="n">cart_item</span><span class="p">.</span><span class="nf">product</span><span class="p">))</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;</span>
              <span class="cp">&lt;%=</span> <span class="n">cart_item</span><span class="p">.</span><span class="nf">product</span><span class="p">.</span><span class="nf">price</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;</span>
              <span class="cp">&lt;%=</span> <span class="n">cart_item</span><span class="p">.</span><span class="nf">quantity</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;/td&gt;</span>
          <span class="nt">&lt;/tr&gt;</span>
        <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

      <span class="nt">&lt;/tbody&gt;</span>
    <span class="nt">&lt;/table&gt;</span>

    <span class="nt">&lt;br&gt;</span>

    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"total clearfix"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"pull-right"</span><span class="nt">&gt;</span>
         <span class="nt">&lt;span&gt;</span> 总计 xxx RMB  <span class="nt">&lt;/span&gt;</span>
      <span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;/div&gt;</span>

    <span class="nt">&lt;hr&gt;</span>

    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"checkout clearfix"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">"确认结账"</span><span class="p">,</span> <span class="s2">"#"</span><span class="p">,</span> <span class="ss">method: :post</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"btn btn-lg btn-danger pull-right"</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</figure>

<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "implement carts index function"
</pre></div>
</figure>

<p>成功的话，应该会看到以下内容</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/lxbI8jNfTJqhya9d4rZF_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-05%20%E4%B8%8B%E5%8D%881.39.04.png" title=""></figure></p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/fLPSVrszRSe9ShgcIPaY_jdstore-posts:223.gif" title=""></figure></p>

    </div>
  </div></div><div class='frame'><h1>
      5-6 Step 5 : 计算总价
    </h1><h4>所属章节：5-购物车实做</h4><hr><div class="post group">
    <div class="post-content markdown">
      <h2>目标</h2>
<p>我们发现购物车里面，还没有计算总价。</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/MX1XnRCtRIuDIFz13lir_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-05%20%E4%B8%8B%E5%8D%881.46.46.png" title=""></figure></p>

<p><br></p>
<h2>步骤：</h2>
<h3>Step 1:</h3>
<p>修改 <code>app/views/carts/index.html.erb</code></p>

<figure class="figure-code code"><figcaption><span>app/views/carts/index.html.erb
</span></figcaption><div class="highlight"><pre>...(略)
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"total clearfix"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"pull-right"</span><span class="nt">&gt;</span>
         <span class="nt">&lt;span&gt;</span>
-           总计 xxx RMB
+           <span class="cp">&lt;%</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span> <span class="cp">%&gt;</span>
+           <span class="cp">&lt;%</span> <span class="n">current_cart</span><span class="p">.</span><span class="nf">cart_items</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">cart_item</span><span class="o">|</span> <span class="cp">%&gt;</span>
+             <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">cart_item</span><span class="p">.</span><span class="nf">product</span><span class="p">.</span><span class="nf">price</span><span class="p">.</span><span class="nf">present?</span> <span class="cp">%&gt;</span>
+               <span class="cp">&lt;%</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">sum</span> <span class="o">+</span> <span class="n">cart_item</span><span class="p">.</span><span class="nf">quantity</span> <span class="o">*</span> <span class="n">cart_item</span><span class="p">.</span><span class="nf">product</span><span class="p">.</span><span class="nf">price</span> <span class="cp">%&gt;</span>
+             <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
+           <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
+           总计 <span class="cp">&lt;%=</span> <span class="n">sum</span> <span class="cp">%&gt;</span> RMB
         <span class="nt">&lt;/span&gt;</span>
      <span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
...(略)
</pre></div>
</figure>

<p>应该会算出真正的总价</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/plqFQ148RMOJAtkYNv8l_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-05%20%E4%B8%8B%E5%8D%881.50.29.png" title=""></figure></p>

<p><br></p>
<h3>Step 2: （如何做的更好）Refactor 到 Helper 去</h3>
<p>但是在 View 里面写这么多丑不拉叽的逻辑实在太难看了。况且「显示逻辑」应该使用 Helper 包装。于是我们可以再把这件事做得漂亮点：</p>

<p>修改　<code>app/views/carts/index.html.erb</code></p>

<figure class="figure-code code"><figcaption><span>app/views/carts/index.html.erb
</span></figcaption><div class="highlight"><pre>...(略)
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"total clearfix"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"pull-right"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;span&gt;</span>
-         <span class="cp">&lt;%</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span> <span class="cp">%&gt;</span>
-         <span class="cp">&lt;%</span> <span class="n">current_cart</span><span class="p">.</span><span class="nf">cart_items</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">cart_item</span><span class="o">|</span> <span class="cp">%&gt;</span>
-           <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">cart_item</span><span class="p">.</span><span class="nf">product</span><span class="p">.</span><span class="nf">price</span><span class="p">.</span><span class="nf">present?</span> <span class="cp">%&gt;</span>
-             <span class="cp">&lt;%</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">sum</span> <span class="o">+</span> <span class="n">cart_item</span><span class="p">.</span><span class="nf">quantity</span> <span class="o">*</span> <span class="n">cart_item</span><span class="p">.</span><span class="nf">product</span><span class="p">.</span><span class="nf">price</span> <span class="cp">%&gt;</span>
-           <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
-         <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
-         总计 <span class="cp">&lt;%=</span> <span class="n">sum</span> <span class="cp">%&gt;</span> RMB
+         总计 <span class="cp">&lt;%=</span> <span class="n">render_cart_total_price</span><span class="p">(</span><span class="n">current_cart</span><span class="p">)</span> <span class="cp">%&gt;</span> RMB
        <span class="nt">&lt;/span&gt;</span>
      <span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
...(略)
</pre></div>
</figure>

<p>修改 <code>app/helpers/carts_helper.rb</code></p>

<figure class="figure-code code"><figcaption><span>app/helpers/carts_helper.rb 
</span></figcaption><div class="highlight"><pre><span class="k">module</span> <span class="nn">CartsHelper</span>
<span class="o">+</span>  <span class="k">def</span> <span class="nf">render_cart_total_price</span><span class="p">(</span><span class="n">cart</span><span class="p">)</span>
<span class="o">+</span>    <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span>
<span class="o">+</span>    <span class="n">cart</span><span class="p">.</span><span class="nf">cart_items</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">cart_item</span><span class="o">|</span>
<span class="o">+</span>      <span class="k">if</span> <span class="n">cart_item</span><span class="p">.</span><span class="nf">product</span><span class="p">.</span><span class="nf">price</span><span class="p">.</span><span class="nf">present?</span>
<span class="o">+</span>        <span class="n">sum</span> <span class="o">+=</span> <span class="n">cart_item</span><span class="p">.</span><span class="nf">quantity</span> <span class="o">*</span> <span class="n">cart_item</span><span class="p">.</span><span class="nf">product</span><span class="p">.</span><span class="nf">price</span>
<span class="o">+</span>      <span class="k">end</span>
<span class="o">+</span>    <span class="k">end</span>
<span class="o">+</span>    <span class="n">sum</span>
<span class="o">+</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</figure>

<p><br></p>
<h3>Step 3. （如何做的更好）Refactor 到 Model 去</h3>
<p>但是算总价，其实不该是 Helper 的任务，而是 model 的任务，所以我们还可以进行下一次的重构</p>

<p>修改 <code>app/helpers/carts_helper.rb</code></p>

<figure class="figure-code code"><figcaption><span>app/helpers/carts_helper.rb 
</span></figcaption><div class="highlight"><pre><span class="k">module</span> <span class="nn">CartsHelper</span>
  <span class="k">def</span> <span class="nf">render_cart_total_price</span><span class="p">(</span><span class="n">cart</span><span class="p">)</span>
<span class="o">-</span>    <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span>
<span class="o">-</span>    <span class="n">cart</span><span class="p">.</span><span class="nf">cart_items</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">cart_item</span><span class="o">|</span>
<span class="o">-</span>      <span class="k">if</span> <span class="n">cart_item</span><span class="p">.</span><span class="nf">product</span><span class="p">.</span><span class="nf">price</span><span class="p">.</span><span class="nf">present?</span>
<span class="o">-</span>        <span class="n">sum</span> <span class="o">+=</span> <span class="n">cart_item</span><span class="p">.</span><span class="nf">quantity</span> <span class="o">*</span> <span class="n">cart_item</span><span class="p">.</span><span class="nf">product</span><span class="p">.</span><span class="nf">price</span>
<span class="o">-</span>      <span class="k">end</span>
<span class="o">-</span>    <span class="k">end</span>
<span class="o">-</span>    <span class="n">sum</span>
<span class="o">+</span>    <span class="n">cart</span><span class="p">.</span><span class="nf">total_price</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</figure>

<p>修改 <code>app/model/cart.rb</code></p>

<figure class="figure-code code"><figcaption><span>app/models/cart.rb 
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">Cart</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>

  <span class="c1"># ... 略
</span>
  
<span class="o">+</span>  <span class="k">def</span> <span class="nf">total_price</span>
<span class="o">+</span>    <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span>
<span class="o">+</span>    <span class="n">cart_items</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">cart_item</span><span class="o">|</span>
<span class="o">+</span>      <span class="k">if</span> <span class="n">cart_item</span><span class="p">.</span><span class="nf">product</span><span class="p">.</span><span class="nf">price</span><span class="p">.</span><span class="nf">present?</span>
<span class="o">+</span>        <span class="n">sum</span> <span class="o">+=</span> <span class="n">cart_item</span><span class="p">.</span><span class="nf">quantity</span> <span class="o">*</span> <span class="n">cart_item</span><span class="p">.</span><span class="nf">product</span><span class="p">.</span><span class="nf">price</span>
<span class="o">+</span>      <span class="k">end</span>
<span class="o">+</span>    <span class="k">end</span>
<span class="o">+</span>    <span class="n">sum</span>
<span class="o">+</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</figure>

<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "implement cart_total_price function"
</pre></div>
</figure>
<h2>效果动图</h2>
<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/cjaUQgcRTgqTs8wuda5p_jdstore-posts:224.gif" title=""></figure></p>

    </div>
  </div></div><div class='frame'><h1>
      5-7 购物车练习作业
    </h1><h4>所属章节：5-购物车实做</h4><hr><div class="post group">
    <div class="post-content markdown">
      <ul>
<li>请设计一个功能，可以一键清空购物车内所有的物品</li>
<li>某样东西突然不想买了，我可以在购物车内删除它</li>
<li>已经加入购物车的物品，不能重复被加入</li>
<li>可以更改购物车内购买的数量( 原本预设数量都是1）</li>
<li>库存为 0 的货品不能购买</li>
<li>在购物车新增数量时，不能更新超过原有库存的数量</li>
</ul>

    </div>
  </div></div><div class='frame'><h1>
      5-8 本章学习以及复盘指南
    </h1><h4>所属章节：5-购物车实做</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>本周因为难度突然间增加很高，所以我设计了一个帮助各位学习的小技巧，协助各位学习这一章。</p>

<p>1) 先按照教程贴 code，确保你的代码是能动的。<br>
2) 请各位打开你的素描本。重新观看每一章指南，并且挑出你不懂的关键字，写在素描本上。<br>
3) 写上去后不要马上查，立刻翻到下一章，继续写。看到不懂的关键词都写下来。</p>

<p>（如此图，在这一章正常数量会超过 10 个以上）</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/iKesmH0BRQijVfNSrw3q_iPhone%20image%20on%202017-02-03%20at%2022-29-56.jpeg" title=""></figure></p>

<p>4) OK 打开 google 开始查每一个词，并写一篇 logdown。</p>

<p>这个方法是为了克服各位大脑工作记忆区不足的技巧。<br>
当你全部写一遍下来后，会神奇的心都不慌了。</p>

<p>接着你可以开始一个一个字慢慢查了。</p>

<p>等到查完之后，回去重看代码后，你会发现原先像外星文般的代码竟然渐渐都理解了。</p>

    </div>
  </div></div><div class='frame'><h1>
      6-1 购物车练习作业 （解答）
    </h1><h4>所属章节：6-购物车实做（解答）</h4><hr><div class="post group">
    <div class="post-content markdown">
      <h3>目标</h3>
<ul>
<li>请设计一个功能，可以一键清空购物车内所有的商品</li>
<li>某商品突然不想买了，我可以在购物车内删除它</li>
<li>已经加入购物车的商品，不能重复被加入</li>
<li>可以更改购物车内购买的商品数量(原本预设数量都是1)</li>
<li>库存为 0 的商品不能购买</li>
<li>在购物车新增数量时，不能更新超过原有库存的商品数量</li>
</ul>

<p><br></p>
<h3>步骤</h3>
<h4>Step 1: 清空购物车</h4>
<figure class="figure-code code"><figcaption><span>config/routes.rb 
</span></figcaption><div class="highlight"><pre><span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
 <span class="o">-</span> <span class="n">resources</span> <span class="ss">:carts</span>
 <span class="o">+</span> <span class="n">resources</span> <span class="ss">:carts</span> <span class="k">do</span>
 <span class="o">+</span>   <span class="n">collection</span> <span class="k">do</span>
 <span class="o">+</span>     <span class="n">delete</span> <span class="ss">:clean</span>
 <span class="o">+</span>   <span class="k">end</span>
 <span class="o">+</span> <span class="k">end</span>
</pre></div>
</figure>

<figure class="figure-code code"><figcaption><span>app/views/carts/index.html.erb 
</span></figcaption><div class="highlight"><pre>...(略)
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-12"</span><span class="nt">&gt;</span>

+  <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">"清空购物车"</span><span class="p">,</span> <span class="n">clean_carts_path</span> <span class="p">,</span>
<span class="o">+</span>              <span class="ss">method: :delete</span> <span class="p">,</span> <span class="ss">class: </span><span class="s2">"pull-right"</span><span class="p">,</span>
<span class="o">+</span>              <span class="ss">style: </span><span class="s2">"text-decoration: underline;"</span><span class="p">,</span>
<span class="o">+</span>              <span class="ss">data: </span><span class="p">{</span> <span class="ss">confirm: </span><span class="s2">"你确定要清空整个购物车吗？"</span><span class="p">}</span> <span class="p">)</span><span class="cp">%&gt;</span>

    <span class="nt">&lt;h2&gt;</span> 购物车 <span class="nt">&lt;/h2&gt;</span>

    <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">"table table-bordered"</span><span class="nt">&gt;</span>
...(略)
</pre></div>
</figure>

<figure class="figure-code code"><figcaption><span>app/controllers/carts_controller.rb 
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">CartsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
<span class="o">+</span> <span class="k">def</span> <span class="nf">clean</span>
<span class="o">+</span>   <span class="n">current_cart</span><span class="p">.</span><span class="nf">clean!</span>
<span class="o">+</span>   <span class="n">flash</span><span class="p">[</span><span class="ss">:warning</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"已清空购物车"</span>
<span class="o">+</span>   <span class="n">redirect_to</span> <span class="n">carts_path</span>
<span class="o">+</span> <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</figure>

<figure class="figure-code code"><figcaption><span>app/models/cart.rb 
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">Cart</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
<span class="o">+</span> <span class="k">def</span> <span class="nf">clean!</span>
<span class="o">+</span>   <span class="n">cart_items</span><span class="p">.</span><span class="nf">destroy_all</span>
<span class="o">+</span> <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</figure>

<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "empty cart"
</pre></div>
</figure>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/tWM3uRNEQRKSuzqll9F6_jdstore-posts:226-step1.gif" title=""></figure><br>
<br></p>
<h4>Step 2: 删除购物车内某一商品</h4>
<p><code>rails g controller cart_items</code></p>

<figure class="figure-code code"><figcaption><span>config/routes.rb
</span></figcaption><div class="highlight"><pre><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
<span class="o">+</span> <span class="n">resources</span> <span class="ss">:cart_items</span>
<span class="k">end</span>
</pre></div>
</figure>

<figure class="figure-code code"><figcaption><span>app/views/carts/index.html.erb 
</span></figcaption><div class="highlight"><pre><span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
        <span class="o">&lt;</span><span class="n">tr</span><span class="o">&gt;</span>
          <span class="o">&lt;</span><span class="n">th</span> <span class="n">colspan</span><span class="o">=</span><span class="s2">"2"</span><span class="o">&gt;</span><span class="err">商品资讯</span><span class="o">&lt;</span><span class="sr">/th&gt;
          &lt;th&gt;单价&lt;/</span><span class="n">th</span><span class="o">&gt;</span>
          <span class="o">&lt;</span><span class="n">th</span><span class="o">&gt;</span><span class="err">数量</span><span class="o">&lt;</span><span class="sr">/th&gt;
+         &lt;th&gt;操作选项 &lt;/</span><span class="n">th</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="sr">/tr&gt;
      &lt;/</span><span class="n">thead</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">tbody</span><span class="o">&gt;</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
            <span class="o">&lt;</span><span class="n">td</span><span class="o">&gt;</span>
              <span class="o">&lt;</span><span class="sx">%= cart_item.quantity %&gt;
            &lt;/td&gt;
+           &lt;td&gt;
+             &lt;%=</span> <span class="n">link_to</span> <span class="n">cart_item_path</span><span class="p">(</span><span class="n">cart_item</span><span class="p">.</span><span class="nf">product_id</span><span class="p">),</span> <span class="ss">method: :delete</span> <span class="k">do</span> <span class="sx">%&gt;
+               &lt;i class="fa fa-trash"&gt;</span><span class="o">&lt;</span><span class="sr">/i&gt;
+             &lt;% end %&gt;
+           &lt;/</span><span class="n">td</span><span class="o">&gt;</span>
          <span class="o">&lt;</span><span class="sr">/tr&gt;
        &lt;% end %&gt;
...(略)
</span></pre></div>
</figure>

<figure class="figure-code code"><figcaption><span>app/controllers/cart_items_controller.rb 
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">CartItemsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
<span class="o">+</span>  <span class="n">before_action</span> <span class="ss">:authenticate_user!</span>

<span class="o">+</span>  <span class="k">def</span> <span class="nf">destroy</span>
<span class="o">+</span>    <span class="vi">@cart</span> <span class="o">=</span> <span class="n">current_cart</span>
<span class="o">+</span>    <span class="vi">@cart_item</span> <span class="o">=</span> <span class="vi">@cart</span><span class="p">.</span><span class="nf">cart_items</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">product_id: </span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
<span class="o">+</span>    <span class="vi">@product</span> <span class="o">=</span> <span class="vi">@cart_item</span><span class="p">.</span><span class="nf">product</span>
<span class="o">+</span>    <span class="vi">@cart_item</span><span class="p">.</span><span class="nf">destroy</span>

<span class="o">+</span>    <span class="n">flash</span><span class="p">[</span><span class="ss">:warning</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"成功将 </span><span class="si">#{</span><span class="vi">@product</span><span class="p">.</span><span class="nf">title</span><span class="si">}</span><span class="s2"> 从购物车删除!"</span>
<span class="o">+</span>    <span class="n">redirect_to</span> <span class="ss">:back</span>
<span class="o">+</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</figure>

<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "delete an item from cart"
</pre></div>
</figure>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/k7hcKTFMQoeqBwqSjUQr_jdstore-posts:226-step2.gif" title=""></figure></p>

<p><br></p>
<h4>Step 3: 已经加入购物车的商品，不能重复被加入</h4>
<figure class="figure-code code"><figcaption><span>app/controllers/products_contoller.rb 
</span></figcaption><div class="highlight"><pre><span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@product</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">add_to_cart</span>
    <span class="vi">@product</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
<span class="o">+</span>   <span class="k">if</span> <span class="o">!</span><span class="n">current_cart</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="vi">@product</span><span class="p">)</span>
      <span class="n">current_cart</span><span class="p">.</span><span class="nf">add_product_to_cart</span><span class="p">(</span><span class="vi">@product</span><span class="p">)</span>
<span class="o">-</span>     <span class="n">flash</span><span class="p">[</span><span class="ss">:notice</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"成功加入购物车"</span>
<span class="o">+</span>     <span class="n">flash</span><span class="p">[</span><span class="ss">:notice</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"你已成功将 </span><span class="si">#{</span><span class="vi">@product</span><span class="p">.</span><span class="nf">title</span><span class="si">}</span><span class="s2"> 加入购物车"</span>
<span class="o">+</span>   <span class="k">else</span>
<span class="o">+</span>     <span class="n">flash</span><span class="p">[</span><span class="ss">:warning</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"你的购物车内已有此物品"</span>
<span class="o">+</span>   <span class="k">end</span>
    <span class="n">redirect_to</span> <span class="ss">:back</span>
  <span class="k">end</span>
 <span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
</pre></div>
</figure>

<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "cannot add same item in cart"
</pre></div>
</figure>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/bgOmZCNwS0SMImh2uKNF_jdstore-posts:226-step3.gif" title=""></figure></p>

<p><br></p>
<h4>Step 4: 可以更改购物车内购买的商品数量（原本预设数量都是1）</h4>
<figure class="figure-code code"><figcaption><span>app/views/carts/index.html.erb
</span></figcaption><div class="highlight"><pre><span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
        <span class="o">&lt;</span><span class="n">td</span><span class="o">&gt;</span>
          <span class="o">&lt;</span><span class="sx">%= cart_item.product.price %&gt;
        &lt;/td&gt;
        &lt;td&gt;
-         &lt;%=</span> <span class="n">cart_item</span><span class="p">.</span><span class="nf">quantity</span> <span class="sx">%&gt;
+         &lt;%= form_for cart_item, url: cart_item_path(cart_item.product_id) do |f| %&gt;</span>
<span class="o">+</span>           <span class="o">&lt;</span><span class="sx">%= f.select :quantity, [1,2,3,4,5] %&gt;
+           &lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">submit</span> <span class="s2">"更新"</span><span class="p">,</span> <span class="ss">data: </span><span class="p">{</span> <span class="ss">disable_with: </span><span class="s2">"Submiting..."</span> <span class="p">}</span> <span class="o">%&gt;</span>
<span class="o">+</span>         <span class="o">&lt;</span><span class="sx">% end </span><span class="o">%&gt;</span>
        <span class="o">&lt;</span><span class="sr">/td&gt;
...(略)
</span></pre></div>
</figure>

<figure class="figure-code code"><figcaption><span>app/controllers/cart_items_controller.rb
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">CartItemsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
<span class="o">+</span>  <span class="k">def</span> <span class="nf">update</span>
<span class="o">+</span>    <span class="vi">@cart</span> <span class="o">=</span> <span class="n">current_cart</span>
<span class="o">+</span>    <span class="vi">@cart_item</span> <span class="o">=</span> <span class="vi">@cart</span><span class="p">.</span><span class="nf">cart_items</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">product_id: </span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
<span class="o">+</span>    <span class="vi">@cart_item</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">cart_item_params</span><span class="p">)</span>

<span class="o">+</span>    <span class="n">redirect_to</span> <span class="n">carts_path</span>
<span class="o">+</span>  <span class="k">end</span>

<span class="o">+</span>  <span class="kp">private</span>

<span class="o">+</span>  <span class="k">def</span> <span class="nf">cart_item_params</span>
<span class="o">+</span>    <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:cart_item</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:quantity</span><span class="p">)</span>
<span class="o">+</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</figure>

<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "change quantity in cart"
</pre></div>
</figure>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/FosOUFeAQFyAVFIGbka6_jdstore-posts:226-step4.gif" title=""></figure></p>

<p><br></p>
<h4>Step 5: 库存为 0 的商品不能购买</h4>
<ul>
<li>在 View 里面不可以加入购物车</li>
<li>在 Controller 里面不可以加入购物车</li>
</ul>

<p>view 的设定</p>

<figure class="figure-code code"><figcaption><span>app/views/products/show.html.erb 
</span></figcaption><div class="highlight"><pre><span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
    <span class="o">&lt;</span><span class="n">div</span> <span class="k">class</span><span class="o">=</span><span class="s2">"product-price"</span><span class="o">&gt;</span> <span class="err">¥</span> <span class="o">&lt;</span><span class="sx">%= @product.price %&gt; &lt;/div&gt;

    &lt;div class=</span><span class="s2">"pull-right"</span><span class="o">&gt;</span>
<span class="o">+</span>     <span class="o">&lt;</span><span class="sx">% if </span><span class="vi">@product</span><span class="p">.</span><span class="nf">quantity</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">%&gt;</span>
        <span class="o">&lt;</span><span class="sx">%= link_to("加入购物车", add_to_cart_product_path(@product), method: :post,
                    class: "btn btn-lg btn-danger") %&gt;
+     &lt;% else %&gt;
+       已销售一空，无法购买
+     &lt;% end %&gt;
    &lt;/div&gt;
...(略)
</span></pre></div>
</figure>

<p>结果：点入商品页面时，库存为0的商品，加入购物车按钮不显示 </p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/veOrBp7MTiKs96LfQ9O7_%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-07%2016.40.28.png" title=""></figure></p>

<p>controller 的设定</p>

<figure class="figure-code code"><figcaption><span>app/controllers/cart_items_controller.rb 
</span></figcaption><div class="highlight"><pre><span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">update</span>
    <span class="vi">@cart</span> <span class="o">=</span> <span class="n">current_cart</span>
    <span class="vi">@cart_item</span> <span class="o">=</span> <span class="vi">@cart</span><span class="p">.</span><span class="nf">cart_items</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">product_id: </span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>

<span class="o">+</span>   <span class="k">if</span> <span class="vi">@cart_item</span><span class="p">.</span><span class="nf">product</span><span class="p">.</span><span class="nf">quantity</span> <span class="o">&gt;=</span> <span class="n">cart_item_params</span><span class="p">[</span><span class="ss">:quantity</span><span class="p">].</span><span class="nf">to_i</span>
      <span class="vi">@cart_item</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">cart_item_params</span><span class="p">)</span>
<span class="o">+</span>     <span class="n">flash</span><span class="p">[</span><span class="ss">:notice</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"成功变更数量"</span>
<span class="o">+</span>   <span class="k">else</span>
<span class="o">+</span>     <span class="n">flash</span><span class="p">[</span><span class="ss">:warning</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"数量不足以加入购物车"</span>
<span class="o">+</span>   <span class="k">end</span>

    <span class="n">redirect_to</span> <span class="n">carts_path</span>
  <span class="k">end</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
</pre></div>
</figure>

<p>结果：尝试将购物车内的商品数量，更新为大于库存的数量(or库存&lt;=0)，将会导致无法操作并弹出警示 <br>
<figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ZiwXZXCqR9uyvhS0RNhn_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-09-20%20%E4%B8%8A%E5%8D%8811.26.43.png" title=""></figure></p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/l0nNCkAtSd6uYuKOfhau_jdstore-posts:226-step5.gif" title=""></figure></p>

<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "cannot add item with quantity 0"
</pre></div>
</figure>

<p><br></p>
<h4>Step 6: 在购物车新增数量时，不能更新超过原有库存的数量</h4>
<figure class="figure-code code"><figcaption><span>app/views/carts/index.html.erb 
</span></figcaption><div class="highlight"><pre><span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
            <span class="o">&lt;</span><span class="n">td</span><span class="o">&gt;</span>
              <span class="o">&lt;</span><span class="sx">% cart_item </span><span class="o">=</span> <span class="n">current_cart</span><span class="p">.</span><span class="nf">cart_items</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">product_id: </span><span class="n">cart_item</span><span class="p">.</span><span class="nf">product_id</span><span class="p">)</span> <span class="o">%&gt;</span>

              <span class="o">&lt;</span><span class="sx">%= form_for cart_item, url: cart_item_path(cart_item.product_id) do |f| %&gt;
-               &lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">select</span> <span class="ss">:quantity</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span> <span class="o">%&gt;</span>
<span class="o">+</span>               <span class="o">&lt;</span><span class="sx">%= f.select :quantity, 1..cart_item.product.quantity %&gt;
                &lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">submit</span> <span class="s2">"更新"</span><span class="p">,</span> <span class="ss">data: </span><span class="p">{</span> <span class="ss">disable_with: </span><span class="s2">"Submiting..."</span> <span class="p">}</span> <span class="o">%&gt;</span>
              <span class="o">&lt;</span><span class="sx">% end </span><span class="o">%&gt;</span>
            <span class="o">&lt;</span><span class="sr">/td&gt;
            &lt;td&gt;
...(略)
</span></pre></div>
</figure>

<p>结果：库存为10，最多仅能更改数量为10 <br>
<figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Nvb9rDA0TwSoh9hSUgGx_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-09-20%20%E4%B8%8A%E5%8D%8811.31.08.png" title=""></figure></p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/wEC7TXi76S86an0HDwWV_jdstore-posts:226-step6.gif" title=""></figure></p>

<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "cannot change quantity which exceed stock"
</pre></div>
</figure>

    </div>
  </div></div><div class='frame'><h1>
      7-1 组队诀窍
    </h1><h4>所属章节：7-如何组队共同成长</h4><hr><div class="post group">
    <div class="post-content markdown">
      <h2>目标</h2>
<ul>
<li>找到协作队友，共同成长一起参加后续的商店创意大赛</li>
<li>锻炼协作能力，成为靠谱的开发者</li>
</ul>
<h3>找什么样的队友</h3>
<p>同城尤佳，找属性互补的，你才可以学到最多东西。</p>

<p>一个擅长编程，一个擅长美术、运营或策划，这样的组合更有可能会赢。</p>
<h3>如何同城组队</h3>
<p>最高效的方法就是参加 Meetup，现场组队。</p>

<p>到商店创意大赛时，组间还可以互换资源，用技术「投资股份」。</p>
<h3>如何远程组队</h3>
<p>到Slack #teamup 频道发表招募信息，请务必按照以下格式撰写信息</p>

<blockquote>
<p>我是 xdite，家住北京朝阳，一个礼拜有三天晚上可以编程，周末一天可以参加面对面组队。擅长：编程推进、文案写作。征求美术、运营、前端擅长者（三选二）同学一起组队。意者 slack 私聊。</p>
</blockquote>
<h3>如何分配任务</h3>
<p>先自己写下 Must Have / Should Have / Could Have / Nice to Have</p>

<p>聚会碰面时列出任务的优先顺序</p>

<p>使用 <a href="https://fullstack.xinshengdaxue.com/posts/694">Github Project</a> 管理待办事项</p>

<p>使用<a href="https://fullstack.xinshengdaxue.com/courses/32/syllabus">「黑客松」</a>技巧，管理精力、预期、产出</p>
<h3>如何组队编程</h3>
<p>首先确定一位主程，负责写程序主干，解决代码冲突</p>

<p>辅攻负责写css或文案</p>

<p>先写完「指定作业」，再研究酷炫技能（一个功能不要写超过两天）</p>

<p><a href="https://fullstack.xinshengdaxue.com/posts/717">github协作指南</a></p>
<h3>如何推进项目</h3>
<p>Standup Meeting</p>

<p>每天早上的站会，每个人花 5 分钟讲述以下三部分内容，远程组队可以语音私聊</p>

<blockquote>
<ul>
<li>昨天我做了什么</li>
<li>今天我接续要做什么</li>
<li>昨天遇到的困难点，希望队友帮忙解决</li>
</ul>
</blockquote>

    </div>
  </div></div><div class='frame'><h1>
      7-2 Github协作指南
    </h1><h4>所属章节：7-如何组队共同成长</h4><hr><div class="post group">
    <div class="post-content markdown">
      <h2>目标</h2>
<p>使用Github进行代码协作</p>
<h2>注意</h2>
<p>本篇指南区分为，「主程篇」、「副程篇」以及「共同遵守篇」，除了共同遵守篇一定需要阅读，请针对自己在团队里的角色进行阅读就可以了，避免过多的资讯导致掉坑</p>
<h2>主程篇</h2>
<h3>Step 0: 找到你的队友</h3>
<p>两人一队，确定一位主程。</p>

<p>由于我们目标是两人一队，主程必须要能负责整个购物网站专案的代码管理<br>
除了负责 merge pull request，也需要能够解决与副程所产生的代码冲突问题。</p>

<p><a href="https://fullstack.xinshengdaxue.com/posts/716">组队诀窍</a></p>
<h3>Step 1: 主程邀请你的队友</h3>
<p>打开要进行协作的repo，点击 <code>Settings</code> -&gt; <code>Collaborators</code></p>

<p>在页面中间的搜索框中输入队友github的username，如果找到，框下面会跳出队友头像，点击头像，然后点击 <code>Add collaborator</code>，这样就邀请成功啦。</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/KxRSUTl6RW2b8a1x3Hd5_%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-13%2020.54.57.png" title=""></figure></p>
<h3>Step 2: 协作之前，将最新分支merge到master</h3>
<p>如果master分支的更新时间不是最近，那么你需要做这一步</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/CiIb3zKdTiOfP8etXfKX_Screen%20Shot%202017-02-21%20at%2015.44.46.png" title=""></figure></p>

<p>比如你的最新分支是story5，那么在终端 <code>git checkout master</code>，然后 <code>git merge story5</code>，再推到github <code>git push origin master</code></p>
<h3>Step 3: 主程 merge 来自副程或自己的 pull request</h3>
<p>点击 <code>Pull requests</code> 可以看到所有 pull requests 记录</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/nv83BTBS0KxmNrVMYqXu_%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-13%2022.20.31.png" title=""></figure></p>

<p>点开 pull request</p>

<p>如果显示 <code>This branch has no conflicts with the base branch</code>，这种情况可以直接merge，点击 <code>Merge pull request</code>，然后 <code>Confirm merge</code> 就可以了</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/YHsNZ0rkQJ2DCAMaoWA5_%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-13%2022.29.10.png" title=""></figure></p>

<p>merge完成</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/I5XYs9V4TsKDGWTkoBv2_%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-13%2022.33.28.png" title=""></figure></p>

<p>那么，什么情况不能直接merge呢？</p>

<p>显示 <code>This branch has conflicts that must be resolved</code>，这时 <code>Merge pull request</code> 按钮呈灰色，无法点击，必须先解决代码冲突才能继续。</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/TOgZ8fViQDGimdGbMtcC_%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-14%2011.26.31.png" title=""></figure></p>
<h3>Step 4: 解决冲突</h3>
<p>如何解决冲突？</p>

<p>你可以选择不处理这个pull request，在本地修改后再上传一个新的pull request</p>

<p>或者按照github给出的指令处理冲突</p>

<p>点击 <code>Resolve conflicts</code>，左边显示出代码有冲突的所有文件，打开其中一个文件</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/fIeRBukJQoeagROsqrcZ_%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-14%2011.37.20.png" title=""></figure></p>

<p>可以看到，<code>&lt;&lt;&lt;&lt;&lt;&lt;&lt;</code> 和 <code>&gt;&gt;&gt;&gt;&gt;&gt;&gt; master</code> 把代码有冲突的部分包了起来</p>

<p><code>=======</code> 又把这部分分成了上下两半</p>

<p>上半部分是当前pull request中这个文件的写法</p>

<p>下半部分是当前master分支上这个文件的写法</p>

<p>接下来把多出的三行符号删掉，保留你需要的代码</p>

<p>比如</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/e9hcNSWUSiGGYh4HT5D3_%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-14%2011.53.37.png" title=""></figure></p>

<p>然后点击 <code>Mark as resolved</code></p>

<p>冲突全部解决之后，会显示 <code>Resolved all conflicts</code>，点击 <code>Commit changes</code></p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/KhfsT9ENSWuEZYlKHHMP_%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-14%2011.56.30.png" title=""></figure></p>

<p>之后会跳转回当前pull request地址，显示 <code>This branch has no conflicts with the base branch</code>，点击 <code>Merge pull request</code>，然后 <code>Confirm merge</code> 就可以了</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/v0qwJIQbQfeBNnynHyku_%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-14%2012.04.17.png" title=""></figure></p>
<h3>Step 5: 在本地获取 merge 后最新的代码</h3>
<p>当最新的代码已经合进 master 分支里，主程只需要在本地的终端checkout回master分支，然后运行git fetch</p>

<p>那么主程就能够得到最新的代码了</p>
<h2>副程篇</h2>
<h3>Step 1: 接受主程邀请，成为协作者</h3>
<p>副程所使用的github注册邮箱会收到一封邀请邮件</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/UJLRG8FTSBake7cgYR3j_Screenshot%20at%20Feb%2013%2020-58-53.png" title=""></figure></p>

<p>点击 <code>View invitation</code> 后，跳转到github页面</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ObEv8dDQGWklU17ZYWt9_Screenshot%20at%20Feb%2013%2020-59-19.png" title=""></figure></p>

<p>点击 <code>Accept invitation</code>，会跳转到协作repo，同时收到一封确认邮件</p>

<p>协作repo如图：<br>
<figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/yomQZoMfR1y2gWLxDuoQ_Screenshot%20at%20Feb%2013%2021-00-19.png" title=""></figure></p>

<p>确认邮件如图：<br>
<figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/A4XP1U67QK2guBmEzbeh_Screenshot%20at%20Feb%2013%2021-01-04.png" title=""></figure></p>
<h3>Step 2: clone 主程的代码一起共同开发</h3>
<p>第一次把代码下载到本地，使用 <code>git clone 主程的repo地址</code></p>

<p>在终端运行 <code>cd xxx（专案名）</code></p>

<p><code>cp config/database.yml.example config/database.yml</code></p>

<p><code>bundle install</code>  </p>

<p><code>rake db:migrate</code></p>

<p>再打开rails s，才能在本地跑起来</p>

<p>如果有先写好的seed档案，也别忘记对数据库初始化，运行 <code>rake db:seed</code> 就可以了</p>

<p>这里请直接 clone 主程的专案到本机进行开发，自己的专案不需要在管。</p>

<p>可以在你 clone 下来的专案输入 <code>git remote -v</code>，检查当中的网址是否为主程的 github 帐号，如果不是，请注意你会无法发送开发功能给主程，请在此刻修正。</p>
<h3>Step 3: 发送 Pull Requset 给主程吧</h3>
<p>在本地终端切出一只分支，尝试修改某个文字之后进行 commit 存档，然后 push 这只分支到 github 吧！</p>

<p>接下来我们就能够发 pull request 给主程啰</p>

<p>点击「New pull request」，会转成以下画面。把base fork点选主程的repo（通常是第二笔）</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/bsYhwQXgReaLIb3EkrQu_Screenshot%20at%20Mar%2007%2018-24-35.png" title=""></figure></p>

<p>可以看到页面跳转成如下。</p>

<p>① 确认已经转到主程的repo；<br>
② base选择你想要merge的分支，可以选择「master」（一般正式协作会另外创建一个develop分支，把开发的进度放到develop，master一般于production环境）；<br>
③ compare选择副程的分支名；<br>
④ 查看是否是「Able to merge」状态；<br>
⑤ 写下你的comment。<br>
确认以上五点后，点击「Create pull request」</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/vMd2FdH7RKOslvGhqzuy_Screenshot%20at%20Mar%2007%2018-27-05.png" title=""></figure></p>

<p>点击「Merge pull request」</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/BFqxQ21DRLi9EvuSmIM2_Screenshot%20at%20Mar%2007%2018-28-03.png" title=""></figure></p>

<p>你就完成提交了功能开发的分支给主程啰，你的任务就是</p>

<p>「本地切分支开发功能」 -&gt; 「开发完后 push 当前分支」 -&gt; 「上 Github 开 pull request 给主程」</p>
<h2>共同遵守篇（主程 + 副程都得这么做）</h2>
<h3>Step 1: 获取最新代码</h3>
<p>每天于开发前执行 <code>git fetch origin</code>，获取当前所有分支的讯息</p>

<p>获取最新代码时，先 <code>git checkout master</code>，然后 <code>git pull origin master</code></p>
<h3>Step 2: 开发项目</h3>
<p>现在你在master分支上，对代码进行任何改动之前，一定要切换到一个新的分支，在新分支上进行修改</p>

<p>分支命名规则 <code>git checkout -b name-feature (姓名-功能)</code></p>

<p>记住一个原则，请勿直接在 master 开发并直接推送到 github ，容易出现双方代码不对齐的情况，并且会不断发生冲突，请详记！</p>
<h3>Step 3: 上传分支</h3>
<p>上传之前，一定要在本地进行测试，确认没有bug才可以上传</p>

<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "这个分支做的功能"
git push origin name-feature
</pre></div>
</figure>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/NIgLGgxSf928gZY7X6gx_Screen%20Shot%202017-02-13%20at%2010.06.09%20PM.png" title=""></figure></p>

    </div>
  </div></div><div class='frame'><h1>
      7-3 利用 Tower 进行项目管理
    </h1><h4>所属章节：7-如何组队共同成长</h4><hr><div class="post group">
    <div class="post-content markdown">
      <h2>目标：</h2>
<p>用 Tower进行项目管理</p>
<h2>步骤：</h2>
<h3>Step1：注册tower</h3>
<p>打开网址: <a href="https://tower.im" rel="nofollow" target="_blank">https://tower.im</a> 注册<br>
<figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/B3h8yEP7TRaSYJobmXLp_Screenshot%20at%20May%2018%2021-37-36.png" title=""></figure></p>
<h3>Step2: 新建看板项目</h3>
<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/30YzhyTRQx6W8RCE2Vqa_Screenshot%20at%20May%2018%2021-39-53.png" title=""></figure></p>
<h3>Step3: 定义项目流程，最基本可以设计成 Todo -&gt; Developing -&gt; Done</h3>
<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/NgbqUly1QeK2aOyggZCw_Screenshot%20at%20May%2018%2021-41-15.png" title=""></figure></p>
<h3>Step4: 每个 User Story 开始实作时，进一步描述任务细节</h3>
<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/hRdttW2VTK6DeYGJa4oH_Screenshot%20at%20May%2018%2021-42-43.png" title=""></figure></p>

    </div>
  </div></div><div class='frame'><h1>
      [直播回放]5月11日 xdite教你如何科学准备商店创意大赛
    </h1><h4>所属章节：7-如何组队共同成长</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>主讲人：<br>
xdite老师</p>

<p>时间：<br>
5月11日 20:00</p>

<p>时长：<br>
主讲时长约37分钟</p>

<p>概要：<br>
xdite教你如何科学准备商店创意大赛</p>

<p>提示：<br>
需要科学上网才可以正常观看本视频<br>
如果画面模糊请到右下角设置中将画质调整为720p<br>
<br></p>

    </div>
      <script src="//fast.wistia.com/embed/medias/e26v4djs9i.jsonp" async></script>
<script src="//fast.wistia.com/assets/external/E-v1.js" async></script>
<div class="player-bg">
    <div class="loading-tips">
        <button class="btn btn-default btn-lg">
            <i class="fa fa-spinner fa-spin"></i>
        </button>
        <p>视频文件正在加载，请确保已经打开VPN</p>
    </div>
    <div class="wistia_responsive_padding" style="padding:56.25% 0 0 0;position:relative;">
        <div class="wistia_responsive_wrapper" style="height:100%;left:0;position:absolute;top:0;width:100%;">
            <div class="wistia_embed wistia_async_e26v4djs9i videoFoam=true" style="height:100%;width:100%"> </div>
            <script>
                window._wq = window._wq || [];
                _wq.push({ id: "e26v4djs9i", onReady: function(video) {
                    window.wistia_video = video;
                        window.wistia_video.time("1045.557967");
                    var url = "/user_wistia_position_records/update_position";
                    var post_id = "1202"; 
                    setInterval(function(){                        
                        if (wistia_video.state() === "playing") {
                            var data = {
                                position: wistia_video.time(),
                                post_id: post_id 
                            };                            
                            $.post(url, data);
                        }                        
                    }, 5000);
                }});
            </script>            
        </div>
    </div>
</div>

  </div></div><div class='frame'><h1>
      [直播回放]5月15日 周一 Nic 商店开发实战技巧
    </h1><h4>所属章节：7-如何组队共同成长</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>时间：<br>
5月15日 周一 20:00</p>

<p>时长：<br>
本次直播总时长52分钟。</p>

<p>概要：<br>
Nic 老师在这次直播会教你用神器 Debug ，同时也会讲解购物车相关的设计内容，让你透过这次直播能够更明白这些开发技巧及细节</p>

<ul>
<li>  Debug 神器使用方式</li>
<li>  购物车基本设计说明</li>
<li>  常用语法说明</li>
<li>排序功能 acts_as_list</li>
</ul>

<p>提示：<br>
需要科学上网才可以正常观看本视频<br>
如果画面模糊请到右下角设置中将画质调整为720p<br>
<br></p>

    </div>
      <script src="//fast.wistia.com/embed/medias/dapga3eh9s.jsonp" async></script>
<script src="//fast.wistia.com/assets/external/E-v1.js" async></script>
<div class="player-bg">
    <div class="loading-tips">
        <button class="btn btn-default btn-lg">
            <i class="fa fa-spinner fa-spin"></i>
        </button>
        <p>视频文件正在加载，请确保已经打开VPN</p>
    </div>
    <div class="wistia_responsive_padding" style="padding:56.25% 0 0 0;position:relative;">
        <div class="wistia_responsive_wrapper" style="height:100%;left:0;position:absolute;top:0;width:100%;">
            <div class="wistia_embed wistia_async_dapga3eh9s videoFoam=true" style="height:100%;width:100%"> </div>
            <script>
                window._wq = window._wq || [];
                _wq.push({ id: "dapga3eh9s", onReady: function(video) {
                    window.wistia_video = video;
                        window.wistia_video.time("1217.242793");
                    var url = "/user_wistia_position_records/update_position";
                    var post_id = "1203"; 
                    setInterval(function(){                        
                        if (wistia_video.state() === "playing") {
                            var data = {
                                position: wistia_video.time(),
                                post_id: post_id 
                            };                            
                            $.post(url, data);
                        }                        
                    }, 5000);
                }});
            </script>            
        </div>
    </div>
</div>

  </div></div><div class='frame'><h1>
      [直播回放]5月18日 ihower 老师直播
    </h1><h4>所属章节：7-如何组队共同成长</h4><hr><div class="post group">
    <div class="post-content markdown">
      <h2>ihower 老师教你如何使用 User Story,Tower 和 Github 进行协作开发</h2>
<p>主讲人：<br>
Ihower 老师</p>

<p>时间：<br>
5月18日 周四 20:00</p>

<p>时长：<br>
本次直播总时长57分钟。</p>

<p>概要：<br>
ihower 教你如何使用 User Story,Tower 和 Github 进行协作开发</p>

<p>提示：<br>
需要科学上网才可以正常观看本视频<br>
如果画面模糊请到右下角设置中将画质调整为720p<br>
<br></p>

<p><strong>备注：下方有该直播的 pdf 简报可以下载查看</strong></p>

    </div>
      <script src="//fast.wistia.com/embed/medias/qpbtkl0lre.jsonp" async></script>
<script src="//fast.wistia.com/assets/external/E-v1.js" async></script>
<div class="player-bg">
    <div class="loading-tips">
        <button class="btn btn-default btn-lg">
            <i class="fa fa-spinner fa-spin"></i>
        </button>
        <p>视频文件正在加载，请确保已经打开VPN</p>
    </div>
    <div class="wistia_responsive_padding" style="padding:56.25% 0 0 0;position:relative;">
        <div class="wistia_responsive_wrapper" style="height:100%;left:0;position:absolute;top:0;width:100%;">
            <div class="wistia_embed wistia_async_qpbtkl0lre videoFoam=true" style="height:100%;width:100%"> </div>
            <script>
                window._wq = window._wq || [];
                _wq.push({ id: "qpbtkl0lre", onReady: function(video) {
                    window.wistia_video = video;
                        window.wistia_video.time("2899.942628");
                    var url = "/user_wistia_position_records/update_position";
                    var post_id = "1236"; 
                    setInterval(function(){                        
                        if (wistia_video.state() === "playing") {
                            var data = {
                                position: wistia_video.time(),
                                post_id: post_id 
                            };                            
                            $.post(url, data);
                        }                        
                    }, 5000);
                }});
            </script>            
        </div>
    </div>
</div>

      <div class="device">
  <div class="device__screen flex">
    <img id="file" src="https://www.filepicker.io/api/file/UCEioD8TGPkWkXLNgliQ/convert?page=1" alt="" class="img-responsive">

    <div class="text-center">
      <br>
      <div class="page-info ">
        页码
        <span class="current-page">
          1
        </span>
        /
        <span class="total-pages"></span>
        <a class="underline" target="_blank" href="https://www.filepicker.io/api/file/UCEioD8TGPkWkXLNgliQ">下载简报</a>
      </div>

      <br>
      <button id="previous" class="page-nav  page-nav--left">
        <i class="fa  fa-lg  fa-chevron-left"></i>
      </button>

           
      <button id="next" class="page-nav  page-nav--right">
        <i class="fa  fa-lg  fa-chevron-right"></i>
      </button>
    </div>
  </div>
</div>


  </div></div><div class='frame'><h1>
      8-1 Step 1 : 建立结帐页
    </h1><h4>所属章节：8-订单实做</h4><hr><div class="post group">
    <div class="post-content markdown">
      <h2>目标</h2>
<p>在购物车按下「确认结帐」按钮后</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/plqFQ148RMOJAtkYNv8l_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-05%20%E4%B8%8B%E5%8D%881.50.29.png" title=""></figure></p>

<p>可以显示结帐明细，并且可以让消费者输入寄送地址</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/uKlDmXfQODGomFujGuQk_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-05%20%E4%B8%8B%E5%8D%883.51.09.png" title=""></figure></p>

<p><br></p>
<h2>步骤</h2>
<h3>Step 0 :</h3>
<p><code>git checkout -b story5</code></p>

<p><br></p>
<h3>Step 1 : 建立结帐页 routing</h3>
<p>修改 <code>app/views/carts/index.html.erb</code></p>

<figure class="figure-code code"><figcaption><span>app/views/carts/index.html.erb
</span></figcaption><div class="highlight"><pre><span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
    <span class="o">&lt;</span><span class="n">div</span> <span class="k">class</span><span class="o">=</span><span class="s2">"checkout clearfix"</span><span class="o">&gt;</span>
<span class="err">－</span>      <span class="o">&lt;</span><span class="sx">%= link_to("确认结账", "#", method: :post, class: "btn btn-lg btn-danger pull-right") %&gt;
＋      &lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">"确认结账"</span><span class="p">,</span> <span class="n">checkout_carts_path</span><span class="p">,</span> <span class="ss">method: :post</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"btn btn-lg btn-danger pull-right"</span><span class="p">)</span> <span class="o">%&gt;</span>
    <span class="o">&lt;</span><span class="sr">/div&gt;
...(略)
</span></pre></div>
</figure>

<p>修改 <code>config/routes.rb</code></p>

<figure class="figure-code code"><figcaption><span>config/routes.rb
</span></figcaption><div class="highlight"><pre><span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
  <span class="n">resources</span> <span class="ss">:carts</span> <span class="k">do</span>
    <span class="n">collection</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="ss">:clean</span>
<span class="o">+</span>      <span class="n">post</span> <span class="ss">:checkout</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
</pre></div>
</figure>

<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "add checkout routing"
</pre></div>
</figure>

<p><br></p>
<h3>Step 2 : 建立 Order model</h3>
<p>从结帐页面看，一张订单最少要有几个信息：</p>

<ul>
<li>总价 total </li>
<li>谁的订单 user_id </li>
<li>购买人姓名、地址 billing_name、billing_address </li>
<li>收件人姓名、地址 shipping_name、shipping_address 
所以
<code>rails g model order</code>
</li>
</ul>

<figure class="figure-code code"><figcaption><span>db/migrate/XXX(一堆数字)_create_orders.rb 
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">CreateOrders</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mi">5</span><span class="o">.</span><span class="mi">0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:orders</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
<span class="o">+</span>      <span class="n">t</span><span class="p">.</span><span class="nf">integer</span> <span class="ss">:total</span><span class="p">,</span> <span class="ss">default: </span><span class="mi">0</span>
<span class="o">+</span>      <span class="n">t</span><span class="p">.</span><span class="nf">integer</span> <span class="ss">:user_id</span>
<span class="o">+</span>      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:billing_name</span>
<span class="o">+</span>      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:billing_address</span>
<span class="o">+</span>      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:shipping_name</span>
<span class="o">+</span>      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:shipping_address</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</figure>

<p>然后执行</p>

<p><code>rake db:migrate</code></p>

<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "add order model"
</pre></div>
</figure>

<p><br></p>
<h3>Step 3 : 建立结帐页</h3>
<figure class="figure-code code"><figcaption><span>app/controllers/carts_controller.rb 
</span></figcaption><div class="highlight"><pre>class CartsController <span class="nt">&lt; ApplicationController</span>
<span class="err">...(略)</span>
<span class="err">+</span>  <span class="na">def</span> <span class="na">checkout</span>
<span class="err">+</span>    <span class="err">@</span><span class="na">order =</span><span class="err"> </span><span class="s">Order.new</span>
<span class="err">+</span>  <span class="na">end</span>

    <span class="na">private</span>
<span class="err">...(略)</span>
<span class="na">end</span>
</pre></div>
</figure>

<p><code>touch app/views/carts/checkout.html.erb</code></p>

<figure class="figure-code code"><figcaption><span>app/views/carts/checkout.html.erb 
</span></figcaption><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
   <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-12"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;h2&gt;</span> 购物明细 <span class="nt">&lt;/h2&gt;</span>

    <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">"table table-bordered"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;thead&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
          <span class="nt">&lt;th</span> <span class="na">width=</span><span class="s">"80%"</span><span class="nt">&gt;</span>商品明细<span class="nt">&lt;/th&gt;</span>
          <span class="nt">&lt;th&gt;</span>单价<span class="nt">&lt;/th&gt;</span>
          <span class="nt">&lt;th&gt;</span>数量<span class="nt">&lt;/th&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
      <span class="nt">&lt;/thead&gt;</span>
      <span class="nt">&lt;tbody&gt;</span>

        <span class="cp">&lt;%</span> <span class="n">current_cart</span><span class="p">.</span><span class="nf">cart_items</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">cart_item</span><span class="o">|</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;td&gt;</span>
              <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="n">cart_item</span><span class="p">.</span><span class="nf">product</span><span class="p">.</span><span class="nf">title</span><span class="p">,</span> <span class="n">product_path</span><span class="p">(</span><span class="n">cart_item</span><span class="p">.</span><span class="nf">product</span><span class="p">))</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;</span>
              <span class="cp">&lt;%=</span> <span class="n">cart_item</span><span class="p">.</span><span class="nf">product</span><span class="p">.</span><span class="nf">price</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;/td&gt;</span>

            <span class="nt">&lt;td&gt;</span>
              <span class="cp">&lt;%=</span> <span class="n">cart_item</span><span class="p">.</span><span class="nf">quantity</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;/td&gt;</span>

          <span class="nt">&lt;/tr&gt;</span>
        <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

      <span class="nt">&lt;/tbody&gt;</span>
    <span class="nt">&lt;/table&gt;</span>

    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"total clearfix"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"pull-right"</span><span class="nt">&gt;</span>
        总计 <span class="cp">&lt;%=</span> <span class="n">render_cart_total_price</span><span class="p">(</span><span class="n">current_cart</span><span class="p">)</span> <span class="cp">%&gt;</span> CNY
      <span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;/div&gt;</span>

    <span class="nt">&lt;hr&gt;</span>

    <span class="nt">&lt;h2&gt;</span> 订单资讯 <span class="nt">&lt;/h2&gt;</span>

    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"order-form"</span><span class="nt">&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">simple_form_for</span> <span class="vi">@order</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>



          <span class="nt">&lt;legend&gt;</span> 订购人<span class="nt">&lt;/legend&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group col-lg-6"</span><span class="nt">&gt;</span>
            <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">input</span> <span class="ss">:billing_name</span>  <span class="cp">%&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group col-lg-6"</span><span class="nt">&gt;</span>
            <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">input</span> <span class="ss">:billing_address</span>  <span class="cp">%&gt;</span>
          <span class="nt">&lt;/div&gt;</span>

          <span class="nt">&lt;legend&gt;</span> 收货人<span class="nt">&lt;/legend&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group col-lg-6"</span><span class="nt">&gt;</span>
           <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">input</span> <span class="ss">:shipping_name</span>  <span class="cp">%&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group col-lg-6"</span><span class="nt">&gt;</span>
            <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">input</span> <span class="ss">:shipping_address</span>  <span class="cp">%&gt;</span>
          <span class="nt">&lt;/div&gt;</span>

        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"checkout"</span><span class="nt">&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">submit</span> <span class="s2">"生成订单"</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"btn btn-lg btn-danger pull-right"</span><span class="p">,</span>
                       <span class="ss">data: </span><span class="p">{</span> <span class="ss">disable_with: </span><span class="s2">"Submitting..."</span> <span class="p">}</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</figure>

<figure class="figure-code code"><figcaption><span>config/routes.rb
</span></figcaption><div class="highlight"><pre><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
<span class="o">+</span>  <span class="n">resources</span> <span class="ss">:orders</span>
<span class="k">end</span>
</pre></div>
</figure>

<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "touch app/views/carts/checkout.html.erb"
</pre></div>
</figure>

<p><br></p>
<h3>Step 4 : 限制必须填写“寄件人”与“购买人资讯”</h3>
<figure class="figure-code code"><figcaption><span>app/models/order.rb 
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="o">+</span>  <span class="n">belongs_to</span> <span class="ss">:user</span>

<span class="o">+</span>  <span class="n">validates</span> <span class="ss">:billing_name</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
<span class="o">+</span>  <span class="n">validates</span> <span class="ss">:billing_address</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
<span class="o">+</span>  <span class="n">validates</span> <span class="ss">:shipping_name</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
<span class="o">+</span>  <span class="n">validates</span> <span class="ss">:shipping_address</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>

<span class="k">end</span>
</pre></div>
</figure>

<p><br></p>
<h3>Step 5: 建立订单 action</h3>
<p><code>rails g controller orders</code></p>

<figure class="figure-code code"><figcaption><span>app/controllers/orders_controller.rb 
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">OrdersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
<span class="o">+</span>  <span class="n">before_action</span> <span class="ss">:authenticate_user!</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:create</span><span class="p">]</span>

<span class="o">+</span>  <span class="k">def</span> <span class="nf">create</span>
<span class="o">+</span>    <span class="vi">@order</span> <span class="o">=</span> <span class="no">Order</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">order_params</span><span class="p">)</span>
<span class="o">+</span>    <span class="vi">@order</span><span class="p">.</span><span class="nf">user</span> <span class="o">=</span> <span class="n">current_user</span>
<span class="o">+</span>    <span class="vi">@order</span><span class="p">.</span><span class="nf">total</span> <span class="o">=</span> <span class="n">current_cart</span><span class="p">.</span><span class="nf">total_price</span>

<span class="o">+</span>    <span class="k">if</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">save</span>
<span class="o">+</span>      <span class="n">redirect_to</span> <span class="n">order_path</span><span class="p">(</span><span class="vi">@order</span><span class="p">)</span>
<span class="o">+</span>    <span class="k">else</span>
<span class="o">+</span>      <span class="n">render</span> <span class="s1">'carts/checkout'</span>
<span class="o">+</span>    <span class="k">end</span>
<span class="o">+</span>  <span class="k">end</span>

<span class="o">+</span>  <span class="kp">private</span>

<span class="o">+</span>  <span class="k">def</span> <span class="nf">order_params</span>
<span class="o">+</span>    <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:order</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:billing_name</span><span class="p">,</span> <span class="ss">:billing_address</span><span class="p">,</span> <span class="ss">:shipping_name</span><span class="p">,</span> <span class="ss">:shipping_address</span><span class="p">)</span>
<span class="o">+</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</figure>

<figure class="figure-code code"><figcaption><span>app/models/user.rb 
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="o">+</span>  <span class="n">has_many</span> <span class="ss">:orders</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>  
</pre></div>
</figure>

<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "add order controller"
</pre></div>
</figure>

<p>此时按下生成订单页面，会报错（正常，因为下一节才会写show）<br>
<figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/bDqUK3TlRdaJCZHFOP9X_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-09-20%20%E4%B8%8B%E5%8D%881.53.51.png" title=""></figure></p>

<p>我们到rails console查看刚刚的订单是否已经生成，输入Order.last<br>
<figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/K4heKPF9TzY5ubfg3d2Q_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-09-20%20%E4%B8%8B%E5%8D%881.54.34.png" title=""></figure></p>
<h2>效果动图</h2>
<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/jjJYmUxvTB2vCv5HW8Zf_jdstore-posts:227.gif" title=""></figure></p>

    </div>
  </div></div><div class='frame'><h1>
      8-2 Step 2 : 建立购买明细
    </h1><h4>所属章节：8-订单实做</h4><hr><div class="post group">
    <div class="post-content markdown">
      <h2>目标</h2>
<p>这时候我们突然发现一件事，购买好像要建立一个“购买明细”。</p>

<p>这个购买明细呢，还不能直接用 product_id 的方式记录信息。</p>

<p>因为</p>

<ul>
<li>有时候商品会下架</li>
<li>或者价格会改变</li>
</ul>

<p>我们需要新建立一个 model 去储存当时购买的信息。</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/AS5M6E5NQMuHqeokflca_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-01%20%E4%B8%8B%E5%8D%885.09.14.png" title=""></figure></p>

<p><br></p>
<h2>步骤</h2>
<h3>Step 1: 建立 ProductList model</h3>
<p>至少要有</p>

<ul>
<li>订单编号 order_id </li>
<li>商品当时的名称 product_name </li>
<li>商品当时的价格 product_price </li>
<li>购买数量 quantity </li>
</ul>

<p><code>rails g model product_list</code></p>

<figure class="figure-code code"><figcaption><span>db/migrate/XXX(一堆数字)_create_product_lists.rb 
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">CreateProductLists</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mi">5</span><span class="o">.</span><span class="mi">0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:product_lists</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
<span class="o">+</span>      <span class="n">t</span><span class="p">.</span><span class="nf">integer</span> <span class="ss">:order_id</span>
<span class="o">+</span>      <span class="n">t</span><span class="p">.</span><span class="nf">string</span>  <span class="ss">:product_name</span>
<span class="o">+</span>      <span class="n">t</span><span class="p">.</span><span class="nf">integer</span> <span class="ss">:product_price</span>
<span class="o">+</span>      <span class="n">t</span><span class="p">.</span><span class="nf">integer</span> <span class="ss">:quantity</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</figure>

<p><code>rake db:migrate</code></p>

<figure class="figure-code code"><figcaption><span>app/models/order.rb 
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>

<span class="o">+</span>  <span class="n">has_many</span> <span class="ss">:product_lists</span>
<span class="k">end</span>
</pre></div>
</figure>

<figure class="figure-code code"><figcaption><span>app/models/product_list.rb 
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">ProductList</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="o">+</span>  <span class="n">belongs_to</span> <span class="ss">:order</span>
<span class="k">end</span>
</pre></div>
</figure>

<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "add product_list model"
</pre></div>
</figure>
<h3>Step 2：在订单建立后建立购买明细缓存</h3>
<figure class="figure-code code"><figcaption><span>app/controllers/orders_controller.rb 
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">OrdersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:authenticate_user!</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:create</span><span class="p">]</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@order</span> <span class="o">=</span> <span class="no">Order</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">order_params</span><span class="p">)</span>
    <span class="vi">@order</span><span class="p">.</span><span class="nf">user</span> <span class="o">=</span> <span class="n">current_user</span>
    <span class="vi">@order</span><span class="p">.</span><span class="nf">total</span> <span class="o">=</span> <span class="n">current_cart</span><span class="p">.</span><span class="nf">total_price</span>

    <span class="k">if</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">save</span>

<span class="o">+</span>      <span class="n">current_cart</span><span class="p">.</span><span class="nf">cart_items</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">cart_item</span><span class="o">|</span>
<span class="o">+</span>        <span class="n">product_list</span> <span class="o">=</span> <span class="no">ProductList</span><span class="p">.</span><span class="nf">new</span>
<span class="o">+</span>        <span class="n">product_list</span><span class="p">.</span><span class="nf">order</span> <span class="o">=</span> <span class="vi">@order</span>
<span class="o">+</span>        <span class="n">product_list</span><span class="p">.</span><span class="nf">product_name</span> <span class="o">=</span> <span class="n">cart_item</span><span class="p">.</span><span class="nf">product</span><span class="p">.</span><span class="nf">title</span>
<span class="o">+</span>        <span class="n">product_list</span><span class="p">.</span><span class="nf">product_price</span> <span class="o">=</span> <span class="n">cart_item</span><span class="p">.</span><span class="nf">product</span><span class="p">.</span><span class="nf">price</span>
<span class="o">+</span>        <span class="n">product_list</span><span class="p">.</span><span class="nf">quantity</span> <span class="o">=</span> <span class="n">cart_item</span><span class="p">.</span><span class="nf">quantity</span>
<span class="o">+</span>        <span class="n">product_list</span><span class="p">.</span><span class="nf">save</span>
<span class="o">+</span>      <span class="k">end</span>

      <span class="n">redirect_to</span> <span class="n">order_path</span><span class="p">(</span><span class="vi">@order</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'carts/checkout'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">order_params</span>
    <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:order</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:billing_name</span><span class="p">,</span> <span class="ss">:billing_address</span><span class="p">,</span> <span class="ss">:shipping_name</span><span class="p">,</span> <span class="ss">:shipping_address</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</figure>
<h3>Step 3 : 建立订单明细</h3>
<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/lIMyxHJkQsSC3ExN0rhH_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-05%20%E4%B8%8B%E5%8D%884.13.45.png" title=""></figure></p>

<figure class="figure-code code"><figcaption><span>app/controllers/orders_controller.rb
</span></figcaption><div class="highlight"><pre><span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
<span class="o">+</span>  <span class="k">def</span> <span class="nf">show</span>
<span class="o">+</span>    <span class="vi">@order</span> <span class="o">=</span> <span class="no">Order</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
<span class="o">+</span>    <span class="vi">@product_lists</span> <span class="o">=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">product_lists</span>
<span class="o">+</span>  <span class="k">end</span>

<span class="kp">private</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
</pre></div>
</figure>

<p><code>touch app/views/orders/show.html.erb</code></p>

<figure class="figure-code code"><figcaption><span>app/views/orders/show.html.erb 
</span></figcaption><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-12"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;h2&gt;</span> 订单明细 <span class="nt">&lt;/h2&gt;</span>

    <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">"table table-bordered"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;thead&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
          <span class="nt">&lt;th</span> <span class="na">width=</span><span class="s">"80%"</span><span class="nt">&gt;</span>商品明细<span class="nt">&lt;/th&gt;</span>
          <span class="nt">&lt;th&gt;</span>单价<span class="nt">&lt;/th&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
      <span class="nt">&lt;/thead&gt;</span>
      <span class="nt">&lt;tbody&gt;</span>

        <span class="cp">&lt;%</span> <span class="vi">@product_lists</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product_list</span><span class="o">|</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;td&gt;</span>
              <span class="cp">&lt;%=</span> <span class="n">product_list</span><span class="p">.</span><span class="nf">product_name</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;</span>
              <span class="cp">&lt;%=</span> <span class="n">product_list</span><span class="p">.</span><span class="nf">product_price</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;/td&gt;</span>
          <span class="nt">&lt;/tr&gt;</span>
        <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

      <span class="nt">&lt;/tbody&gt;</span>
    <span class="nt">&lt;/table&gt;</span>

    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"total clearfix"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"pull-right"</span><span class="nt">&gt;</span>
        总计 <span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">total</span> <span class="cp">%&gt;</span> CNY
      <span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;/div&gt;</span>

     <span class="nt">&lt;hr&gt;</span>

     <span class="nt">&lt;h2&gt;</span> 寄送资讯 <span class="nt">&lt;/h2&gt;</span>

     <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">"table table-striped table-bordered"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;tbody&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
          <span class="nt">&lt;td&gt;</span>
            订购人
          <span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
          <span class="nt">&lt;td&gt;</span>
            <span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">billing_name</span> <span class="cp">%&gt;</span> - <span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">billing_address</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
          <span class="nt">&lt;td&gt;</span>
            收件人
          <span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
          <span class="nt">&lt;td&gt;</span>
            <span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">shipping_name</span> <span class="cp">%&gt;</span> - <span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">shipping_address</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
      <span class="nt">&lt;/tbody&gt;</span>
    <span class="nt">&lt;/table&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</figure>

<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "add orders show function"
</pre></div>
</figure>
<h2>效果动图</h2>
<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/L1KUarQSXevj4Vj2pQFw_jdstore-posts:228.gif" title=""></figure></p>

    </div>
  </div></div><div class='frame'><h1>
      8-3 Step 3 : 将网址改为秘密
    </h1><h4>所属章节：8-订单实做</h4><hr><div class="post group">
    <div class="post-content markdown">
      <h2>目标</h2>
<p>订单完成之后，我们赫然发现有一个严重的问题，我们产生的订单是流水号。</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ULpESOhOQFQuQUhwwBH4_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-01%20%E4%B8%8B%E5%8D%885.20.03.png" title=""></figure></p>

<p>如此一来：</p>

<ul>
<li>路人都知道你每天的生意成交量是多少</li>
<li>路人可以猜到规律</li>
</ul>

<p>非常危险。</p>

<p>因此，我们必须把订单号码改成乱序编码。如下图</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/5a3Zim2tSruXoZZaJnnB_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-05%20%E4%B8%8B%E5%8D%884.22.06.png" title=""></figure></p>

<p>从 <code>/orders/1</code> 改成 <code>/orders/0f054ab5-2833-4a6d-bde5-0820b68fffae</code></p>
<h2>步骤</h2>
<h3>Step 1:</h3>
<p>我们在订单这个 model 里面加上一个栏位叫 token 存订单乱序号</p>

<p><code>rails g migration add_token_to_order</code></p>

<figure class="figure-code code"><figcaption><span>db/migrate/XXX(一堆数字)_add_token_to_order.rb 
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddTokenToOrder</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mi">5</span><span class="o">.</span><span class="mi">0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
<span class="o">+</span>    <span class="n">add_column</span> <span class="ss">:orders</span><span class="p">,</span> <span class="ss">:token</span><span class="p">,</span> <span class="ss">:string</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</figure>

<p><code>rake db:migrate</code></p>

<p><br></p>
<h3>Step 2:</h3>
<figure class="figure-code code"><figcaption><span>app/models/order.rb 
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="o">+</span>  <span class="n">before_create</span> <span class="ss">:generate_token</span>

<span class="o">+</span>  <span class="k">def</span> <span class="nf">generate_token</span>
<span class="o">+</span>    <span class="nb">self</span><span class="p">.</span><span class="nf">token</span> <span class="o">=</span> <span class="no">SecureRandom</span><span class="p">.</span><span class="nf">uuid</span>
<span class="o">+</span>  <span class="k">end</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</figure>

<p><br></p>
<h3>Step 3 修改重导网址</h3>
<figure class="figure-code code"><figcaption><span>app/controllers/orders_controller.rb
</span></figcaption><div class="highlight"><pre><span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@order</span> <span class="o">=</span> <span class="no">Order</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">order_params</span><span class="p">)</span>
    <span class="vi">@order</span><span class="p">.</span><span class="nf">user</span> <span class="o">=</span> <span class="n">current_user</span>
    <span class="vi">@order</span><span class="p">.</span><span class="nf">total</span> <span class="o">=</span> <span class="n">current_cart</span><span class="p">.</span><span class="nf">total_price</span>

    <span class="k">if</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">save</span>
      <span class="n">current_cart</span><span class="p">.</span><span class="nf">cart_items</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">cart_item</span><span class="o">|</span>
        <span class="n">product_list</span> <span class="o">=</span> <span class="no">ProductList</span><span class="p">.</span><span class="nf">new</span>
        <span class="n">product_list</span><span class="p">.</span><span class="nf">order</span> <span class="o">=</span> <span class="vi">@order</span>
        <span class="n">product_list</span><span class="p">.</span><span class="nf">product_name</span> <span class="o">=</span> <span class="n">cart_item</span><span class="p">.</span><span class="nf">product</span><span class="p">.</span><span class="nf">title</span>
        <span class="n">product_list</span><span class="p">.</span><span class="nf">product_price</span> <span class="o">=</span> <span class="n">cart_item</span><span class="p">.</span><span class="nf">product</span><span class="p">.</span><span class="nf">price</span>
        <span class="n">product_list</span><span class="p">.</span><span class="nf">quantity</span> <span class="o">=</span> <span class="n">cart_item</span><span class="p">.</span><span class="nf">quantity</span>
        <span class="n">product_list</span><span class="p">.</span><span class="nf">save</span>
      <span class="k">end</span>
<span class="o">-</span>     <span class="n">redirect_to</span> <span class="n">order_path</span><span class="p">(</span><span class="vi">@order</span><span class="p">)</span>
<span class="o">+</span>     <span class="n">redirect_to</span> <span class="n">order_path</span><span class="p">(</span><span class="vi">@order</span><span class="p">.</span><span class="nf">token</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'carts/checkout'</span>
    <span class="k">end</span>
  <span class="k">end</span>
  
  <span class="k">def</span> <span class="nf">show</span>
<span class="o">-</span>   <span class="vi">@order</span> <span class="o">=</span> <span class="no">Order</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
<span class="o">+</span>   <span class="vi">@order</span> <span class="o">=</span> <span class="no">Order</span><span class="p">.</span><span class="nf">find_by_token</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="vi">@product_lists</span> <span class="o">=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">product_lists</span>
  <span class="k">end</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
</pre></div>
</figure>

<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "add token to order"
</pre></div>
</figure>
<h2>效果动图</h2>
<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/J8KC3bmLTLGykSeKFlzi_jdstore-posts:229.gif" title=""></figure></p>
<h2>解说</h2>
<h3>before_create</h3>
<figure class="figure-code code"><figcaption><span>app/models/order.rb 
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">before_create</span> <span class="ss">:generate_token</span>

  <span class="k">def</span> <span class="nf">generate_token</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">token</span> <span class="o">=</span> <span class="no">SecureRandom</span><span class="p">.</span><span class="nf">uuid</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</figure>

<p><code>before_create</code> 是 Rails model 内建的 callbacks，目的是让资料生成储存前先执行某某动作。比如说我们在这里就是让订单在生成前，先生成「乱数序号」。而<code>SecureRandom.uuid</code> 是 Ruby 内建的随机生成器。</p>

    </div>
  </div></div><div class='frame'><h1>
      8-4 订单练习作业 
    </h1><h4>所属章节：8-订单实做</h4><hr><div class="post group">
    <div class="post-content markdown">
      <ul>
<li>使用者可以在 /account/orders/ 看到过去所有订单</li>
<li>使用者在下拉式选单可以看到过去所有的订单</li>
</ul>

    </div>
  </div></div><div class='frame'><h1>
      9-1 订单练习作业（解答）
    </h1><h4>所属章节：9-订单实做（解答）</h4><hr><div class="post group">
    <div class="post-content markdown">
      <h3>目标</h3>
<ul>
<li>使用者可以在 /account/orders/ 看到过去所有订单</li>
<li>使用者在下拉式选单可以看到过去所有的订单</li>
</ul>

<p><br></p>
<h3>步骤</h3>
<h4>Step 1: 建立 account/orders 的 controller &amp; view</h4>
<p><code>rails g controller account::orders</code></p>

<figure class="figure-code code"><figcaption><span>config/routes.rb 
</span></figcaption><div class="highlight"><pre><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
<span class="o">+</span> <span class="n">namespace</span> <span class="ss">:account</span> <span class="k">do</span>
<span class="o">+</span>   <span class="n">resources</span> <span class="ss">:orders</span>
<span class="o">+</span> <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</figure>

<figure class="figure-code code"><figcaption><span>app/controllers/account/orders_controller.rb 
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">Account</span><span class="o">::</span><span class="no">OrdersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
<span class="o">+</span>  <span class="n">before_action</span> <span class="ss">:authenticate_user!</span>

<span class="o">+</span>  <span class="k">def</span> <span class="nf">index</span>
<span class="o">+</span>    <span class="vi">@orders</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">orders</span>
<span class="o">+</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</figure>

<p><code>touch app/views/account/orders/index.html.erb</code></p>

<figure class="figure-code code"><figcaption><span>app/views/account/orders/index.html.erb 
</span></figcaption><div class="highlight"><pre><span class="nt">&lt;h2&gt;</span>订单列表 <span class="nt">&lt;/h2&gt;</span>

<span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">"table table-bordered"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;thead&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
      <span class="nt">&lt;th&gt;</span>#<span class="nt">&lt;/th&gt;</span>
      <span class="nt">&lt;th&gt;</span>生成时间<span class="nt">&lt;/th&gt;</span>

    <span class="nt">&lt;/tr&gt;</span>
  <span class="nt">&lt;/thead&gt;</span>
  <span class="nt">&lt;tbody&gt;</span>

    <span class="cp">&lt;%</span> <span class="vi">@orders</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">order</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
      <span class="nt">&lt;td&gt;</span> <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="n">order</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="n">order_path</span><span class="p">(</span><span class="n">order</span><span class="p">.</span><span class="nf">token</span><span class="p">))</span> <span class="cp">%&gt;</span> <span class="nt">&lt;/td&gt;</span>
      <span class="nt">&lt;td&gt;</span> <span class="cp">&lt;%=</span> <span class="n">order</span><span class="p">.</span><span class="nf">created_at</span><span class="p">.</span><span class="nf">to_s</span><span class="p">(</span><span class="ss">:long</span><span class="p">)</span> <span class="cp">%&gt;</span> <span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

  <span class="nt">&lt;/tbody&gt;</span>
<span class="nt">&lt;/table&gt;</span>
</pre></div>
</figure>

<p><a href="http://localhost:3000/account/orders" rel="nofollow" target="_blank">http://localhost:3000/account/orders</a> 可以看到曾经下过的订单列表</p>

<p><br></p>
<h4>Bug 解决: 之前的订单没有 token 资料</h4>
<p>由于在开发时，到后面才实作将订单加入 token 的栏位，所以导致之前的订单资料完全没有 token 的数值 这会导致在这章可能会出现如下的问题</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/TeEj9SO4TP2KbjJQjtpl_pOzD1moQQ263h1dCCMcK_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-02-26%20%E4%B8%8B%E5%8D%881.41.38.png" title=""></figure></p>

<p>解决方法：<br>
<code>rails c</code> 到 rails console 输入以下指令:<br>
<code>Order.where(token: nil).destroy_all</code></p>

<p><br></p>
<h4>Step 2: 订单的排列顺序按照 最新 -&gt; 最旧 排列</h4>
<figure class="figure-code code"><figcaption><span>app/controllers/account/orders_controller.rb 
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">Account</span><span class="o">::</span><span class="no">OrdersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:authenticate_user!</span>

  <span class="k">def</span> <span class="nf">index</span>
<span class="o">-</span>   <span class="vi">@orders</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">orders</span>
<span class="o">+</span>   <span class="vi">@orders</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">orders</span><span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="s2">"id DESC"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</figure>

<p><a href="http://localhost:3000/account/orders" rel="nofollow" target="_blank">http://localhost:3000/account/orders</a><br>
最新订单会在上方</p>
<h4>Step 3: navbar 新增个人订单列表的连结</h4>
<figure class="figure-code code"><figcaption><span>app/views/common/_navbar.html.erb 
</span></figcaption><div class="highlight"><pre>...(略)
            <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"dropdown-menu"</span><span class="nt">&gt;</span>
              <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">admin?</span> <span class="cp">%&gt;</span>
                <span class="nt">&lt;li&gt;</span>
                  <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">"Admin 选单"</span><span class="p">,</span> <span class="n">admin_products_path</span> <span class="p">)</span> <span class="cp">%&gt;</span>
                <span class="nt">&lt;/li&gt;</span>
              <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
+             <span class="nt">&lt;li&gt;</span>
+               <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">"个人订单列表"</span><span class="p">,</span> <span class="n">account_orders_path</span> <span class="p">)</span> <span class="cp">%&gt;</span>
+             <span class="nt">&lt;/li&gt;</span>
              <span class="nt">&lt;li&gt;</span>
                <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">"登出"</span><span class="p">,</span> <span class="n">destroy_user_session_path</span><span class="p">,</span> <span class="ss">method: :delete</span> <span class="p">)</span> <span class="cp">%&gt;</span>
              <span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;/ul&gt;</span>
...(略)
</pre></div>
</figure>

<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "users can see their orders"
</pre></div>
</figure>
<h3>效果动图</h3>
<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/WfPTi1DpQgiYm9VUYZmA_jdstore-posts:233.gif" title=""></figure></p>

    </div>
  </div></div><div class='frame'><h1>
      10-1 Step 1 : 消费者可以针对订单付款
    </h1><h4>所属章节：10-支付订单与寄信</h4><hr><div class="post group">
    <div class="post-content markdown">
      <h2>目标</h2>
<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/7F2BF4ioTYq6UGDe6HJ8_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-02%20%E4%B8%8B%E5%8D%884.23.35.png" title=""></figure></p>

<p>这一章我们要实做的内容是：为订单页面加上付款按钮，消费者可以在这个页面上点击付费，并且分为两种渠道。</p>

<p>主要思路为：</p>

<ul>
<li>使用 is_paid（boolean 属性）判断是否已付费</li>
<li>使用 payment_method 判断，实际付款渠道为：微信、支付宝</li>
<li>已付款过的订单不可以再付</li>
</ul>

<p><br></p>
<h2>步骤</h2>
<h3>Step 1: 将订单分为「已付款」、「未付款」</h3>
<ul>
<li>新增一个栏位 <code>is_paid</code> 到 <code>Order</code> 这个 model，使用 boolean （true / false ) 属性</li>
<li>预设是 false（未付费）。</li>
</ul>

<p><code>rails g migration add_is_paid_to_order</code></p>

<figure class="figure-code code"><figcaption><span>db/migrate/XXX(一堆数字)_add_is_paid_to_order.rb 
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddIsPaidToOrder</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mi">5</span><span class="o">.</span><span class="mi">0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
<span class="o">+</span>    <span class="n">add_column</span> <span class="ss">:orders</span><span class="p">,</span> <span class="ss">:is_paid</span><span class="p">,</span> <span class="ss">:boolean</span><span class="p">,</span> <span class="ss">default: </span><span class="kp">false</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</figure>

<p><code>rake db:migrate</code></p>

<p><br></p>
<h3>Step 2: 记录订单付款方式</h3>
<ul>
<li>新增一个栏位 <code>payment_method</code>  到 <code>Order</code> 这个 model，使用 string 属性</li>
</ul>

<p><code>rails g migration add_payment_method_to_order</code></p>

<figure class="figure-code code"><figcaption><span>db/migrate/XXX(一堆数字)_add_payment_method_to_order.rb 
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddPaymentMethodToOrder</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mi">5</span><span class="o">.</span><span class="mi">0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
<span class="o">+</span>    <span class="n">add_column</span> <span class="ss">:orders</span><span class="p">,</span> <span class="ss">:payment_method</span><span class="p">,</span> <span class="ss">:string</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</figure>

<p><code>rake db:migrate</code></p>

<p><br></p>
<h3>Step 3: 在 show 页面上加入结帐按钮</h3>
<p>修改 <code>app/views/orders/show.html.erb</code></p>

<figure class="figure-code code"><figcaption><span>app/views/orders/show.html.erb 
</span></figcaption><div class="highlight"><pre>   <span class="nt">&lt;/table&gt;</span>

+   <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"group pull-right"</span><span class="nt">&gt;</span>
+     <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">"以支付宝支付"</span><span class="p">,</span> <span class="n">pay_with_alipay_order_path</span><span class="p">(</span><span class="vi">@order</span><span class="p">.</span><span class="nf">token</span><span class="p">),</span> <span class="ss">:method</span> <span class="o">=&gt;</span> <span class="ss">:post</span><span class="p">,</span> <span class="ss">:class</span> <span class="o">=&gt;</span> <span class="s2">"btn btn-danger"</span><span class="p">)</span> <span class="cp">%&gt;</span>
+     <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">"以微信支付"</span><span class="p">,</span> <span class="n">pay_with_wechat_order_path</span><span class="p">(</span><span class="vi">@order</span><span class="p">.</span><span class="nf">token</span><span class="p">),</span> <span class="ss">:method</span> <span class="o">=&gt;</span> <span class="ss">:post</span><span class="p">,</span> <span class="ss">:class</span> <span class="o">=&gt;</span> <span class="s2">"btn btn-danger"</span><span class="p">)</span> <span class="cp">%&gt;</span>
+   <span class="nt">&lt;/div&gt;</span>

  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>

</pre></div>
</figure>
<h3>Step 4: 设定路径</h3>
<p>修改 <code>config/routes.rb</code></p>

<figure class="figure-code code"><figcaption><span>config/routes.rb 
</span></figcaption><div class="highlight"><pre><span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
<span class="o">-</span>  <span class="n">resources</span> <span class="ss">:orders</span>
<span class="o">+</span>  <span class="n">resources</span> <span class="ss">:orders</span> <span class="k">do</span>
<span class="o">+</span>    <span class="n">member</span> <span class="k">do</span>
<span class="o">+</span>      <span class="n">post</span> <span class="ss">:pay_with_alipay</span>
<span class="o">+</span>      <span class="n">post</span> <span class="ss">:pay_with_wechat</span>
<span class="o">+</span>    <span class="k">end</span>
<span class="o">+</span>  <span class="k">end</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
</pre></div>
</figure>

<p><br></p>
<h3>Step 5: 设定Controller</h3>
<p>修改 <code>app/controllers/orders_controller.rb</code></p>

<figure class="figure-code code"><figcaption><span>app/controllers/orders_controller.rb 
</span></figcaption><div class="highlight"><pre><span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pay_with_alipay</span>
    <span class="vi">@order</span> <span class="o">=</span> <span class="no">Order</span><span class="p">.</span><span class="nf">find_by_token</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="vi">@order</span><span class="p">.</span><span class="nf">set_payment_with!</span><span class="p">(</span><span class="s2">"alipay"</span><span class="p">)</span>
    <span class="vi">@order</span><span class="p">.</span><span class="nf">pay!</span>

    <span class="n">redirect_to</span> <span class="n">order_path</span><span class="p">(</span><span class="vi">@order</span><span class="p">.</span><span class="nf">token</span><span class="p">),</span> <span class="ss">notice: </span><span class="s2">"使用支付宝成功完成付款"</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">pay_with_wechat</span>
    <span class="vi">@order</span> <span class="o">=</span> <span class="no">Order</span><span class="p">.</span><span class="nf">find_by_token</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="vi">@order</span><span class="p">.</span><span class="nf">set_payment_with!</span><span class="p">(</span><span class="s2">"wechat"</span><span class="p">)</span>
    <span class="vi">@order</span><span class="p">.</span><span class="nf">pay!</span>

    <span class="n">redirect_to</span> <span class="n">order_path</span><span class="p">(</span><span class="vi">@order</span><span class="p">.</span><span class="nf">token</span><span class="p">),</span> <span class="ss">notice: </span><span class="s2">"使用微信成功完成付款"</span>
  <span class="k">end</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
</pre></div>
</figure>

<p><br></p>
<h3>Step 6: 修改 model 设定 order 付款完成与付款方式纪录的 method</h3>
<figure class="figure-code code"><figcaption><span>app/models/order.rb
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
<span class="o">+</span> <span class="k">def</span> <span class="nf">set_payment_with!</span><span class="p">(</span><span class="nb">method</span><span class="p">)</span>
<span class="o">+</span>   <span class="nb">self</span><span class="p">.</span><span class="nf">update_columns</span><span class="p">(</span><span class="ss">payment_method: </span><span class="nb">method</span> <span class="p">)</span>
<span class="o">+</span> <span class="k">end</span>

<span class="o">+</span> <span class="k">def</span> <span class="nf">pay!</span>
<span class="o">+</span>   <span class="nb">self</span><span class="p">.</span><span class="nf">update_columns</span><span class="p">(</span><span class="ss">is_paid: </span><span class="kp">true</span> <span class="p">)</span>
<span class="o">+</span> <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</figure>

<p><br></p>
<h3>Step 7: 已经结帐的订单不可再付款</h3>
<p>修改 <code>app/views/orders/show.html.erb</code></p>

<figure class="figure-code code"><figcaption><span>app/views/orders/show.html.erb
</span></figcaption><div class="highlight"><pre>
...(略)
+   <span class="cp">&lt;%</span> <span class="k">if</span> <span class="o">!</span><span class="vi">@order</span><span class="p">.</span><span class="nf">is_paid?</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"group pull-right"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">"以支付宝支付"</span><span class="p">,</span> <span class="n">pay_with_alipay_order_path</span><span class="p">(</span><span class="vi">@order</span><span class="p">.</span><span class="nf">token</span><span class="p">),</span> <span class="ss">:method</span> <span class="o">=&gt;</span> <span class="ss">:post</span><span class="p">,</span> <span class="ss">:class</span> <span class="o">=&gt;</span> <span class="s2">"btn btn-danger"</span><span class="p">)</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">"以微信支付"</span><span class="p">,</span> <span class="n">pay_with_wechat_order_path</span><span class="p">(</span><span class="vi">@order</span><span class="p">.</span><span class="nf">token</span><span class="p">),</span> <span class="ss">:method</span> <span class="o">=&gt;</span> <span class="ss">:post</span><span class="p">,</span> <span class="ss">:class</span> <span class="o">=&gt;</span> <span class="s2">"btn btn-danger"</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
+    <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
+      <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"text-center"</span><span class="nt">&gt;</span>此订单已完成付款<span class="nt">&lt;/p&gt;</span>
+    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

   <span class="nt">&lt;/div&gt;</span>
 <span class="nt">&lt;/div&gt;</span>
</pre></div>
</figure>

<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "add payment_method function"
</pre></div>
</figure>
<h2>成果</h2>
<p>试着结帐看看，原先订单页面会从</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/7F2BF4ioTYq6UGDe6HJ8_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-02%20%E4%B8%8B%E5%8D%884.23.35.png" title=""></figure></p>

<p>变成</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/09tDEsvoSselamcTc9pS_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-09-21%20%E4%B8%8A%E5%8D%889.59.41.png" title=""></figure></p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/iQaUrZURSyyzDBzE4xTz_jdstore-posts:231.gif" title=""></figure></p>

    </div>
  </div></div><div class='frame'><h1>
      10-2 Step 2 : 寄送订单确认通知信
    </h1><h4>所属章节：10-支付订单与寄信</h4><hr><div class="post group">
    <div class="post-content markdown">
      <h2>寄送订单通知信</h2>
<h3>目标</h3>
<ul>
<li>使用者在下单后会收到一封订单确认信</li>
</ul>
<h2>步骤</h2>
<h3>Step 1: 产⽣ Mailer</h3>
<p><code>rails g mailer OrderMailer</code></p>

<p><br></p>
<h3>Step 2: 设定通知订单成立的寄信功能</h3>
<figure class="figure-code code"><figcaption><span>app/mailers/application_mailer.rb 
</span></figcaption><div class="highlight"><pre> <span class="k">class</span> <span class="nc">ApplicationMailer</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span>
<span class="o">-</span>  <span class="n">default</span> <span class="ss">from: </span><span class="s2">"from@example.com"</span>
<span class="o">+</span>  <span class="n">default</span> <span class="ss">from: </span><span class="s2">"service@jdstore.com"</span>
   <span class="n">layout</span> <span class="s1">'mailer'</span>
 <span class="k">end</span>
</pre></div>
</figure>

<figure class="figure-code code"><figcaption><span>app/mailers/order_mailer.rb 
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">OrderMailer</span> <span class="o">&lt;</span> <span class="no">ApplicationMailer</span>
  <span class="k">def</span> <span class="nf">notify_order_placed</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
    <span class="vi">@order</span>       <span class="o">=</span> <span class="n">order</span>
    <span class="vi">@user</span>        <span class="o">=</span> <span class="n">order</span><span class="p">.</span><span class="nf">user</span>
    <span class="vi">@product_lists</span> <span class="o">=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">product_lists</span>

    <span class="n">mail</span><span class="p">(</span><span class="ss">to: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span> <span class="p">,</span> <span class="ss">subject: </span><span class="s2">"[JDstore] 感谢您完成本次的下单，以下是您这次购物明细 </span><span class="si">#{</span><span class="n">order</span><span class="p">.</span><span class="nf">token</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</figure>

<p><code>touch app/views/order_mailer/notify_order_placed.html.erb</code></p>

<figure class="figure-code code"><figcaption><span>app/views/order_mailer/notify_order_placed.html.erb 
</span></figcaption><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-12"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h2&gt;</span>
      订单明细 <span class="nt">&lt;br&gt;</span>
      <span class="nt">&lt;small&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">"订单连结"</span><span class="p">,</span> <span class="n">order_url</span><span class="p">(</span><span class="vi">@order</span><span class="p">.</span><span class="nf">token</span><span class="p">))</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/small&gt;</span>
    <span class="nt">&lt;/h2&gt;</span>
    <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">"table table-bordered"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;thead&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
          <span class="nt">&lt;th</span> <span class="na">width=</span><span class="s">"70%"</span><span class="nt">&gt;</span>商品明细<span class="nt">&lt;/th&gt;</span>
          <span class="nt">&lt;th&gt;</span>单价<span class="nt">&lt;/th&gt;</span>
          <span class="nt">&lt;th&gt;</span>数量<span class="nt">&lt;/th&gt;</span>
          <span class="nt">&lt;th&gt;</span>小记<span class="nt">&lt;/th&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
      <span class="nt">&lt;/thead&gt;</span>
      <span class="nt">&lt;tbody&gt;</span>

        <span class="cp">&lt;%</span> <span class="vi">@product_lists</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product_list</span><span class="o">|</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;td&gt;</span>
              <span class="cp">&lt;%=</span> <span class="n">product_list</span><span class="p">.</span><span class="nf">product_name</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;</span>
              <span class="cp">&lt;%=</span> <span class="n">product_list</span><span class="p">.</span><span class="nf">product_price</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;</span>
              <span class="cp">&lt;%=</span> <span class="n">product_list</span><span class="p">.</span><span class="nf">quantity</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;</span>
              <span class="cp">&lt;%=</span> <span class="n">product_list</span><span class="p">.</span><span class="nf">quantity</span> <span class="o">*</span> <span class="n">product_list</span><span class="p">.</span><span class="nf">product_price</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;/td&gt;</span>
          <span class="nt">&lt;/tr&gt;</span>
        <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

      <span class="nt">&lt;/tbody&gt;</span>
    <span class="nt">&lt;/table&gt;</span>

    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"total group clearfix"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;h4</span> <span class="na">class=</span><span class="s">"pull-right"</span><span class="nt">&gt;</span>
        总计 <span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">total</span> <span class="cp">%&gt;</span> CNY
      <span class="nt">&lt;/h4&gt;</span>
     <span class="nt">&lt;/div&gt;</span>

     <span class="nt">&lt;hr&gt;</span>

     <span class="nt">&lt;h2&gt;</span> 寄送资讯 <span class="nt">&lt;/h2&gt;</span>

     <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">"table table-striped table-bordered"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;tbody&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
          <span class="nt">&lt;td&gt;</span> 订购人 <span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
          <span class="nt">&lt;td&gt;</span>
            <span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">billing_name</span> <span class="cp">%&gt;</span> - <span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">billing_address</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
          <span class="nt">&lt;td&gt;</span> 收件者 <span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
          <span class="nt">&lt;td&gt;</span>
            <span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">shipping_name</span> <span class="cp">%&gt;</span> - <span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">shipping_address</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
      <span class="nt">&lt;/tbody&gt;</span>
    <span class="nt">&lt;/table&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</figure>

<p><br></p>
<h3>Step 3: 安装 gem letter_opener 来预览邮件</h3>
<figure class="figure-code code"><figcaption><span>Gemfile 
</span></figcaption><div class="highlight"><pre><span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
<span class="n">gem</span> <span class="s1">'mini_magick'</span>

<span class="o">+</span> <span class="n">gem</span> <span class="s1">'letter_opener'</span><span class="p">,</span> <span class="ss">group: :development</span>

<span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
</pre></div>
</figure>

<figure class="figure-code code"><figcaption><span>config/environments/development.rb 
</span></figcaption><div class="highlight"><pre><span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
<span class="o">+</span> <span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">default_url_options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">host: </span><span class="s1">'localhost:3000'</span> <span class="p">}</span>
<span class="o">+</span> <span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">delivery_method</span> <span class="o">=</span> <span class="ss">:letter_opener</span>
<span class="k">end</span>
</pre></div>
</figure>

<p><code>bundle install</code></p>

<p>重开 <code>rails s</code></p>

<p><br></p>
<h3>Step 4: 在 console 模式测试信件预览</h3>
<p>执行<code>rails c</code></p>

<p><code>OrderMailer.notify_order_placed(Order.last).deliver!</code></p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/3j6NwQh8R6tgblAR8IwW_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-09-21%20%E4%B8%8B%E5%8D%882.57.21.png" title=""></figure></p>

<p>浏览器会自动开启信件如下 <br>
<figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/wtByWcjJRnm03MKR9e1G_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-09-21%20%E4%B8%8B%E5%8D%882.56.20.png" title=""></figure></p>

<p><br></p>
<h3>Step 5: 在订单建立时寄通知信</h3>
<figure class="figure-code code"><figcaption><span>app/controllers/orders_controller.rb 
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">OrdersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:authenticate_user!</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@order</span> <span class="o">=</span> <span class="no">Order</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">order_params</span><span class="p">)</span>
    <span class="vi">@order</span><span class="p">.</span><span class="nf">user</span> <span class="o">=</span> <span class="n">current_user</span>
    <span class="vi">@order</span><span class="p">.</span><span class="nf">total</span> <span class="o">=</span> <span class="n">current_cart</span><span class="p">.</span><span class="nf">total_price</span>

    <span class="k">if</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">save</span>

      <span class="n">current_cart</span><span class="p">.</span><span class="nf">cart_items</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">cart_item</span><span class="o">|</span>
        <span class="n">product_list</span> <span class="o">=</span> <span class="no">ProductList</span><span class="p">.</span><span class="nf">new</span>
        <span class="n">product_list</span><span class="p">.</span><span class="nf">order</span> <span class="o">=</span> <span class="vi">@order</span>
        <span class="n">product_list</span><span class="p">.</span><span class="nf">product_name</span> <span class="o">=</span> <span class="n">cart_item</span><span class="p">.</span><span class="nf">product</span><span class="p">.</span><span class="nf">title</span>
        <span class="n">product_list</span><span class="p">.</span><span class="nf">product_price</span> <span class="o">=</span> <span class="n">cart_item</span><span class="p">.</span><span class="nf">product</span><span class="p">.</span><span class="nf">price</span>
        <span class="n">product_list</span><span class="p">.</span><span class="nf">quantity</span> <span class="o">=</span> <span class="n">cart_item</span><span class="p">.</span><span class="nf">quantity</span>
        <span class="n">product_list</span><span class="p">.</span><span class="nf">save</span>
      <span class="k">end</span>
 <span class="o">+</span>    <span class="n">current_cart</span><span class="p">.</span><span class="nf">clean!</span>
 <span class="o">+</span>    <span class="no">OrderMailer</span><span class="p">.</span><span class="nf">notify_order_placed</span><span class="p">(</span><span class="vi">@order</span><span class="p">).</span><span class="nf">deliver!</span>

      <span class="n">redirect_to</span> <span class="n">order_path</span><span class="p">(</span><span class="vi">@order</span><span class="p">.</span><span class="nf">token</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'carts/checkout'</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
</pre></div>
</figure>

<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "add OrderMailer function"
</pre></div>
</figure>
<h2>结果</h2>
<p>回到购物车，去下一张订单，浏览器应该除了会跳到订单支付页面外，还会跳出一个邮件预览页面。</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/wtByWcjJRnm03MKR9e1G_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-09-21%20%E4%B8%8B%E5%8D%882.56.20.png" title=""></figure></p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/XPHS3GWnTMKBq6bJs6Wf_jdstore-posts:235.gif" title=""></figure></p>

    </div>
  </div></div><div class='frame'><h1>
      11-1 情境和 Model 准备
    </h1><h4>所属章节：11-后台出货订单操作</h4><hr><div class="post group">
    <div class="post-content markdown">
      <h2>目标</h2>
<p>我们的订单系统其实应该分为六种以上的状态</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/OlKrqkd8QfqeMk8ek5zf_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-03%20%E4%B8%8B%E5%8D%883.15.13.png" title=""></figure></p>

<ul>
<li>已下订（order_placed）</li>
<li>已付款（paid）</li>
<li>出货中（shipping）</li>
<li>到货（shipped）</li>
<li>取消订单（order_cancelled）</li>
<li>退货（good_returned）</li>
</ul>

<p>其中只有「已下订」能前进到「已付款」，只有「已下定」或「已付款」可以变成「取消订单」。只有「到货」可以变成「退货」等等。</p>

<p>其余皆属于非法操作。</p>

<p>但是这个架构实践起来却非常复杂，我们这一章会介绍「有限状态机」这个架构去将后台订单切换状态这个功能实践出来，以让管理员可以真正的操作出货或者退货流程。</p>
<h2>步骤</h2>
<h3>Step 1: AASM</h3>
<p>安装 gem "aasm"</p>

<figure class="figure-code code"><figcaption><span>Gemfile 
</span></figcaption><div class="highlight"><pre><span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
<span class="o">+</span> <span class="n">gem</span> <span class="s1">'aasm'</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
</pre></div>
</figure>

<p><code>bundle install</code><br>
记得重开 <code>rails s</code></p>
<h3>Step 2: 新增 aasm_state 栏位</h3>
<p><code>rails g migration add_aasm_state_to_order</code></p>

<figure class="figure-code code"><figcaption><span>db/migrate/xxx(一堆数字)_add_aasm_state_to_order.rb 
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddAasmStateToOrder</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
<span class="o">+</span>   <span class="n">add_column</span> <span class="ss">:orders</span><span class="p">,</span> <span class="ss">:aasm_state</span><span class="p">,</span> <span class="ss">:string</span><span class="p">,</span> <span class="ss">default: </span><span class="s2">"order_placed"</span>
<span class="o">+</span>   <span class="n">add_index</span>  <span class="ss">:orders</span><span class="p">,</span> <span class="ss">:aasm_state</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</figure>

<p><code>rake db:migrate</code></p>

<p><br></p>
<h3>Step 3 : 设定订单状态机制</h3>
<p>在order.rb 插入以下的程式码</p>

<figure class="figure-code code"><figcaption><span>app/models/order.rb 
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
  <span class="kp">include</span> <span class="no">AASM</span>

  <span class="n">aasm</span> <span class="k">do</span>
    <span class="n">state</span> <span class="ss">:order_placed</span><span class="p">,</span> <span class="ss">initial: </span><span class="kp">true</span>
    <span class="n">state</span> <span class="ss">:paid</span>
    <span class="n">state</span> <span class="ss">:shipping</span>
    <span class="n">state</span> <span class="ss">:shipped</span>
    <span class="n">state</span> <span class="ss">:order_cancelled</span>
    <span class="n">state</span> <span class="ss">:good_returned</span>


    <span class="n">event</span> <span class="ss">:make_payment</span> <span class="k">do</span>
      <span class="n">transitions</span> <span class="ss">from: :order_placed</span><span class="p">,</span> <span class="ss">to: :paid</span>
    <span class="k">end</span>

    <span class="n">event</span> <span class="ss">:ship</span> <span class="k">do</span>
      <span class="n">transitions</span> <span class="ss">from: :paid</span><span class="p">,</span>         <span class="ss">to: :shipping</span>
    <span class="k">end</span>

    <span class="n">event</span> <span class="ss">:deliver</span> <span class="k">do</span>
      <span class="n">transitions</span> <span class="ss">from: :shipping</span><span class="p">,</span>     <span class="ss">to: :shipped</span>
    <span class="k">end</span>

    <span class="n">event</span> <span class="ss">:return_good</span> <span class="k">do</span>
      <span class="n">transitions</span> <span class="ss">from: :shipped</span><span class="p">,</span>      <span class="ss">to: :good_returned</span>
    <span class="k">end</span>

    <span class="n">event</span> <span class="ss">:cancel_order</span> <span class="k">do</span>
      <span class="n">transitions</span> <span class="ss">from: </span><span class="p">[</span><span class="ss">:order_placed</span><span class="p">,</span> <span class="ss">:paid</span><span class="p">],</span> <span class="ss">to: :order_cancelled</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</figure>
<h3>Step 4 : 用 AASM 的机制设定订单付款</h3>
<figure class="figure-code code"><figcaption><span>app/controllers/orders_controller.rb 
</span></figcaption><div class="highlight"><pre><span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">pay_with_alipay</span>
    <span class="vi">@order</span> <span class="o">=</span> <span class="no">Order</span><span class="p">.</span><span class="nf">find_by_token</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="vi">@order</span><span class="p">.</span><span class="nf">set_payment_with!</span><span class="p">(</span><span class="s2">"alipay"</span><span class="p">)</span>
<span class="o">-</span>   <span class="vi">@order</span><span class="p">.</span><span class="nf">pay!</span>
<span class="o">+</span>   <span class="vi">@order</span><span class="p">.</span><span class="nf">make_payment!</span>

    <span class="n">redirect_to</span> <span class="n">order_path</span><span class="p">(</span><span class="vi">@order</span><span class="p">.</span><span class="nf">token</span><span class="p">),</span> <span class="ss">notice: </span><span class="s2">"使用支付宝成功完成付款"</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">pay_with_wechat</span>
    <span class="vi">@order</span> <span class="o">=</span> <span class="no">Order</span><span class="p">.</span><span class="nf">find_by_token</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="vi">@order</span><span class="p">.</span><span class="nf">set_payment_with!</span><span class="p">(</span><span class="s2">"wechat"</span><span class="p">)</span>
<span class="o">-</span>   <span class="vi">@order</span><span class="p">.</span><span class="nf">pay!</span>
<span class="o">+</span>   <span class="vi">@order</span><span class="p">.</span><span class="nf">make_payment!</span>

    <span class="n">redirect_to</span> <span class="n">order_path</span><span class="p">(</span><span class="vi">@order</span><span class="p">.</span><span class="nf">token</span><span class="p">),</span> <span class="ss">notice: </span><span class="s2">"使用微信支付成功完成付款"</span>
  <span class="k">end</span>
  
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
</pre></div>
</figure>

<figure class="figure-code code"><figcaption><span>app/models/order.rb 
</span></figcaption><div class="highlight"><pre><span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
<span class="o">-</span>    <span class="n">event</span> <span class="ss">:make_payment</span> <span class="k">do</span>
<span class="o">+</span>    <span class="n">event</span> <span class="ss">:make_payment</span><span class="p">,</span> <span class="ss">after_commit: :pay!</span> <span class="k">do</span>
       <span class="n">transitions</span> <span class="ss">from: :order_placed</span><span class="p">,</span> <span class="ss">to: :paid</span>
     <span class="k">end</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
</pre></div>
</figure>

<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "add aasm_state to order"
</pre></div>
</figure>
<h2>结果</h2>
<p>重新操作一次订单建立与付款流程后，到 <code>rails c</code> 输入Order.last 检查 aasm_state 是否正确(应显示为 paid)。</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Ait3qE7nSYu4snD8kgEq_jdstore-posts:237.gif" title=""></figure></p>

    </div>
  </div></div><div class='frame'><h1>
      11-2 订单状态切换
    </h1><h4>所属章节：11-后台出货订单操作</h4><hr><div class="post group">
    <div class="post-content markdown">
      <h2>目标</h2>
<ul>
<li>建立 admin/orders 可以看到系统内所有订单</li>
<li>admin 的 order 列表应要能显示订单状态</li>
<li>使用者可以“申请取消订单”</li>
<li>使用者“申请取消订单”后，管理员应该要收到“申请通知信”</li>
<li>后台管理员可以“取消订单”、“出货”</li>
<li>后台管理“出货”后，系统应该寄出通知信</li>
<li>后台管理员“取消订单”后，系统应该寄出通知信</li>
</ul>
<h2>步骤</h2>
<h3>建立 admin/orders 可以看到系统内所有订单</h3>
<h4>Step 1: 建立 admin/orders 的 controller &amp; views</h4>
<p><code>rails g controller admin::orders</code></p>

<figure class="figure-code code"><figcaption><span>config/routes.rb 
</span></figcaption><div class="highlight"><pre><span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
  <span class="n">namespace</span> <span class="ss">:admin</span> <span class="k">do</span>
    <span class="n">resources</span> <span class="ss">:products</span>
<span class="o">+</span>   <span class="n">resources</span> <span class="ss">:orders</span>
  <span class="k">end</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
</pre></div>
</figure>

<figure class="figure-code code"><figcaption><span>app/controllers/admin/orders_controller.rb 
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">Admin</span><span class="o">::</span><span class="no">OrdersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">layout</span> <span class="s2">"admin"</span>

  <span class="n">before_action</span> <span class="ss">:authenticate_user!</span>
  <span class="n">before_action</span> <span class="ss">:admin_required</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@orders</span> <span class="o">=</span> <span class="no">Order</span><span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="s2">"id DESC"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</figure>

<figure class="figure-code code"><figcaption><span>app/views/layouts/admin.html.erb
</span></figcaption><div class="highlight"><pre>...(略)
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-2"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav nav-pills nav-stacked"</span> <span class="na">style=</span><span class="s">"max-width: 300px;"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;li&gt;</span> <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">"Products"</span><span class="p">,</span> <span class="n">admin_products_path</span><span class="p">)</span> <span class="cp">%&gt;</span> <span class="nt">&lt;/li&gt;</span>
+          <span class="nt">&lt;li&gt;</span> <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">"Orders"</span><span class="p">,</span> <span class="n">admin_orders_path</span><span class="p">)</span> <span class="cp">%&gt;</span> <span class="nt">&lt;/li&gt;</span>
        <span class="nt">&lt;/ul&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
...(略)
</pre></div>
</figure>

<p><code>touch app/views/admin/orders/index.html.erb</code></p>

<figure class="figure-code code"><figcaption><span>app/views/admin/orders/index.html.erb 
</span></figcaption><div class="highlight"><pre><span class="nt">&lt;h2&gt;</span>订单列表 <span class="nt">&lt;/h2&gt;</span>

<span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">"table table-bordered"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;thead&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
      <span class="nt">&lt;th&gt;</span>#<span class="nt">&lt;/th&gt;</span>
      <span class="nt">&lt;th&gt;</span>生成时间<span class="nt">&lt;/th&gt;</span>
      <span class="nt">&lt;th&gt;</span>订购者<span class="nt">&lt;/th&gt;</span>
      <span class="nt">&lt;th&gt;</span>订单状态<span class="nt">&lt;/th&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
  <span class="nt">&lt;/thead&gt;</span>
  <span class="nt">&lt;tbody&gt;</span>
    <span class="cp">&lt;%</span> <span class="vi">@orders</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">order</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
      <span class="nt">&lt;td&gt;</span> <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="n">order</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="n">admin_order_path</span><span class="p">(</span><span class="n">order</span><span class="p">)</span> <span class="p">)</span> <span class="cp">%&gt;</span> <span class="nt">&lt;/td&gt;</span>
      <span class="nt">&lt;td&gt;</span> <span class="cp">&lt;%=</span> <span class="n">order</span><span class="p">.</span><span class="nf">created_at</span><span class="p">.</span><span class="nf">to_s</span><span class="p">(</span><span class="ss">:long</span><span class="p">)</span> <span class="cp">%&gt;</span> <span class="nt">&lt;/td&gt;</span>
      <span class="nt">&lt;td&gt;</span> <span class="cp">&lt;%=</span> <span class="n">order</span><span class="p">.</span><span class="nf">user</span><span class="p">.</span><span class="nf">email</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
      <span class="nt">&lt;td&gt;</span> <span class="cp">&lt;%=</span> <span class="n">order</span><span class="p">.</span><span class="nf">aasm_state</span> <span class="cp">%&gt;</span> <span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

  <span class="nt">&lt;/tbody&gt;</span>
<span class="nt">&lt;/table&gt;</span>
</pre></div>
</figure>

<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "add admin/orders"
</pre></div>
</figure>

<p><br></p>
<h4>Step 2: 建立后台订单页面</h4>
<figure class="figure-code code"><figcaption><span>app/controllers/admin/orders_controller.rb 
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">Admin</span><span class="o">::</span><span class="no">OrdersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
  
<span class="o">+</span> <span class="k">def</span> <span class="nf">show</span>
<span class="o">+</span>   <span class="vi">@order</span> <span class="o">=</span> <span class="no">Order</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
<span class="o">+</span>   <span class="vi">@product_lists</span> <span class="o">=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">product_lists</span>
<span class="o">+</span> <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</figure>

<p><code>touch app/views/admin/orders/show.html.erb</code></p>

<figure class="figure-code code"><figcaption><span>app/views/admin/orders/show.html.erb 
</span></figcaption><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
   <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-12"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;h2&gt;</span> 订单明细 (<span class="cp">&lt;%=</span> <span class="n">render_order_paid_state</span><span class="p">(</span><span class="vi">@order</span><span class="p">)</span> <span class="cp">%&gt;</span>) <span class="nt">&lt;/h2&gt;</span>

    <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">"table table-bordered"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;thead&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
          <span class="nt">&lt;th</span> <span class="na">width=</span><span class="s">"80%"</span><span class="nt">&gt;</span>商品明细<span class="nt">&lt;/th&gt;</span>
          <span class="nt">&lt;th&gt;</span>单价<span class="nt">&lt;/th&gt;</span>
          <span class="nt">&lt;th&gt;</span>数量<span class="nt">&lt;/th&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
      <span class="nt">&lt;/thead&gt;</span>
      <span class="nt">&lt;tbody&gt;</span>

        <span class="cp">&lt;%</span> <span class="vi">@product_lists</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product_list</span><span class="o">|</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;td&gt;</span>
              <span class="cp">&lt;%=</span> <span class="n">product_list</span><span class="p">.</span><span class="nf">product_name</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;</span>
              <span class="cp">&lt;%=</span> <span class="n">product_list</span><span class="p">.</span><span class="nf">product_price</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;</span>
              <span class="cp">&lt;%=</span> <span class="n">product_list</span><span class="p">.</span><span class="nf">quantity</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;/td&gt;</span>
          <span class="nt">&lt;/tr&gt;</span>
        <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

      <span class="nt">&lt;/tbody&gt;</span>
    <span class="nt">&lt;/table&gt;</span>

    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"total clearfix"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"pull-right"</span><span class="nt">&gt;</span>
       总计 <span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">total</span> <span class="cp">%&gt;</span> CNY
       <span class="nt">&lt;/span&gt;</span>
     <span class="nt">&lt;/div&gt;</span>

     <span class="nt">&lt;hr&gt;</span>

     <span class="nt">&lt;h2&gt;</span> 寄送资讯 <span class="nt">&lt;/h2&gt;</span>

     <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">"table table-striped table-bordered"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;tbody&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
          <span class="nt">&lt;td&gt;</span>
            订购人
          <span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
          <span class="nt">&lt;td&gt;</span>
            <span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">billing_name</span> <span class="cp">%&gt;</span> - <span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">billing_address</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
          <span class="nt">&lt;td&gt;</span>
            收件人
          <span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
          <span class="nt">&lt;td&gt;</span>
            <span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">shipping_name</span> <span class="cp">%&gt;</span> - <span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">shipping_address</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
      <span class="nt">&lt;/tbody&gt;</span>
    <span class="nt">&lt;/table&gt;</span>

  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</figure>

<figure class="figure-code code"><figcaption><span>app/helpers/orders_helper.rb 
</span></figcaption><div class="highlight"><pre><span class="k">module</span> <span class="nn">OrdersHelper</span>
<span class="o">+</span> <span class="k">def</span> <span class="nf">render_order_paid_state</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
<span class="o">+</span>   <span class="k">if</span> <span class="n">order</span><span class="p">.</span><span class="nf">is_paid?</span>
<span class="o">+</span>     <span class="s2">"已付款"</span>
<span class="o">+</span>   <span class="k">else</span>
<span class="o">+</span>     <span class="s2">"未付款"</span>
<span class="o">+</span>   <span class="k">end</span>
<span class="o">+</span> <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</figure>

<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "implement admin/orders show function"
</pre></div>
</figure>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/21QYc2AkSGCYo8jz30DX_jdstore-posts:238g1.gif" title=""></figure></p>

<p><br></p>
<h4>Step 3: 后台的订单可以依照“按照状态图”改变状态</h4>
<figure class="figure-code code"><figcaption><span>config/routes.rb 
</span></figcaption><div class="highlight"><pre><span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
  <span class="n">namespace</span> <span class="ss">:admin</span> <span class="k">do</span>
    <span class="n">resources</span> <span class="ss">:products</span>
<span class="o">-</span>   <span class="n">resources</span> <span class="ss">:orders</span>
<span class="o">+</span>   <span class="n">resources</span> <span class="ss">:orders</span> <span class="k">do</span>
<span class="o">+</span>     <span class="n">member</span> <span class="k">do</span>
<span class="o">+</span>       <span class="n">post</span> <span class="ss">:cancel</span>
<span class="o">+</span>       <span class="n">post</span> <span class="ss">:ship</span>
<span class="o">+</span>       <span class="n">post</span> <span class="ss">:shipped</span>
<span class="o">+</span>       <span class="n">post</span> <span class="ss">:return</span>
<span class="o">+</span>     <span class="k">end</span>
<span class="o">+</span>   <span class="k">end</span>
  <span class="k">end</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
</pre></div>
</figure>

<p>admin/orders_controller.rb 放入以下 action</p>

<figure class="figure-code code"><figcaption><span>app/controllers/admin/orders_controller.rb 
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">Admin</span><span class="o">::</span><span class="no">OrdersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">ship</span>
    <span class="vi">@order</span> <span class="o">=</span> <span class="no">Order</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="vi">@order</span><span class="p">.</span><span class="nf">ship!</span>
    <span class="n">redirect_to</span> <span class="ss">:back</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">shipped</span>
    <span class="vi">@order</span> <span class="o">=</span> <span class="no">Order</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="vi">@order</span><span class="p">.</span><span class="nf">deliver!</span>
    <span class="n">redirect_to</span> <span class="ss">:back</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">cancel</span>
    <span class="vi">@order</span> <span class="o">=</span> <span class="no">Order</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="vi">@order</span><span class="p">.</span><span class="nf">cancel_order!</span>
    <span class="n">redirect_to</span> <span class="ss">:back</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">return</span>
    <span class="vi">@order</span> <span class="o">=</span> <span class="no">Order</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="vi">@order</span><span class="p">.</span><span class="nf">return_good!</span>
    <span class="n">redirect_to</span> <span class="ss">:back</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</figure>

<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "add ship/shipped/cancel/return action to admin/orders_controller"
</pre></div>
</figure>

<p><br></p>
<h4>Step 4: 新增异动订单状态的按钮</h4>
<p><code>touch app/views/admin/orders/_state_option.html.erb</code></p>

<figure class="figure-code code"><figcaption><span>app/views/admin/orders/_state_option.html.erb 
</span></figcaption><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">"padding:10px; float:right;"</span><span class="nt">&gt;</span>

  <span class="cp">&lt;%</span> <span class="k">case</span> <span class="n">order</span><span class="p">.</span><span class="nf">aasm_state</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">when</span> <span class="s2">"order_placed"</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">"取消订单"</span><span class="p">,</span>
                <span class="n">cancel_admin_order_path</span><span class="p">(</span><span class="n">order</span><span class="p">),</span>
                <span class="ss">class: </span><span class="s2">"btn btn-default btn-sm"</span><span class="p">,</span> <span class="ss">method: :post</span><span class="p">)</span> <span class="cp">%&gt;</span>

  <span class="cp">&lt;%</span> <span class="k">when</span> <span class="s2">"paid"</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">"取消订单"</span><span class="p">,</span>
                <span class="n">cancel_admin_order_path</span><span class="p">(</span><span class="n">order</span><span class="p">),</span>
                <span class="ss">class: </span><span class="s2">"btn btn-default btn-sm"</span><span class="p">,</span> <span class="ss">method: :post</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">"出货"</span><span class="p">,</span>
                <span class="n">ship_admin_order_path</span><span class="p">(</span><span class="n">order</span><span class="p">),</span>
                <span class="ss">class: </span><span class="s2">"btn btn-default btn-sm"</span><span class="p">,</span> <span class="ss">method: :post</span><span class="p">)</span> <span class="cp">%&gt;</span>

  <span class="cp">&lt;%</span> <span class="k">when</span> <span class="s2">"shipping"</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">"设为已出货"</span><span class="p">,</span>
                <span class="n">shipped_admin_order_path</span><span class="p">(</span><span class="n">order</span><span class="p">),</span>
                <span class="ss">class: </span><span class="s2">"btn btn-default btn-sm"</span><span class="p">,</span> <span class="ss">method: :post</span><span class="p">)</span> <span class="cp">%&gt;</span>

  <span class="cp">&lt;%</span> <span class="k">when</span> <span class="s2">"shipped"</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">"退货"</span><span class="p">,</span>
                <span class="n">return_admin_order_path</span><span class="p">(</span><span class="n">order</span><span class="p">),</span>
                <span class="ss">class: </span><span class="s2">"btn btn-default btn-sm"</span><span class="p">,</span> <span class="ss">method: :post</span><span class="p">)</span> <span class="cp">%&gt;</span>

  <span class="cp">&lt;%</span> <span class="k">when</span> <span class="s2">"order_cancelled"</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"label label-default"</span><span class="nt">&gt;</span>订单已取消<span class="nt">&lt;/span&gt;</span>

  <span class="cp">&lt;%</span> <span class="k">when</span> <span class="s2">"good_returned"</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"label label-default"</span><span class="nt">&gt;</span>已退货<span class="nt">&lt;/span&gt;</span>

  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

<span class="nt">&lt;/div&gt;</span>
</pre></div>
</figure>

<figure class="figure-code code"><figcaption><span>app/views/admin/orders/show.html.erb 
</span></figcaption><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
   <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-12"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;h2&gt;</span> 订单明细 (<span class="cp">&lt;%=</span> <span class="n">render_order_paid_state</span><span class="p">(</span><span class="vi">@order</span><span class="p">)</span> <span class="cp">%&gt;</span>) <span class="nt">&lt;/h2&gt;</span>

+   <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s2">"admin/orders/state_option"</span><span class="p">,</span> <span class="ss">order: </span><span class="vi">@order</span> <span class="cp">%&gt;</span>

    <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">"table table-bordered"</span><span class="nt">&gt;</span>
...(略)
</pre></div>
</figure>

<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "add admin/orders/state_option button"
</pre></div>
</figure>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/EK4GJJ51R8y8svWJ5WBJ_jdstore-posts:238g2.gif" title=""></figure></p>

<p><br></p>
<h4>Step 5: 用户取消订单</h4>
<figure class="figure-code code"><figcaption><span>app/controllers/orders_controller.rb 
</span></figcaption><div class="highlight"><pre><span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">apply_to_cancel</span>
    <span class="vi">@order</span> <span class="o">=</span> <span class="no">Order</span><span class="p">.</span><span class="nf">find_by_token</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="no">OrderMailer</span><span class="p">.</span><span class="nf">apply_cancel</span><span class="p">(</span><span class="vi">@order</span><span class="p">).</span><span class="nf">deliver!</span>
    <span class="n">flash</span><span class="p">[</span><span class="ss">:notice</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"已提交申请"</span>
    <span class="n">redirect_to</span> <span class="ss">:back</span>
  <span class="k">end</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
</pre></div>
</figure>

<figure class="figure-code code"><figcaption><span>config/routes.rb 
</span></figcaption><div class="highlight"><pre>  <span class="n">resources</span> <span class="ss">:orders</span> <span class="k">do</span>
    <span class="n">member</span> <span class="k">do</span>
      <span class="n">post</span> <span class="ss">:pay_with_alipay</span>
      <span class="n">post</span> <span class="ss">:pay_with_wechat</span>
<span class="o">+</span>     <span class="n">post</span> <span class="ss">:apply_to_cancel</span>
    <span class="k">end</span>
  <span class="k">end</span>
</pre></div>
</figure>

<p>修改订单页面，增加使用者申请取消订单按钮:</p>

<figure class="figure-code code"><figcaption><span>app/views/orders/show.html.erb 
</span></figcaption><div class="highlight"><pre><span class="nt">&lt;/table&gt;</span>

+   <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"pull-left"</span><span class="nt">&gt;</span>
+     <span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">order_placed?</span> <span class="o">||</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">paid?</span> <span class="cp">%&gt;</span>
+       <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">"申请取消订单"</span><span class="p">,</span> <span class="n">apply_to_cancel_order_path</span><span class="p">(</span><span class="vi">@order</span><span class="p">.</span><span class="nf">token</span><span class="p">),</span> <span class="ss">method: :post</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"btn  btn-info"</span><span class="p">)</span> <span class="cp">%&gt;</span>
+     <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
+   <span class="nt">&lt;/div&gt;</span>

<span class="cp">&lt;%</span> <span class="k">if</span> <span class="o">!</span><span class="vi">@order</span><span class="p">.</span><span class="nf">is_paid?</span> <span class="cp">%&gt;</span>
</pre></div>
</figure>

<figure class="figure-code code"><figcaption><span>app/mailers/order_mailer.rb 
</span></figcaption><div class="highlight"><pre><span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">apply_cancel</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
    <span class="vi">@order</span>       <span class="o">=</span> <span class="n">order</span>
    <span class="vi">@user</span>        <span class="o">=</span> <span class="n">order</span><span class="p">.</span><span class="nf">user</span>
    <span class="vi">@product_lists</span> <span class="o">=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">product_lists</span>

    <span class="n">mail</span><span class="p">(</span><span class="ss">to: </span><span class="s2">"admin@test.com"</span> <span class="p">,</span> <span class="ss">subject: </span><span class="s2">"[JDStore] 用户</span><span class="si">#{</span><span class="n">order</span><span class="p">.</span><span class="nf">user</span><span class="p">.</span><span class="nf">email</span><span class="si">}</span><span class="s2">申请取消订单 </span><span class="si">#{</span><span class="n">order</span><span class="p">.</span><span class="nf">token</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
</pre></div>
</figure>

<p><code>touch app/views/order_mailer/apply_cancel.html.erb</code></p>

<figure class="figure-code code"><figcaption><span>app/views/order_mailer/apply_cancel.html.erb 
</span></figcaption><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-12"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h2&gt;</span>
      订单明细 <span class="nt">&lt;br&gt;</span>
      <span class="nt">&lt;small&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">"订单连结"</span><span class="p">,</span> <span class="n">order_url</span><span class="p">(</span><span class="vi">@order</span><span class="p">.</span><span class="nf">token</span><span class="p">))</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/small&gt;</span>
    <span class="nt">&lt;/h2&gt;</span>
    <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">"table table-bordered"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;thead&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
          <span class="nt">&lt;th</span> <span class="na">width=</span><span class="s">"70%"</span><span class="nt">&gt;</span>商品明细<span class="nt">&lt;/th&gt;</span>
          <span class="nt">&lt;th&gt;</span>单价<span class="nt">&lt;/th&gt;</span>
          <span class="nt">&lt;th&gt;</span>数量<span class="nt">&lt;/th&gt;</span>
          <span class="nt">&lt;th&gt;</span>小记<span class="nt">&lt;/th&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
      <span class="nt">&lt;/thead&gt;</span>
      <span class="nt">&lt;tbody&gt;</span>

        <span class="cp">&lt;%</span> <span class="vi">@product_lists</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product_list</span><span class="o">|</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;td&gt;</span>
              <span class="cp">&lt;%=</span> <span class="n">product_list</span><span class="p">.</span><span class="nf">product_name</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;</span>
              <span class="cp">&lt;%=</span> <span class="n">product_list</span><span class="p">.</span><span class="nf">product_price</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;</span>
              <span class="cp">&lt;%=</span> <span class="n">product_list</span><span class="p">.</span><span class="nf">quantity</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;</span>
              <span class="cp">&lt;%=</span> <span class="n">product_list</span><span class="p">.</span><span class="nf">quantity</span> <span class="o">*</span> <span class="n">product_list</span><span class="p">.</span><span class="nf">product_price</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;/td&gt;</span>
          <span class="nt">&lt;/tr&gt;</span>
        <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

      <span class="nt">&lt;/tbody&gt;</span>
    <span class="nt">&lt;/table&gt;</span>

    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"total group clearfix"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;h4</span> <span class="na">class=</span><span class="s">"pull-right"</span><span class="nt">&gt;</span>
        总计 <span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">total</span> <span class="cp">%&gt;</span> CNY
      <span class="nt">&lt;/h4&gt;</span>
     <span class="nt">&lt;/div&gt;</span>

     <span class="nt">&lt;hr&gt;</span>

     <span class="nt">&lt;h2&gt;</span> 寄送资讯 <span class="nt">&lt;/h2&gt;</span>

     <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">"table table-striped table-bordered"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;tbody&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
          <span class="nt">&lt;td&gt;</span> 订购人 <span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
          <span class="nt">&lt;td&gt;</span>
            <span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">billing_name</span> <span class="cp">%&gt;</span> - <span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">billing_address</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
          <span class="nt">&lt;td&gt;</span> 收件者 <span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
          <span class="nt">&lt;td&gt;</span>
            <span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">shipping_name</span> <span class="cp">%&gt;</span> - <span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">shipping_address</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
      <span class="nt">&lt;/tbody&gt;</span>
    <span class="nt">&lt;/table&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</figure>

<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "add apply_cancel function"
</pre></div>
</figure>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ehT78SCkRyWy3m1jPFxy_jdstore-posts:238g3.gif" title=""></figure></p>

<p><br></p>
<h4>Step 6: 在出货/取消订单后，系统应该寄出通知信</h4>
<figure class="figure-code code"><figcaption><span>app/controllers/admin/orders_controller.rb 
</span></figcaption><div class="highlight"><pre><span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">ship</span>
    <span class="vi">@order</span> <span class="o">=</span> <span class="no">Order</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="vi">@order</span><span class="p">.</span><span class="nf">ship!</span>
<span class="o">+</span>   <span class="no">OrderMailer</span><span class="p">.</span><span class="nf">notify_ship</span><span class="p">(</span><span class="vi">@order</span><span class="p">).</span><span class="nf">deliver!</span>
    <span class="n">redirect_to</span> <span class="ss">:back</span>
  <span class="k">end</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">cancel</span>
    <span class="vi">@order</span> <span class="o">=</span> <span class="no">Order</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="vi">@order</span><span class="p">.</span><span class="nf">cancel_order!</span>
<span class="o">+</span>   <span class="no">OrderMailer</span><span class="p">.</span><span class="nf">notify_cancel</span><span class="p">(</span><span class="vi">@order</span><span class="p">).</span><span class="nf">deliver!</span>
    <span class="n">redirect_to</span> <span class="ss">:back</span>
  <span class="k">end</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
</pre></div>
</figure>

<p>在 <code>order_mailer.rb</code> 新增</p>

<figure class="figure-code code"><figcaption><span>app/mailers/order_mailer.rb 
</span></figcaption><div class="highlight"><pre><span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">notify_ship</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
    <span class="vi">@order</span>        <span class="o">=</span> <span class="n">order</span>
    <span class="vi">@user</span>         <span class="o">=</span> <span class="n">order</span><span class="p">.</span><span class="nf">user</span>
    <span class="vi">@product_lists</span> <span class="o">=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">product_lists</span>

    <span class="n">mail</span><span class="p">(</span><span class="ss">to: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="ss">subject: </span><span class="s2">"[JDStore] 您的订单 </span><span class="si">#{</span><span class="n">order</span><span class="p">.</span><span class="nf">token</span><span class="si">}</span><span class="s2">已发货"</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">notify_cancel</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
    <span class="vi">@order</span>        <span class="o">=</span> <span class="n">order</span>
    <span class="vi">@user</span>         <span class="o">=</span> <span class="n">order</span><span class="p">.</span><span class="nf">user</span>
    <span class="vi">@product_lists</span> <span class="o">=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">product_lists</span>

    <span class="n">mail</span><span class="p">(</span><span class="ss">to: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="ss">subject: </span><span class="s2">"[JDStore] 您的订单 </span><span class="si">#{</span><span class="n">order</span><span class="p">.</span><span class="nf">token</span><span class="si">}</span><span class="s2">已取消"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
</pre></div>
</figure>

<p><code>touch app/views/order_mailer/notify_cancel.html.erb</code></p>

<figure class="figure-code code"><figcaption><span>app/views/order_mailer/notify_cancel.html.erb 
</span></figcaption><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-12"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h2&gt;</span>
      订单明细 <span class="nt">&lt;br&gt;</span>
      <span class="nt">&lt;small&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">"订单连结"</span><span class="p">,</span> <span class="n">order_url</span><span class="p">(</span><span class="vi">@order</span><span class="p">.</span><span class="nf">token</span><span class="p">))</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/small&gt;</span>
    <span class="nt">&lt;/h2&gt;</span>
    <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">"table table-bordered"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;thead&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
          <span class="nt">&lt;th</span> <span class="na">width=</span><span class="s">"70%"</span><span class="nt">&gt;</span>商品明细<span class="nt">&lt;/th&gt;</span>
          <span class="nt">&lt;th&gt;</span>单价<span class="nt">&lt;/th&gt;</span>
          <span class="nt">&lt;th&gt;</span>数量<span class="nt">&lt;/th&gt;</span>
          <span class="nt">&lt;th&gt;</span>小记<span class="nt">&lt;/th&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
      <span class="nt">&lt;/thead&gt;</span>
      <span class="nt">&lt;tbody&gt;</span>

        <span class="cp">&lt;%</span> <span class="vi">@product_lists</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product_list</span><span class="o">|</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;td&gt;</span>
              <span class="cp">&lt;%=</span> <span class="n">product_list</span><span class="p">.</span><span class="nf">product_name</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;</span>
              <span class="cp">&lt;%=</span> <span class="n">product_list</span><span class="p">.</span><span class="nf">product_price</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;</span>
              <span class="cp">&lt;%=</span> <span class="n">product_list</span><span class="p">.</span><span class="nf">quantity</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;</span>
              <span class="cp">&lt;%=</span> <span class="n">product_list</span><span class="p">.</span><span class="nf">quantity</span> <span class="o">*</span> <span class="n">product_list</span><span class="p">.</span><span class="nf">product_price</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;/td&gt;</span>
          <span class="nt">&lt;/tr&gt;</span>
        <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

      <span class="nt">&lt;/tbody&gt;</span>
    <span class="nt">&lt;/table&gt;</span>

    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"total group clearfix"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;h4</span> <span class="na">class=</span><span class="s">"pull-right"</span><span class="nt">&gt;</span>
        总计 <span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">total</span> <span class="cp">%&gt;</span> CNY
      <span class="nt">&lt;/h4&gt;</span>
     <span class="nt">&lt;/div&gt;</span>

     <span class="nt">&lt;hr&gt;</span>

     <span class="nt">&lt;h2&gt;</span> 寄送资讯 <span class="nt">&lt;/h2&gt;</span>

     <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">"table table-striped table-bordered"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;tbody&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
          <span class="nt">&lt;td&gt;</span> 订购人 <span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
          <span class="nt">&lt;td&gt;</span>
            <span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">billing_name</span> <span class="cp">%&gt;</span> - <span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">billing_address</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
          <span class="nt">&lt;td&gt;</span> 收件者 <span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
          <span class="nt">&lt;td&gt;</span>
            <span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">shipping_name</span> <span class="cp">%&gt;</span> - <span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">shipping_address</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
      <span class="nt">&lt;/tbody&gt;</span>
    <span class="nt">&lt;/table&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</figure>

<p><code>touch app/views/order_mailer/notify_ship.html.erb</code></p>

<figure class="figure-code code"><figcaption><span>app/views/order_mailer/notify_ship.html.erb 
</span></figcaption><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-12"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h2&gt;</span>
      订单明细 <span class="nt">&lt;br&gt;</span>
      <span class="nt">&lt;small&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">"订单连结"</span><span class="p">,</span> <span class="n">order_url</span><span class="p">(</span><span class="vi">@order</span><span class="p">.</span><span class="nf">token</span><span class="p">))</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/small&gt;</span>
    <span class="nt">&lt;/h2&gt;</span>
    <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">"table table-bordered"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;thead&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
          <span class="nt">&lt;th</span> <span class="na">width=</span><span class="s">"70%"</span><span class="nt">&gt;</span>商品明细<span class="nt">&lt;/th&gt;</span>
          <span class="nt">&lt;th&gt;</span>单价<span class="nt">&lt;/th&gt;</span>
          <span class="nt">&lt;th&gt;</span>数量<span class="nt">&lt;/th&gt;</span>
          <span class="nt">&lt;th&gt;</span>小记<span class="nt">&lt;/th&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
      <span class="nt">&lt;/thead&gt;</span>
      <span class="nt">&lt;tbody&gt;</span>

        <span class="cp">&lt;%</span> <span class="vi">@product_lists</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product_list</span><span class="o">|</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;td&gt;</span>
              <span class="cp">&lt;%=</span> <span class="n">product_list</span><span class="p">.</span><span class="nf">product_name</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;</span>
              <span class="cp">&lt;%=</span> <span class="n">product_list</span><span class="p">.</span><span class="nf">product_price</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;</span>
              <span class="cp">&lt;%=</span> <span class="n">product_list</span><span class="p">.</span><span class="nf">quantity</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;</span>
              <span class="cp">&lt;%=</span> <span class="n">product_list</span><span class="p">.</span><span class="nf">quantity</span> <span class="o">*</span> <span class="n">product_list</span><span class="p">.</span><span class="nf">product_price</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;/td&gt;</span>
          <span class="nt">&lt;/tr&gt;</span>
        <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

      <span class="nt">&lt;/tbody&gt;</span>
    <span class="nt">&lt;/table&gt;</span>

    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"total group clearfix"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;h4</span> <span class="na">class=</span><span class="s">"pull-right"</span><span class="nt">&gt;</span>
        总计 <span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">total</span> <span class="cp">%&gt;</span> CNY
      <span class="nt">&lt;/h4&gt;</span>
     <span class="nt">&lt;/div&gt;</span>

     <span class="nt">&lt;hr&gt;</span>

     <span class="nt">&lt;h2&gt;</span> 寄送资讯 <span class="nt">&lt;/h2&gt;</span>

     <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">"table table-striped table-bordered"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;tbody&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
          <span class="nt">&lt;td&gt;</span> 订购人 <span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
          <span class="nt">&lt;td&gt;</span>
            <span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">billing_name</span> <span class="cp">%&gt;</span> - <span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">billing_address</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
          <span class="nt">&lt;td&gt;</span> 收件者 <span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
          <span class="nt">&lt;td&gt;</span>
            <span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">shipping_name</span> <span class="cp">%&gt;</span> - <span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">shipping_address</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
      <span class="nt">&lt;/tbody&gt;</span>
    <span class="nt">&lt;/table&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</figure>

<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "add notify_cancel/ship function"
</pre></div>
</figure>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/oX8zB0JBQjy5xq8bW6es_jdstore-posts:238g4.gif" title=""></figure></p>

    </div>
  </div></div><div class='frame'><h1>
      商店创意大赛参赛手册
    </h1><h4>所属章节：12-部署到 Heroku （七牛云）</h4><hr><div class="post group">
    <div class="post-content markdown">
      <h3><a href="https://www.filepicker.io/api/file/BW4zCvlWTgSpi6uato3T">请点击这里下载参赛手册并打印出来</a></h3>
    </div>
      <div class="device">
  <div class="device__screen flex">
    <img id="file" src="https://www.filepicker.io/api/file/BW4zCvlWTgSpi6uato3T/convert?page=1" alt="" class="img-responsive">

    <div class="text-center">
      <br>
      <div class="page-info ">
        页码
        <span class="current-page">
          1
        </span>
        /
        <span class="total-pages"></span>
        <a class="underline" target="_blank" href="https://www.filepicker.io/api/file/BW4zCvlWTgSpi6uato3T">下载简报</a>
      </div>

      <br>
      <button id="previous" class="page-nav  page-nav--left">
        <i class="fa  fa-lg  fa-chevron-left"></i>
      </button>

           
      <button id="next" class="page-nav  page-nav--right">
        <i class="fa  fa-lg  fa-chevron-right"></i>
      </button>
    </div>
  </div>
</div>


  </div></div><div class='frame'><h1>
      [直播回放]5月22日 Xdite 从新手到冠军的实践之路
    </h1><h4>所属章节：12-部署到 Heroku （七牛云）</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>主讲人：<br>
Xdite老师</p>

<p>时间：<br>
5月22日 周一 20:00</p>

<p>时长：<br>
本次直播总时长30分钟。</p>

<p>概要：<br>
Xdite 从新手到冠军的实践之路</p>

<p>提示：<br>
需要科学上网才可以正常观看本视频<br>
如果画面模糊请到右下角设置中将画质调整为720p<br>
<br></p>

<p>Anndo同学的直播笔记 <a href="http://anndo-blog.logdown.com/posts/1864643" rel="nofollow" target="_blank">http://anndo-blog.logdown.com/posts/1864643</a></p>

    </div>
      <script src="//fast.wistia.com/embed/medias/dothqsxk62.jsonp" async></script>
<script src="//fast.wistia.com/assets/external/E-v1.js" async></script>
<div class="player-bg">
    <div class="loading-tips">
        <button class="btn btn-default btn-lg">
            <i class="fa fa-spinner fa-spin"></i>
        </button>
        <p>视频文件正在加载，请确保已经打开VPN</p>
    </div>
    <div class="wistia_responsive_padding" style="padding:56.25% 0 0 0;position:relative;">
        <div class="wistia_responsive_wrapper" style="height:100%;left:0;position:absolute;top:0;width:100%;">
            <div class="wistia_embed wistia_async_dothqsxk62 videoFoam=true" style="height:100%;width:100%"> </div>
            <script>
                window._wq = window._wq || [];
                _wq.push({ id: "dothqsxk62", onReady: function(video) {
                    window.wistia_video = video;
                    var url = "/user_wistia_position_records/update_position";
                    var post_id = "1276"; 
                    setInterval(function(){                        
                        if (wistia_video.state() === "playing") {
                            var data = {
                                position: wistia_video.time(),
                                post_id: post_id 
                            };                            
                            $.post(url, data);
                        }                        
                    }, 5000);
                }});
            </script>            
        </div>
    </div>
</div>

  </div></div><div class='frame'><h1>
      12-1 本章学习指南
    </h1><h4>所属章节：12-部署到 Heroku （七牛云）</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>本章，我们要把JDstore部署到heroku。</p>

<p>和以往的专案不同的是，我们要在生产环境（真实环境）实现上传图片和发送邮件的功能，这里使用七牛云存储图片，最后使用SendCloud服务发送邮件。</p>

<p>而要使用这两个服务，我们还需要使用figaro进行密码管理，避免安全信息泄露。</p>

<p>所以，以下教材必读！并且按照这个顺序阅读：</p>

<p><a href="https://fullstack.xinshengdaxue.com/posts/702">一些安全概念</a></p>

<p><a href="https://fullstack.xinshengdaxue.com/posts/712">申请七牛云（用来储存图片）</a></p>

<p><a href="https://fullstack.xinshengdaxue.com/posts/713">使用 Figaro 管理密码</a> </p>

<p><a href="https://fullstack.xinshengdaxue.com/posts/714">部署 JDStore 到 Heroku</a></p>

<p><a href="https://fullstack.xinshengdaxue.com/posts/706">使用SendCloud服务发送邮件</a></p>

    </div>
  </div></div><div class='frame'><h1>
      12-2 一些安全概念 (本节只需要看，不需要实作)
    </h1><h4>所属章节：12-部署到 Heroku （七牛云）</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>各位都已经有部署产品到 Heroku 的经验了。但是这里，我们需要强调一些安全观念。</p>

<p>在以往的教材里，我们都是教大家把密码写死在 .rb 档案里面，但是这样其实是很危险的。当我们把专案上传到 github 上后，github 是全世界都可以看的，这样就相当于把你的私人密码公布给大家，可想而知你的私人财产毫无保障。</p>

<p>我们可以上网看看，网络上常常有这样的惨案，坏人偷了你的钥匙后……</p>

<p><figure><img src="http://7xqmjb.com1.z0.glb.clouddn.com/2017020381957Screenshot%20at%20Feb%2003%2022-19-36.png" title=""></figure></p>

<p><figure><img src="http://7xqmjb.com1.z0.glb.clouddn.com/2017020360467Screenshot%20at%20Feb%2003%2022-21-03.png" title=""></figure></p>

<p>为了不让这些惨案发生在自己身上，我们需要增强自己的密码管理意识。</p>

<p>那么，我们应该如何管理自己的密钥呢？</p>
<h4>首先：<strong>密码不要放在 .rb 档案里面</strong>
</h4>
<p>(如下图所示的写法是很危险的)</p>

<p><figure><img src="http://7xqmjb.com1.z0.glb.clouddn.com/2017020662808snip20170206_30.png" title=""></figure></p>
<h4>其次：<strong>把密码放在 .yml 档案里面</strong>
</h4>
<p>在做大项目的时候，我们需要与人协作。大家在 fork 或者 clone job-listing 和 jdstore 专案的时候，应该会发现一件事情，我给大家的是 database.yml.example，是因为我们不把自己真的 key（真的 key 在 database.yml 档里）给别人。所以在本地的时候就需要准备一份 database.yml.example （这是范例档，给同事知道有这个档——为了协作）。也就是说，上传到 github 上的是 database.yml.example 档。<br>
（如下图所示的写法才是正确的）</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/D4o7snRRGsYosZGRyY0A_Screenshot%20at%20Feb%2017%2020-26-52.png" title=""></figure></p>
<h4>最后：<strong>.gitignore 设定不要上传 database.yml</strong>
</h4>
<p>我们要在 .gitignore（我们不要上传的档）加入 database.yml 档<br>
（如下图所示的写法才是正确的）</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/zSmPwfaURIeZASdvxUO7_Screenshot%20at%20Feb%2015%2021-38-04.png" title=""></figure></p>

<p>这样我们就可以让自己的秘钥不上传到 github 上了。在接下来的课程里，我们更需要有这些正确的安全观念。</p>

<p><br></p>
<h3>正确安全观念</h3>
<p>• 密码用 figaro 管理</p>

<p>figaro 是一个方便管理机密信息、密码的gem，并且能一个指令就将机密信息同步到 Heroku上。</p>

<p>• ENV 环境变数</p>

<p>把密码设置到环境变量里，然后调用这些变量。这样就能在隐藏密码的同时，使用它们。<br>
注意：carrierwave.rb 中只需要填写 AWS_ACCESS_KEY_ID（不用填写真实的密码），figaro自己会进行调用。</p>

    </div>
  </div></div><div class='frame'><h1>
      12-3 使用七牛云（用来存储图片）
    </h1><h4>所属章节：12-部署到 Heroku （七牛云）</h4><hr><div class="post group">
    <div class="post-content markdown">
      <blockquote>
<p>注意：AWS S3 存储图片（方案1）与七牛云存储图片（方案2）切勿混用！</p>
</blockquote>
<h2>目标</h2>
<p>注册<a href="https://www.qiniu.com/">七牛云</a></p>

<p>创建存储空间，用来存储图片</p>
<h2>步骤</h2>
<h3>Step 1: 注册七牛云</h3>
<p>申请个人账户</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/R49PeafuQD2yF0tnjvLm_Screen%20Shot%202017-02-19%20at%2013.47.29.png" title=""></figure></p>

<p>注册后需要激活邮箱</p>

<p>在个人面板 -&gt; 密钥管理中，可以查看AccessKey/SecretKey，后面会用到</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Ji0YehzaQc2o2kDsZoPB_Screen%20Shot%202017-02-19%20at%2014.40.44.png" title=""></figure></p>
<h3>Step 2: 创建存储空间</h3>
<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/toE828w6TDCiDpwLzoPQ_Screen%20Shot%202017-02-19%20at%2019.19.53.png" title=""></figure></p>

<p>这些信息后面会用到</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/MtQjrNfQRurCbEdQrpJA_Screen%20Shot%202017-02-19%20at%2019.26.41.png" title=""></figure></p>
<h3>Step 3: 在专案中设置七牛云</h3>
<p><code>git checkout -b qiniu</code></p>

<figure class="figure-code code"><figcaption><span>Gemfile
</span></figcaption><div class="highlight"><pre><span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
<span class="o">+</span> <span class="n">gem</span> <span class="s1">'carrierwave-qiniu'</span>
<span class="o">+</span> <span class="n">gem</span> <span class="s1">'qiniu-rs'</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
</pre></div>
</figure>

<p><code>bundle install</code></p>

<p><code>bundle update</code></p>

<p><code>touch config/initializers/carrierwave.rb</code></p>

<figure class="figure-code code"><figcaption><span>config/initializers/carrierwave.rb
</span></figcaption><div class="highlight"><pre><span class="no">CarrierWave</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">storage</span>             <span class="o">=</span> <span class="ss">:qiniu</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">qiniu_access_key</span>    <span class="o">=</span> <span class="no">ENV</span><span class="p">[</span><span class="s2">"qiniu_access_key"</span><span class="p">]</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">qiniu_secret_key</span>    <span class="o">=</span> <span class="no">ENV</span><span class="p">[</span><span class="s2">"qiniu_secret_key"</span><span class="p">]</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">qiniu_bucket</span>        <span class="o">=</span> <span class="no">ENV</span><span class="p">[</span><span class="s2">"qiniu_bucket"</span><span class="p">]</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">qiniu_bucket_domain</span> <span class="o">=</span> <span class="no">ENV</span><span class="p">[</span><span class="s2">"qiniu_bucket_domain"</span><span class="p">]</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">qiniu_block_size</span>    <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">qiniu_protocol</span>      <span class="o">=</span> <span class="s2">"http"</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">qiniu_up_host</span>       <span class="o">=</span> <span class="s2">"http://up.qiniu.com"</span>  <span class="c1">#选择不同的区域时，"up.qiniu.com" 不同
</span>
<span class="k">end</span>
</pre></div>
</figure>

<p>将图片存储位置改为七牛</p>

<figure class="figure-code code"><figcaption><span>app/uploaders/image_uploader.rb 
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">ImageUploader</span> <span class="o">&lt;</span> <span class="no">CarrierWave</span><span class="o">::</span><span class="no">Uploader</span><span class="o">::</span><span class="no">Base</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
<span class="o">-</span> <span class="n">storage</span> <span class="ss">:file</span>
<span class="o">+</span> <span class="c1"># storage :file
</span>
<span class="o">+</span> <span class="n">storage</span> <span class="ss">:qiniu</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
</pre></div>
</figure>

<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "config qiniu"
</pre></div>
</figure>

    </div>
  </div></div><div class='frame'><h1>
      12-4 使用 Figaro 管理密码
    </h1><h4>所属章节：12-部署到 Heroku （七牛云）</h4><hr><div class="post group">
    <div class="post-content markdown">
      <h2>为什么我们需要 figaro？</h2>
<p>当我们使用 Github 存储我们代码的时候，一些诸如 AccessKey 等密钥信息是不能够让其他人获得的，但项目中又需要提供配置信息。</p>

<p>figaro是一个方便管理机密信息、密钥的gem，并且能一个指令就将机密信息同步到heroku上，如此一来密钥也不会外泄。</p>
<h3>Step 1: 安装 figaro</h3>
<figure class="figure-code code"><figcaption><span>
</span></figcaption><div class="highlight"><pre>+ gem 'figaro'
</pre></div>
</figure>

<p><code>bundle install</code></p>

<p><code>figaro install</code></p>

<p>会自动生成 config/application.yml 文件并自动添加到 .gitignore 档案里<br>
<figure><img src="http://user-image.logdown.io/user/19197/blog/18708/post/1383092/b5ktTYYGRbqmfpbF9pxU_Snip20170205_27.png" title=""></figure></p>
<h3>Step 2: 设定机密信息</h3>
<p><code>cp config/application.yml config/application.yml.example</code></p>

<p>修改 config/application.yml 档案</p>

<p>{备注：config/application.yml 档案有可能被隐藏了，所以我们要把它调出来。打开 atom 编辑器里的 settings（可以通过 command+ 逗号快速调出） -&gt; packages。在搜索栏中输入 tree，在 tree-view 中点选 settings，把 Hide VCS Ignored Files 的勾去掉就会显示出来了。}</p>

<figure class="figure-code code"><figcaption><span>config/application.yml
</span></figcaption><div class="highlight"><pre><span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>

 <span class="ss">production:
   qiniu_access_key: </span><span class="n">xxxx</span>  <span class="c1"># 你的 qiniu AccessKey
</span>
   <span class="ss">qiniu_secret_key: </span><span class="n">xxxx</span>  <span class="c1"># 你的 qiniu SecretKey
</span>
   <span class="ss">qiniu_bucket: </span><span class="n">xxxx</span>  <span class="c1"># 你的 qiniu bucket
</span>
   <span class="ss">qiniu_bucket_domain: </span><span class="n">xxxx</span>  <span class="c1"># 你的 qiniu bucket domain
</span>


 <span class="ss">development:
   qiniu_access_key: </span><span class="n">xxxx</span>  <span class="c1"># 你的 qiniu AccessKey
</span>
   <span class="ss">qiniu_secret_key: </span><span class="n">xxxx</span>  <span class="c1"># 你的 qiniu SecretKey
</span>
   <span class="ss">qiniu_bucket: </span><span class="n">xxxx</span>  <span class="c1"># 你的 qiniu bucket
</span>
   <span class="ss">qiniu_bucket_domain: </span><span class="n">xxxx</span>  <span class="c1"># 你的 qiniu bucket domain
</span>

</pre></div>
</figure>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/7PIMYGk5Sg2N32ymTM5j_Screenshot%20at%20Feb%2022%2021-16-13.png" title=""></figure></p>

<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "figaro"
</pre></div>
</figure>

    </div>
  </div></div><div class='frame'><h1>
      12-5 将JDStore部署到Heroku
    </h1><h4>所属章节：12-部署到 Heroku （七牛云）</h4><hr><div class="post group">
    <div class="post-content markdown">
      <h2>目标</h2>
<ul>
<li>将密钥设定同步到Heroku</li>
<li>将JDStore部署到Heroku</li>
</ul>

<p><br></p>
<h2>步骤</h2>
<h3>Step 1: 修改 Gemfile 档案</h3>
<p>把 sqlite3 从第7行搬到 group :development, :test do 中间</p>

<p><figure><img src="http://ww1.sinaimg.cn/large/006tNbRwjw1fb5t9ep5udj30dc03ydg7.jpg" title=""></figure></p>

<p>在末尾新增一个 production group，加上 pg 这个 gem</p>

<figure class="figure-code code"><div class="highlight"><pre>group :production do 
  gem 'pg'
end 
</pre></div>
</figure>

<p><figure><img src="http://ww3.sinaimg.cn/large/006tNbRwjw1fb5vm23d6wj30ft03zwex.jpg" title=""></figure></p>

<p>command+s 存档</p>

<p>修改 Gemfile 后要 <code>bundle install</code></p>

<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "move sqlite3 to dev group &amp; add pg to production group"
</pre></div>
</figure>

<p>具体可以参考第一课<a href="https://fullstack.xinshengdaxue.com/posts/26" target="_blank">相关章节</a>以及<a href="http://docs.qzy.camp/docs/heroku" target="_blank">帮助文档</a></p>

<p><br></p>
<h3>Step 2: 创建heroku app并将设定好的机密资讯同步到这个app</h3>
<p><code>heroku create</code> 先创建一个heroku app</p>

<p><code>figaro heroku:set -e production</code></p>

<p><code>heroku config</code> 可以列出目前所有的设定</p>
<h3>Step 3: 上传到github和heroku</h3>
<figure class="figure-code code"><div class="highlight"><pre>git push origin qiniu
git push heroku qiniu:master
heroku run rake db:migrate
</pre></div>
</figure>
<h4>提示：如何在本地设置环境变数</h4>
<ul>
<li><a href="http://thejavashop.net/blog/?p=5" rel="nofollow" target="_blank">http://thejavashop.net/blog/?p=5</a></li>
</ul>

<p><br></p>
<h4>提示：如何在 Heroku 设置环境变数</h4>
<ul>
<li><a href="https://devcenter.heroku.com/articles/config-vars" rel="nofollow" target="_blank">https://devcenter.heroku.com/articles/config-vars</a></li>
</ul>

    </div>
  </div></div><div class='frame'><h1>
      12-6 JDStore 商店创意大赛（第二季）参赛指南
    </h1><h4>所属章节：12-部署到 Heroku （七牛云）</h4><hr><div class="post group">
    <div class="post-content markdown">
      <h3>活动时间</h3>
<p>2017年5月22日00:00~2017年6月11日23:59<br>
<br></p>
<h3>活动内容</h3>
<p>以VIP课程《Rails实战：购物网站》的实作项目为基本框架，并以开发真实网站为结果导向，对网站本身进行产品定位，然后设计网站的功能、页面。<br>
<br></p>
<h3>参赛资格</h3>
<p>1.本次活动仅限本网站VIP用户投稿参赛作品<br>
2.每个参赛作品必须由两名VIP用户组队参加<br>
3.比赛进行期间均可提交参赛作品<br>
4.参赛作品由参赛小组其中一个成员提交即可，不得重复提交<br>
5.已在JSstore商店创意大赛第一季获得一等奖、二等奖的VIP用户不可重复参加本次比赛<br>
<br></p>
<h3>投票说明</h3>
<p>1.投票时间为2017年5月24日0:00至6月11日23:59<br>
2.本网站的免费用户/VIP用户均可为参赛作品投票<br>
3.每个用户最多可以为10个不同的作品投票<br>
4.每个用户只能为同一个作品投一次票（免费用户一次投票＝1票，VIP用户一次投票＝5票）<br>
5.投票后无法撤销投票<br>
<br></p>
<h3>评选规则</h3>
<p>1.至活动截止日期，我们将按得票数高低依次评选出一等奖、二等奖、优秀奖<br>
2.评审特设奖将由Xdite老师从所有的参赛作品中选定(可重复获奖)<br>
3.最佳心得奖将从参赛成员在「购物网站」作业提交的Logdown心得中评选(可重复获奖)<br>
4.我们还将从所有完成10次投票的用户(含VIP和免费用户)中随机挑选20名送出投票参与奖<br>
<br></p>
<h3>结果公布</h3>
<p>1.活动结束后，我们将会有专门的页面公布结果/集中展示获奖作品<br>
2.获奖作品的奖品以每组2人为单位进行奖励（如一等奖共奖励两把 Aeron 座椅，该小组的两名成员每人各获得一把Aeron座椅）<br>
3.如果您在活动中获奖，我们将按照您填写的收货地址寄送奖品（请所有参赛者和投票者在“我的账户”中完善收货地址）<br>
<br></p>
<h2>FAQ</h2>
<p>Q：第一期没留级，还能参加第二期商店创意大赛吗？</p>

<p>A：可以，只要是全栈营VIP用户，并且没有在JSstore商店创意大赛第一季获得一等奖、二等奖的，都可以参赛。<br>
<br></p>

<p>Q：课程需要学到什么程度才能参加商店创意大赛？</p>

<p>A：只要你跟着教材完成了JDStore的课程就可以参加大赛。<br>
<br></p>

<p>Q：怎样才可以有底气参加商店创意大赛？现在心里没底。</p>

<p>A：一开始不要追求完美，尽快把自己的作品呈现出来。好的产品/作品都是经过一层层迭代才变得越来越好的。所以只要你先提交了作品，你就赢了60%的人。<br>
<br></p>

<p>Q：怎么安排时间，分解任务呢？</p>

<p>A：可以重新观看直播回放<a href="https://fullstack.xinshengdaxue.com/posts/1202" target="_blank">《5月11日 xdite教你如何科学准备商店创意大赛》</a>，学习时间约37分钟，磨刀不误砍柴功，期待在商店创意大赛中看到你的作品。<br>
<br></p>

<p>Q：除了基本的套路之外, 有没有排名前面的套路？</p>

<p>A：有。</p>

<ul>
<li>在课程《Rails实战：商店网站》的基础上优化页面并添加小功能。</li>
<li>做完《Rails实战：商店网站》即可发布自己的作品第一版，后续再对页面和功进行优化和添加。</li>
<li>把网站中已有的按钮功能都实作出来（实在做不出来的可以暂时砍掉），并写成可实操的小教程，发布在论坛或者自己的博客里（有利于其他小伙伴给你投票哦）。</li>
<li>可参考的技术资源有：<a href="https://fullstack.xinshengdaxue.com/courses/31/syllabus" target="_blank">教材《Rails实战：购物网站》</a>、<a href="https://forum.qzy.camp/" target="_blank">交流论坛</a>、<a href="https://fullstack.xinshengdaxue.com/competitions/2" target="_blank">往期参赛作品</a>等。</li>
<li>可参考的网站资源：<a href="http://bootsnipp.com/" rel="nofollow" target="_blank">http://bootsnipp.com/</a> <a href="https://themeforest.net/" rel="nofollow" target="_blank">https://themeforest.net/</a>
</li>
<li>新功能很重要，但是页面的美观和主题的创意也都是很重要的。</li>
<li>积极在slack、微信、论坛上帮助其他小伙伴debug（这时候可以让小伙伴们给你的作品投票哦，不仅践行了教就是最好的学，也为自己拉到了宝贵的票）。</li>
</ul>

<p><br></p>

    </div>
  </div></div><div class='frame'><h1>
      12-7 使用SendCloud服务发送邮件
    </h1><h4>所属章节：12-部署到 Heroku （七牛云）</h4><hr><div class="post group">
    <div class="post-content markdown">
      <h2>目标</h2>
<ul>
<li>之前的章节中，我们学习了<a href="https://fullstack.xinshengdaxue.com/posts/697">如何寄信和预览邮件</a>
</li>
<li>在真实环境中，需要使用邮件发送服务才可以真正发送邮件</li>
<li>本节教给大家如何使用中国大陆的SendCloud服务让用户收到邮件</li>
</ul>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/7mSBOnmzQaOMbm3Ezklj_%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-13%2016.35.17.png" title=""></figure></p>
<h2>步骤</h2>
<h3>Step 1: 注册SendCloud</h3>
<p><a href="http://sendcloud.net/">http://sendcloud.net/</a></p>

<p>将生成的<code>API_USER</code>和<code>API_KEY</code>信息保存下来</p>

<p>如果忘记 <code>API_KEY</code>，可以到 <code>发送设置</code> 生成一个新的</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/6IcbgG2Ty2aevQcYmXDg_3bLoUnjtR5qYNPSPjk3r_WX20170209-105306.png" title=""></figure></p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/9fV4p037SfaE5oD2VfdR_ng2cBeGRGKRr6ftEj3gH_WX20170209-105808.png" title=""></figure></p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/4hkObqRATYGks7DsPeSu_vtk2KiN2SJq4YXf9UQar_WX20170209-111805.png" title=""></figure></p>
<h3>Step 2: 修改文件</h3>
<p>修改开发环境用于本地测试</p>

<figure class="figure-code code"><figcaption><span>config/environments/development.rb
</span></figcaption><div class="highlight"><pre><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
<span class="err">－</span>    <span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">delivery_method</span> <span class="o">=</span> <span class="ss">:letter_opener</span>
<span class="err">＋</span>  <span class="c1"># config.action_mailer.delivery_method = :letter_opener
</span>
<span class="err">＋</span>  <span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">delivery_method</span> <span class="o">=</span> <span class="ss">:smtp</span>
<span class="err">＋</span>  <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">smtp_settings</span> <span class="o">=</span> <span class="p">{</span>
<span class="err">＋</span>    <span class="ss">address: </span><span class="s2">"smtpcloud.sohu.com"</span><span class="p">,</span>
<span class="err">＋</span>    <span class="ss">port: </span><span class="mi">25</span><span class="p">,</span>
<span class="err">＋</span>    <span class="ss">domain: </span><span class="s2">"heroku.com"</span><span class="p">,</span>
<span class="err">＋</span>    <span class="ss">authentication: </span><span class="s2">"login"</span><span class="p">,</span>
<span class="err">＋</span>    <span class="ss">enable_starttls_auto: </span><span class="kp">true</span><span class="p">,</span>
<span class="err">＋</span>    <span class="ss">user_name: </span><span class="no">ENV</span><span class="p">[</span><span class="s2">"SEND_CLOUD_USER_NAME"</span><span class="p">],</span>
<span class="err">＋</span>    <span class="ss">password: </span><span class="no">ENV</span><span class="p">[</span><span class="s2">"SEND_CLOUD_USER_KEY"</span><span class="p">]</span>
<span class="err">＋</span>    <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</figure>

<p>修改生产环境用于heroku使用</p>

<figure class="figure-code code"><figcaption><span>config/environments/production.rb
</span></figcaption><div class="highlight"><pre><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>

<span class="o">+</span>  <span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">default_url_options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:host</span> <span class="o">=&gt;</span> <span class="s1">'你的herokuapp地址'</span><span class="p">}</span>

<span class="o">+</span>  <span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">delivery_method</span> <span class="o">=</span> <span class="ss">:smtp</span>
<span class="o">+</span>  <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">smtp_settings</span> <span class="o">=</span> <span class="p">{</span>
<span class="o">+</span>    <span class="ss">address: </span><span class="s2">"smtpcloud.sohu.com"</span><span class="p">,</span>
<span class="o">+</span>    <span class="ss">port: </span><span class="mi">25</span><span class="p">,</span>
<span class="o">+</span>    <span class="ss">domain: </span><span class="s2">"heroku.com"</span><span class="p">,</span>
<span class="o">+</span>    <span class="ss">authentication: </span><span class="s2">"login"</span><span class="p">,</span>
<span class="o">+</span>    <span class="ss">enable_starttls_auto: </span><span class="kp">true</span><span class="p">,</span>
<span class="o">+</span>    <span class="ss">user_name: </span><span class="no">ENV</span><span class="p">[</span><span class="s2">"SEND_CLOUD_USER_NAME"</span><span class="p">],</span>
<span class="o">+</span>    <span class="ss">password: </span><span class="no">ENV</span><span class="p">[</span><span class="s2">"SEND_CLOUD_USER_KEY"</span><span class="p">]</span>
<span class="o">+</span>    <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</figure>

<figure class="figure-code code"><figcaption><span>config/application.yml
</span></figcaption><div class="highlight"><pre><span class="ss">production:
  </span><span class="no">AWS_ACCESS_KEY_ID</span><span class="p">:</span> <span class="s2">"xxxx"</span>
  <span class="no">AWS_SECRET_ACCESS_KEY</span><span class="p">:</span> <span class="s2">"xxxx"</span>
  <span class="no">AWS_REGION</span><span class="p">:</span> <span class="s2">"xxxx"</span>
  <span class="no">AWS_BUCKET_NAME</span><span class="p">:</span> <span class="s2">"xxxx"</span>
<span class="o">+</span> <span class="no">SEND_CLOUD_USER_NAME</span><span class="p">:</span> <span class="s2">"xxxx"</span>  <span class="c1"># 你的 API_USER
</span>
<span class="o">+</span> <span class="no">SEND_CLOUD_USER_KEY</span><span class="p">:</span> <span class="s2">"xxxx"</span>  <span class="c1"># 你的 API_KEY 
</span>


<span class="ss">development:
  </span><span class="no">AWS_ACCESS_KEY_ID</span><span class="p">:</span> <span class="s2">"xxxx"</span>
  <span class="no">AWS_SECRET_ACCESS_KEY</span><span class="p">:</span> <span class="s2">"xxxx"</span>
  <span class="no">AWS_REGION</span><span class="p">:</span> <span class="s2">"xxxx"</span>
  <span class="no">AWS_BUCKET_NAME</span><span class="p">:</span> <span class="s2">"xxxx"</span>
<span class="o">+</span> <span class="no">SEND_CLOUD_USER_NAME</span><span class="p">:</span> <span class="s2">"xxxx"</span>  <span class="c1"># 你的 API_USER
</span>
<span class="o">+</span> <span class="no">SEND_CLOUD_USER_KEY</span><span class="p">:</span> <span class="s2">"xxxx"</span>  <span class="c1"># 你的 API_KEY 
</span></pre></div>
</figure>
<h3>Step 3: 本地测试</h3>
<p>重开rails server</p>

<p>请用真实邮箱注册登录你的网站，生成订单后查收注册邮箱，收到邮件即可确认成功</p>

<p>如果出现下图报错，请断开VPN再测试</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/EVFrmz1ATsifxV0brJr8_%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-13%2015.12.57.png" title=""></figure></p>
<h3>Step 4: 部署到heroku</h3>
<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "sendcloud settings"
figaro heroku:set -e production
git push heroku story5:master
</pre></div>
</figure>

<p>同样请用真实邮箱注册登录你的网站，生成订单后查收注册邮箱，收到邮件即可确认成功</p>

    </div>
  </div></div><div class='frame'><h1>
      12-8 Rails 环境架构
    </h1><h4>所属章节：12-部署到 Heroku （七牛云）</h4><hr><div class="post group">
    <div class="post-content markdown">
      <h2>Rails 架构</h2>
<p>各位在 Rails 的 <code>config/enviorments/</code> 下面应该会看到三个档案，分别代表了 Rails 里面运行的三种模式：</p>

<ul>
<li>development</li>
<li>test</li>
<li>production</li>
</ul>

<p>Rails 的哲学是：开发者可以只写一套代码，透过截取不同环境设定档（<code>config/enviorments/*.rb</code>）以及不同数据库 (<code>config/database.yml</code>) 来达到不同环境的数据库部署与系统设置。</p>

<p>如此以来可以让代码保持干净，不必在代码里面针对硬性写死代码，处理一些「正式」与「开发」环境上的例外。</p>
<h3>development</h3>
<p>所谓的 development 就是开发模式，平常我们在本地电脑用的就是这种模式，包括</p>

<ul>
<li><code>rails s</code></li>
<li><code>rails c</code></li>
</ul>

<p>读取的都是本地开发模式。这个开发模式故障时可直接看到程式码可以 debug。</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/6gwJGGDlRxiAnpcFHYTm_development.png" title=""></figure></p>
<h3>production</h3>
<p>而 production 就是正式环境，heroku 就属于正式环境部署平台的一种。在正式环境上出错了，使用者只会看到 500 画面。</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/F41YWhdXSv6QbNTZejCQ_pr.png" title=""></figure></p>
<h3>test</h3>
<p>这个模式，是「测试」模式。（但是不是各位想像的「手动测试」，我们将会在其他课程单独讲这个主题，目前先跳过不说）</p>

<p><br></p>
<h2>如何修改环境变数</h2>
<p>通常我们会修改 config/enviorments/xxx.rb 里面的档案。（有时候某些 gem 安装时就会请你修改这里面的设置）</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Cb3fGkwDT5SAzF4ggrNt_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-03%20%E4%B8%8B%E5%8D%883.59.37.png" title=""></figure></p>

<p>修改完记得要重开 <code>rails s</code> 才会生效</p>

<p><br></p>
<h2>如何在 Controller 里判断环境，而决定执行不同行为呢？</h2>
<p>有时候，我们要做的并不是改环境设置，而是有时候在测试某些功能，只在开发环境上有效。那么我们要如何做呢？</p>

<p>答案就是使用这个 Rails 提供的变量 <code>Rails.env</code>，这是一个字串，只会根据环境回传 <code>development</code>，<code>test</code>或是 <code>production</code>。</p>

<p>具体示范如下：</p>

<figure class="figure-code code"><figcaption><span>
</span></figcaption><div class="highlight"><pre><span class="k">def</span> <span class="nf">mail_to_customer</span>
<span class="err"> </span> <span class="k">if</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">env</span> <span class="o">==</span> <span class="s2">"development"</span>
    <span class="n">do_xxx</span>
<span class="err"> </span> <span class="k">else</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">do_yyy</span>
<span class="err"> </span> <span class="k">end</span>
<span class="k">end</span>

</pre></div>
</figure>

    </div>
  </div></div><div class='frame'><h1>
      12-9 如何在 Heroku 上 Debug
    </h1><h4>所属章节：12-部署到 Heroku （七牛云）</h4><hr><div class="post group">
    <div class="post-content markdown">
      <h3>目标</h3>
<ul>
<li>heroku logs/console/seed</li>
<li>安装套件 airbrake 实现自动通知 bug</li>
</ul>
<h3>步骤</h3>
<h4>Step 0:</h4>
<p>通常在 heroku 上的错误信息可以透过<code>heroku logs</code>来检查。</p>

<p>此外，heroku open 无法开启，通常是忘了输入</p>

<p><code>heroku run rake db:migrate</code></p>

<p>进入rails console的方式<br>
<code>heroku run rails console</code></p>

<p>如果有写seeds档案，可以执行</p>

<p><code>heroku run rake db:seed</code></p>

<p><br><br>
本章另外介绍 airbrake 这个服务，可以随时记录错误信息，并发送邮件通知网站出现 bug。</p>
<h4>Step 1: 注册 airbrake</h4>
<p>到 <a href="https://airbrake.io" rel="nofollow" target="_blank">https://airbrake.io</a> 注册帐号，选择 ESSENTIAL 方案(30天免费)</p>

<p>（记得14天后取消，否则会被收费）</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/XheD2eSKWr0yPMoEpAmA_Snip20170213_7.png" title=""></figure></p>

<p>输入subdomain、帐号、邮箱和密码</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/yQiN7duQCmtZLufhREBC_Snip20170213_8.png" title=""></figure></p>

<p>填写信用卡信息</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/lBRIrfzRTByOHAMylbru_Snip20170213_11.png" title=""></figure></p>

<p>新建 airbrake 项目，点击 Generate projects from GitHub</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/z1UgLe0lQgmgccTkWrzA_Snip20170213_12.png" title=""></figure></p>

<p>授权让 airbrake 接入 github，点击 Authorize application<br>
<figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/2RgCpnLfS48Zek9Arlvz_Snip20170213_13.png" title=""></figure></p>

<p>选择项目，点击 Create 1 project</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/u7arihwbT7GthKBm3INf_Snip20170213_18.png" title=""></figure></p>

<p>点击 Finish setup<br>
<figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Vz0ejzkMQGKqSLGRxtLk_Snip20170213_19.png" title=""></figure></p>
<h3>Step 2: 在项目里加上 gem airbrake</h3>
<p>在终端输入 <code>git checkout -b airbrake</code></p>

<p>安装 airbrake gem</p>

<figure class="figure-code code"><figcaption><span>Gemfile
</span></figcaption><div class="highlight"><pre>

<span class="o">+</span> <span class="n">gem</span> <span class="s1">'airbrake'</span><span class="p">,</span> <span class="s1">'~&gt; 5.4'</span>

</pre></div>
</figure>

<p><code>bundle install</code></p>

<p>输入<code>rails g airbrake PROJECT_ID PROJECT_KEY</code> 会产生档案如下</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/olrJ7woQRKxD17vlLCiw_Snip20170213_23.png" title=""></figure></p>

<p>将红框内的代码修改如下</p>

<figure class="figure-code code"><figcaption><span>config/initializers/airbrake.rb
</span></figcaption><div class="highlight"><pre>
<span class="o">-</span> <span class="n">c</span><span class="p">.</span><span class="nf">project_id</span> <span class="o">=</span> <span class="no">PROJECT_ID</span>
<span class="o">-</span> <span class="n">c</span><span class="p">.</span><span class="nf">project_key</span> <span class="o">=</span> <span class="s1">'PROJECT_KEY'</span>

<span class="o">+</span> <span class="n">c</span><span class="p">.</span><span class="nf">project_id</span> <span class="o">=</span> <span class="no">ENV</span><span class="p">[</span><span class="s1">'PROJECT_ID'</span><span class="p">]</span>
<span class="o">+</span> <span class="n">c</span><span class="p">.</span><span class="nf">project_key</span> <span class="o">=</span> <span class="no">ENV</span><span class="p">[</span><span class="s1">'PROJECT_KEY'</span><span class="p">]</span>
</pre></div>
</figure>

<p>在 airbrake 后台 =&gt; Project Settings，可以查找到 Project ID 和 Project API Key<br>
<figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/po3UcTJbS6KReqnVzKkA_Snip20170213_34.png" title=""></figure></p>

<p>将其添加到 config/application.yml 中</p>

<figure class="figure-code code"><figcaption><span>config/application.yml
</span></figcaption><div class="highlight"><pre><span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
  <span class="ss">prouction:
    </span><span class="no">AWS_ACCESS_KEY_ID</span><span class="p">:</span>  <span class="s2">"XXXX"</span>
    <span class="no">AWS_SECRET_ACCESS_KEY</span><span class="p">:</span>  <span class="s2">"XXXX"</span>
    <span class="no">AWS_REGION</span><span class="p">:</span>  <span class="s2">"XXXX"</span>
    <span class="no">AWS_BUCKET_NAME</span><span class="p">:</span>  <span class="s2">"XXXX"</span>
    <span class="no">SEND_CLOUND_USER_NAME</span><span class="p">:</span>  <span class="s2">"XXXX"</span>
    <span class="no">SEND_CLOUND_USER_KEY</span><span class="p">:</span>  <span class="s2">"XXXX"</span>
<span class="o">+</span>   <span class="no">PROJECT_ID</span><span class="p">:</span>  <span class="s2">"XXXX"</span>
<span class="o">+</span>   <span class="no">PROJECT_KEY</span><span class="p">:</span>   <span class="s2">"XXXX"</span>

  <span class="ss">development:
    </span><span class="no">AWS_ACCESS_KEY_ID</span><span class="p">:</span>  <span class="s2">"XXXX"</span>
    <span class="no">AWS_SECRET_ACCESS_KEY</span><span class="p">:</span>  <span class="s2">"XXXX"</span>
    <span class="no">AWS_REGION</span><span class="p">:</span>  <span class="s2">"XXXX"</span>
    <span class="no">AWS_BUCKET_NAME</span><span class="p">:</span>  <span class="s2">"XXXX"</span>
    <span class="no">SEND_CLOUND_USER_NAME</span><span class="p">:</span>  <span class="s2">"XXXX"</span>
    <span class="no">SEND_CLOUND_USER_KEY</span><span class="p">:</span>  <span class="s2">"XXXX"</span>
<span class="o">+</span>   <span class="no">PROJECT_ID</span><span class="p">:</span>  <span class="s2">"XXXX"</span>
<span class="o">+</span>   <span class="no">PROJECT_KEY</span><span class="p">:</span>   <span class="s2">"XXXX"</span>

</pre></div>
</figure>

<p>测试看看，在终端运行<br>
<code>rake airbrake:test</code><br>
（会得到一连串信息，是正常的。）</p>

<p>保存并上传到 heroku<br>
<code>git add .</code><br>
<code>git commit -m "install airbrake"</code><br>
<code>figaro heroku:set -e production</code><br>
<code>git push heroku airbrake:master</code></p>
<h4>Step 3: 效果</h4>
<p>若网站报错时：<br>
<figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/v7UkVcRPCev4UC8YaRQD_Snip20170213_28.png" title=""></figure></p>

<p>Airbrake 后台会自动收到错误信息：<br>
<figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/HVaNsjUWRZiX9UkHCSmV_Snip20170213_30.png" title=""></figure></p>

<p>邮箱里面也会收到错误信息通知：<br>
<figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/x817bgR0TwK7BFD7qhah_Snip20170213_32.png" title=""></figure></p>

<p>如此一来便可以随时追踪错误信息了！</p>
<h3>将帐户注销方式（避免收费）</h3>
<p>点击右上角帐户姓名，然后选择 Account &amp; Billing，并依照下图点击 Cancel Account（撤销帐户）</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/YuAk0cOZSTWVqmt4ZaYa_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-05-31%20%E4%B8%8B%E5%8D%882.05.59.png" title=""></figure></p>

<p>填写撤销原因，以及自己注册的domain</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/gtybgpbRvGS3fIsaWbyE_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-05-31%20%E4%B8%8B%E5%8D%882.11.43.png" title=""></figure></p>

    </div>
  </div></div><div class='frame'><h1>
      13-1 本章部属指南
    </h1><h4>所属章节：13-部署到 Heroku (海外用户方案)</h4><hr><div class="post group">
    <div class="post-content markdown">
      <blockquote>
<p>由于海外用户无法依据手机号办理七牛云相关服务，导致无法使用云储存服务将图片上传，本章节为海外用户的解决方案。</p>

<p>请已经做完七牛云的国内用户同学，直接<strong>略过此章节</strong>即可。</p>
</blockquote>

    </div>
  </div></div><div class='frame'><h1>
      13-2 申请AWS S3（用来储存图片）
    </h1><h4>所属章节：13-部署到 Heroku (海外用户方案)</h4><hr><div class="post group">
    <div class="post-content markdown">
      <blockquote>
<p>注意：<strong>AWS S3 存储图片</strong>与<strong>七牛云存储图片</strong>切勿混用！</p>
</blockquote>
<h3>目标</h3>
<ul>
<li>注册及设置AWS S3</li>
<li>没有信用卡的同学请使用<a href="https://fullstack.xinshengdaxue.com/posts/482">七牛云教程</a>（方案）</li>
</ul>

<p><br></p>
<h3>Step 0: 注册以及设置AWS S3</h3>
<ul>
<li>先注册 AWS 的帐号（需要Visa或MasterCard），注册完登入</li>
</ul>

<p><br></p>
<h3>Step 1: 根据AWS安全审查指南，创建 IAM 用户</h3>
<ul>
<li>在右上角点击你的帐号，选择「我的安全凭证」</li>
</ul>

<p><figure><img src="http://user-image.logdown.io/user/19197/blog/18708/post/1383092/G0ngnm8TpiwO5iLlyA3l_Snip20170204_12.png" title=""></figure><br>
<br></p>

<ul>
<li>添加用户</li>
</ul>

<p><figure><img src="http://user-image.logdown.io/user/19197/blog/18708/post/1383092/mX4f8ThJRtGXNQWjj2hT_Snip20170204_13.png" title=""></figure><br>
<br></p>

<ul>
<li>输入用户名和选择访问类型</li>
</ul>

<p><figure><img src="http://user-image.logdown.io/user/19197/blog/18708/post/1383092/3nc6dS08QHe7hGQiJVSj_Snip20170204_14.png" title=""></figure><br>
<br></p>

<ul>
<li>设定权限</li>
</ul>

<p><figure><img src="http://user-image.logdown.io/user/19197/blog/18708/post/1383092/AC8fNEpKRoWWSW4v36kV_Snip20170204_15.png" title=""></figure><br>
<br></p>

<ul>
<li>下载key文件，之后会用（里面有两个key，分别是access key ID和secret access key）</li>
</ul>

<p><figure><img src="http://user-image.logdown.io/user/19197/blog/18708/post/1383092/dPuvq5rHT9SieYONTOjH_Snip20170204_16.png" title=""></figure><br>
<br></p>

<ul>
<li>s3上创建存储桶Bucket</li>
</ul>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/w7tTYqhrQCmnTXMotI4T_Screenshot%20at%20Feb%2016%2015-21-39.png" title=""></figure><br>
<figure><img src="http://user-image.logdown.io/user/19197/blog/18708/post/1383092/0uEQY9pVQwO74RwQfJTb_Snip20170204_18.png" title=""></figure><br>
<br></p>

<ul>
<li>输入存储桶名称，选择区域</li>
</ul>

<p><figure><img src="http://user-image.logdown.io/user/19197/blog/18708/post/1383092/7uDtiGVATVCm8SB81VBr_Snip20170204_19.png" title=""></figure><br>
<br></p>
<h4>重点 :</h4>
<ul>
<li>要保护好 aws 的 id 与 key 不要 push 到 github 上面，避免被盗用</li>
</ul>
<h4>提示：Region位置</h4>
<ul>
<li><a href="http://docs.aws.amazon.com/general/latest/gr/rande.html#s3_region" rel="nofollow" target="_blank">http://docs.aws.amazon.com/general/latest/gr/rande.html#s3_region</a></li>
</ul>

<p><br></p>

    </div>
  </div></div><div class='frame'><h1>
      13-3 使用 Figaro 管理密码
    </h1><h4>所属章节：13-部署到 Heroku (海外用户方案)</h4><hr><div class="post group">
    <div class="post-content markdown">
      <blockquote>
<p>注意：AWS S3 存储图片（方案1）与七牛云存储图片（方案2）切勿混用！</p>
</blockquote>
<h2>为什么我们需要 figaro？</h2>
<p>当我们使用 Github 存储我们代码的时候，一些诸如 AccessKey 等密钥信息是不能够让其他人获得的，但项目中又需要提供配置信息。</p>

<p>figaro是一个方便管理机密信息、密钥的gem，并且能一个指令就将机密信息同步到heroku上，如此一来密钥也不会外泄。</p>
<h3>Step 1: 安装 figaro</h3>
<p><code>git checkout -b aws</code></p>

<p>打开 Gemfile，加入</p>

<figure class="figure-code code"><figcaption><span>Gemfile
</span></figcaption><div class="highlight"><pre>...(略)
+ gem 'figaro'
...(略)
</pre></div>
</figure>

<p><code>bundle install</code></p>

<p><code>figaro install</code></p>

<p>会自动生成 config/application.yml 文件并自动添加到 .gitignore 档案里<br>
<figure><img src="http://user-image.logdown.io/user/19197/blog/18708/post/1383092/b5ktTYYGRbqmfpbF9pxU_Snip20170205_27.png" title=""></figure></p>
<h3>Step 2: 设定机密信息</h3>
<p><code>cp config/application.yml config/application.yml.example</code></p>

<p>修改 config/application.yml 档案</p>

<p>{备注：config/application.yml 档案有可能被隐藏了，所以我们要把它调出来。打开 atom 编辑器里的 settings（可以通过 command+ 逗号快速调出） -&gt; packages。在搜索栏中输入 tree，在 tree-view 中点选 settings，把 Hide VCS Ignored Files 的勾去掉就会显示出来了。}</p>

<figure class="figure-code code"><figcaption><span>config/application.yml
</span></figcaption><div class="highlight"><pre><span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>

<span class="o">+</span> <span class="ss">production:
</span><span class="o">+</span>   <span class="no">AWS_ACCESS_KEY_ID</span><span class="p">:</span> <span class="s2">"xxxx"</span>  <span class="c1"># 你的 Access key ID
</span>
<span class="o">+</span>   <span class="no">AWS_SECRET_ACCESS_KEY</span><span class="p">:</span> <span class="s2">"xxxx"</span>  <span class="c1"># 你的 Secret access key
</span>
<span class="o">+</span>   <span class="no">AWS_REGION</span><span class="p">:</span> <span class="s2">"xxxx"</span>  <span class="c1"># 你的 S3 bucket 的 Region 位置
</span>
<span class="o">+</span>   <span class="no">AWS_BUCKET_NAME</span><span class="p">:</span> <span class="s2">"xxxx"</span>  <span class="c1"># 你设定的 bucket name
</span>

<span class="o">+</span> <span class="ss">development:
</span><span class="o">+</span>   <span class="no">AWS_ACCESS_KEY_ID</span><span class="p">:</span> <span class="s2">"xxxx"</span>  <span class="c1"># 你的 Access key ID
</span>
<span class="o">+</span>   <span class="no">AWS_SECRET_ACCESS_KEY</span><span class="p">:</span> <span class="s2">"xxxx"</span>  <span class="c1"># 你的 Secret access key
</span>
<span class="o">+</span>   <span class="no">AWS_REGION</span><span class="p">:</span> <span class="s2">"xxxx"</span>  <span class="c1"># 你的 S3 bucket 的 Region 位置
</span>
<span class="o">+</span>   <span class="no">AWS_BUCKET_NAME</span><span class="p">:</span> <span class="s2">"xxxx"</span>  <span class="c1"># 你设定的 bucket name
</span></pre></div>
</figure>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/M6gI6NETeK2iWVFPDtcq_snip20170222_34.png" title=""></figure></p>

<p>注意：请在<a href="http://docs.aws.amazon.com/general/latest/gr/rande.html#s3_region">Amazon S3 - Buckets and Regions</a>查找Region name对应的Region，Region name是在创建存储桶时选择的，可以在存储桶的属性中查看。比如 Region name 是 "Tokyo"，Region 就是"ap-northeast-1"。 Region一定要填对，上传到 heroku 的图片才能正常显示。</p>

<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "figaro"
</pre></div>
</figure>

    </div>
  </div></div><div class='frame'><h1>
      13-4 将JDStore部署到Heroku
    </h1><h4>所属章节：13-部署到 Heroku (海外用户方案)</h4><hr><div class="post group">
    <div class="post-content markdown">
      <blockquote>
<p>注意：AWS S3 存储图片（方案1）与七牛云存储图片（方案2）切勿混用！</p>
</blockquote>
<h2>目标</h2>
<ul>
<li>在 Heroku 上可以上传图片</li>
<li>将JDStore部署到Heroku</li>
</ul>

<p><br></p>
<h2>步骤</h2>
<h3>Step 1: 在 Heroku 上可以上传图片</h3>
<ul>
<li><p>依照教程<a href="https://fullstack.xinshengdaxue.com/posts/427">申请 AWS 服务</a></p></li>
<li><p>安装 gem 'fog'</p></li>
</ul>

<figure class="figure-code code"><figcaption><span>Gemfile 
</span></figcaption><div class="highlight"><pre><span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
<span class="n">gem</span> <span class="s1">'fog'</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
</pre></div>
</figure>

<p><code>bundle install</code><br>
<br></p>
<h3>Step 2: 新增 config/initializers/carrierwave.rb</h3>
<p><code>touch config/initializers/carrierwave.rb</code></p>

<figure class="figure-code code"><figcaption><span>config/initializers/carrierwave.rb 
</span></figcaption><div class="highlight"><pre><span class="no">CarrierWave</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="k">if</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">env</span><span class="p">.</span><span class="nf">production?</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">fog_provider</span> <span class="o">=</span> <span class="s1">'fog'</span>                  
    <span class="n">config</span><span class="p">.</span><span class="nf">fog_credentials</span> <span class="o">=</span> <span class="p">{</span>
      <span class="ss">provider:              </span><span class="s1">'AWS'</span><span class="p">,</span>                        
      <span class="ss">aws_access_key_id:     </span><span class="no">ENV</span><span class="p">[</span><span class="s2">"AWS_ACCESS_KEY_ID"</span><span class="p">],</span>         

      <span class="ss">aws_secret_access_key: </span><span class="no">ENV</span><span class="p">[</span><span class="s2">"AWS_SECRET_ACCESS_KEY"</span><span class="p">],</span>        

      <span class="ss">region:                </span><span class="no">ENV</span><span class="p">[</span><span class="s2">"AWS_REGION"</span><span class="p">]</span>    

    <span class="p">}</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">fog_directory</span>  <span class="o">=</span> <span class="no">ENV</span><span class="p">[</span><span class="s2">"AWS_BUCKET_NAME"</span><span class="p">]</span> 


  <span class="k">else</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">storage</span> <span class="ss">:file</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</figure>

<p><br></p>
<h3>Step 3: 修改 app/uploader/image_uploader.rb</h3>
<figure class="figure-code code"><figcaption><span>app/uploader/image_uploader.rb 
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">ImageUploader</span> <span class="o">&lt;</span> <span class="no">CarrierWave</span><span class="o">::</span><span class="no">Uploader</span><span class="o">::</span><span class="no">Base</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
<span class="o">-</span> <span class="n">storage</span> <span class="ss">:file</span>
<span class="o">+</span> <span class="c1"># storage :file
</span>
<span class="o">+</span> <span class="n">storage</span> <span class="ss">:fog</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="p">(</span><span class="err">略</span><span class="p">)</span>
</pre></div>
</figure>

<figure class="figure-code code"><div class="highlight"><pre>git add .
git commit -m "install fog"
</pre></div>
</figure>

<p><br></p>
<h3>Step 4: 修改 Gemfile 档案</h3>
<p>把 sqlite3 从第7行搬到约第30到40行的group :development, :test do</p>

<p>这一行里面，置于gem 'byebug'的下面。</p>

<p><figure><img src="http://ww1.sinaimg.cn/large/006tNbRwjw1fb5t9ep5udj30dc03ydg7.jpg" title=""></figure></p>

<p>在末尾新增一个 production group，加上 pg 这个 gem</p>

<figure class="figure-code code"><div class="highlight"><pre>group :production do 
  gem 'pg'
end 
</pre></div>
</figure>

<p><figure><img src="http://ww3.sinaimg.cn/large/006tNbRwjw1fb5vm23d6wj30ft03zwex.jpg" title=""></figure></p>

<p>command+s 存档</p>

<p>修改 Gemfile 后要 <code>bundle install</code></p>

<p>存档</p>

<ul>
<li><code>git add .</code></li>
<li><code>git commit -m "move sqlite3 to dev group &amp; add pg to production group "</code></li>
</ul>

<p>具体可以参考第一课<a href="https://fullstack.xinshengdaxue.com/posts/26" target="_blank">相关章节</a>以及<a href="http://docs.qzy.camp/docs/heroku" target="_blank">帮助文档</a></p>

<p><br></p>
<h3>Step 5: 创建heroku app并将设定好的机密资讯同步到这个app</h3>
<p><code>heroku create</code> 先创建一个heroku app</p>

<p><code>figaro heroku:set -e production</code></p>

<p><code>heroku config</code> 可以列出目前所有的设定</p>
<h3>Step 5: 上传到github和heroku</h3>
<figure class="figure-code code"><div class="highlight"><pre>git push origin aws
git push heroku aws:master
heroku run rake db:migrate
</pre></div>
</figure>
<h4>重点 1:</h4>
<p>申请完 AWS 帐号后到帐号名称的下拉选单里面点“Security Credentials”，然后选导览列的“Details”可以看到有个“＋Access Keys”这边可以申请 key 跟 secret。</p>
<h4>重点 2:</h4>
<p><a href="https://fullstack.xinshengdaxue.com/posts/240">不要把 aws 的 id 与 key push 到 github 上面，避免被盗用。</a>解决的方法可以使用 <a href="https://fullstack.xinshengdaxue.com/posts/241">figaro</a> 或 heroku config。</p>

<p><br></p>
<h4>提示：如何在本地设置环境变数</h4>
<ul>
<li><a href="http://thejavashop.net/blog/?p=5" rel="nofollow" target="_blank">http://thejavashop.net/blog/?p=5</a></li>
</ul>

<p><br></p>
<h4>提示：如何在 Heroku 设置环境变数</h4>
<ul>
<li><a href="https://devcenter.heroku.com/articles/config-vars" rel="nofollow" target="_blank">https://devcenter.heroku.com/articles/config-vars</a></li>
</ul>

<p><br></p>
<h4>提示：出现 uninitialized constant CarrierWave::Storage::Fog 报错，请参考</h4>
<ul>
<li>帮助文档<a href="http://docs.qzy.camp/v0.1/docs/%E5%B0%86-jdstore-%E9%83%A8%E7%BD%B2%E5%88%B0-heroku">将 JDStore 部署到 Heroku</a>
</li>
</ul>

    </div>
  </div></div><div class='frame'><h1>
      13-5 泄漏 S3 密钥的处理方式
    </h1><h4>所属章节：13-部署到 Heroku (海外用户方案)</h4><hr><div class="post group">
    <div class="post-content markdown">
      <h2>目标</h2>
<p>如果没有正确使用 <a href="https://fullstack.xinshengdaxue.com/posts/241">Figaro管理密码</a>，将密钥上传到了github，会造成 S3 密钥泄漏。</p>

<p>如果发生了这种事情，我们需要马上删除泄漏的密钥。</p>
<h2>步骤</h2>
<h3>Step 1: 登入 AWS 后台，删除根密钥</h3>
<p>如果你泄漏了根密钥，会导致信用卡被盗刷</p>

<p>打开我的安全凭证</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/12Kp5BR9Qf2AKXqT1nDQ_006tNbRwly1fcr2qxyrhhj308z06jjrk-1.jpg" title=""></figure></p>

<p>打开访问密钥</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/b8ng7UZOQSW45n3mS9Or_006tNbRwly1fcr39yfjqlj30l609g75i.jpg" title=""></figure></p>

<p>删除泄漏访问密钥</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/sFBL68YtT6OH8HccB5RD_OCj67Wq9TImgKaz3jQfz_006tNbRwly1fcr84r1cyoj30t20ixn21.jpg" title=""></figure></p>
<h3>Step 2: 登入 AWS 后台,删除 IAM 用户</h3>
<p>如果泄漏了 IAM 用户的密钥，需要把 IAM 用户一并删除<br>
打开我的安全凭证</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/12Kp5BR9Qf2AKXqT1nDQ_006tNbRwly1fcr2qxyrhhj308z06jjrk-1.jpg" title=""></figure></p>

<p>打开用户，选择泄漏的密钥的用户，删除用户即可</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/J8r7AsTSP6Fqjv9UPkVX_006tNbRwly1fcr3ya6vcoj30ie095gmf.jpg" title=""></figure></p>
<h3>Step 3: 如果信用卡已经被盗刷</h3>
<p>立即联系亚马逊客服，可以把这笔钱找回来。</p>

    </div>
  </div></div><div class='frame'><h1>
      [直播回放]5月25日 Nic 前端知识补充
    </h1><h4>所属章节：14-提升网站技术品質</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>主讲人：<br>
Nic 老师</p>

<p>时间：<br>
5月25日 周四 20:00</p>

<p>时长：<br>
本次直播总时长49分钟。</p>

<p>概要：Nic 教你如何解决 JS 的在 Rails 上的灵异事件，也能够同时学习 Rails 的 Asset Pipeline 是如何运作的。</p>

<ul>
<li>  Google Chrome 高颜值插件</li>
<li>  Asset Pipeline 说明</li>
<li>  避开 Trubolinks 坑（或出坑）</li>
<li>  三个小 jQuery 插件应用Autosize Countdown WoW</li>
</ul>

<p>提示：<br>
需要科学上网才可以正常观看本视频<br>
如果画面模糊请到右下角设置中将画质调整为720p<br>
<br></p>

    </div>
      <script src="//fast.wistia.com/embed/medias/y04hrj45n7.jsonp" async></script>
<script src="//fast.wistia.com/assets/external/E-v1.js" async></script>
<div class="player-bg">
    <div class="loading-tips">
        <button class="btn btn-default btn-lg">
            <i class="fa fa-spinner fa-spin"></i>
        </button>
        <p>视频文件正在加载，请确保已经打开VPN</p>
    </div>
    <div class="wistia_responsive_padding" style="padding:56.25% 0 0 0;position:relative;">
        <div class="wistia_responsive_wrapper" style="height:100%;left:0;position:absolute;top:0;width:100%;">
            <div class="wistia_embed wistia_async_y04hrj45n7 videoFoam=true" style="height:100%;width:100%"> </div>
            <script>
                window._wq = window._wq || [];
                _wq.push({ id: "y04hrj45n7", onReady: function(video) {
                    window.wistia_video = video;
                        window.wistia_video.time("2451.613249");
                    var url = "/user_wistia_position_records/update_position";
                    var post_id = "1279"; 
                    setInterval(function(){                        
                        if (wistia_video.state() === "playing") {
                            var data = {
                                position: wistia_video.time(),
                                post_id: post_id 
                            };                            
                            $.post(url, data);
                        }                        
                    }, 5000);
                }});
            </script>            
        </div>
    </div>
</div>

  </div></div><div class='frame'><h1>
      [直播回放]5月29日 Nic 编程知识补充
    </h1><h4>所属章节：14-提升网站技术品質</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>主讲人：<br>
Nic 老师</p>

<p>时间：<br>
5月29日 周一 20:00</p>

<p>时长：<br>
本次直播总时长40分钟。</p>

<p>概要：Nic 在这次直播会提到如何找到好用的 Gem 以及什么是 Gem ，同时也会补充编程的相关知识给你知道哦</p>

<ul>
<li>要记得交作业</li>
<li>了解 $ 的用法</li>
<li>两个 Gem 的应用(图片验证／浏览量)</li>
</ul>

<p>提示：<br>
需要科学上网才可以正常观看本视频<br>
如果画面模糊请到右下角设置中将画质调整为720p</p>

    </div>
      <script src="//fast.wistia.com/embed/medias/riax30ulnd.jsonp" async></script>
<script src="//fast.wistia.com/assets/external/E-v1.js" async></script>
<div class="player-bg">
    <div class="loading-tips">
        <button class="btn btn-default btn-lg">
            <i class="fa fa-spinner fa-spin"></i>
        </button>
        <p>视频文件正在加载，请确保已经打开VPN</p>
    </div>
    <div class="wistia_responsive_padding" style="padding:56.25% 0 0 0;position:relative;">
        <div class="wistia_responsive_wrapper" style="height:100%;left:0;position:absolute;top:0;width:100%;">
            <div class="wistia_embed wistia_async_riax30ulnd videoFoam=true" style="height:100%;width:100%"> </div>
            <script>
                window._wq = window._wq || [];
                _wq.push({ id: "riax30ulnd", onReady: function(video) {
                    window.wistia_video = video;
                        window.wistia_video.time("2288.900269");
                    var url = "/user_wistia_position_records/update_position";
                    var post_id = "1343"; 
                    setInterval(function(){                        
                        if (wistia_video.state() === "playing") {
                            var data = {
                                position: wistia_video.time(),
                                post_id: post_id 
                            };                            
                            $.post(url, data);
                        }                        
                    }, 5000);
                }});
            </script>            
        </div>
    </div>
</div>

  </div></div><div class='frame'><h1>
      [直播回放]6月1日 xdite 刻意练习
    </h1><h4>所属章节：14-提升网站技术品質</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>主讲人：<br>
Xdite老师</p>

<p>时间：<br>
6月1日 </p>

<p>时长：<br>
本次直播总时长49分钟。</p>

<p>概要：<br>
Xdite 刻意练习<br>
JD Store 大赛最后如何冲刺<br>
如何做阶段性复盘</p>

<p>提示：<br>
需要科学上网才可以正常观看本视频<br>
如果画面模糊请到右下角设置中将画质调整为720p<br>
<br></p>

    </div>
      <script src="//fast.wistia.com/embed/medias/h3l1uuc8x0.jsonp" async></script>
<script src="//fast.wistia.com/assets/external/E-v1.js" async></script>
<div class="player-bg">
    <div class="loading-tips">
        <button class="btn btn-default btn-lg">
            <i class="fa fa-spinner fa-spin"></i>
        </button>
        <p>视频文件正在加载，请确保已经打开VPN</p>
    </div>
    <div class="wistia_responsive_padding" style="padding:56.25% 0 0 0;position:relative;">
        <div class="wistia_responsive_wrapper" style="height:100%;left:0;position:absolute;top:0;width:100%;">
            <div class="wistia_embed wistia_async_h3l1uuc8x0 videoFoam=true" style="height:100%;width:100%"> </div>
            <script>
                window._wq = window._wq || [];
                _wq.push({ id: "h3l1uuc8x0", onReady: function(video) {
                    window.wistia_video = video;
                    var url = "/user_wistia_position_records/update_position";
                    var post_id = "1344"; 
                    setInterval(function(){                        
                        if (wistia_video.state() === "playing") {
                            var data = {
                                position: wistia_video.time(),
                                post_id: post_id 
                            };                            
                            $.post(url, data);
                        }                        
                    }, 5000);
                }});
            </script>            
        </div>
    </div>
</div>

  </div></div><div class='frame'><h1>
      [直播回放]6月5日 Nic 放下你的围观心态
    </h1><h4>所属章节：14-提升网站技术品質</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>主讲人：<br>
Nic老师</p>

<p>时间：<br>
6月5日 </p>

<p>时长：<br>
本次直播总时长20分钟。</p>

<p>概要：<br>
参赛期间也进入了最后一星期， 这次直播会告诉你如何在迷惘的时候找到定位。</p>

<p>提示：<br>
需要科学上网才可以正常观看本视频<br>
如果画面模糊请到右下角设置中将画质调整为720p<br>
<br></p>

    </div>
      <script src="//fast.wistia.com/embed/medias/95bxzbjb51.jsonp" async></script>
<script src="//fast.wistia.com/assets/external/E-v1.js" async></script>
<div class="player-bg">
    <div class="loading-tips">
        <button class="btn btn-default btn-lg">
            <i class="fa fa-spinner fa-spin"></i>
        </button>
        <p>视频文件正在加载，请确保已经打开VPN</p>
    </div>
    <div class="wistia_responsive_padding" style="padding:56.25% 0 0 0;position:relative;">
        <div class="wistia_responsive_wrapper" style="height:100%;left:0;position:absolute;top:0;width:100%;">
            <div class="wistia_embed wistia_async_95bxzbjb51 videoFoam=true" style="height:100%;width:100%"> </div>
            <script>
                window._wq = window._wq || [];
                _wq.push({ id: "95bxzbjb51", onReady: function(video) {
                    window.wistia_video = video;
                    var url = "/user_wistia_position_records/update_position";
                    var post_id = "1397"; 
                    setInterval(function(){                        
                        if (wistia_video.state() === "playing") {
                            var data = {
                                position: wistia_video.time(),
                                post_id: post_id 
                            };                            
                            $.post(url, data);
                        }                        
                    }, 5000);
                }});
            </script>            
        </div>
    </div>
</div>

  </div></div><div class='frame'><h1>
      [直播回放] 6月8日 Xdite 你应该掌握哪些基本功
    </h1><h4>所属章节：14-提升网站技术品質</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>主讲人：<br>
Xdite 老师</p>

<p>时间：<br>
6月8日 </p>

<p>时长：<br>
本次直播总时长32分钟。</p>

<p>概要：<br>
你应该掌握哪些基本功</p>

<p>提示：<br>
需要科学上网才可以正常观看本视频<br>
如果画面模糊请到右下角设置中将画质调整为720p<br>
<br></p>

    </div>
      <script src="//fast.wistia.com/embed/medias/z8pi7b2sfh.jsonp" async></script>
<script src="//fast.wistia.com/assets/external/E-v1.js" async></script>
<div class="player-bg">
    <div class="loading-tips">
        <button class="btn btn-default btn-lg">
            <i class="fa fa-spinner fa-spin"></i>
        </button>
        <p>视频文件正在加载，请确保已经打开VPN</p>
    </div>
    <div class="wistia_responsive_padding" style="padding:56.25% 0 0 0;position:relative;">
        <div class="wistia_responsive_wrapper" style="height:100%;left:0;position:absolute;top:0;width:100%;">
            <div class="wistia_embed wistia_async_z8pi7b2sfh videoFoam=true" style="height:100%;width:100%"> </div>
            <script>
                window._wq = window._wq || [];
                _wq.push({ id: "z8pi7b2sfh", onReady: function(video) {
                    window.wistia_video = video;
                        window.wistia_video.time("1958.21208");
                    var url = "/user_wistia_position_records/update_position";
                    var post_id = "1398"; 
                    setInterval(function(){                        
                        if (wistia_video.state() === "playing") {
                            var data = {
                                position: wistia_video.time(),
                                post_id: post_id 
                            };                            
                            $.post(url, data);
                        }                        
                    }, 5000);
                }});
            </script>            
        </div>
    </div>
</div>

  </div></div><div class='frame'><h1>
      [直播回放]6月12日 Nic直播比完赛的你该如何再次成长？
    </h1><h4>所属章节：14-提升网站技术品質</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>时间：<br>
6月12日 </p>

<p>时长：<br>
本次直播总时长30分钟。</p>

<p>概要：<br>
为期三周的比赛结束后， Nic 会教你如何保持成长速度，做个更厉害的编程手</p>

<p>提示：<br>
需要科学上网才可以正常观看本视频<br>
如果画面模糊请到右下角设置中将画质调整为720p<br>
<br></p>

    </div>
      <script src="//fast.wistia.com/embed/medias/ovcwq0out0.jsonp" async></script>
<script src="//fast.wistia.com/assets/external/E-v1.js" async></script>
<div class="player-bg">
    <div class="loading-tips">
        <button class="btn btn-default btn-lg">
            <i class="fa fa-spinner fa-spin"></i>
        </button>
        <p>视频文件正在加载，请确保已经打开VPN</p>
    </div>
    <div class="wistia_responsive_padding" style="padding:56.25% 0 0 0;position:relative;">
        <div class="wistia_responsive_wrapper" style="height:100%;left:0;position:absolute;top:0;width:100%;">
            <div class="wistia_embed wistia_async_ovcwq0out0 videoFoam=true" style="height:100%;width:100%"> </div>
            <script>
                window._wq = window._wq || [];
                _wq.push({ id: "ovcwq0out0", onReady: function(video) {
                    window.wistia_video = video;
                        window.wistia_video.time("2148.10138");
                    var url = "/user_wistia_position_records/update_position";
                    var post_id = "1410"; 
                    setInterval(function(){                        
                        if (wistia_video.state() === "playing") {
                            var data = {
                                position: wistia_video.time(),
                                post_id: post_id 
                            };                            
                            $.post(url, data);
                        }                        
                    }, 5000);
                }});
            </script>            
        </div>
    </div>
</div>

  </div></div><div class='frame'><h1>
      [直播回放]6月15日 Xdite 揭晓JD-Store商店创意大赛获奖名单
    </h1><h4>所属章节：14-提升网站技术品質</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>主讲人：<br>
Xdite 老师</p>

<p>时间：<br>
6月15日 </p>

<p>时长：<br>
本次直播总时长37分钟</p>

<p>概要：<br>
xdite老师将为大家揭晓商店创意大赛的获奖名单</p>

<p>提示：<br>
需要科学上网才可以正常观看本视频<br>
如果画面模糊请到右下角设置中将画质调整为720p<br>
<br></p>

    </div>
      <script src="//fast.wistia.com/embed/medias/3mwnbqzawl.jsonp" async></script>
<script src="//fast.wistia.com/assets/external/E-v1.js" async></script>
<div class="player-bg">
    <div class="loading-tips">
        <button class="btn btn-default btn-lg">
            <i class="fa fa-spinner fa-spin"></i>
        </button>
        <p>视频文件正在加载，请确保已经打开VPN</p>
    </div>
    <div class="wistia_responsive_padding" style="padding:56.25% 0 0 0;position:relative;">
        <div class="wistia_responsive_wrapper" style="height:100%;left:0;position:absolute;top:0;width:100%;">
            <div class="wistia_embed wistia_async_3mwnbqzawl videoFoam=true" style="height:100%;width:100%"> </div>
            <script>
                window._wq = window._wq || [];
                _wq.push({ id: "3mwnbqzawl", onReady: function(video) {
                    window.wistia_video = video;
                        window.wistia_video.time("2227.330491");
                    var url = "/user_wistia_position_records/update_position";
                    var post_id = "1423"; 
                    setInterval(function(){                        
                        if (wistia_video.state() === "playing") {
                            var data = {
                                position: wistia_video.time(),
                                post_id: post_id 
                            };                            
                            $.post(url, data);
                        }                        
                    }, 5000);
                }});
            </script>            
        </div>
    </div>
</div>

  </div></div><div class='end'>
              <a href='https://fullstack.qzy.camp/'>
                <img src='https://img.buzzfeed.com/buzzfeed-static/static/2014-10/26/6/enhanced/webdr08/longform-original-14836-1414320930-10.jpg'>
              </a>
              <p>The End</p>
            </div>