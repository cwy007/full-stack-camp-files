
<style>
  .frame {
      margin-left: 30px;
      margin-right: 30px;
  }

  h1, h2, h3, h4, h5, h6 {
      font-weight: normal;
  }

  .view-count {
      float: right;
      margin-top: -54px;
      color: #9B9B9B;
  }

  .markdown h2, .markdown h3, .markdown h4 {
      text-align: left;
      font-weight: 800;
      font-size: 16px !important;
      line-height: 100%;
      margin: 0;
      color: #555;
      margin-top: 16px;
      margin-bottom: 16px;
      border-bottom: 1px solid #eee;
      padding-bottom: 5px;
  }

    .markdown .figure-code figcaption {
      background-color: #e6e6e6;

      font: 100%/2.25 Monaco, Menlo, Consolas, 'Courier New', monospace;
      text-indent: 10.5px;

      -moz-border-radius: 0.25em 0.25em 0 0;
      -webkit-border-radius: 0.25em;
      border-radius: 0.25em 0.25em 0 0;
      -moz-box-shadow: inset 0 0 0 1px #d9d9d9;
      -webkit-box-shadow: inset 0 0 0 1px #d9d9d9;
      box-shadow: inset 0 0 0 1px #d9d9d9;
  }

  .markdown {
      position: relative;
      line-height: 1.8em;
      font-size: 14px;
      text-overflow: ellipsis;
      word-wrap: break-word;
      font-family: 'PT Serif', Georgia, Times, 'Times New Roman', serif !important;
  }

  .markdown ol li, .markdown ul li {
      line-height: 1.6em;
      padding: 2px 0;
      color: #333;
      font-size: 16px;
  }

  .markdown .figure-code {
      margin: 20px 0;
  }

  .post-content {
      padding-top: 5px;
      padding-bottom: 5px;
  }

  .markdown code {
      background-color: #ececec;
      color: #d14;
      font-size: 85%;
      text-shadow: 0 1px 0 rgba(255,255,255,0.9);
      border: 1px solid #d9d9d9;
      padding: 0.15em 0.3em;
  }

  div {
      display: block;
  }

  .markdown figure.code pre {
      background-color: #ffffcc !important;
  }

  .code .gi {
      color: #859900;
      line-height: 1.2em;
  }

  .code .err {
      color: #93A1A1;
  }

  .markdown a:link, .markdown a:visited {
      color: #0069D6 !important;
      text-decoration: none !important;
  }

  .markdown p {
      font-size: 16px;
      line-height: 1.5em;
  }

  .markdown blockquote {
      margin-left: 0 !important;
      margin-right: 0 !important;
      padding: 12px;
      border-left: 5px solid #50AF51;
      background-color: #F3F8F3;
      clear: both;
      display: block;
  }

  .markdown blockquote>*:first-child {
      margin-top: 0 !important;
  }

  .markdown blockquote>*:last-child {
      margin-bottom: 0 !important;
  }

  .markdown blockquote p {
      color: #222;
  }

  * {
      outline: none !important;
  }

  a:active, a:hover, a:link, a:visited {
      text-decoration: none;
  }

  pre {
      margin: 0;
  }

  .markdown img {
      vertical-align: top;
      max-width:100%;
      height:auto;
  }

  h1 a {
    color: #071A52;
  }

  h4 {
    color: #734488;
  }

  hr {
    border-color: #DEDEDE;
    border-width: 0.8px;
    margin-bottom: auto;
  }

  .end {
    height: 400px;
  }

  .end img {
    clear: both;
    display: block;
    margin: 10px auto;
  }

  .end p {
    text-align: center;
    font-size: 2.5em;
    margin: 60px auto 100px;
    color: #ddd;
  }
</style>
<div class='frame'><h1>
      1-1 å‰è¨€
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š1. å‰è¨€ä¸æ¡ˆä¾‹å‡†å¤‡</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>ä¸ºäº†è®©å¤§å®¶å¯ä»¥å¿«é€Ÿå¼€å§‹è¿›è¡Œ<del>æ”»å‡»</del>ï¼Œè¯· Fork è¿™ä¸ªé¡¹ç›®ï¼š<a href="https://github.com/growthschool/hackme-app" rel="nofollow" target="_blank">https://github.com/growthschool/hackme-app</a>ï¼Œç„¶å Clone å›å»ã€‚</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/RJ7gTIJqTLWOQtFmp3J3_1-1.png" title=""></figure></p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/bsQSwaFnT0SXT38aPK8E_1-2.png" title=""></figure></p>

<blockquote>
<p>å› ä¸ºç­‰ä¼šäº¤ä½œä¸šç”¨ Pull Requestï¼Œæ‰€ä»¥ä½ éœ€è¦ç”¨ Fork æŠŠé¡¹ç›®å¤åˆ¶åœ¨ä½ çš„ Github å¸å·ä¸‹ï¼Œè¿™æ ·ä¿®æ”¹åæ‰å¯ä»¥ Push ä¸Šå»ï¼Œæœ€åç”¨ Pull Request äº¤ä½œä¸šã€‚</p>
</blockquote>

<p>Fork åï¼Œè¯·ä¾åºæ‰§è¡Œï¼š</p>

<p><code>git clone git@github.com:ä½ çš„å¸å·/hackme-app.git</code><br>
<code>cd hackme-app</code><br>
<code>bin/setup</code><br>
<code>bundle exec rake dev:fake</code></p>

<p>åœ¨è¿™ä¸ªé¡¹ç›®ä¸­ï¼Œå·²ç»è£…å¥½äº† Deviseã€Bootstrapã€RSpecï¼Œå¹¶ä¸”å»ºç«‹å¥½äº†ä»¥ä¸‹åŠŸèƒ½ï¼š</p>

<ul>
<li>ç”¨æˆ·ç™»å…¥ã€ç™»å‡º</li>
<li>ç”¨æˆ·å¯ä»¥æµè§ˆä¸åŒæ´»åŠ¨</li>
<li>ç”¨æˆ·å¯ä»¥é’ˆå¯¹æ´»åŠ¨ç•™è¨€</li>
<li>ç®¡ç†å‘˜å¯ä»¥é’ˆå¯¹ç‰¹å®šç•™è¨€ï¼Œè¿›è¡Œé«˜äº®(Highlight)æ˜¾ç¤º</li>
<li>ç”¨æˆ·å¯ä»¥æµè§ˆå•†å“</li>
<li>ç”¨æˆ·å¯ä»¥å°†å•†å“åŠ å…¥è´­ç‰©è½¦</li>
</ul>

<p>æ‰§è¡Œ <code>rails server</code></p>

<p>æ¥ç€æ‰“å¼€æµè§ˆå™¨ <a href="http://localhost:3000" rel="nofollow" target="_blank">http://localhost:3000</a></p>

<p>æ•°æ®åº“ä¸­å·²ç»æœ‰ä¸‰ä¸ªç”¨æˆ·ï¼š</p>

<p>å¸å·: <code>hacker@example.org</code><br>
å¯†ç : <code>12345678</code><br>
è¯´æ˜: è¿™æ˜¯ä½ ï¼Œè¶…çº§éª‡å®¢</p>

<p>å¸å·: <code>ihower@gmail.com</code><br>
å¯†ç : <code>12345678</code><br>
è¯´æ˜: è¿™æ˜¯è¦è¢«éª‡çš„è·¯äºº</p>

<p>å¸å·: <code>admin@example.org</code><br>
å¯†ç : <code>12345678</code><br>
è¯´æ˜: è¿™æ˜¯è¦è¢«éª‡çš„ç½‘ç«™ç®¡ç†å‘˜</p>

<p>è¯·æµè§ˆçœ‹çœ‹å‰å°å…¶ä¸­ä¸€ä¸ªæ´»åŠ¨é¡µé¢ï¼š</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/0pC86VofRmLDzD6Zkm3x_1-3.png" title=""></figure></p>

    </div>
  </div></div><div class='frame'><h1>
      1-2 æ³•å¾‹è­¦å‘Š
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š1. å‰è¨€ä¸æ¡ˆä¾‹å‡†å¤‡</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>æœ¬è¯¾ç¨‹çš„ç›®çš„æ˜¯ä¸ºäº†è®©å¤§å®¶èƒ½å¤Ÿæ›´å¥½çš„ä¿æŠ¤è‡ªå·±ï¼Œäº†è§£éª‡å®¢æ˜¯å¦‚ä½•æ”»å‡»çš„ï¼Œè¿›è€Œäº†è§£ Rails æ˜¯å¦‚ä½•è¿›è¡Œé˜²å¾¡çš„ã€‚æ‰€è°“ã€Œå®³äººä¹‹å¿ƒä¸å¯æœ‰ï¼Œé˜²äººä¹‹å¿ƒä¸å¯æ— ã€ï¼Œçœ‹åˆ°åˆ«äººå®¶é‡Œæ²¡é”é—¨ï¼Œä¸ä»£è¡¨ä½ å¯ä»¥è¿›å»ç ´åæˆ–å·ä¸œè¥¿ã€‚è¿™åœ¨æ¯ä¸ªå›½å®¶éƒ½æ˜¯çŠ¯æ³•çš„è¡Œä¸ºï¼ä½ å¯ä»¥å–„æ„åœ°æé†’äººå®¶æ²¡é”é—¨ï¼Œä½†æ˜¯åƒä¸‡ä¸è¦è‡ªä»¥ä¸ºæ˜¯è¶Šè¿‡æ³•å¾‹çš„ç•Œçº¿å–”ã€‚</p>

<blockquote>
<p><a href="http://www.npc.gov.cn/npc/xinwen/2016-11/07/content_2001605.htm">ä¸­åäººæ°‘å…±å’Œå›½ç½‘ç»œå®‰å…¨æ³•</a> ç¬¬äºŒåä¸ƒæ¡  ä»»ä½•ä¸ªäººå’Œç»„ç»‡ä¸å¾—ä»äº‹éæ³•ä¾µå…¥ä»–äººç½‘ç»œã€å¹²æ‰°ä»–äººç½‘ç»œæ­£å¸¸åŠŸèƒ½ã€çªƒå–ç½‘ç»œæ•°æ®ç­‰å±å®³ç½‘ç»œå®‰å…¨çš„æ´»åŠ¨ï¼›ä¸å¾—æä¾›ä¸“é—¨ç”¨äºä»äº‹ä¾µå…¥ç½‘ç»œã€å¹²æ‰°ç½‘ç»œæ­£å¸¸åŠŸèƒ½åŠé˜²æŠ¤æªæ–½ã€çªƒå–ç½‘ç»œæ•°æ®ç­‰å±å®³ç½‘ç»œå®‰å…¨æ´»åŠ¨çš„ç¨‹åºã€å·¥å…·ï¼›æ˜çŸ¥ä»–äººä»äº‹å±å®³ç½‘ç»œå®‰å…¨çš„æ´»åŠ¨çš„ï¼Œä¸å¾—ä¸ºå…¶æä¾›æŠ€æœ¯æ”¯æŒã€å¹¿å‘Šæ¨å¹¿ã€æ”¯ä»˜ç»“ç®—ç­‰å¸®åŠ©ã€‚</p>
</blockquote>

    </div>
  </div></div><div class='frame'><h1>
      2-1 ä»€ä¹ˆæ˜¯ XSS è·¨ç«™è„šæœ¬æ”»å‡»?
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š2. XSS è·¨ç«™è„šæœ¬æ”»å‡»</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>æˆ‘ä»¬åœ¨ã€Œç™¾å®ç®± 13. Rich Editor ç¼–è¾‘å™¨ã€æœ‰ä»‹ç»è¿‡ <a href="https://zh.wikipedia.org/zh-cn/%E8%B7%A8%E7%BD%91%E7%AB%99%E6%8C%87%E4%BB%A4%E7%A0%81">XSS</a> è·¨ç«™è„šæœ¬æ”»å‡»ï¼šå¦‚æœç”¨æˆ·å¯ä»¥è‡ªå·±å¼ è´´å†…å®¹åˆ°ç½‘ç«™ä¸Šï¼Œå¹¶ä¸”ç½‘ç«™ä¼šæ˜¾ç¤ºå‡ºæ¥çš„è¯ï¼Œå°±æœ‰å¯èƒ½æœ‰ XSS æ¼æ´ã€‚æ¶æ„ç”¨æˆ·ä¼šå¼ è´´ JavaScript ä»£ç ä¸Šæ¥ï¼Œé‚£ä¹ˆè¿™ä¹ˆå½“å…¶ä»–ç”¨æˆ·æµè§ˆåˆ°è¿™ä¸€é¡µæ—¶ï¼Œæµè§ˆå™¨å°±ä¼šç›²ç›®çš„æ‰§è¡Œ JavaScript ä»£ç ã€‚</p>

<p>è®©æˆ‘ä»¬æ”»å‡»çœ‹çœ‹ï¼Œè¯·ç”¨ <code>hacker@example.org</code> ç™»å…¥ï¼Œç„¶åé’ˆå¯¹ä¸€åˆ™æ´»åŠ¨ç•™è¨€ï¼Œè´´ä¸Šä»¥ä¸‹ JavaScript ä»£ç ï¼š</p>

<figure class="figure-code code"><div class="highlight"><pre>&lt;script&gt;
$.ajax({
  url: $(location).attr('href') + "/comments",
  method: "POST",
  data: {  comment : { content: "å•Šå“ˆå“ˆå“ˆï½ä½ çœ‹çœ‹ä½ ï¼ (Ïƒï¾Ÿâˆ€ï¾Ÿ)Ïƒï¾Ÿâˆ€ï¾Ÿ)Ïƒï¾Ÿâˆ€ï¾Ÿ)Ïƒ" } },
  dataType: "JSON"
})
&lt;/script&gt;
</pre></div>
</figure>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/spCHxGm0T1a72SvrzZCV_2-1.png" title=""></figure></p>

<p>ç•™è¨€å®Œä¹‹åï¼Œæ¥ä¸‹æ¥ä»»ä½•äººçœ‹åˆ°è¿™ä¸€é¡µï¼Œå°±ä¼šæ‰§è¡Œè¿™æ®µ Ajax ä»£ç ï¼Œä¹Ÿè·Ÿç€ç•™è¨€ä¸€æ¬¡ã€‚è¯·å¤šé‡æ–°æ•´ç†é¡µé¢å‡ æ¬¡çœ‹çœ‹ã€‚</p>

<p>ä½ ä¹Ÿå¯ä»¥æµ‹è¯•çœ‹çœ‹å…¶ä»–äººæµè§ˆä¼šæ€ä¹ˆæ ·ï¼Ÿä½ å¯ä»¥ç”¨å¦ä¸€ä¸ªæµè§ˆå™¨(ä¾‹å¦‚ Safari)ï¼Œæˆ–æ˜¯ç”¨ Chrome çš„ Incognito Windows(æ— ç—•æ¨¡å¼ï¼Œè¿™ä¼šå¼€å¯ä¸€ä¸ªå¹²å‡€æ²¡æœ‰ Cookie çš„æ–°è§†çª—)ï¼Œç„¶åæ”¹ç”¨ <code>admin@example.org</code> ç™»å…¥ï¼Œç„¶åæµè§ˆåˆšåˆšé‚£ä¸€ä¸ªæ´»åŠ¨...</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/pVhhnVfpQhORali1KhpE_2-chrome.png" title=""></figure></p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/j0wwOYnhQ8qwc4Nx7rhk_2-2.png" title=""></figure></p>

<p><code>admin</code> ä¹Ÿä¼šè‡ªåŠ¨å¼ è´´ç•™è¨€äº†....</p>

    </div>
  </div></div><div class='frame'><h1>
      2-2 å¦‚ä½•é˜²å¾¡ XSS?
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š2. XSS è·¨ç«™è„šæœ¬æ”»å‡»</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>è¦é˜²å¾¡è¯´èµ·æ¥ç®€å•ï¼Œå°±æ˜¯æ˜¾ç¤ºæ¯ä¸ªç”¨æˆ·è´´æ–‡çš„åœ°æ–¹éƒ½è¦è„±é€¸(æˆ–å«åšè½¬ä¹‰) HTMLï¼Œæ‰“å¼€ <code>app/views/events/show.html.erb</code></p>

<figure class="figure-code code"><figcaption><span>app/views/events/show.html.erb
</span></figcaption><div class="highlight"><pre><span class="gd">-  &lt;%= raw comment.content %&gt;
</span><span class="err">+  &lt;%= comment.content %&gt;
</span></pre></div>
</figure>

<p>Rails é»˜è®¤å°±ä¼šè„±é€¸ HTML äº†ï¼Œç”¨ <code>raw comment.content</code> æˆ– <code>comment.content.html_safe</code> åè€Œæ˜¯å‘Šè¯‰ Rails ä¸è¦è„±é€¸ HTMLã€‚æ‹¿æ‰ <code>raw</code> ä¹‹åï¼Œå°±ä¼šè„±é€¸æ˜¾ç¤ºå‡ºåŸä»£ç ï¼Œä¾‹å¦‚ <code>&lt;</code> ä¼šå˜æˆ <code>&amp;lt;</code>ã€‚</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/1GJCqr1cSja2Ogj1Y6Hk_2-3.png" title=""></figure></p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ENHZc8s5T66i5qSGpllR_2-4.png" title=""></figure></p>

<p>ä¸è¿‡è¿™æ ·ä¼šå®Œå…¨é˜²æ­¢ä»»ä½• HTML æ ‡ç±¤ï¼Œä¾‹å¦‚æˆ‘ä»¬å¼ è´´ä»¥ä¸‹è¿™å¼ å›¾ç‰‡ï¼š</p>

<figure class="figure-code code"><div class="highlight"><pre>&lt;img src="http://placehold.it/200x200" /&gt;
</pre></div>
</figure>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/TUL929xbQHaN0UknZsg2_2-5.png" title=""></figure></p>

<p>ä¸€æ ·è¢«è„±é€¸äº† :(</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/A36zirZfQ7CaOuHabLkL_2-6.png" title=""></figure></p>

<p>å¦‚æœæˆ‘ä»¬è¿˜æ˜¯å¸Œæœ›ç”¨æˆ·å¯ä»¥è¾“å…¥ HTMLï¼Œå°±åƒç™¾å®ç®± 13. Rich Editor ç¼–è¾‘å™¨çš„éœ€æ±‚ï¼Œè¯·æ”¹ç”¨ sanitize ç™½åå•è¿‡æ»¤ï¼Œåªå…è®¸éƒ¨åˆ†çš„ HTML æ ‡ç±¤ï¼š</p>

<figure class="figure-code code"><figcaption><span>app/views/events/show.html.erb
</span></figcaption><div class="highlight"><pre><span class="gd">-  &lt;%= comment.content %&gt;
</span><span class="err">+  &lt;%= sanitize comment.content %&gt;
</span></pre></div>
</figure>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/xahFlNcQgGPo1lW4430z_2-7.png" title=""></figure></p>

    </div>
  </div></div><div class='frame'><h1>
      2-3 å¦ä¸€ä¸ªä¸å°å¿ƒçš„æ¼æ´
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š2. XSS è·¨ç«™è„šæœ¬æ”»å‡»</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>è¯·ç‚¹ä¸»é€‰å•çš„ä¿®æ”¹ä¸ªäººèµ„æ–™ï¼Œè¿™ä¸ªåœ°æ–¹ä¼šä¸ä¼šæœ‰æ¼æ´å‘¢?</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/OGu6g0GnTimIzv03Wkdb_2-8.png" title=""></figure></p>

<p>å›åˆ°ä»»ä¸€ä¸ªæ´»åŠ¨é¡µé¢ï¼š</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ogGFNIQTjmKqTWzeXt29_2-9.png" title=""></figure></p>

<p>å‘ç°ç«Ÿç„¶æœ‰æ¼æ´ï¼Œè¿™æ®µ JavaScript è¢«æ‰§è¡Œäº†ã€‚</p>

<p>è®©æˆ‘ä»¬æ‰¾æ‰¾çœ‹æ¼æ´å‡ºç°åœ¨å“ªé‡Œï¼ŒåŸæ¥æ˜¯åœ¨ç•™è¨€æ˜¾ç¤ºç”¨æˆ·åç§°çš„åœ°æ–¹ï¼Œæ²¡æœ‰åšå¥½è„±é€¸ :(</p>

<figure class="figure-code code"><figcaption><span>app/views/events/show.html
</span></figcaption><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"panel-heading"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">user_avatar_link</span><span class="p">(</span><span class="n">comment</span><span class="p">.</span><span class="nf">author</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</figure>

<figure class="figure-code code"><figcaption><span>app/helpers/users_helper.rb
</span></figcaption><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'digest/md5'</span>

<span class="k">module</span> <span class="nn">UsersHelper</span>

  <span class="k">def</span> <span class="nf">user_avatar_link</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="c1"># https://cn.gravatar.com/
</span>
    <span class="n">email_md5</span> <span class="o">=</span> <span class="no">Digest</span><span class="o">::</span><span class="no">MD5</span><span class="p">.</span><span class="nf">hexdigest</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">email</span><span class="p">)</span>
    <span class="n">gravatar_url</span> <span class="o">=</span> <span class="s2">"https://www.gravatar.com/avatar/</span><span class="si">#{</span><span class="n">email_md5</span><span class="si">}</span><span class="s2">"</span>

    <span class="n">str</span> <span class="o">=</span> <span class="s2">"&lt;div class ='user-link'&gt;"</span> <span class="o">+</span> <span class="n">link_to</span><span class="p">(</span><span class="n">image_tag</span><span class="p">(</span><span class="n">gravatar_url</span><span class="p">),</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="o">+</span> <span class="s2">" "</span> <span class="o">+</span> <span class="n">user</span><span class="p">.</span><span class="nf">display_name</span> <span class="o">+</span> <span class="s2">"&lt;/div&gt;"</span>

    <span class="n">str</span><span class="p">.</span><span class="nf">html_safe</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div>
</figure>

<p>è¿™ä¸ª <code>user_avatar_link</code> helper çš„ç›®çš„æ˜¯è¾“å‡ºç”¨æˆ·çš„ <a href="https://cn.gravatar.com/">Gravater</a> ç…§ç‰‡çš„è¿ç»“ï¼Œä»¥åŠç”¨æˆ·çš„æ˜¾ç¤ºåç§°ï¼Œè€Œé—®é¢˜å°±å‡ºåœ¨ <code>str.html_safe</code> å¤ªè¿‡æ”¾çºµäº†ã€‚</p>

<p>ä½†æ˜¯å¦‚æœä½ æŠŠ <code>str.html_safe</code> è¿™è¡Œæ‹¿æ‰ï¼Œä½ ä¼šå‘ç°æ•´ä¸ª Helper çš„è¾“å‡ºéƒ½è¢«è„±é€¸äº† :( ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ç»“æœã€‚</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/dNkDDgeuS2euPQwfxWVQ_2-10.png" title=""></figure></p>

<p>è¿™æ˜¯å› ä¸º Rails ä¼šè¿½è¸ªæ¯ä¸ªå­—ç¬¦ä¸²æ˜¯å¦æ˜¯å®‰å…¨çš„ï¼Œå¦‚æœä¸å®‰å…¨çš„è¯ï¼Œè¾“å‡ºæ—¶ä¼šè‡ªåŠ¨è„±é€¸ã€‚ä¸å®‰å…¨çš„å­—ç¬¦ä¸² <code>+</code> å®‰å…¨çš„å­—ç¬¦ä¸²ï¼Œä¼šå˜æˆä¸å®‰å…¨çš„ã€‚ç”±äºå­—ç¬¦ä¸² <code>"&lt;div class ='user-link'&gt;"</code> é»˜è®¤æ˜¯ä¸å®‰å…¨çš„ï¼Œå› æ­¤åæ¥ç´¯åŠ å­—ç¬¦ä¸²è¿›æ¥ï¼Œæ•´ä¸ª <code>str</code> éƒ½æ˜¯ä¸å®‰å…¨çš„ï¼Œæ‰€ä»¥ Rails æœ€åä¼šè®©æ•´ä¸ª <code>str</code> éƒ½è„±é€¸ï¼Œé€ æˆå›¾ç‰‡ img æ ‡ç±¤ä¹Ÿæ— æ³•æ˜¾ç¤ºã€‚</p>

    </div>
  </div></div><div class='frame'><h1>
      2-4 è§£æ³•åŠæ³•
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š2. XSS è·¨ç«™è„šæœ¬æ”»å‡»</h4><hr><div class="post group">
    <div class="post-content markdown">
      <h4>è§£æ³•åŠæ³•ä¸€</h4>
<p>å°å¿ƒç¿¼ç¿¼åœ°åœ¨ä¸éœ€è¦è„±é€¸çš„åœ°æ–¹åŠ ä¸Š <code>.html_safe</code></p>

<figure class="figure-code code"><figcaption><span>app/helpers/users_helper.rb
</span></figcaption><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'digest/md5'</span>

<span class="k">module</span> <span class="nn">UsersHelper</span>

  <span class="k">def</span> <span class="nf">user_avatar_link</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="c1"># https://cn.gravatar.com/
</span>
    <span class="n">email_md5</span> <span class="o">=</span> <span class="no">Digest</span><span class="o">::</span><span class="no">MD5</span><span class="p">.</span><span class="nf">hexdigest</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">email</span><span class="p">)</span>
    <span class="n">gravatar_url</span> <span class="o">=</span> <span class="s2">"https://www.gravatar.com/avatar/</span><span class="si">#{</span><span class="n">email_md5</span><span class="si">}</span><span class="s2">"</span>

<span class="o">-</span>   <span class="n">str</span> <span class="o">=</span> <span class="s2">"&lt;div class ='user-link'&gt;"</span> <span class="o">+</span> <span class="n">link_to</span><span class="p">(</span><span class="n">image_tag</span><span class="p">(</span><span class="n">gravatar_url</span><span class="p">),</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="o">+</span> <span class="s2">" "</span> <span class="o">+</span> <span class="n">user</span><span class="p">.</span><span class="nf">display_name</span> <span class="o">+</span> <span class="s2">"&lt;/div&gt;"</span>
<span class="o">-</span>   <span class="n">str</span><span class="p">.</span><span class="nf">html_safe</span>

<span class="o">+</span>   <span class="s2">"&lt;div class ='user-link'&gt;"</span><span class="p">.</span><span class="nf">html_safe</span> <span class="o">+</span> <span class="n">link_to</span><span class="p">(</span><span class="n">image_tag</span><span class="p">(</span><span class="n">gravatar_url</span><span class="p">),</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="o">+</span> <span class="s2">" "</span> <span class="o">+</span> <span class="n">user</span><span class="p">.</span><span class="nf">display_name</span> <span class="o">+</span> <span class="s2">"&lt;/div&gt;"</span><span class="p">.</span><span class="nf">html_safe</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div>
</figure>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/w86gvStkTVKo8BkJUMQ0_2-11.png" title=""></figure></p>
<h4>è§£æ³•åŠæ³•äºŒ</h4>
<p>å¯ä»¥ç”¨ Rails å†…å»ºçš„ <code>content_tag</code> helper äº§ç”Ÿæ ‡ç±¤ï¼Œç»“æœä¸€æ ·ï¼Œåªæ˜¯å†™èµ·æ¥ä¼šæ¯”å­—ç¬¦ä¸²ç›¸åŠ å¥½çœ‹ä¸€ç‚¹ï¼š</p>

<figure class="figure-code code"><figcaption><span>app/helpers/users_helper.rb
</span></figcaption><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'digest/md5'</span>

<span class="k">module</span> <span class="nn">UsersHelper</span>

  <span class="k">def</span> <span class="nf">user_avatar_link</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="c1"># https://cn.gravatar.com/
</span>
    <span class="n">email_md5</span> <span class="o">=</span> <span class="no">Digest</span><span class="o">::</span><span class="no">MD5</span><span class="p">.</span><span class="nf">hexdigest</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">email</span><span class="p">)</span>
    <span class="n">gravatar_url</span> <span class="o">=</span> <span class="s2">"https://www.gravatar.com/avatar/</span><span class="si">#{</span><span class="n">email_md5</span><span class="si">}</span><span class="s2">"</span>

<span class="o">-</span>   <span class="s2">"&lt;div class ='user-link'&gt;"</span><span class="p">.</span><span class="nf">html_safe</span> <span class="o">+</span> <span class="n">link_to</span><span class="p">(</span><span class="n">image_tag</span><span class="p">(</span><span class="n">gravatar_url</span><span class="p">),</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="o">+</span> <span class="s2">" "</span> <span class="o">+</span> <span class="n">user</span><span class="p">.</span><span class="nf">display_name</span> <span class="o">+</span> <span class="s2">"&lt;/div&gt;"</span><span class="p">.</span><span class="nf">html_safe</span>

<span class="o">+</span>   <span class="n">content_tag</span><span class="p">(</span><span class="ss">:div</span><span class="p">,</span>
      <span class="n">link_to</span><span class="p">(</span><span class="n">image_tag</span><span class="p">(</span><span class="n">gravatar_url</span><span class="p">),</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="o">+</span> <span class="s2">" "</span> <span class="o">+</span> <span class="n">user</span><span class="p">.</span><span class="nf">display_name</span> <span class="p">,</span>
      <span class="ss">:class</span> <span class="o">=&gt;</span> <span class="s2">"user-link"</span> <span class="p">)</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div>
</figure>

    </div>
  </div></div><div class='frame'><h1>
      2-5 å°ç»“
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š2. XSS è·¨ç«™è„šæœ¬æ”»å‡»</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>ç”±äº Rails é»˜è®¤ä¼šè„±é€¸ HTML çš„å…³ç³»ï¼Œæ‰€ä»¥ Rails å¯¹ XSS æ˜¯æœ‰äº†åŸºæœ¬çš„é˜²å¾¡ã€‚å¦‚æœä¸æ˜¯ Rails è¿™ç§çš„æ¡†æ¶å¸®ä½ é»˜è®¤è„±é€¸çš„è¯ï¼Œç½‘é¡µä¸Šåªè¦æ˜¾ç¤ºç”¨æˆ·çš„è¾“å‡ºï¼Œéƒ½æœ‰å¯èƒ½æ˜¯ä¸ªå®‰å…¨æ¼æ´ã€‚</p>

<p>ä¸è¿‡å³ä½¿æœ‰ Rails çš„ä¿æŠ¤ï¼Œä½ ä¹Ÿæœ‰å¯èƒ½åœ¨å­—ç¬¦ä¸²ç›¸åŠ çš„è¿‡ç¨‹ä¸­ï¼Œä¸å°å¿ƒå¤ªè¿‡æ”¾çºµè€Œé€ æˆæ¼æ´ï¼Œå°±åƒè¿™ä¸€èŠ‚æ‰€ç¤ºèŒƒçš„ã€‚è¿™æ—¶å€™å°±å¿…é¡»å°å¿ƒå¤„ç†é‚£äº›æ˜¯å®‰å…¨çš„å­—ç¬¦ä¸²ã€é‚£äº›æ˜¯ç”¨æˆ·è¾“å…¥çš„ä¸å®‰å…¨å­—ç¬¦ä¸²ã€‚</p>

    </div>
  </div></div><div class='frame'><h1>
      3-1 ä»€ä¹ˆæ˜¯ CSRF è·¨ç«™è¯·æ±‚ä¼ªé€ ?
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š3. CSRF è·¨ç«™è¯·æ±‚ä¼ªé€ </h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>è¯·ç”¨ <code>admin@example.org</code> å¸å·ç™»å…¥ï¼Œæµè§ˆä»»ä¸€æ´»åŠ¨ï¼š</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/xzif4mY0RHSx4CHkXAHg_3-1.png" title=""></figure></p>

<p>ç®¡ç†å‘˜å¯ä»¥ç»™ç•™è¨€ Highlight é«˜äº®ï¼Œè¿™æ ·å°±ä¼šæ˜¾ç¤ºé»„è‰²èƒŒæ™¯ã€‚</p>

<p>éª‡å®¢æ²¡æœ‰åŠæ³•åŠæ³•éª—ç®¡ç†å‘˜å»é«˜äº®ç‰¹å®šæ–‡ç« å‘¢? å¦‚æœè¿˜æœ‰ XSS æ¼æ´çš„è¯ï¼Œå¯ä»¥ç”¨ XSS æ”»å‡»ï¼Œç•™ä¸‹ä¸€æ®µ JavaScript ä»£ç å»è§¦å‘é‚£ä¸ªé«˜äº®æŒ‰é’®ï¼Œåªè¦ç®¡ç†å‘˜é€›åˆ°é‚£ä¸€é¡µï¼Œæ‰§è¡Œåˆ° JavaScript çš„è¯ï¼Œä¹Ÿå¯ä»¥åŠåˆ°è¿™ä»¶äº‹æƒ…ã€‚</p>

<p>ä¸è¿‡ï¼Œä¸Šä¸€èŠ‚æˆ‘ä»¬å·²ç»é˜²å¾¡å¥½ XSSï¼Œè¿™ä¸€èŠ‚æˆ‘ä»¬ç”¨å¦ä¸€æ¡æ”»å‡»æ‰‹æ³•ã€‚è¯·å…ˆè§‚å¯Ÿä½ è¦é«˜äº®é‚£ä¸€ç¯‡ç•™è¨€ï¼š</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ufxd4fILRnOPoEdRvjon_3-2.png" title=""></figure></p>

<p>è¿™ä¸€ç¯‡ç•™è¨€çš„IDæ˜¯ 522ï¼Œæ‰€ä»¥è¦éª—ç®¡ç†å‘˜å»é«˜äº®è¿™ç¯‡ç•™è¨€ï¼Œå°±æ˜¯è¦éª—ç®¡ç†å‘˜çš„æµè§ˆå™¨å»æ‰“ <code>/events/92/comments/522/highlight</code> å›‰ï¼Œè¿™ä»¶äº‹æƒ…å…¶å®å¾ˆç®€å•ï¼Œéª‡å®¢ç•™è¨€ä¸€ä¸‹ï¼š</p>

<figure class="figure-code code"><div class="highlight"><pre>&lt;img src="/events/92/comments/522/highlight"&gt;


</pre></div>
</figure>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/tA2uiHPVR4GsxUU8sbcW_3-3.png" title=""></figure></p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Z9iRHVb0R02iZnVSFpi2_3-4.png" title=""></figure></p>

<p>ä¸Šä¸€èŠ‚é˜²æ­¢ XSS æ—¶ï¼Œæœ‰ç”¨ sanitize æ¥åšç™½åå•çš„è¿‡æ»¤ï¼Œè€Œ <code>img</code> æ ‡ç±¤æ˜¯ä¸€ä¸ªç™½åå•æ”¾è¡Œçš„æ ‡ç±¤ï¼Œå› æ­¤è¿™ä¸ªå›¾æ¡£æµè§ˆå™¨ä¼šå‘é€ Request è¯·æ±‚åˆ° <code>/events/92/comments/522/highlight</code> å»æŠ“å›¾ã€‚å½“ç„¶ï¼Œæˆ‘ç›®å‰çš„èº«ä»½æ˜¯ <code>hacker@example.org</code> æ˜¯æ²¡æœ‰æƒé™é«˜äº®çš„ï¼Œä½†æ˜¯å·²ç»æŒ–äº†ä¸€ä¸ªå‘å‡†å¤‡ç»™ç®¡ç†å‘˜è·³ã€‚</p>

<blockquote>
<p>åœ¨ <code>app/controllers/comments_controller.rb</code> ä¸­ï¼Œæˆ‘ä»¬æœ‰ç”¨ <code>before_action :require_admin!, :only =&gt; [:highlight]</code> æ£€æŸ¥è°ƒç”¨ highlight æ–¹æ³•å¿…é¡»æœ‰ç®¡ç†å‘˜æƒé™ã€‚</p>
</blockquote>

<p>æ¥ç€è¯·åˆ‡æ¢åˆ°ç®¡ç†å‘˜ <code>admin@example.org</code> èº«ä»½ï¼Œå»æµè§ˆè¿™ä¸€é¡µï¼Œç„¶åé‡æ–°æ•´ç†é¡µé¢ä¸€æ¬¡ï¼š</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/yKUjNFM8SVK4wuRsd4UO_3-5.png" title=""></figure></p>

<p>è¿™ç¯‡æ–‡ç« å°±è¢«é«˜äº®äº†..... ç”¨ç®¡ç†å‘˜çš„æƒé™å»é«˜äº®çš„ã€‚æµè§ˆå™¨çœŸå¥½éª—å•Šã€‚</p>

<p>è¿™ç§æ”»å‡»ï¼Œå°±å«åš<a href="https://zh.wikipedia.org/wiki/%E8%B7%A8%E7%AB%99%E8%AF%B7%E6%B1%82%E4%BC%AA%E9%80%A0">CSRF è·¨ç«™è¯·æ±‚ä¼ªé€ </a>ï¼Œéª‡å®¢æŒ–å‘è®©æœ‰æƒé™çš„ç”¨æˆ·å»è·³ã€‚</p>

    </div>
  </div></div><div class='frame'><h1>
      3-2 å¦‚ä½•é˜²å¾¡ï¼Ÿ
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š3. CSRF è·¨ç«™è¯·æ±‚ä¼ªé€ </h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>é¦–å…ˆï¼Œè¿™ä¸ªé«˜äº®ä¼šè¿™ä¹ˆå¥½è§¦å‘çš„åŸå› ï¼Œåœ¨äºæˆ‘ä»¬æŠŠå®ƒè®¾è®¡æˆ <code>GET</code> è¯·æ±‚ï¼Œè¿™æ ·éª‡å®¢ç”¨ <code>img</code> æ ‡ç±¤å¤ªå®¹æ˜“å°±èƒ½è¯±éª—æµè§ˆå™¨äº†ã€‚è®©æˆ‘ä»¬æŠŠå®ƒæ”¹æˆ <code>POST</code> æ“ä½œã€‚</p>

<figure class="figure-code code"><figcaption><span>
</span></figcaption><div class="highlight"><pre>  resources :events do
    resources :comments do
      member do
-       get :highlight
+       post :highlight
      end
    end
  end

</pre></div>
</figure>

<p>ä»¥åŠ</p>

<figure class="figure-code code"><figcaption><span>app/views/events/show.html.erb
</span></figcaption><div class="highlight"><pre><span class="gd">-  &lt;%= link_to "Highligh", highlight_event_comment_path(@event, comment), :class =&gt; "btn btn-default" %&gt;
</span><span class="gi">+  &lt;%= link_to "Highligh", highlight_event_comment_path(@event, comment), :method =&gt; :post, :class =&gt; "btn btn-default" %&gt;
</span><span class="err">
</span></pre></div>
</figure>

<blockquote>
<p>åœ¨ Web API è®¾è®¡å®ä½œè¯¾ç¨‹çš„ <a href="https://fullstack.xinshengdaxue.com/posts/838">3-2 ä»€ä¹ˆæ˜¯ REST API</a> ä¹‹ä¸­ï¼Œä¹Ÿæœ‰è®²è¿°åˆ° GET å’Œ POST çš„å·®å¼‚ï¼šGET åªèƒ½å•çº¯è¯»å–èµ„æ–™ï¼Œä¸åº”è¯¥ä¿®æ”¹èµ„æ–™ã€‚è€Œ POST åˆ™æ˜¯æ‰§è¡ŒæŸä¸ªæ“ä½œï¼Œä¼šä¿®æ”¹åˆ°æœåŠ¡å™¨çš„èµ„æ–™ã€‚</p>
</blockquote>

<p>è¿™æ ·çš„è¯ï¼Œç”¨ <code>img</code> æ ‡ç±¤å°±ä¸èƒ½æ”»å‡»äº†ï¼Œéª‡å®¢å¿…é¡»ç”¨åˆ° JavaScript æ‰èƒ½è®©ç®¡ç†å‘˜çš„æµè§ˆå™¨å»åš POST è¯·æ±‚ã€‚ä½†æ˜¯è¦ç”¨ JavaScript çš„è¯ï¼Œå°±å¿…é¡»å­˜åœ¨æœ‰ä¸Šä¸€èŠ‚çš„ XSS æ¼æ´æ‰è¡Œäº†ã€‚</p>

    </div>
  </div></div><div class='frame'><h1>
      3-3 æ¼ç½‘ä¹‹é±¼
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š3. CSRF è·¨ç«™è¯·æ±‚ä¼ªé€ </h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>CSRF ä¹‹æ‰€ä»¥å±é™©çš„åœ°æ–¹ï¼Œåœ¨äºæ”»å‡»æ–¹å¯ä»¥åœ¨å…¶ä»–ç½‘ç«™æŒ–å‘ï¼Œåªè¦ç®¡ç†å‘˜æµè§ˆåˆ°é‚£ä¸€é¡µï¼Œä¸€æ ·å¯ä»¥æ‰§è¡Œè¿™ä¸ªæ”»å‡»ã€‚</p>

<p>æ‰€ä»¥å°±ç®—ä¸Šä¸€èŠ‚æˆ‘ä»¬å·²ç»æ”¹æˆ POST äº†ï¼Œè€Œä¸”è¿™ä¸ªç½‘ç«™ä¹Ÿä¸å­˜åœ¨ XSS æ¼æ´ï¼Œéª‡å®¢ä¾ç„¶æœ‰åŠæ³•å»è¯±ä½¿ç®¡ç†å‘˜çš„æµè§ˆå™¨å» POST æ“ä½œã€‚ä¾‹å¦‚éª‡å®¢çŸ¥é“ç®¡ç†å‘˜å¸¸å»çœ‹ã€Œç™¾åº¦è´´å§ã€ï¼Œç„¶åå‡è®¾ã€Œç™¾åº¦è´´å§ã€æœ‰ä¸ª XSS æ¼æ´å¯ä»¥è´´ JavaScript ä»£ç ï¼Œé‚£ä¹ˆéª‡å®¢å¯ä»¥è´´æ–‡ï¼š</p>

<figure class="figure-code code"><div class="highlight"><pre>&lt;iframe style="display:none" name="csrf-frame"&gt;&lt;/iframe&gt;

&lt;form method='POST' action='http://localhost:3000/events/92/comments/522/highlight' target="csrf-frame" id="csrf-form"&gt;
  &lt;input type='submit' value='submit'&gt;
&lt;/form&gt;

&lt;script&gt;document.getElementById("csrf-form").submit()&lt;/script&gt;
</pre></div>
</figure>

<p>è¿™æ®µ HTML å’Œ JavaScript ä»£ç ä¼šè‡ªåŠ¨ submit åˆ°éšè—çš„ iframe è§†çª—é‡Œé¢ï¼Œæ‰€ä»¥ç®¡ç†å‘˜æ˜¯æ²¡æœ‰æ„Ÿè§‰çš„ã€‚åªè¦ç®¡ç†å‘˜æµè§ˆåˆ°è¿™æ®µè´´æ–‡çš„ç½‘é¡µï¼Œæµè§ˆå™¨å°±ä¼šè‡ªåŠ¨ POST å‡ºå»äº†.... è¾¾æˆé«˜äº®æ•ˆæœã€‚</p>

    </div>
  </div></div><div class='frame'><h1>
      3-4 å¦‚ä½•é˜²å¾¡ POST ç±»å‹çš„ CSRF æ”»å‡»ï¼Ÿ
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š3. CSRF è·¨ç«™è¯·æ±‚ä¼ªé€ </h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>é‚£è¦å¦‚ä½•é˜²å¾¡å‘¢ï¼Ÿæˆ‘ä»¬éœ€è¦é’ˆå¯¹æ‰€æœ‰é GET çš„æ“ä½œï¼Œéƒ½åŠ ä¸Šé¢å¤–çš„ token éªŒè¯ç å‚æ•°ï¼Œæ£€æŸ¥ç”¨æˆ·æµè§ˆå™¨å½“åˆçœŸçš„æ˜¯ä»ç½‘ç«™ä¸Šçš„æŸä¸ªè¡¨å•é€å‡ºçš„ï¼Œè€Œä¸æ˜¯ä¸å°å¿ƒè§¦å‘çš„ CSRF æ”»å‡»ã€‚</p>

<p>è¿™ä¸ªé˜²å¾¡åŠŸèƒ½ Rails å·²ç»å†…å»ºäº†ï¼Œè¯·ä¿®æ”¹ <code>app/controllers/application_controller.rb</code>ï¼Œæ‰“å¼€ <code>protect_from_forgery</code></p>

<figure class="figure-code code"><figcaption><span>app/controllers/application_controller.rb
</span></figcaption><div class="highlight"><pre>  class ApplicationController &lt; ActionController::Base

    # protect_from_forgery with: :exception
<span class="gi">+   protect_from_forgery with: :exception
</span><span class="err">
</span></pre></div>
</figure>

<p>åœ¨ Rails äº§ç”Ÿçš„è¡¨å•ä¸­ï¼Œå°±æœ‰å¸¦è¿™ä¸ªå‚æ•° <code>authenticity_token</code></p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/CWOAeWOaS4pAEApihUoO_3-6.png" title=""></figure></p>

<p>å¦‚æœæ˜¯ Ajax è¯·æ±‚ï¼ŒjQuery åˆ™ä¼šå»æŠ“ meta ä¸­çš„ <code>csrf-token</code> å‚æ•°é™„åŠ ä¸Šå»ï¼š</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/kK2BE2SMTJ2qI4NiaSSp_3-7.png" title=""></figure></p>

<p>é€è¿‡è¿™ç§æœºåˆ¶ï¼Œéª‡å®¢åœ¨å…¶ä»–ç½‘ç«™æŒ–çš„å‘å› ä¸ºæ²¡æœ‰è¿™ä¸ª<code>authenticity_token</code>å‚æ•°ï¼Œé€è¿‡æ¥çš„æ—¶å€™å°±ä¼šè¢« Rails é˜»æŒ¡ä½ï¼Œä¼šæœ‰ä»¥ä¸‹çš„é”™è¯¯ç”»é¢ï¼š</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/7MnnSijMSdCm8zBg47jj_3-8-422.png" title=""></figure></p>

<p>è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæœ‰æ—¶å€™é€› Rails åˆ¶ä½œçš„ç½‘ç«™ï¼Œè¡¨å•å¦‚æœæ”¾å¤ªä¹…æ‰é€å‡ºï¼Œæœ‰æ—¶å€™ä¹Ÿä¼šå‡ºç°è¿™ä¸ªé”™è¯¯ç”»é¢ï¼Œå› ä¸ºè¿™ä¸ª <code>authenticity_token</code> è¿‡æœŸå¤±æ•ˆäº†ã€‚</p>

    </div>
  </div></div><div class='frame'><h1>
      4-1 ä»€ä¹ˆæ˜¯ SQL
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š4. SQL Injection æ•°æ®åº“æ³¨å…¥æ”»å‡»</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>åœ¨ Rails ä¸­æˆ‘ä»¬åˆ©ç”¨ ActiveRecord è¯­æ³•æ¥æ“ä½œæ•°æ®åº“çš„èµ„æ–™ï¼Œä¾‹å¦‚æŸ¥è¯¢æ‰€æœ‰æ´»åŠ¨ï¼š</p>

<p><code>@events = Event.all</code></p>

<p>è¿™æ®µ Ruby ä»£ç ï¼Œå®é™…ä¸Šä¼šè¢«è½¬æˆæ•°æ®åº“è¯­è¨€ <a href="https://zh.wikipedia.org/zh-cn/SQL">SQL</a> æ¥å¯¹æ•°æ®åº“åšæŸ¥è¯¢ ï¼š</p>

<p><code>SELECT "events".* FROM "events"</code></p>

<p>åœ¨ Rails log ä¸­ï¼Œåªè¦å¯¹æ•°æ®åº“åšä»»ä½• CRUD æ“ä½œï¼Œéƒ½ä¼šæ˜¯ä¸€ä¸ª SQLï¼Œä¾‹å¦‚è¿™äº›éƒ½æ˜¯ SQL</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/2P3yfiytQS6PMtmaHwdb_4-1.png" title=""></figure></p>

<blockquote>
<p>ä¹‹åä¼šæœ‰æ•°æ®åº“è¯¾ç¨‹æ•™å„ä½ç†è§£æ•°æ®åº“åŸç†å’Œ SQLï¼Œç†è§£ SQL å°±å¯ä»¥åšå‡ºæ¯”è¾ƒå¤æ‚çš„æ•°æ®åˆ†æåŠŸèƒ½ï¼Œå¯ä»¥æŠŠ ActiveRecord æ•°æ®æŸ¥è¯¢ç”¨çš„æ›´å¥½ã€‚</p>
</blockquote>

    </div>
  </div></div><div class='frame'><h1>
      4-2 ä»€ä¹ˆæ˜¯ SQL Injection æ”»å‡»?
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š4. SQL Injection æ•°æ®åº“æ³¨å…¥æ”»å‡»</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>åœ¨å®é™…çš„ç½‘ç«™åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬ä¼šå°†ç”¨æˆ·è¾“å…¥çš„å‚æ•°ï¼ŒåŠ¨æ€åœ°ç»„åˆå‡º SQL æ¥å¯¹æ•°æ®åº“æŸ¥è¯¢ã€‚ä¾‹å¦‚ï¼š</p>

<p><code>@registrations = Registration.where( :status =&gt; params[:status] )</code></p>

<p>å°±ä¼šæ ¹æ®ç”¨æˆ·æµè§ˆå™¨ä¼ è¿‡æ¥çš„ <code>params[:status]</code> å‚æ•°ä¸åŒï¼Œè€Œç»„åˆå‡ºä¸åŒçš„ SQL å¥å­ã€‚å‡å¦‚å‚æ•° <code>params[:status]</code> æ˜¯ <code>pending</code>ï¼Œé‚£è¿™ä¸ª SQL å¥å°±ä¼šæ˜¯ï¼š</p>

<p><code>SELECT "registrations".* FROM "registrations" WHERE "registrations"."status" = 'pending'</code></p>
<h3>å®é™…æ”»å‡»ç¤ºèŒƒ</h3>
<p>åœ¨æœ¬è¯¾ç¨‹çš„èŒƒä¾‹ä¸­ï¼Œæœ‰ä¸€ä¸ªåŠŸèƒ½æ˜¯å…³é”®å­—æŸ¥è¯¢ç•™è¨€ï¼Œè¯·æµè§ˆè‡³ä»»ä¸€ä¸ªæ´»åŠ¨é¡µé¢ï¼š</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/2yEqOPZRuKISZQSStiOz_4-2.png" title=""></figure></p>

<p>æŒ‰ä¸‹ Search æŒ‰é’®åï¼Œå¯¹åº”çš„å¤„ç†ä»£ç åœ¨ <code>app/controllers/events_controller.rb</code> ä¸­çš„ show action:</p>

<figure class="figure-code code"><figcaption><span>app/controllers/events_controller.rb
</span></figcaption><div class="highlight"><pre>  <span class="vi">@comments</span> <span class="o">=</span> <span class="vi">@comments</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span> <span class="s2">"comments.content LIKE '%</span><span class="si">#{</span><span class="n">params</span><span class="p">[</span><span class="ss">:keyword</span><span class="p">]</span><span class="si">}</span><span class="s2">%'"</span><span class="p">)</span>
</pre></div>
</figure>

<p>è¿™æ®µ ActiveRecord è¯­æ³•ä¼šè¢«è½¬æˆå¦‚ä»¥ä¸‹çš„ SQL å¥ï¼š</p>

<figure class="figure-code code"><div class="highlight"><pre>SELECT "comments".* FROM "comments" WHERE "comments"."event_id" = ? AND (comments.content LIKE '%è¿™æ˜¯æœå¯»å…³é”®å­—%')  [["event_id", 95]]
</pre></div>
</figure>

<p>å¾ˆä¸å¹¸çš„ï¼Œè¿™ç§å†™æ³•å­˜åœ¨ SQL Injection æ¼æ´ï¼Œç”¨ä»¥ä¸‹çš„å…³é”®å­—å°±å¯ä»¥è¿›è¡Œæ”»å‡»ï¼Œåˆ é™¤æ‰€æœ‰ç•™è¨€æ•°æ®ï¼š</p>

<figure class="figure-code code"><div class="highlight"><pre>sorry'); DELETE * FROM comments; --
</pre></div>
</figure>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/9rU0g4kwRuOkcbxbQdnE_4-3.png" title=""></figure></p>

<p>æŒ‰ä¸‹ Search æŒ‰é’®åï¼Œæ‚²æƒ¨çš„äº‹æƒ…å°±å‘ç”Ÿäº†ï¼Œæ‰€æœ‰ç•™è¨€éƒ½è¢«åˆ é™¤äº† ğŸ˜³ğŸ˜³ğŸ˜³ğŸ˜³ğŸ˜³</p>

<p>è¿™æ˜¯æ€ä¹ˆåŠåˆ°çš„ï¼Ÿæˆ‘ä»¬æŠŠæ”»å‡»çš„å…³é”®å­—ä»£å…¥ SQL å¥å­ï¼Œå°±ä¼šå˜æˆï¼š</p>

<p><code>SELECT "comments".* FROM "comments" WHERE "comments"."event_id" = ? AND (comments.content LIKE '%sorry'); DELETE * FROM comments; --%')  [["event_id", 95]]</code></p>

<p>è¿™ä¼šè¢«æ•°æ®åº“è§£è¯»æˆä¸‰ä¸ª SQL å¥å­ï¼š</p>

<ol>
<li><code>SELECT "comments".* FROM "comments" WHERE "comments"."event_id" = ? AND (comments.content LIKE '%sorry');</code></li>
<li><code>DELETE * FROM comments;</code></li>
<li><code>--%')  [["event_id", 95]]</code></li>
</ol>

<p>å…¶ä¸­ç¬¬äºŒå¥å°±è¾¾æˆåˆ é™¤çš„æ•ˆæœï¼Œç¬¬ä¸‰å¥çš„ <code>--</code> æ˜¯ SQL çš„æ³¨è§£ã€‚</p>

<p>ç”±æ­¤å¯çŸ¥ï¼ŒSQL Injection æ•°æ®åº“æ³¨å…¥æ”»å‡»å¯ä»¥ç ´åæˆ‘ä»¬çš„æ•°æ®åº“ã€ä¿®æ”¹æ•°æ®èµ„æ–™ã€è·³è¿‡ç™»å…¥å¯†ç æ£€æŸ¥ç­‰ç­‰ï¼Œæ˜¯éå¸¸æœ‰ç ´ååŠ›çš„æ”»å‡»è¡Œä¸ºã€‚</p>

    </div>
  </div></div><div class='frame'><h1>
      4-3 å¦‚ä½•é˜²å¾¡ SQL æ³¨å…¥æ”»å‡» ï¼Ÿ
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š4. SQL Injection æ•°æ®åº“æ³¨å…¥æ”»å‡»</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>è·Ÿé˜²å¾¡ XSS ä¸€æ ·çš„é“ç†ï¼Œæ‰€æœ‰ç”¨æˆ·ä¼ è¿›æ¥è¦ä»£å…¥ SQL çš„å‚æ•°ï¼Œéƒ½å¿…é¡»åŠ ä»¥é€¸å‡ºï¼š</p>

<figure class="figure-code code"><figcaption><span>app/controllers/events_controller.rb
</span></figcaption><div class="highlight"><pre><span class="gd">-  @comments = @comments.where( "comments.content LIKE '%#{params[:keyword]}%'")
</span>
<span class="gi">+  keyword = ActiveRecord::Base::connection.quote_string( params[:keyword] )
+  @comments = @comments.where( "comments.content LIKE '%#{keyword}%'")
</span><span class="err">
</span></pre></div>
</figure>

<p>ä¸è¿‡ä»£å…¥ç”¨æˆ·å‚æ•°çš„æƒ…æ™¯å®åœ¨å¤ªå¸¸è§äº†ï¼Œåœ¨ Rails ä¼šé€šå¸¸ä¼šç”¨ç‰¹åˆ«çš„å†™æ³•æ¥æŒ‡å®š SQL æ¡ä»¶ï¼Œè®© Rails èƒ½å¤ŸçŸ¥é“å“ªä¸€éƒ¨åˆ†éœ€è¦é€¸å‡ºï¼š</p>

<figure class="figure-code code"><figcaption><span>app/controllers/events_controller.rb
</span></figcaption><div class="highlight"><pre><span class="gd">-  @comments = @comments.where( "comments.content LIKE '%#{params[:keyword]}%'")
</span><span class="gi">+  @comments = @comments.where( "comments.content LIKE ?", "%#{params[:keyword]}%")
</span><span class="err">
</span></pre></div>
</figure>

<p>å…¶ä¸­ <code>?</code> ä»£è¡¨è¦ä»£å…¥çš„å‚æ•°ã€‚</p>

<p>æœ€åçš„ SQL å¥å­å˜æˆï¼š</p>

<figure class="figure-code code"><div class="highlight"><pre>SELECT "comments".* FROM "comments" WHERE "comments"."event_id" = ? AND (comments.content LIKE '%sorry''); DELETE * FROM comments; --%')  [["event_id", 95]]
</pre></div>
</figure>

<p>å…¶ä¸­ <code>sorry')</code> å˜æˆ <code>sorry'')</code> äº†ï¼Œè¿™æ ·æ•°æ®åº“å°±çŸ¥é“è¿™æ­¤å•å¼•å·ä¸æ˜¯ç»“æŸçš„å•å¼•å·ã€‚</p>

<blockquote>
<p>ä½ å¯ä»¥å†æµ‹è¯•çœ‹çœ‹è¿˜ä¼šä¸ä¼šæœ‰è¿™ä¸ªæ¼æ´ï¼Œé€å‡ºåä¼šå…ˆçœ‹åˆ°æ²¡æœ‰ä»»ä½•èµ„æ–™æ˜¯æ­£å¸¸çš„ï¼Œå› ä¸ºæŸ¥ä¸åˆ°ä»»ä½•ç•™è¨€æ˜¯ç¬¦åˆå…³é”®å­—ã€‚è¯·å›é¦–é¡µå†è¿›æ¥ï¼Œç•™è¨€è¿˜æ˜¯æ­£å¸¸æ²¡æœ‰è¢«åˆ é™¤æ‰ã€‚</p>
</blockquote>

<p>å¦ä¸€ç§å¸¸è§çš„å†™æ³•æ˜¯ç”¨ Hashï¼Œä¾‹å¦‚</p>

<figure class="figure-code code"><figcaption><span>
</span></figcaption><div class="highlight"><pre><span class="vi">@registrations</span> <span class="o">=</span> <span class="no">Registraion</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span> <span class="s2">"status = '</span><span class="si">#{</span><span class="n">params</span><span class="p">[</span><span class="ss">:status</span><span class="p">]</span><span class="si">}</span><span class="s2">' ) # è‡ªå·±ç»„å­—ç¬¦ä¸²ï¼Œè¿™ä¸å®‰å…¨ï¼Œæœ‰ SQL æ³¨å…¥æ¼æ´

@registrations = Registraion.where( :status =&gt; params[:status] ) # Hash å†™æ³•ï¼Œè¿™æ˜¯å®‰å…¨çš„
@registrations = Registraion.where( "</span><span class="n">status</span> <span class="o">=</span> <span class="sc">?"</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="ss">:status</span><span class="p">]</span> <span class="p">)</span> <span class="c1"># Array å†™æ³•ï¼Œè¿™æ˜¯å®‰å…¨çš„
</span>

</pre></div>
</figure>

    </div>
  </div></div><div class='frame'><h1>
      4-4 æ¼ç½‘ä¹‹é±¼
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š4. SQL Injection æ•°æ®åº“æ³¨å…¥æ”»å‡»</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>ä¸Šä¸€èŠ‚ä¸­æˆ‘ä»¬ç¤ºèŒƒäº†åœ¨ <code>where</code> è¯­æ³•ä¸­ï¼Œç”¨ Hash æˆ– Array å†™æ³•å¯ä»¥è‡ªåŠ¨åšé€¸å‡ºã€‚ä½†æ˜¯åœ¨ ActiveReocrd ä¸­ï¼Œè¿˜æœ‰ä¸€äº›æ–¹æ³•å¹¶æ²¡æœ‰å¸®æˆ‘ä»¬åšé€¸å‡ºï¼ŒåŒ…æ‹¬ <code>order</code>ã€<code>pluck</code> ç­‰ç­‰ï¼Œè¯¦è§ <a href="https://rails-sqli.org">Rails SQL Injection</a>ã€‚</p>

<p>æ‰€ä»¥å½“æˆ‘ä»¬éœ€è¦å°†ç”¨æˆ·ä¼ è¿‡æ¥çš„å‚æ•°ä¼ è¿›å»æ—¶ï¼Œé™¤äº†é€¸å‡ºä¹‹å¤–ï¼Œä¹Ÿå¯ä»¥é‡‡ç”¨ç™½åå•çš„è¿‡æ»¤æ–¹å¼ã€‚</p>

<p>åœ¨èŒƒä¾‹ä¸­ï¼Œå¯ä»¥æ ¹æ®ç”¨æˆ·æŒ‡å®šçš„é¡ºåºæ¥åšæ’åºï¼š</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/wmMSHd62RnQnxiWbhfKV_4-4.png" title=""></figure></p>

<p>ç”¨æˆ·å¯ä»¥ç‚¹ä¸åŒè¿ç»“æ¥è¿›è¡Œæ’åºï¼Œä¼šä¼ ä¸åŒ <code>sort</code> å‚æ•°ã€‚ç”¨æˆ·ä¼ è¿‡æ¥çš„å‚æ•°éƒ½æ˜¯ä¸å¯ä»¥ä¿¡ä»»çš„ï¼Œç”¨æˆ·å¤§å¯ä»¥ç›´æ¥ä¿®æ”¹ç½‘å€å°±å¯ä»¥ä¼ ä»»æ„å‚æ•°è¿›æ¥ ğŸ™€ğŸ™€ğŸ™€</p>

<p>è¯·ä¿®æ”¹ <code>app/controllers/events_controller.rb</code>ï¼Œæˆ‘ä»¬åªèƒ½å…è®¸ç‰¹å®šçš„æŸ¥è¯¢å‚æ•°ï¼š</p>

<figure class="figure-code code"><figcaption><span>app/controllers/events_controller.rb
</span></figcaption><div class="highlight"><pre><span class="gd">-  if params[:sort] # æœ¬æ¥è¿™æ ·æœ‰æ¼æ´ï¼Œä½ å¤ªç›¸ä¿¡ç”¨æˆ·ä¼ è¿›æ¥çš„å‚æ•°äº†
</span><span class="gi">+  if params[:sort] &amp;&amp; ["id DESC", "id ASC"].include?(params[:sort])  # åªæœ‰ç™½åå•å†…çš„å‚æ•°å¯ä»¥ç”¨
</span>    @comments = @comments.order(params[:sort])
  end
<span class="err">
</span></pre></div>
</figure>

    </div>
  </div></div><div class='frame'><h1>
      5-1 ActiveRecord èµ‹å€¼åŠŸèƒ½
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š5. å¤§é‡èµ‹å€¼(Mass Assignment)</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>å¤§é‡èµ‹å€¼(Mass Assignment)æ˜¯ ActiveRecord çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œä¾‹å¦‚ä»¥ä¸‹æ˜¯æ–°å»º Event çš„ä»£ç ï¼š</p>

<figure class="figure-code code"><figcaption><span>
</span></figcaption><div class="highlight"><pre><span class="n">event</span> <span class="o">=</span> <span class="no">Event</span><span class="p">.</span><span class="nf">new</span>
<span class="n">event</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"Foo"</span>
<span class="n">event</span><span class="p">.</span><span class="nf">description</span> <span class="o">=</span> <span class="s2">"Bar"</span>
<span class="n">event</span><span class="p">.</span><span class="nf">save</span>
</pre></div>
</figure>

<p>è¿™ä¸ª <code>new</code> å¯ä»¥æ¥å— Hash æ¥åšèµ‹å€¼ï¼Œä¸Šè¿°çš„ä»£ç ç­‰åŒäºï¼š</p>

<figure class="figure-code code"><figcaption><span>
</span></figcaption><div class="highlight"><pre><span class="no">Event</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">"Foo"</span><span class="p">,</span> <span class="ss">:description</span> <span class="o">=&gt;</span> <span class="s2">"Bar"</span> <span class="p">}</span> <span class="p">)</span>
</pre></div>
</figure>

<p>å¦å¤–ï¼Œæ”¾åœ¨æ–¹æ³•å‚æ•°æœ€åé¢çš„ Hashï¼Œå®ƒçš„ <code>{ }</code> æ˜¯å¯ä»¥çœç•¥çš„ï¼Œå› æ­¤è¿™åˆç­‰åŒäºï¼š</p>

<figure class="figure-code code"><div class="highlight"><pre>Event.new( :name =&gt; "Foo", :description =&gt; "Bar" )
</pre></div>
</figure>

<p>è¿™ç§ç”¨æ³•å°±å«åšå¤§é‡èµ‹å€¼(Mass Assignment)ã€‚é™¤äº† <code>new</code> ä¹‹å¤–ï¼Œ<code>update</code> ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œè¿™ä¸ªæˆ‘ä»¬åœ¨åš CRUD æ—¶å°±æœ‰çœ‹è¿‡ï¼Œä¾‹å¦‚ï¼š</p>

<figure class="figure-code code"><figcaption><span>
</span></figcaption><div class="highlight"><pre><span class="n">event</span> <span class="o">=</span> <span class="no">Event</span><span class="p">.</span><span class="nf">first</span>
<span class="n">event</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"Foo"</span>
<span class="n">event</span><span class="p">.</span><span class="nf">description</span> <span class="o">=</span> <span class="s2">"Bar"</span>
<span class="n">event</span><span class="p">.</span><span class="nf">save</span>

</pre></div>
</figure>

<p>ç­‰åŒäº</p>

<figure class="figure-code code"><figcaption><span>
</span></figcaption><div class="highlight"><pre><span class="n">event</span> <span class="o">=</span> <span class="no">Event</span><span class="p">.</span><span class="nf">first</span>
<span class="n">event</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">"Foo"</span><span class="p">,</span> <span class="ss">:description</span> <span class="o">=&gt;</span> <span class="s2">"Bar"</span> <span class="p">)</span>

</pre></div>
</figure>

    </div>
  </div></div><div class='frame'><h1>
      5-2 å¤§é‡èµ‹å€¼ä¸ Rails è¡¨å•
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š5. å¤§é‡èµ‹å€¼(Mass Assignment)</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>è¿™ä¸ªåŠŸèƒ½çš„ä¸»ç”¨ç”¨é€”æ˜¯å¯ä»¥è·Ÿ Rails <code>form_for</code> æ–¹æ³•äº§ç”Ÿçš„è¡¨å•åšé…å¥—ï¼Œåœ¨ä»¥ä¸‹çš„ Event è¡¨å•ä¸­ï¼ŒRails æ•…æ„å°† HTML è¾“å…¥æ¡† input çš„ <code>name</code> å‘½åæˆ <code>event[name]</code> å’Œ <code>event[description]</code></p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/gNJTNOwpQUKrR6pgsccI_5-1.png" title=""></figure></p>

<p>è¿™æ ·é€å‡ºåï¼ŒRails ä¼šè§£ææˆ <code>params[:event]</code> åˆšå¥½æ˜¯ä¸€ä¸ª Hashï¼Œå¯ä»¥è·Ÿå¤§é‡èµ‹å€¼ç”¨æ³•é…å¥—åœ¨ä¸€èµ·ï¼š</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/MlJegER3y7OdbjesqaSg_5-2.png" title=""></figure></p>

<p>åœ¨æ—©å…ˆçš„ Rails ç‰ˆæœ¬ä¸­ï¼Œå¯ä»¥ç›´æ¥æŠŠ <code>params[:event]</code> ä¸¢è¿› <code>new</code> æˆ– <code>update</code> ä¸­ï¼Œä¾‹å¦‚ï¼š</p>

<p><code>Event.new(params[:event])</code></p>

<p><code>@event.update( params[:event] )</code></p>

<p>ä¸è¿‡è¿™æ ·å´å­˜åœ¨ä¸€ä¸ªå¤§æ¼æ´ï¼Œç”¨æˆ·å¯ä»¥è‡ªè¡Œä¿®æ”¹è¡¨å• input çš„ nameã€‚è¿™å¾ˆç®€å•ä½ ç”¨ Chrome é™¤é”™å™¨å°±å¯ä»¥åŠåˆ°äº†ï¼Œç‚¹è¯¥ input çš„ name å°±å¯ä»¥æ”¹ï¼š</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/r79h5T4SQ15rSZpoaU7M_5-3.png" title=""></figure></p>

<p>è¿™é‡Œæ”¹æˆ <code>event[user_id]</code>ï¼Œé€å‡ºä¹‹åå¦‚æœç›´æ¥è°ƒç”¨<code>@event.update( params[:event] )</code>çš„è¯ï¼Œé‚£å°±ä¿®æ”¹åˆ° <code>user_id</code> äº† ğŸ™€ğŸ™€ğŸ™€</p>

<p>å› æ­¤åœ¨æ–°ç‰ˆçš„ Rails ä¸­ï¼Œå¿…é¡»ç»è¿‡ <a href="https://github.com/rails/strong_parameters">Strong Parameters</a> è¿‡æ»¤åï¼Œæ‰èƒ½ä¼ è¿› <code>new</code> æˆ– <code>update</code> ä¹‹ä¸­ï¼Œä»¥ä¸‹è¿™æ®µä»£ç å¤§å®¶éƒ½ç†Ÿæ‚‰ï¼š</p>

<figure class="figure-code code"><figcaption><span>
</span></figcaption><div class="highlight"><pre>  <span class="k">def</span> <span class="nf">update</span>
    <span class="vi">@event</span> <span class="o">=</span> <span class="no">Event</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>

    <span class="k">if</span> <span class="vi">@event</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">event_params</span><span class="p">)</span>
      <span class="n">redirect_to</span> <span class="n">admin_events_path</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s2">"edit"</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">protected</span>

  <span class="k">def</span> <span class="nf">event_params</span>
    <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:event</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:description</span><span class="p">)</span>
  <span class="k">end</span>

</pre></div>
</figure>

<p>å…¶ä¸­ <code>params.require(:event).permit(:name, :description)</code> å°±æ˜¯åœ¨åšç™½åå•çš„æ£€æŸ¥ï¼Œåªèƒ½å…è®¸ <code>params[:event][:name]</code> å’Œ <code>params[:event][:description]</code></p>

    </div>
  </div></div><div class='frame'><h1>
      5-3 æ”»å‡»ç¤ºèŒƒ
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š5. å¤§é‡èµ‹å€¼(Mass Assignment)</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>ä¸è¿‡å³ä½¿æœ‰ <a href="https://github.com/rails/strong_parameters">Strong Parameters</a> çš„ä¿æŠ¤ï¼Œè¿˜æ˜¯å¯èƒ½å› ä¸ºç¨‹åºå‘˜æ¼«ä¸ç»å¿ƒè€Œå­˜åœ¨æ¼æ´ã€‚è®©æˆ‘ä»¬æ¥æ”»å‡»çœ‹çœ‹ã€‚</p>

<p>è¯·ç‚¹é€‰ä¸»é€‰å•ä¸Šçš„ä¿®æ”¹ä¸ªäººèµ„æ–™ï¼Œä¸è¿‡æˆ‘ä»¬ä¸æ˜¯æƒ³è¦ä¿®æ”¹æš±ç§°ï¼Œæˆ‘ä»¬æƒ³è¦æ¥ä¿®æ”¹ Role è§’è‰²....</p>

<ol>
<li>é€è¿‡ Chrome é™¤é”™å™¨å°†æš±ç§° input çš„ name ä¸º <code>user[role]</code>
</li>
<li>è¾“å…¥æ¡†è¾“å…¥ <code>admin</code>
</li>
<li>æŒ‰ä¸‹é€å‡º</li>
</ol>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ilSd1SFgTTO7pN4W2TvE_5-4.png" title=""></figure></p>

<p>ç„¶å hacker å°±å˜æˆ admin äº†ï¼Œä½ ç°åœ¨å¯ä»¥åœ¨ä¸»é€‰å•ä¸Šç‚¹è¿›åå°.... ğŸ™€ğŸ™€ğŸ™€ğŸ™€ğŸ™€</p>

    </div>
  </div></div><div class='frame'><h1>
      5-4 ä¿®è¡¥æ¼æ´
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š5. å¤§é‡èµ‹å€¼(Mass Assignment)</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>è®©æˆ‘ä»¬çœ‹çœ‹åˆ°åº•å“ªé‡Œå‡ºäº†æ¼æ´ï¼Œè¯·æ‰“å¼€ <code>app/controllers/users_controller.rb</code>ï¼Œé—®é¢˜å‡ºåœ¨ <code>params.require(:user).permit(:nickname, :role)</code> è¿™ä¸€è¡Œå¤ªè¿‡æ”¾çºµäº†ï¼Œç«Ÿç„¶å…è®¸ç”¨æˆ·å¯ä»¥ä¼ å‚æ•° <code>role</code> è¿›æ¥... :(</p>

<p>è™½ç„¶åœ¨ç½‘é¡µè¡¨å•ä¸Šé¢æ²¡æœ‰ <code>role</code> è¾“å…¥æ¡†ï¼Œä½†æ˜¯ç”¨æˆ·ä¾ç„¶å¯ä»¥è‡ªå·±æƒ³åŠæ³•æŠŠå‚æ•°ä¼ è¿›æ¥ã€‚</p>

<p>è®©æˆ‘ä»¬ä¿®è¡¥è¿™ä¸ªæ¼æ´ï¼š</p>

<figure class="figure-code code"><figcaption><span>app/controllers/users_controller.rb
</span></figcaption><div class="highlight"><pre>  def update
    @user = current_user

    if @user.update(user_params)
      redirect_to user_path(@user)
    else
      render "edit"
    end
  end

  protected

  def user_params
<span class="gd">-    params.require(:user).permit(:nickname, :role)
</span><span class="gi">+    params.require(:user).permit(:nickname)
</span>  end
<span class="err">
</span></pre></div>
</figure>

<p>å†æµ‹è¯•ä¸€æ¬¡ï¼Œéª‡å®¢å°±ä¸èƒ½ä¿®æ”¹ role äº†ã€‚åœ¨ Rails log ä¹‹ä¸­ï¼Œä¼šå‡ºç°</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/7tNCd9v4ReeoZ4mAaoiq_5-5.png" title=""></figure></p>

<p><code>Unpermitted parameter: role</code> çš„æ„æ€å°±æ˜¯ç”¨æˆ·ä¼ äº†ä¸€ä¸ª <code>role</code> å‚æ•°è¿›æ¥è¢«è¿‡æ»¤æ‰äº†ã€‚</p>

<p>ä»è¿™ä¸ªæ¼æ´æˆ‘ä»¬ä¹Ÿå¯ä»¥äº†è§£ä¸ºä»€ä¹ˆå‰å°ã€åå°çš„ controller ä¼šæ‹†å¼€çš„ä¸€ä¸ªåŸå› ï¼Œå°±æ˜¯å‰åå°çš„ Strong Parameters å‚æ•°ç™½åå•æ˜¯ä¸ä¸€æ ·çš„ã€‚ç»™å‰å°ç”¨æˆ·çš„ <code>users_controller</code> ä¸å…è®¸ä¿®æ”¹ roleï¼Œä½†æ˜¯åå° <code>admin::users_controller</code> æ˜¯å¯ä»¥å…è®¸ä¿®æ”¹ role çš„ã€‚å¦‚æ­¤æ‹†åˆ†æ‰ä¼šæ¸…æ¥šä¸ä¼šææ··é€ æˆæ¼æ´ã€‚</p>

    </div>
  </div></div><div class='frame'><h1>
      6-1 ä»€ä¹ˆæ˜¯åŠ å¯† Cookie
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š6. ç ´è§£åŠ å¯† Cookie-based Session</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p><a href="https://zh.wikipedia.org/zh-cn/Cookie">Cookie</a> æ˜¯æµè§ˆå™¨çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œè®©æœåŠ¡å™¨å¯ä»¥ç•™æ•°æ®åœ¨ç”¨æˆ·æµè§ˆå™¨ä¸Šï¼Œè¿™æ · Rails å°±å¯ä»¥è¿½è¸ªè¯†åˆ«ä¸åŒç™»å…¥ç”¨æˆ·ã€‚æµè§ˆå™¨æ¯æ¬¡å¯¹æœåŠ¡å™¨çš„è¯·æ±‚ï¼Œéƒ½ä¼šé™„å¸¦è¿™ä¸ª Cookie æ•°æ®ã€‚</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/8Q50gisARByEBfKgIE2u_6-1.png" title=""></figure></p>

<p>ä¾‹å¦‚ç”¨æˆ·ç™»å…¥æ—¶ï¼Œè¾“å…¥å¸å·ã€å¯†ç ï¼ŒæœåŠ¡å™¨æ£€æŸ¥æ²¡é—®é¢˜åï¼Œå°±ä¼šè®¾å®šè¯¥æµè§ˆå™¨çš„ä¸€ä¸ª Cookie æ˜¯ user_id æ˜¯ 123<br>
æ¥ä¸‹æ¥ç”¨æˆ·æµè§ˆå™¨å¯¹è¿™ä¸ªç½‘ç«™çš„ä»»ä½•è¯·æ±‚ï¼Œå°±ä¼šé™„å¸¦è¿™ä¸ª Cookie å‚æ•°ï¼Œé‚£ä¹ˆæœåŠ¡å™¨å°±çŸ¥é“è¿™ä¸ªæµè§ˆå™¨æ˜¯ç”¨æˆ· 123</p>

<p>ä¸è¿‡ï¼Œè¿™æ˜¯ç®€åŒ–çš„ç‰ˆæœ¬ï¼Œç›¸ä¿¡å¤§å®¶éƒ½çŸ¥é“ç”¨æˆ·æ˜¯ä¸å¯ä»¥ç›¸ä¿¡çš„ï¼Œå­˜åœ¨ç”¨æˆ·ç«¯çš„ Cookie ä¹Ÿæ˜¯ä¸å¯ä»¥ç›¸ä¿¡çš„ï¼Œéª‡å®¢å¯ä»¥ä¿®æ”¹ user_id å˜æˆ 1ï¼Œé‚£ä¸å°±å˜èº«ä¸ºç®¡ç†å‘˜äº†å—?</p>

<p>å› æ­¤æˆ‘ä»¬éœ€è¦é’ˆå¯¹ Cookie åšåŠ å¯†ï¼Œç”¨ä¸€ç§å«åš<a href="https://zh.wikipedia.org/wiki/%E5%B0%8D%E7%A8%B1%E5%AF%86%E9%91%B0%E5%8A%A0%E5%AF%86">å¯¹ç§°å¯†é’¥åŠ å¯†</a>çš„ç®—æ³•ï¼Œç”¨ä¸€æŠŠå¯†é’¥æ¥åšåŠ å¯†ï¼Œå¹¶ä¸”ç”¨è¿™ä¸ªå¯†é’¥å¯ä»¥è§£å¯†å›æ¥ã€‚</p>

<p>ä¾‹å¦‚ï¼Œä»¥ä¸‹æ˜¯ä¸€æ®µç”¨ <a href="https://zh.wikipedia.org/wiki/%E8%B3%87%E6%96%99%E5%8A%A0%E5%AF%86%E6%A8%99%E6%BA%96">DES</a> ç®—æ³•åŠ å¯†çš„ Ruby ä»£ç ï¼Œå°† <code>{message: "è¿™æ˜¯å¯†æ–‡"}</code> è¿›è¡ŒåŠ å¯†ï¼Œä½ å¯ä»¥è¿› <code>irb</code> å®éªŒçœ‹çœ‹ï¼š</p>

<figure class="figure-code code"><figcaption><span>
</span></figcaption><div class="highlight"><pre><span class="n">key</span> <span class="o">=</span> <span class="s1">'baRudSWouiTVfu0jwXfYDg=='</span> <span class="c1"># ä¸€æ®µéšæœºæ•°æ˜¯å¯†é’¥
</span>

<span class="c1"># åŠ å¯†
</span>
<span class="nb">require</span> <span class="s1">'json'</span>
<span class="nb">require</span> <span class="s1">'base64'</span>
<span class="nb">require</span> <span class="s1">'openssl'</span>
<span class="n">text</span> <span class="o">=</span> <span class="p">{</span><span class="ss">message: </span><span class="s2">"è¿™æ˜¯å¯†æ–‡"</span><span class="p">}.</span><span class="nf">to_json</span>
<span class="n">cipher</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">Cipher</span><span class="o">::</span><span class="no">DES</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"ECB"</span><span class="p">)</span>
<span class="n">cipher</span><span class="p">.</span><span class="nf">encrypt</span>
<span class="n">cipher</span><span class="p">.</span><span class="nf">key</span> <span class="o">=</span> <span class="no">Base64</span><span class="p">.</span><span class="nf">strict_decode64</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="n">encrypted</span> <span class="o">=</span> <span class="n">cipher</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">+</span> <span class="n">cipher</span><span class="p">.</span><span class="nf">final</span>
<span class="n">data</span> <span class="o">=</span> <span class="no">Base64</span><span class="p">.</span><span class="nf">strict_encode64</span><span class="p">(</span><span class="n">encrypted</span><span class="p">)</span>
</pre></div>
</figure>

<p>æœ€åå¾—åˆ°çš„ data æ˜¯ <code>"pxsTws7UtD7bOwCl6+FeLQEBJWqNTb3RSo2V84/udL0="</code> å°±æ˜¯ä¸€æ®µåŠ å¯†åçš„æ–‡å­—ã€‚</p>

<p>ä»¥ä¸‹æ˜¯è§£å¯†çš„ä»£ç ï¼š</p>

<figure class="figure-code code"><figcaption><span>
</span></figcaption><div class="highlight"><pre><span class="n">key</span> <span class="o">=</span> <span class="s1">'baRudSWouiTVfu0jwXfYDg=='</span> <span class="c1"># è¦åŒä¸€æŠŠå¯†é’¥æ‰èƒ½è§£å¼€
</span>

<span class="nb">require</span> <span class="s1">'json'</span>
<span class="nb">require</span> <span class="s1">'base64'</span>
<span class="nb">require</span> <span class="s1">'openssl'</span>

<span class="n">encrypted_string</span> <span class="o">=</span> <span class="no">Base64</span><span class="p">.</span><span class="nf">decode64</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">cipher</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">Cipher</span><span class="o">::</span><span class="no">DES</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"ECB"</span><span class="p">)</span>
<span class="n">cipher</span><span class="p">.</span><span class="nf">decrypt</span>
<span class="n">cipher</span><span class="p">.</span><span class="nf">key</span> <span class="o">=</span> <span class="no">Base64</span><span class="p">.</span><span class="nf">strict_decode64</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">cipher</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">encrypted_string</span><span class="p">)</span> <span class="o">+</span> <span class="n">cipher</span><span class="p">.</span><span class="nf">final</span>
<span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</figure>

<p>æœ€åå°±è§£å› <code>{message: "è¿™æ˜¯å¯†æ–‡"}</code> äº†ã€‚</p>

<p>åœ¨ä¸çŸ¥é“å¯†é’¥çš„æƒ…å†µä¸‹ï¼Œè¦ç ´è§£å›æœ¬æ¥çš„ç§˜æ–‡æ˜¯éå¸¸å›°éš¾çš„ï¼Œéœ€è¦è€—è´¹éå¸¸å¼ºå¤§çš„è¶…çº§ç”µè„‘ CPU è¿ç®—èµ„æºæ‰èƒ½ç ´è§£ã€‚</p>

    </div>
  </div></div><div class='frame'><h1>
      6-2 Rails çš„ secret key
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š6. ç ´è§£åŠ å¯† Cookie-based Session</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>åœ¨ Rails ä¸­ï¼Œé»˜è®¤çš„ Session å®é™…ä¸Šå°±æ˜¯åŠ å¯†çš„ Cookieï¼Œæˆ‘ä»¬åœ¨è´­ç‰©è½¦æ•™ç¨‹ä¸­ï¼Œä½¿ç”¨äº† <code>session[:cart_id]</code> æ¥å‚¨å­˜è¿½è¸ªç”¨æˆ·æ˜¯å“ªä¸€å°è´­ç‰©è½¦ã€‚</p>

<p>åˆšåˆšæˆ‘ä»¬å­¦åˆ°è¦èƒ½è§£å¯†çš„å…³é”®æ˜¯é‚£ä¸ªå¯†é’¥ï¼Œè€Œåœ¨ Rails ä¸­ï¼Œè¿™ä¸€æŠŠå¯†é’¥å°±å­˜åœ¨ <code>config/secrets.yml</code></p>

<figure class="figure-code code"><figcaption><span>
</span></figcaption><div class="highlight"><pre><span class="s">development:</span><span class="err">
</span>
  <span class="s">secret_key_base</span><span class="pi">:</span> <span class="s">a875bedfd1ba629c6c6039597cfd89a5bfb34fc440a0203d649bbd9e06de3e1939a4a586e1ed893108157688782b86b25223853a5b140aba7a21e5df675bed22</span><span class="err">
</span>

<span class="s">test:</span><span class="err">
</span>
  <span class="s">secret_key_base</span><span class="pi">:</span> <span class="s">162ffbf8a8079326e46d6f6cf946de5c67a5c2372120a642b10c6d14b413f78fda09870a0697315ac067cf6bb6924b7ae16841894f3919ef09de65238d85f712</span><span class="err">
</span>

<span class="c1"># Do not keep production secrets in the repository,
</span>
<span class="c1"># instead read values from the environment.
</span>
<span class="s">production:</span><span class="err">
</span>
  <span class="s">secret_key_base</span><span class="pi">:</span> <span class="s">&lt;%= ENV["SECRET_KEY_BASE"] %&gt;</span><span class="err">
</span></pre></div>
</figure>

<p>è¿™ä¸ª YAML è¿˜æ ¹æ®ä¸åŒç¯å¢ƒåŒºåˆ†ï¼Œæœ¬æœºå¼€å‘ç”¨çš„å¯†é’¥ï¼Œå’Œéƒ¨ç½² production ç¯å¢ƒç”¨çš„å¯†é’¥æ˜¯ä¸åŒçš„ã€‚</p>

<p>è¿™æŠŠå¯†é’¥éå¸¸é‡è¦ï¼Œä¸èƒ½å¤–æ´©ã€‚çŸ¥é“å¯†é’¥çš„è¯ï¼Œç”¨æˆ·å°±å¯ä»¥è§£å¼€ Cookieï¼Œå·çœ‹é‡Œé¢çš„å†…å®¹ï¼Œç”šè‡³ä¿®æ”¹å­˜å›å»ï¼Œè¿™æ ·æœåŠ¡å™¨å°±ä¼šè¢«éª—è¿‡å»....</p>

<p>è®©æˆ‘ä»¬çœ‹çœ‹å¦‚æœå¤–æ´©ä¼šæ€ä¹ˆæ ·ï¼Œä¾‹å¦‚ä½ æŠŠ production æ­£å¼ç¯å¢ƒçš„å¯†é’¥ push åˆ° github å…¬å¼€çš„é¡¹ç›®....</p>

    </div>
  </div></div><div class='frame'><h1>
      6-3 ç ´è§£ç¤ºèŒƒ
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š6. ç ´è§£åŠ å¯† Cookie-based Session</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>å¥½ï¼Œï¼Œå‡è®¾æˆ‘ä»¬å·²ç»çŸ¥é“å¯†é’¥æ˜¯ <code>a875bedfd1ba629c6c6039597cfd89a5bfb34fc440a0203d649bbd9e06de3e1939a4a586e1ed893108157688782b86b25223853a5b140aba7a21e5df675bed22</code></p>

<p>æ¥ç€æ‰“å¼€ Chrome é™¤é”™å™¨ï¼Œå¤åˆ¶ä¸‹ <code>_hackme-app_session</code> è¿™æ®µ Cookie çš„å€¼ï¼Œä¾‹å¦‚ï¼š</p>

<figure class="figure-code code"><div class="highlight"><pre>V0JxRVF2UjQ4ZUx5M0tYMFgxN3ZIK092Yy9aY1RSNGJFZ3FIdDgvbUdOZjJxd0tJWHMyRk12bjRpRmMyRm85Qko1bXAwSThHZVA1TnhhZHhNb0hNL3FJQ0c3cVpGVUJ0VVY3N28zU3l6bkRCQkJXdGQ0LzRqR2tCeVVMSzNYbWtIRm1ycEhIejN2L1FmUTFIMktvNGpmWk8yOHFyQXUxZXlBMXd2SHlkV29RaENUdWwxSWsxdlBHVHF2Q0hTYXFoc0RydUd4MXJJMzQ5dm5ZUS9vYURnaWdubnduc1cwK3ExZldpMFVRSmZkUXZRa0FvR3FqQVplZEordE10MzVqTS0tSUs4NCtsZjNRZGRDMjM1ajVzQkRHQT09--f99ee52c228793955481cf56604ca293c96989a4
</pre></div>
</figure>

<p>è¿› <code>rails console</code> è´´ä¸Šï¼š</p>

<figure class="figure-code code"><div class="highlight"><pre>def decrypt_session_cookie(cookie, key)
  cookie = CGI::unescape(cookie)
  salt         = "encrypted cookie"
  signed_salt  = "signed encrypted cookie"

  key_generator = ActiveSupport::KeyGenerator.new(key, iterations: 1000)
  secret = key_generator.generate_key(salt)
  sign_secret = key_generator.generate_key(signed_salt)

  encryptor = ActiveSupport::MessageEncryptor.new(secret, sign_secret, serializer: ActiveSupport::MessageEncryptor::NullSerializer)
  encryptor.decrypt_and_verify(cookie)
end

key = 'a875bedfd1ba629c6c6039597cfd89a5bfb34fc440a0203d649bbd9e06de3e1939a4a586e1ed893108157688782b86b25223853a5b140aba7a21e5df675bed22'
cookie = 'V0JxRVF2UjQ4ZUx5M0tYMFgxN3ZIK092Yy9aY1RSNGJFZ3FIdDgvbUdOZjJxd0tJWHMyRk12bjRpRmMyRm85Qko1bXAwSThHZVA1TnhhZHhNb0hNL3FJQ0c3cVpGVUJ0VVY3N28zU3l6bkRCQkJXdGQ0LzRqR2tCeVVMSzNYbWtIRm1ycEhIejN2L1FmUTFIMktvNGpmWk8yOHFyQXUxZXlBMXd2SHlkV29RaENUdWwxSWsxdlBHVHF2Q0hTYXFoc0RydUd4MXJJMzQ5dm5ZUS9vYURnaWdubnduc1cwK3ExZldpMFVRSmZkUXZRa0FvR3FqQVplZEordE10MzVqTS0tSUs4NCtsZjNRZGRDMjM1ajVzQkRHQT09--f99ee52c228793955481cf56604ca293c96989a4'

j = decrypt_session_cookie(cookie, key)

</pre></div>
</figure>

<p>å°±ä¼šè§£å¯†å‡ºä¸€æ®µ JSON å‘Šè¯‰æˆ‘ä»¬ç”¨æˆ· id æ˜¯ 48ï¼Œè´­ç‰©è½¦ <code>cart_id</code> æ˜¯ 501ã€‚</p>

<figure class="figure-code code"><div class="highlight"><pre>"{\"session_id\":\"744813165ee90c30650c4ab8338d8140\",\"cart_id\":501,\"warden.user.user.key\":[[48],\"$2a$11$tpfEqlcCqD/8JRWPtvZTzu\"],\"_csrf_token\":\"zMPrCyTnxvpsPY0OWhPi8sM2suOa3dUFk4HHDyedbIs=\"}"
</pre></div>
</figure>

<p>ä»¥ä¸‹ä»£ç ä¼šä¿®æ”¹ cart_id å¹¶å¯ä»¥åŠ å¯†å›å»ï¼š</p>

<figure class="figure-code code"><div class="highlight"><pre>def encrypt_session_cookie(value, key)
  salt         = "encrypted cookie"
  signed_salt  = "signed encrypted cookie"

  key_generator = ActiveSupport::KeyGenerator.new(key, iterations: 1000)
  secret = key_generator.generate_key(salt)
  sign_secret = key_generator.generate_key(signed_salt)

  encryptor = ActiveSupport::MessageEncryptor.new(secret, sign_secret, serializer: ActionDispatch::Cookies::JsonSerializer)
  encryptor.encrypt_and_sign(value)
end

h = JSON.parse(j)
h["cart_id"] = 1
encrypt_session_cookie(h, key)
</pre></div>
</figure>

<blockquote>
<p>åŠ è§£å¯†çš„ä»£ç æ˜¯ä» Rails æºä»£ç ä¸­æŒ–å‡ºæ¥çš„</p>
</blockquote>

<p>æœ€åå¾—åˆ° cookie å€¼ï¼Œæœ€åä¸€æ­¥å°±æ˜¯è®¾å®šå› Chrome æµè§ˆå™¨ã€‚ä¸è¿‡ Chrome é»˜è®¤ä¸å…è®¸æˆ‘ä»¬æ”¹ Cookieï¼Œä½ å¯ä»¥è£…ä¸€ä¸ª extension æ˜¯ <a href="https://chrome.google.com/webstore/detail/cookie-inspector/jgbbilmfbammlbbhmmgaagdkbkepnijn">Cookie Inspector</a>ï¼Œç„¶åæŠŠåˆšåˆšæ”¹è¿‡çš„ cookie å€¼è®¾è¿›å»ï¼Œè¿™æ ·å°±ä¼šéª—è¿‡æœåŠ¡å™¨äº†ã€‚</p>

    </div>
  </div></div><div class='frame'><h1>
      6-4 å¦‚ä½•é˜²å¾¡?
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š6. ç ´è§£åŠ å¯† Cookie-based Session</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>æœ€åŸºæœ¬çš„å½“ç„¶æ˜¯ä¸è¦å¤–æ´©å¯†é’¥ï¼Œå¦‚æœå¤–æ´©äº†ï¼Œè¯·é©¬ä¸Šæ¢ä¸€ä¸ªå¯†é’¥ã€‚æ¢å¯†é’¥ä¼šå¼ºè¿«æ‰€æœ‰ç”¨æˆ·ç™»å‡ºï¼Œå› ä¸ºå¤§å®¶çš„ Cookie éƒ½ä¼šå› ä¸ºæ— æ³•è§£å¯†å›æ¥è€Œå¤±æ•ˆã€‚</p>

<p>å¦‚æœä½ çš„ç½‘ç«™éœ€è¦éå¸¸é«˜çš„å®‰å…¨æ€§ï¼Œåˆ™ä¸å»ºè®®ä½¿ç”¨ Cookie åŠ å¯†æ¥åš Sessionã€‚åœ¨ Rails å¯ä»¥æ›´æ¢ Session å­˜å‚¨çš„æ–¹å¼ï¼Œä¾‹å¦‚æ¢æˆ <a href="https://github.com/rails/activerecord-session_store">Active Record's Session Store</a>ã€‚è¿™ä¼šå°† Session æ•°æ®å­˜åœ¨æ•°æ®åº“ä¸­ï¼Œè€Œä¸æ˜¯ Cookie ä¹‹ä¸­ï¼Œè¿™æ ·éª‡å®¢å°±å®Œå…¨æ— ä»ä¸‹æ‰‹äº†ã€‚</p>

<p>æ‰“å¼€ <code>config/initializers/session_store.rb</code> è§‚å¯Ÿçœ‹çœ‹ï¼š</p>

<figure class="figure-code code"><figcaption><span>config/initializers/session_store.rb
</span></figcaption><div class="highlight"><pre><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">session_store</span> <span class="ss">:cookie_store</span><span class="p">,</span> <span class="ss">key: </span><span class="s1">'_hackme-app_session'</span>

</pre></div>
</figure>

<p>è¿™ä¸ªè®¾å®šæ¡£å°±æ˜¯åœ¨è®¾å®š Session çš„ cookie key å«åš <code>_hackme-app_session</code>ï¼Œè€Œä¸”ä½¿ç”¨ <code>cookie_store</code> æœºåˆ¶æ¥å­˜å‚¨ã€‚</p>

    </div>
  </div></div><div class='frame'><h1>
      7-1 ä»€ä¹ˆæ˜¯ DoS æ‹’ç»æœåŠ¡æ”»å‡»
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š 7. DoS æ‹’ç»æœåŠ¡æ”»å‡»</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>æƒ³åƒä½ ä»Šå¤©å¼€ä¸€é—´ä¹¦åº—ï¼Œæ¶æ„çš„å¯¹æ‰‹æ‰¾äº†è·‘è…¿100äººåœ¨ä½ çš„åº—é—¨å£åªçœ‹ä¸ä¹°ï¼Œè¿™ä¸€ç§æ”»å‡»å°±å«åš <a href="https://zh.wikipedia.org/wiki/%E9%98%BB%E6%96%B7%E6%9C%8D%E5%8B%99%E6%94%BB%E6%93%8A">DoS æ‹’ç»æœåŠ¡æ”»å‡»</a>ã€‚ä¸åƒå‰å‡ ç« ï¼Œéª‡å®¢çš„ç›®çš„æ˜¯çªƒå–èµ„æ–™æˆ–æ˜¯ä¿®æ”¹èµ„æ–™ï¼ŒDoS æ”»å‡»çš„ç›®çš„æ˜¯è®©ä½ åšä¸æˆç”Ÿæ„ï¼Œè®©ä½ çš„ç½‘ç«™æ— æ³•æœåŠ¡æ­£å¸¸ç”¨æˆ·ã€‚</p>

<p>æ”»å‡»çš„æ‰‹æ³•å°±æ˜¯æš´åŠ›ï¼Œåªè¦ä¸æ–­åœ°å‘é€ HTTP è¯·æ±‚è®©æœåŠ¡å™¨å¿™ä¸è¿‡æ¥å³å¯ã€‚ç”¨æµè§ˆå™¨ä¸æ–­é‡æ–°æ•´ç†å¤ªæ…¢äº†ï¼Œè®©æˆ‘ä»¬å®‰è£…ä¸€ä¸ª <a href="https://github.com/wg/wrk">wrk</a>ï¼Œè¿™æ˜¯ä¸€ä¸ªé‡æµ‹ HTTP æœåŠ¡å™¨æ•ˆèƒ½çš„å‹åŠ›æµ‹è¯•å·¥å…·ï¼š</p>

<p>æ‰§è¡Œ <code>brew install wrk</code></p>

<p>æ‰§è¡Œ <code>wrk -t12 -c400 -d30s http://localhost:3000/products</code></p>

<p>è¿™ä¼šåœ¨ 30 ç§’å†…ï¼ŒåŒæ—¶å¹³è¡Œå‘é€ 12 ä¸ª HTTP è¯·æ±‚ï¼Œå¹¶ä¿æŒ 400 ä¸ª HTTP è¿çº¿ä¸ä¸­æ–­çš„é€Ÿåº¦ï¼Œè¿›è¡Œ <code>http://localhost:3000/products</code> çš„å‹åŠ›æµ‹è¯•ã€‚</p>

<figure class="figure-code code"><div class="highlight"><pre>Running 30s test @ http://localhost:3000/products
  12 threads and 400 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency   468.83ms  168.30ms 888.55ms   63.89%
    Req/Sec     3.12      3.07    10.00     65.31%
  50 requests in 30.06s, 1.30MB read
  Socket errors: connect 0, read 319, write 0, timeout 14
  Non-2xx or 3xx responses: 4
Requests/sec:      1.66
Transfer/sec:     44.25KB
</pre></div>
</figure>

<p>æœ¬æœºè·‘çš„ <code>rails server</code> è¶…ä¸è€æ‰“çš„ï¼Œè¿™ä¸ªç½‘ç«™åŸºæœ¬ä¸Šæ˜¯åºŸäº†ï¼Œä½ ç”¨æµè§ˆå™¨å·²ç»æ— æ³•æ­£å¸¸æµè§ˆ <code>http://localhost:3000</code> äº†ã€‚</p>

<blockquote>
<p>å¼ºçƒˆè­¦å‘Šï¼Œå¯¹è‡ªå·±çš„ç½‘ç«™æ‰“å«åš"å‹åŠ›æµ‹è¯•"ï¼Œå¯¹åˆ«äººçš„ç½‘ç«™æ‰“å¯æ˜¯"å¹²æ‰°ä»–äººç½‘ç»œæ­£å¸¸åŠŸèƒ½"ï¼Œæ˜¯çŠ¯æ³•çš„è¡Œä¸ºã€‚è¯·ä¸è¦ä»¥èº«è¯•æ³•ã€‚</p>
</blockquote>

    </div>
  </div></div><div class='frame'><h1>
      7-2 å¦‚ä½•é˜²å¾¡?
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š 7. DoS æ‹’ç»æœåŠ¡æ”»å‡»</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>DoS å…¶å®æ˜¯ä¸å¤ªå¥½é˜²å¾¡çš„æ”»å‡»ï¼Œå› ä¸ºå¹¶ä¸æ˜¯å› ä¸ºç½‘ç«™æœ‰ä»€ä¹ˆæ¼æ´é€ æˆçš„ã€‚å¤§æ–¹å‘åªèƒ½æƒ³åŠæ³•å»è¾¨è¯†æ”»å‡»æ–¹çš„æ ·æ€ï¼Œç„¶åè¿›è¡Œå°é”ã€‚å®åŠ¡ä¸Šéœ€è¦ä¸´åœºååº”ï¼Œç¢°åˆ°äº†è§æ‹›æ‹†æ‹›ã€‚</p>

<p>å°é”æ”»å‡»æ–¹çš„ IP ç½‘ç»œåœ°å€æ˜¯æœ€åŸºæœ¬çš„æ‰‹æ³•ï¼Œé—®é¢˜å°±å‡ºåœ¨æ ·æ€å¯èƒ½å¾ˆå¤šç§ï¼Œä¾‹å¦‚ DDoS (åˆ†å¸ƒå¼DoS)å°±æ˜¯åˆ©ç”¨å¾ˆå¤šå°è¢«éª‡å®¢æ§åˆ¶çš„ä¸­æ¯’ç”µè„‘ï¼ŒåŒæ—¶è¿›è¡Œæ”»å‡»ï¼Œé‚£ä¹ˆæ¥æº IP å°±å¾ˆå¤šï¼Œé˜²å¾¡æ–¹å°±ä¸å®¹æ˜“åˆ¤æ–­å“ªä¸€äº›æ˜¯æ­£å¸¸ç”¨æˆ·æµé‡ã€å“ªä¸€äº›æ˜¯æ¶æ„çš„ã€‚</p>

<p>åœ¨ Rails ä¸­ï¼Œå¯ä»¥å®‰è£… <a href="https://github.com/kickstarter/rack-attack">rack-attack</a> gemï¼Œè¿™å¯ä»¥è®¾å®šå½“ç‰¹å®š IP ä½å€å°±æŸä¸€æ®µæ—¶é—´å†…å­˜å–å¤ªå¤šæ¬¡çš„è¯ï¼Œè‡ªåŠ¨è¿›è¡Œå°é”ï¼š</p>

<blockquote>
<p>ä¸è¿‡å›°éš¾ç‚¹åœ¨äºå¤ªå¤šæ¬¡æ˜¯å¤šå°‘æ¬¡ï¼Œè®¾å¤ªä½ä¼šé˜»æŒ¡åˆ°æ­£å¸¸ç”¨æˆ·ï¼Œä¾‹å¦‚æœ‰äº›å…¬å¸ç»„ç»‡å¾ˆå¯èƒ½æ˜¯å¾ˆå¤šäººå…±äº«åŒä¸€ä¸ª IP ä½å€æ¥ä¸Šç½‘çš„ï¼Œé€è¿‡ VPN ç§‘å­¦ä¸Šç½‘çš„è¯ï¼Œæ¥æº IP ä¹Ÿæ˜¯å¾ˆå¤šäººå…±äº«çš„ã€‚ä½†æ˜¯è®¾å¤ªé«˜åˆæ²¡æ•ˆæœã€‚</p>
</blockquote>

<p>ç¼–è¾‘ <code>Gemfile</code></p>

<figure class="figure-code code"><figcaption><span>
</span></figcaption><div class="highlight"><pre>+  gem 'rack-attack'
</pre></div>
</figure>

<p>æ‰§è¡Œ <code>bundle</code></p>

<p>ç¼–è¾‘ <code>config/application.rb</code></p>

<figure class="figure-code code"><figcaption><span>config/application.rb
</span></figcaption><div class="highlight"><pre><span class="gi">+     config.middleware.use Rack::Attack
</span><span class="err">
</span></pre></div>
</figure>

<p>æ–°å¢ <code>config/initializers/rack-attack.rb</code></p>

<figure class="figure-code code"><figcaption><span>config/initializers/rack-attack.rb
</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">Rack</span><span class="o">::</span><span class="no">Attack</span>

  <span class="n">throttle</span><span class="p">(</span><span class="s1">'req/ip'</span><span class="p">,</span> <span class="ss">:limit</span> <span class="o">=&gt;</span> <span class="mi">180</span><span class="p">,</span> <span class="ss">:period</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">.</span><span class="nf">minutes</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">req</span><span class="o">|</span>
    <span class="n">req</span><span class="p">.</span><span class="nf">ip</span>
  <span class="k">end</span>

  <span class="c1">### Prevent Brute-Force Login Attacks ###
</span>

  <span class="c1"># The most common brute-force login attack is a brute-force password
</span>
  <span class="c1"># attack where an attacker simply tries a large number of emails and
</span>
  <span class="c1"># passwords to see if any credentials match.
</span>
  <span class="c1">#
</span>
  <span class="c1"># Another common method of attack is to use a swarm of computers with
</span>
  <span class="c1"># different IPs to try brute-forcing a password for a specific account.
</span>

  <span class="c1"># Throttle POST requests to /login by IP address
</span>
  <span class="c1">#
</span>
  <span class="c1"># Key: "rack::attack:#{Time.now.to_i/:period}:logins/ip:#{req.ip}"
</span>
  <span class="n">throttle</span><span class="p">(</span><span class="s1">'logins/ip'</span><span class="p">,</span> <span class="ss">:limit</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">,</span> <span class="ss">:period</span> <span class="o">=&gt;</span> <span class="mi">20</span><span class="p">.</span><span class="nf">seconds</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">req</span><span class="o">|</span>
    <span class="k">if</span> <span class="n">req</span><span class="p">.</span><span class="nf">path</span> <span class="o">==</span> <span class="s1">'/users/sign_in'</span> <span class="o">&amp;&amp;</span> <span class="n">req</span><span class="p">.</span><span class="nf">post?</span>
      <span class="n">req</span><span class="p">.</span><span class="nf">ip</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="c1"># Throttle POST requests to /login by email param
</span>
  <span class="c1">#
</span>
  <span class="c1"># Key: "rack::attack:#{Time.now.to_i/:period}:logins/email:#{req.email}"
</span>
  <span class="c1">#
</span>
  <span class="c1"># Note: This creates a problem where a malicious user could intentionally
</span>
  <span class="c1"># throttle logins for another user and force their login requests to be
</span>
  <span class="c1"># denied, but that's not very common and shouldn't happen to you. (Knock
</span>
  <span class="c1"># on wood!)
</span>
  <span class="n">throttle</span><span class="p">(</span><span class="s2">"logins/email"</span><span class="p">,</span> <span class="ss">:limit</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">,</span> <span class="ss">:period</span> <span class="o">=&gt;</span> <span class="mi">20</span><span class="p">.</span><span class="nf">seconds</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">req</span><span class="o">|</span>
    <span class="k">if</span> <span class="n">req</span><span class="p">.</span><span class="nf">path</span> <span class="o">==</span> <span class="s1">'/users/sign_in'</span> <span class="o">&amp;&amp;</span> <span class="n">req</span><span class="p">.</span><span class="nf">post?</span>
      <span class="c1"># return the email if present, nil otherwise
</span>
      <span class="n">req</span><span class="p">.</span><span class="nf">params</span><span class="p">[</span><span class="s1">'email'</span><span class="p">].</span><span class="nf">presence</span>
    <span class="k">end</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div>
</figure>

<p>é‡å¯æœåŠ¡å™¨ã€‚ä»¥ä¸Šè®¾å®šåŒ…æ‹¬ï¼š</p>

<ol>
<li>ä¸€åˆ†é’Ÿå†…ï¼Œä¸€ä¸ª IP ä½å€åªèƒ½å­˜å– 180 æ¬¡</li>
<li>é’ˆå¯¹ <code>/users/sign_in</code> è¿™ä¸ªç™»å…¥ç½‘å€ï¼Œ20 ç§’å†…åªèƒ½å°è¯•ç™»å…¥ 5 æ¬¡</li>
<li>é’ˆå¯¹ <code>/users/sign_in</code> è¿™ä¸ªç½‘å€ï¼ŒåŒä¸€ email åœ¨ 20 ç§’å†…åªèƒ½å°è¯•ç™»å…¥ 5 æ¬¡</li>
</ol>

<p>å¦å¤–å¯ä»¥åšçš„äº‹æƒ…å°±æ˜¯ï¼Œæ”¹è¿›ç½‘ç«™æ•ˆèƒ½ï¼šå‡å¦‚ä½ æœ‰ä¸€ä¸ªé¡µé¢æ•ˆèƒ½å¾ˆçƒ‚ï¼Œéœ€è¦è·‘å¥½å‡ ç§’ï¼Œè¿™ä¹ˆè¿™å°±æ˜¯ç½‘ç«™ DoS çš„å¼±ç‚¹ï¼Œå› ä¸ºéª‡å®¢åªè¦å»æ‰“è¿™ä¸ªé¡µé¢å°±æœ‰æœ€å¥½çš„æ”»å‡»æ•ˆæœã€‚</p>

<p>å¦‚æœçœŸçš„é¢ä¸´å¤§é‡çš„DDoS æ”»å‡»ï¼Œå°±ä¸æ˜¯Rails åº”ç”¨å±‚çº§å¯ä»¥å¤„ç†å¾—äº†ï¼Œå¿…é¡»è´­ä¹°ä¸“é—¨çš„ç½‘ç»œé˜²ç«å¢™ï¼Œä¾‹å¦‚<a href="http://anquan.baidu.com/pages/ddos.html">ç™¾åº¦å®‰å…¨</a>ã€<a href="https://intl.aliyun.com/zh/product/ddos-pro">äº‘ç›¾DDoSé«˜é˜²IP</a>ç­‰ç­‰äº‘æœåŠ¡å•†çš„äº§å“ã€‚</p>

    </div>
  </div></div><div class='frame'><h1>
      8-1 å®‰è£… brakeman æ£€æµ‹ä»£ç 
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š8. å®‰å…¨åˆ†æå·¥å…·</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p><a href="https://github.com/presidentbeef/brakeman">brakeman</a> æ˜¯ä¸€ä¸ª Rails çš„å·¥å…·å¯ä»¥åˆ†æä»£ç ï¼Œæ‰¾å‡ºå¯èƒ½æœ‰æ¼æ´çš„åœ°æ–¹ã€‚</p>

<p>ä¿®æ”¹ <code>Gemfile</code></p>

<figure class="figure-code code"><figcaption><span>
</span></figcaption><div class="highlight"><pre>  group :development do
+    gem 'brakeman'

</pre></div>
</figure>

<p>æ‰§è¡Œ <code>bundle</code></p>

<p>æ‰§è¡Œ <code>brakeman</code>ï¼Œå°±ä¼šåˆ†æä½ çš„ä»£ç ï¼Œåˆ—å‡º"å¯èƒ½"æœ‰æ¼æ´çš„åœ°æ–¹ï¼š</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/FKULBIUCTemz0A82LlO2_8-1.png" title=""></figure></p>

<blockquote>
<p>brakeman æŠ¥è¡¨ç»“æœä»…ä¾›å‚è€ƒï¼Œä¸è¡¨ç¤ºå¿…ç„¶æœ‰æ¼æ´ã€‚éœ€è¦ä¸€æ¡ä¸€æ¡å®é™…æ£€æŸ¥çœ‹çœ‹ã€‚</p>
</blockquote>

    </div>
  </div></div><div class='frame'><h1>
      8-2 å®‰è£… bundler-audit æ£€æµ‹å¥—ä»¶
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š8. å®‰å…¨åˆ†æå·¥å…·</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>é™¤äº†è‡ªå·±å†™çš„ä»£ç æœ‰å¯èƒ½æœ‰æ¼æ´ä¹‹å¤–ï¼Œå®‰è£…çš„ gem ä¹Ÿæœ‰å¯èƒ½çˆ†å‡ºå®‰å…¨æ€§æ¼æ´ã€‚é€è¿‡ bundler-audit è¿™ä¸ª gem å¯ä»¥å¸®å¿™æ£€æŸ¥æœ‰æ²¡æœ‰å¥—ä»¶æœ‰å·²çŸ¥çš„æ¼æ´éœ€è¦å‡çº§ã€‚</p>

<p>ä¿®æ”¹ <code>Gemfile</code></p>

<figure class="figure-code code"><figcaption><span>
</span></figcaption><div class="highlight"><pre>  group :development do
+    gem 'bundler-audit'

</pre></div>
</figure>

<p>æ‰§è¡Œ <code>bundle</code></p>

<p>æ‰§è¡Œ <code>bundle-audit</code></p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/5zgyzSq5REaICSpf5OXf_8-2.png" title=""></figure></p>

<p>ç›®å‰æ²¡æœ‰éœ€è¦å‡çº§çš„å¥—ä»¶ã€‚å¦‚æœæœ‰çš„è¯ï¼Œè¯·æ‰§è¡Œ <code>bundle update å¥—ä»¶åç§°</code> å°±å¯ä»¥è¿›è¡Œå‡çº§ã€‚</p>

    </div>
  </div></div><div class='frame'><h1>
      9-1 è®¤è¯†æ•£åˆ—å‡½æ•°
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š9. å¯†ç æ˜¯å¦‚ä½•å­˜å‚¨çš„ï¼Ÿ</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>æ•£åˆ—å‡½æ•°æ˜¯ä¸€ç§èƒ½å°†æ•°æ®å˜æˆæ‘˜è¦(digest)çš„ç®—æ³•ï¼Œæ‰§è¡Œ <code>irb</code>ï¼Œç„¶åè¾“å…¥ä»¥ä¸‹ä»£ç å®éªŒçœ‹çœ‹ï¼š</p>

<figure class="figure-code code"><div class="highlight"><pre>require 'digest'
Digest::SHA1.hexdigest '12345678'
</pre></div>
</figure>

<p>å¾—åˆ° <code>"7c222fb2927d828af22f592134e8932480637c0d"</code></p>

<p>æ•£åˆ—å‡½æ•°æœ‰ä¸€äº›ç‰¹æ€§ï¼š</p>

<ol>
<li>ç›¸åŒçš„æ•°æ®ï¼Œæ¯æ¬¡éƒ½ä¼šå¾—åˆ°ä¸€æ ·çš„æ‘˜è¦</li>
<li>æ˜¯å•å‘çš„ï¼Œæ— æ³•é€†æ¨ï¼šåªçŸ¥é“æ‘˜è¦çš„è¯ï¼Œæ²¡æœ‰åŠæ³•èƒ½å¤Ÿé€è¿‡è®¡ç®—çŸ¥é“æœ¬æ¥çš„æ•°æ®é•¿æ€æ ·ã€‚ä¾‹å¦‚ç»™ä½  <code>7c222fb2927d828af22f592134e8932480637c0d</code>ï¼Œæ²¡æœ‰ç®—æ³•å¯ä»¥é€†æ¨å›æ¥ã€‚é™¤éæœ‰ä¸€ä¸ªå¯¹ç…§çš„å­—å…¸ã€‚</li>
</ol>

    </div>
  </div></div><div class='frame'><h1>
      9-2 æ•£åˆ—å‡½æ•°çš„ç”¨é€”
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š9. å¯†ç æ˜¯å¦‚ä½•å­˜å‚¨çš„ï¼Ÿ</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p><a href="https://zh.wikipedia.org/wiki/%E6%95%A3%E5%88%97%E5%87%BD%E6%95%B8">æ•£åˆ—å‡½æ•°</a>éå¸¸æœ‰ç”¨ï¼Œå¯ä»¥æ‹¿æ¥å¿«é€Ÿæ¯”è¾ƒä¸¤ä¸ªæ–‡æ¡£æ˜¯å¦ç›¸åŒï¼Œè€Œä¸éœ€è¦å®é™…æ¯”è¾ƒæ–‡æ¡£å†…å®¹ï¼Œä¾‹å¦‚ï¼š</p>

<ol>
<li>Git æ¯æ¬¡çš„ commitï¼Œéƒ½ä¼šæœ‰ä¸€ä¸ªæ‘˜è¦ã€‚ä¸åŒçš„æ‘˜è¦å°±ä»£è¡¨ commit å†…å®¹ä¸åŒã€‚Git ç”¨è¿™ä¸ªæ‘˜è¦å€¼å½“ä½œæ¯æ¬¡ commit çš„å”¯ä¸€è¯†åˆ« IDã€‚</li>
<li>ç½‘ç»œä¼ æ¡£çš„æ—¶å€™ï¼Œé€è¿‡æ¯”è¾ƒè¿™ä¸ªæ‘˜è¦ï¼Œå°±å¯ä»¥çŸ¥é“ä¸‹è½½äº†å®Œæ•´æ­£ç¡®çš„æ¡£æ¡ˆã€‚</li>
<li>åœ¨ Rails ä¸­ï¼ŒAsset pipeline ä¼šå°† CSS å’Œ JavaScript å‹ç¼©ï¼Œæ¡£åå°±æ˜¯é€è¿‡æ•£åˆ—å‡½æ•°äº§ç”Ÿçš„ã€‚è¿™æ˜¯å› ä¸ºæµè§ˆå™¨ä¼šç¼“å­˜é™æ€æ¡£æ¡ˆï¼Œå¦‚æœ CSS/Javascript å†…å®¹æœ‰ä¿®æ”¹çš„è¯ï¼Œç”¨æˆ·æµè§ˆå™¨å¯èƒ½ä¸çŸ¥é“æœ‰æ–°ç‰ˆè€Œä½¿ç”¨åˆ°æ—§çš„ CSS/JS æ¡£æ¡ˆã€‚ä½†æ˜¯å› ä¸ºæ¡£åç”¨äº†æ•£åˆ—å‡½æ•°çš„å…³ç³»ï¼Œå†…å®¹ä¸€æ”¹æ¡£åå°±ä¼šå˜å¾—ä¸ä¸€æ ·ï¼Œé‚£ä¹ˆæµè§ˆå™¨å°±ä¼šä¸‹è½½æ–°çš„æ¡£æ¡ˆäº†ã€‚</li>
</ol>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/4zxGcrmNRCG4BgiySHAo_9-3.png" title=""></figure></p>

<ol>
<li>å­˜å‚¨ç”¨æˆ·å¯†ç ã€‚å¤§å®¶å·²ç»ä¼šç”¨ Devise åœ¨ Rails ä¸­å®åš User Modelï¼Œåœ¨ users table ä¸­å®é™…çš„å­—æ®µæ˜¯ <code>encrypted_password</code>
</li>
</ol>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/8UURspY6Rc2nBum563xr_9-1.png" title=""></figure></p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/m7jUkAkFRtuW7ZIZmre4_9-2.png" title=""></figure></p>

<p>ç”¨æˆ·æ³¨å†Œæ—¶è¾“å…¥çš„å¯†ç ï¼Œåœ¨å®é™…å­˜å‚¨è¿›æ•°æ®åº“æ—¶ï¼Œä¼šå…ˆç»è¿‡æ•£åˆ—å‡½æ•°ï¼Œå˜æˆæ‘˜è¦å€¼ã€‚æ•°æ®åº“é‡Œé¢æ²¡æœ‰å­˜ç”¨æˆ·çš„æ˜ç ï¼Œè€Œæ˜¯å­˜å¯†ç æ‘˜è¦åçš„å€¼ã€‚</p>

<p>è€Œä¸‹æ¬¡ç”¨æˆ·è¦ç™»å…¥çš„æ—¶å€™ï¼Œå°†ç”¨æˆ·è¾“å…¥çš„å¯†ç æ‘˜è¦ä¸€æ¬¡ï¼Œä¸æ•°æ®åº“ä¸­å­˜çš„å¯†ç æ‘˜è¦è¿›è¡Œæ¯”å¯¹ï¼Œå°±å¯ä»¥çŸ¥é“å¯†ç å¯¹ä¸å¯¹äº†ã€‚</p>

<p>è¿™æ ·çš„å¥½å¤„æ˜¯ä»€ä¹ˆå‘¢?</p>

<ol>
<li>æ•°æ®åº“ä¸ä¼šå­˜ç”¨æˆ·çš„æ˜ç ï¼Œæ‰€ä»¥å³ä½¿æ˜¯æ•°æ®åº“ç®¡ç†å‘˜ï¼Œä¹Ÿä¸ä¼šçŸ¥é“ç”¨æˆ·çœŸæ­£çš„å¯†ç æ˜¯ä»€ä¹ˆã€‚çŸ¥é“ <code>encrypted_password</code> å¹¶æ²¡æœ‰ä»€ä¹ˆç”¨ï¼Œå› ä¸ºæˆ‘ä»¬æ— æ³•é€†æ¨ã€‚ä¹Ÿæ— æ³•ç”¨è¿™ä¸ª <code>encrypted_password</code> åšç™»å…¥ã€‚</li>
<li>ä¸‡ä¸€æ•°æ®åº“æ•´ä¸ªå¤–æ´©äº†ï¼Œéª‡å®¢ä¹Ÿæ— æ³•çŸ¥é“ç”¨æˆ·çš„å¯†ç </li>
</ol>

<p>ä¸è¿‡ï¼Œç›®å‰æ˜¯å¸‚é¢ä¸Šä»æœ‰å¾ˆå¤šç½‘ç«™æ˜¯ç›´æ¥å­˜å‚¨ç”¨æˆ·æ˜ç ï¼Œè¿™ä¼šé€ æˆç”¨æˆ·éšç§å¾ˆå¤§çš„å±å®³ã€‚å› ä¸ºç®¡ç†å‘˜æˆ–éª‡å®¢(å¦‚æœæ•°æ®åº“å¤–æ´©)å¯ä»¥ç›´æ¥çœ‹åˆ°ä½ å¯†ç ï¼Œç„¶åå¾ˆå¤šäººåœ¨ä¸åŒç½‘ç«™ä¸­ï¼Œä¼šæ²¿ç”¨ä¸€æ ·çš„å¯†ç ã€‚</p>

<p>è¦æ€ä¹ˆåˆ¤æ–­ä¸€ä¸ªç½‘ç«™æœ‰æ²¡æœ‰å­˜æ˜ç å‘¢ï¼Ÿåªè¦è¯•è¯•çœ‹å¿˜è®°å¯†ç ç¨‹åºå³å¯ï¼Œå¦‚æœç½‘ç«™ç›´æ¥å°†ä½ çš„å¯†ç å¯„ç»™ä½ ï¼Œé‚£å°±ä»£è¡¨ä»–çš„<br>
æ•°æ®åº“å­˜æ˜ç ã€‚å¦‚æœç½‘ç«™è¦æ±‚ä½ é‡æ–°è®¾å®šå¯†ç (å°±åƒ Devise ä¸€æ ·)ï¼Œå°±è¡¨ç¤ºè¿™ç½‘ç«™æœ‰å®‰å…¨æ„è¯†ã€‚</p>

    </div>
  </div></div><div class='frame'><h1>
      10-1. è®¤è¯†éå¯¹ç§°åŠ å¯†
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š10. HTTPS åŠ å¯†å®‰å…¨è¿çº¿</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>è¿‘å¹´æ¥ç”±äºä¸Šç½‘å®‰å…¨æ„è¯†çš„æå‡ï¼Œè¶Šæ¥è¶Šå¤šçš„ç½‘ç«™ä½¿ç”¨ HTTPS åŠ å¯†è¿çº¿ï¼Œç½‘å€åƒè¿™æ ·ï¼š</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/FQaKnbDVTyaoqrilCA3M_10-1.png" title=""></figure></p>

<p>è¿™ä¸ªåŸç†æ˜¯ä»€ä¹ˆå‘¢? æµè§ˆå™¨å’ŒæœåŠ¡å™¨ä¹‹é—´ï¼Œæ˜¯å¦‚ä½•å®‰å…¨è¿çº¿çš„ï¼Ÿå¦‚ä½•ä¿éšœä¸­é—´ä¼ è¾“çš„è¿‡ç¨‹ï¼Œä¸ä¼šè¢«äººå·å¬ã€è¢«äººä¿®æ”¹å†…å®¹ã€‚</p>

<blockquote>
<p>æ²¡æœ‰åŠ å¯†çš„ HTTP è¿çº¿ï¼Œå¯ä»¥é€è¿‡ç›‘å¬ç½‘ç»œå°åŒ…ï¼Œå°±å¯ä»¥çŸ¥é“æµè§ˆå™¨ä¼ è¾“çš„å†…å®¹ã€‚ä¾‹å¦‚åœ¨å’–å•¡å…ä¸Šç½‘ï¼Œéª‡å®¢å¯ä»¥é€è¿‡ç›‘å¬æ— çº¿ç½‘ç»œï¼Œçœ‹åˆ°ä½ ä¸Šç½‘çš„ä¸€ä¸¾ä¸€åŠ¨ã€‚æœ‰äº›å’–å•¡å…å¯ä»¥åœ¨ç½‘é¡µä¸­ç½®å…¥å¹¿å‘Š Bannerï¼Œå°±æ˜¯å› ä¸ºè¿çº¿æ˜¯èµ° HTTP æœªåŠ å¯†çš„å…³ç³»ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“å°±å¯ä»¥ä¿®æ”¹ç½‘é¡µå†…å®¹ã€‚</p>
</blockquote>

<p>æˆ‘ä»¬åœ¨ 6-1 æ•™è¿‡ä»€ä¹ˆæ˜¯<a href="https://zh.wikipedia.org/wiki/%E5%B0%8D%E7%A8%B1%E5%AF%86%E9%91%B0%E5%8A%A0%E5%AF%86">å¯¹ç§°å¯†é’¥åŠ å¯†</a>ç®—æ³•ï¼Œé€è¿‡å¯†é’¥å°±å¯ä»¥ä¼ è¾“å¯†æ–‡ã€‚</p>

<p>ä½†æ˜¯å¯¹ç§°å¯†é’¥åŠ å¯†æ–¹æ³•ï¼Œåœ¨æµè§ˆå™¨å’ŒæœåŠ¡å™¨è¿çº¿çš„æƒ…å¢ƒï¼Œæœ‰ä¸ªè‡´å‘½çš„ç¼ºç‚¹ï¼Œå°±æ˜¯ä¸€å¼€å§‹è¿çº¿æ—¶å¦‚ä½•äº¤æ¢å¯†é’¥ã€‚åŒæ–¹éƒ½è¦çŸ¥é“å¯†é’¥ï¼Œæ‰èƒ½çŸ¥é“å¯¹æ–¹è®²äº†ä»€ä¹ˆè¯ã€‚</p>

<p>æ—¢ç„¶ä¸€å¼€å§‹è¿çº¿å°±æ˜¯ä¸å®‰å…¨çš„ï¼Œåœ¨æŠŠå¯†é’¥å‘Šè¯‰å¯¹æ–¹çš„è¿‡ç¨‹ä¸­ï¼Œè¿™ä¸ªå¯†é’¥ä¹Ÿå°±å¤–æ´©äº†...</p>

<p>æ‰€å¹¸èªæ˜çš„æ•°å­¦å®¶å‘æ˜äº†<a href="https://zh.wikipedia.org/zh-cn/%E5%85%AC%E5%BC%80%E5%AF%86%E9%92%A5%E5%8A%A0%E5%AF%86">éå¯¹ç§°åŠ å¯†</a>ï¼Œå¯ä»¥åœ¨ä¸äº¤æ¢å¯†é’¥çš„æƒ…å†µä¸‹ï¼Œè§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>

<p>åœ¨éå¯¹ç§°åŠ å¯†ç®—æ³•ä¸­ï¼Œä¼šæœ‰ä¸¤æŠŠé’¥åŒ™ï¼Œä¸€æŠŠå«åšå…¬é’¥ã€ä¸€æŠŠå«åšå¯†é’¥ã€‚</p>

<ul>
<li>é€è¿‡å…¬é’¥åŠ å¯†çš„å¯†æ–‡ï¼Œåªæœ‰å¯†é’¥èƒ½å¤Ÿè§£å¼€</li>
<li>é€è¿‡å¯†é’¥åŠ å¯†çš„å¯†æ–‡ï¼Œåªæœ‰å…¬é’¥èƒ½å¤Ÿè§£å¼€</li>
</ul>

<p>æœåŠ¡å™¨ä¼šå°†å…¬é’¥å…¬å¼€ç»™æµè§ˆå™¨çŸ¥é“ï¼Œæµè§ˆå™¨ä¼šç”¨å…¬é’¥åŠ å¯†å†…å®¹ï¼Œä¼ ç»™æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨ç”¨å¯†é’¥è§£å¼€ã€‚åä¹‹æœåŠ¡å™¨ç”¨å¯†é’¥åŠ å¯†ï¼Œæµè§ˆå™¨ç”¨å…¬é’¥è§£å¼€ã€‚å¦‚æ­¤å°±è§£å†³äº†ä¸€å¼€å§‹å¯†é’¥äº¤æ¢çš„é—®é¢˜ã€‚</p>

<blockquote>
<p>è¿™ç§æ–¹å¼ä¹Ÿç”¨åœ¨ SSH è¿çº¿è®¤è¯å’ŒåŠ å¯†è¿çº¿ 1. åœ¨éƒ¨ç½² Linux æœåŠ¡å™¨æ—¶ï¼Œæˆ‘ä»¬ä¼šå°†è‡ªå·±çš„å…¬é’¥æ”¾åœ¨æœåŠ¡å™¨ä¸Šï¼Œè¿™æ ·ç™»å…¥çš„æ—¶å€™å°±ä¸éœ€è¦æ‰“å¸å·å¯†ç ï¼ŒæœåŠ¡å™¨å°±èƒ½è®¤è¯ä½  2. åœ¨ Git ä¹‹ä¸­ï¼Œæˆ‘ä»¬ä¼šå°†è‡ªå·±çš„å…¬é’¥æ”¾åœ¨ Github ä¸Šï¼Œè¿™æ · git push å’Œ pull æ—¶ï¼ŒGithub å°±èƒ½åšè®¤è¯ã€‚</p>
</blockquote>

<p>å‰©ä¸‹ä¿¡ä»»é—®é¢˜ï¼Œæˆ‘ä»¬æ€ä¹ˆçŸ¥é“è¿™ä¸ªå…¬é’¥çœŸçš„ä»£è¡¨è¿™ä¸ªç½‘ç«™ä¸»ï¼Ÿè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦ç”³è¯·æˆ–è´­ä¹°ç½‘ç«™å®‰å…¨å‡­è¯(SSL certificate)çš„åŸå› ã€‚ç½‘ç«™ä¸»éœ€è¦å‘æƒå¨æœºæ„è´­ä¹°ç”³è¯·æˆ–è´­ä¹°ï¼Œç»è¿‡ä¸€äº›è®¤è¯ç¨‹åºåï¼Œæ‰èƒ½è·å¾— HTTPS éœ€è¦çš„å®‰å…¨å‡­è¯ã€‚è€Œç”¨æˆ·çš„æµè§ˆå™¨ä¸­ï¼Œåœ¨å‡ºåœºæ—¶å°±ä¼šé»˜è®¤ç›¸ä¿¡ä¸€äº›æƒå¨æœºæ„æ‰€æ ¸å‘çš„å®‰å…¨å‡­è¯ï¼Œä»¥æ­¤å»ºæ„å‡ºä¿¡ä»»éŠã€‚</p>

<p>ä¸Šè¿°æ˜¯ç®€åŒ–çš„è¯´æ˜ï¼Œè¯¦ç»†å¯ä»¥å‚è€ƒä»¥ä¸‹æ–‡ç« ï¼š</p>

<ul>
<li><a href="http://showme.codes/2017-02-20/understand-https/">ä¹Ÿè®¸ï¼Œè¿™æ ·ç†è§£HTTPSæ›´å®¹æ˜“</a></li>
<li><a href="https://segmentfault.com/a/1190000004523659">HTTPSç§‘æ™®æ‰«ç›²å¸–</a></li>
<li><a href="https://cattail.me/tech/2015/11/30/how-https-works.html">HTTPSå·¥ä½œåŸç†</a></li>
</ul>

<p>é‚£ä¹ˆè¦å¦‚ä½•åœ¨æœåŠ¡å™¨ä¸Šå®‰è£… HTTPS å‘¢? æ­¥éª¤ä¼šæ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬ä¼šåœ¨è¿›é˜¶çš„éƒ¨ç½²æ•™ç¨‹å†è¯´ä»¥è¯´æ˜ã€‚</p>

<blockquote>
<p><a href="https://blog.heroku.com/announcing-automated-certificate-management">Heroku: Announcing Free and Automated SSL Certs For All Paid Dynos</a> Heroku çš„ä»˜è´¹ç”¨æˆ·å¯ä»¥å…è´¹å¾—åˆ°SSL Certs</p>
</blockquote>

    </div>
  </div></div><div class='frame'><h1>
      10-2 ç»“è¯­
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š10. HTTPS åŠ å¯†å®‰å…¨è¿çº¿</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>å¸Œæœ›æœ¬è¯¾ç¨‹å¯ä»¥æœ‰æ•ˆæä¾›å¤§å®¶ç½‘ç«™å®‰å…¨æ„è¯†ï¼Œã€Œå®³äººä¹‹å¿ƒä¸å¯æœ‰ï¼Œé˜²äººä¹‹å¿ƒä¸å¯æ— ã€ï¼Œå†æ¬¡æé†’å¤§å®¶åˆ‡å‹¿ä»¥èº«è¯•æ³•ã€‚</p>

<p>å¯¹ç½‘ç»œå®‰å…¨æœ‰å…´è¶£çš„æœ‹å‹ï¼Œæ¨èé˜…è¯»é˜¿é‡Œå·´å·´çš„ç½‘ç»œå®‰å…¨ä¸“å®¶æ‰€å†™çš„å…¥é—¨ä¹¦ï¼š<a href="https://book.douban.com/subject/10546925/">ç™½å¸½å­è®²Webå®‰å…¨</a>è¿™æœ¬ä¹¦ã€‚</p>

    </div>
  </div></div><div class='end'>
              <a href='https://fullstack.qzy.camp/'>
                <img src='https://img.buzzfeed.com/buzzfeed-static/static/2014-10/26/6/enhanced/webdr08/longform-original-14836-1414320930-10.jpg'>
              </a>
              <p>The End</p>
            </div>