
<style>
  .frame {
      margin-left: 30px;
      margin-right: 30px;
  }

  h1, h2, h3, h4, h5, h6 {
      font-weight: normal;
  }

  .view-count {
      float: right;
      margin-top: -54px;
      color: #9B9B9B;
  }

  .markdown h2, .markdown h3, .markdown h4 {
      text-align: left;
      font-weight: 800;
      font-size: 16px !important;
      line-height: 100%;
      margin: 0;
      color: #555;
      margin-top: 16px;
      margin-bottom: 16px;
      border-bottom: 1px solid #eee;
      padding-bottom: 5px;
  }

    .markdown .figure-code figcaption {
      background-color: #e6e6e6;

      font: 100%/2.25 Monaco, Menlo, Consolas, 'Courier New', monospace;
      text-indent: 10.5px;

      -moz-border-radius: 0.25em 0.25em 0 0;
      -webkit-border-radius: 0.25em;
      border-radius: 0.25em 0.25em 0 0;
      -moz-box-shadow: inset 0 0 0 1px #d9d9d9;
      -webkit-box-shadow: inset 0 0 0 1px #d9d9d9;
      box-shadow: inset 0 0 0 1px #d9d9d9;
  }

  .markdown {
      position: relative;
      line-height: 1.8em;
      font-size: 14px;
      text-overflow: ellipsis;
      word-wrap: break-word;
      font-family: 'PT Serif', Georgia, Times, 'Times New Roman', serif !important;
  }

  .markdown ol li, .markdown ul li {
      line-height: 1.6em;
      padding: 2px 0;
      color: #333;
      font-size: 16px;
  }

  .markdown .figure-code {
      margin: 20px 0;
  }

  .post-content {
      padding-top: 5px;
      padding-bottom: 5px;
  }

  .markdown code {
      background-color: #ececec;
      color: #d14;
      font-size: 85%;
      text-shadow: 0 1px 0 rgba(255,255,255,0.9);
      border: 1px solid #d9d9d9;
      padding: 0.15em 0.3em;
  }

  div {
      display: block;
  }

  .markdown figure.code pre {
      background-color: #ffffcc !important;
  }

  .code .gi {
      color: #859900;
      line-height: 1.2em;
  }

  .code .err {
      color: #93A1A1;
  }

  .markdown a:link, .markdown a:visited {
      color: #0069D6 !important;
      text-decoration: none !important;
  }

  .markdown p {
      font-size: 16px;
      line-height: 1.5em;
  }

  .markdown blockquote {
      margin-left: 0 !important;
      margin-right: 0 !important;
      padding: 12px;
      border-left: 5px solid #50AF51;
      background-color: #F3F8F3;
      clear: both;
      display: block;
  }

  .markdown blockquote>*:first-child {
      margin-top: 0 !important;
  }

  .markdown blockquote>*:last-child {
      margin-bottom: 0 !important;
  }

  .markdown blockquote p {
      color: #222;
  }

  * {
      outline: none !important;
  }

  a:active, a:hover, a:link, a:visited {
      text-decoration: none;
  }

  pre {
      margin: 0;
  }

  .markdown img {
      vertical-align: top;
      max-width:100%;
      height:auto;
  }

  h1 a {
    color: #071A52;
  }

  h4 {
    color: #734488;
  }

  hr {
    border-color: #DEDEDE;
    border-width: 0.8px;
    margin-bottom: auto;
  }

  .end {
    height: 400px;
  }

  .end img {
    clear: both;
    display: block;
    margin: 10px auto;
  }

  .end p {
    text-align: center;
    font-size: 2.5em;
    margin: 60px auto 100px;
    color: #ddd;
  }
</style>
<div class='frame'><h1>
      21-1 éœ€æ±‚è¯´æ˜
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š21. è½¯åˆ é™¤å’Œç‰ˆæœ¬æ§åˆ¶</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>åœ¨å®é™…è¿ä½œçš„ç½‘ç«™ä¸­ï¼Œç”¨æˆ·å¯èƒ½ä¼šä¸å°å¿ƒåˆ é™¤èµ„æ–™ï¼Œæˆ–æ˜¯ä¿®æ”¹æ—¶ä¸å°å¿ƒæ”¹é”™ç­‰ç­‰ã€‚è¿™æ—¶å€™ç”¨æˆ·å¯èƒ½ä¼šé€è¿‡å®¢æœå¸Œæœ›ç®¡ç†å‘˜èƒ½è¿›è¡Œå¤åŸçš„åŠ¨ä½œã€‚å¦ä¸€æ–¹é¢ï¼Œé’ˆå¯¹é‡è¦çš„èµ„æ–™ï¼Œæˆ‘ä»¬ä¹Ÿå¸Œæœ›å»ºç«‹è¿½è¸ªå’Œç¨½æ ¸çš„æœºåˆ¶ã€‚</p>

<p>è¿™ç§éœ€æ±‚å«åšè½¯åˆ é™¤(Soft Deletion)å’Œç‰ˆæœ¬æ§ç®¡(Versions)ã€‚</p>

<p>è½¯åˆ é™¤(Soft Deletion)çš„æ„æ€æ˜¯ä¸è¦çœŸçš„åˆ é™¤è¿™ä¸€ç¬”èµ„æ–™ï¼Œå¸¸è§çš„ä½œæ³•æ˜¯å¢åŠ ä¸€ä¸ªåˆ é™¤çš„æ ‡è®°å­—æ®µ(ä¾‹å¦‚ <code>deleted_at</code>å­—æ®µ)ï¼Œå¦‚æœè¢«æ ‡è®°åˆ é™¤äº†ï¼Œé‚£å°±ä¸è¦æ˜¾ç¤ºå‡ºæ¥å³å¯ï¼Œä½¿ç”¨ <a href="http://www.rubydoc.info/gems/paranoia">Paranoia</a> è¿™ä¸ª gem å¯ä»¥å®Œæˆè¿™ä¸ªåŠŸèƒ½ã€‚</p>

<p>è‡³äºç‰ˆæœ¬æ§ç®¡çš„ä½œæ³•ï¼Œåˆ™ä¼šå¦å¤–å»ºç«‹ä¸€ä¸ª Version Model æ¥å­˜å‚¨ç¼–ä¿®çºªå½•ã€‚å¦‚æœæœ¬æ¥çš„èµ„æ–™è¢«åˆ é™¤æˆ–ä¿®æ”¹ï¼Œåˆ™ä¼šå¤åˆ¶èµ„æ–™åˆ°è¿™ä¸ª Model å»ã€‚ç­‰ä¼šæˆ‘ä»¬ç¤ºèŒƒç”¨ <a href="https://github.com/airblade/paper_trail">paper_trail</a> gemã€‚å¦‚æœç”¨äº† paper_trail æ¥åšç‰ˆæœ¬æ§ç®¡ï¼Œä¹Ÿå°±ä¸éœ€è¦ç”¨ paranoia äº†ã€‚å› ä¸ºå‰è€…ä¹Ÿå¯ä»¥åšåˆ é™¤çš„å¤åŸã€‚</p>

<blockquote>
<p>ä¸å»ºè®®ç”¨ paranoia çš„æ–¹å¼ï¼Œè¿™ç§æ–¹å¼æœ‰ä¸€ä¸ªä¸¥é‡çš„æ•°æ®åº“é—®é¢˜ï¼Œä¼šå¹²æ‰° unique indexã€‚ä¾‹å¦‚ User çš„ email æ˜¯å”¯ä¸€çš„ï¼Œå¦‚æœä¸çœŸçš„åˆ é™¤è¿™ä¸€ç¬”èµ„æ–™ï¼Œåªæ˜¯æ ‡è®°è¢«åˆ é™¤çš„è¯ï¼Œé‚£ä¹ˆè¢«åˆ é™¤çš„ç”¨æˆ·èµ„æ–™ï¼Œè¯¥ email ä¾ç„¶æ— æ³•æ³¨å†Œã€‚å› ä¸ºæ•°æ®åº“è®¤ä¸º email é‡å¤äº†ã€‚</p>
</blockquote>

    </div>
  </div></div><div class='frame'><h1>
      21-2 å®‰è£…ä½¿ç”¨ paper_trail
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š21. è½¯åˆ é™¤å’Œç‰ˆæœ¬æ§åˆ¶</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>ç¼–è¾‘ <code>Gemfile</code></p>

<figure class="figure-code code"><figcaption><span>Gemfile
</span></figcaption><div class="highlight"><pre><span class="gi">+  gem 'paper_trail'
</span><span class="err">
</span></pre></div>
</figure>

<p>æ‰§è¡Œ <code>bundle</code>ï¼Œé‡å¯æœåŠ¡å™¨</p>

<p>æ‰§è¡Œ <code>bundle exec rails generate paper_trail:install --with-changes</code></p>

<p>æ‰§è¡Œ <code>bundle exec rake db:migrate</code></p>

<p>ç¼–è¾‘ <code>app/models/registration.rb</code></p>

<figure class="figure-code code"><figcaption><span>app/models/registration.rb
</span></figcaption><div class="highlight"><pre>  class Registration &lt; ApplicationRecord

<span class="gi">+   has_paper_trail
</span><span class="err">
</span></pre></div>
</figure>

<p>è¿™æ ·å°±å®Œæˆäº†ï¼Œæ‰€æœ‰çš„ä¿®æ”¹å’Œåˆ é™¤ï¼Œéƒ½ä¼šçºªå½•åœ¨ paper_trail çš„ Version model é‡Œé¢ã€‚</p>

<p>åœ¨ <a href="https://github.com/airblade/paper_trail">paper_trail</a> æ–‡æ¡£ä¸Šï¼Œæœ‰å®Œæ•´çš„ç‰ˆæœ¬æµè§ˆã€æ¯”è¾ƒå’Œå¤åŸçš„ä½œæ³•ã€‚</p>

    </div>
  </div></div><div class='frame'><h1>
      21-3 ç¼–ä¿®çºªå½•çš„ UI å’Œå¤åŸ
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š21. è½¯åˆ é™¤å’Œç‰ˆæœ¬æ§åˆ¶</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>æˆ‘ä»¬å¯ä»¥åœ¨åå°æ–°å¢ä¸€ä¸ª UI æ¥æµè§ˆæœ€è¿‘çš„ç¼–ä¿®çºªå½•ï¼š</p>

<p>ç¼–è¾‘ <code>config/routes.rb</code></p>

<figure class="figure-code code"><figcaption><span>config/routes.rb
</span></figcaption><div class="highlight"><pre>  namespace :admin do
    root "events#index"

<span class="gi">+   resources :versions do
+     post :undo
+   end
</span><span class="err">
</span></pre></div>
</figure>

<p>æ‰§è¡Œ <code>rails g controller admin::versions</code></p>

<p>ç¼–è¾‘ <code>app/controllers/admin/versions_controller.rb</code></p>

<figure class="figure-code code"><figcaption><span>app/controllers/admin/versions_controller.rb
</span></figcaption><div class="highlight"><pre><span class="gd">-  class Admin::VersionsController &lt; ApplicationController
</span><span class="gi">+  class Admin::VersionsController &lt; AdminController
</span>
<span class="gi">+    def index
+      @versions = PaperTrail::Version.order("id DESC").page(params[:page])
+    end
</span>
<span class="gi">+    def undo
+      @version = PaperTrail::Version.find(params[:version_id])
+      @version.reify.save!
+
+      redirect_to admin_versions_path
+    end
</span>
<span class="err">   end
</span></pre></div>
</figure>

<p>æ–°å¢ <code>app/views/admin/versions/index.html.erb</code></p>

<figure class="figure-code code"><figcaption><span>app/views/admin/versions/index.html.erb
</span></figcaption><div class="highlight"><pre>&lt;h2&gt;ç¼–ä¿®çºªå½•&lt;/h2&gt;

&lt;table class="table"&gt;
&lt;tr&gt;
  &lt;td&gt;ID&lt;/td&gt;
  &lt;td&gt;Model&lt;/td&gt;
  &lt;td&gt;Model ID&lt;/td&gt;
  &lt;td&gt;äº‹ä»¶&lt;/td&gt;
  &lt;td&gt;&lt;/td&gt;
  &lt;td&gt;æ“ä½œè€…&lt;/td&gt;
  &lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;% @versions.each do |version| %&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;%= version.id %&gt;&lt;/td&gt;
    &lt;td&gt;&lt;%= version.item_type %&gt;&lt;/td&gt;
    &lt;td&gt;&lt;%= version.item_id %&gt;&lt;/td&gt;
    &lt;td&gt;&lt;%= version.event %&gt;&lt;/td&gt;
    &lt;td&gt;
      &lt;ul&gt;
      &lt;% version.changeset.each do |key, value| %&gt;
        &lt;li&gt;ä» &lt;%= value[0] %&gt; æ”¹æˆ &lt;%= value[1] %&gt;&lt;/li&gt;
      &lt;% end %&gt;
      &lt;/ul&gt;
    &lt;/td&gt;
    &lt;td&gt;&lt;%= version.whodunnit &amp;&amp; User.find(version.whodunnit).display_name %&gt;&lt;/td&gt;
    &lt;td&gt;
      &lt;% if version.event != 'create' %&gt;
      &lt;%= link_to "Undo", admin_version_undo_path(version), :data =&gt; { :confirm =&gt; "Are you sure?"}, :method =&gt; :post, class: "btn btn-danger" %&gt;
      &lt;% end %&gt;
    &lt;/td&gt;
  &lt;/tr&gt;
&lt;% end %&gt;
&lt;/table&gt;

&lt;%= paginate @versions %&gt;
<span class="err">
</span></pre></div>
</figure>

<p>æµè§ˆ <code>http://localhost:3000/admin/versions</code></p>

<p>ä½ å¯ä»¥è¯•ç€åˆ é™¤æˆ–ç¼–è¾‘æŠ¥åèµ„æ–™çœ‹çœ‹ï¼Œå¯ä»¥çœ‹åˆ°ç¼–ä¿®çºªå½•ï¼Œå¹¶è¿›è¡Œå¤åŸ(Undo)ã€‚</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/L5cCTA8cSgSfev1RgE2L_19.png" title=""></figure></p>

    </div>
  </div></div><div class='frame'><h1>
      22-1 æ±‡å‡º CSV æ¡£æ¡ˆ
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š22. æ•°æ®æ±‡å‡º</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>éœ€æ±‚ï¼šåå°å¯ä»¥æ±‡å‡ºæŠ¥åèµ„æ–™</p>

<p>æœ‰æ—¶å€™åå°åŠŸèƒ½åšå†å¤šï¼Œä¹Ÿä¸å¦‚ Microsoft Excel æˆ– Apple Numbers è¯•ç®—è¡¨è½¯ä»¶æä¾›çš„åˆ†æåŠŸèƒ½ï¼Œè¿™æ—¶å€™å¦‚æœæœ‰æ±‡å‡ºåŠŸèƒ½ï¼Œå°±å¯ä»¥å¾ˆæ–¹ä¾¿åœ°æŠŠèµ„æ–™æ±‡å‡ºæ¥ï¼Œç”¨è½¯ä»¶æ¥æ‰“å¼€æµè§ˆã€‚</p>

<p><a href="https://zh.wikipedia.org/wiki/%E9%80%97%E5%8F%B7%E5%88%86%E9%9A%94%E5%80%BC">CSV é€—å·åˆ†éš”å€¼</a>æ˜¯ä¸€ç§ç®€å•çš„èµ„æ–™æ ¼å¼ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯å•çº¯çš„æ–‡å­—æ¡£ï¼Œä¸€è¡Œä¸€ç¬”èµ„æ–™ï¼Œä¸åŒå­—æ®µç”¨é€—å·éš”å¼€ã€‚è¿™ä¸€èŠ‚å…ˆæ¥åšè¿™ç§ã€‚</p>

<p>ç¼–è¾‘ <code>app/views/admin/event_registrations/index.html.erb</code>ï¼Œåœ¨æœ€ä¸‹æ–¹åŠ ä¸Šæ±‡å‡ºæŒ‰é’®ï¼ŒæŒ‡å®š format æ ¼å¼æ˜¯ csv</p>

<figure class="figure-code code"><figcaption><span>app/views/admin/event_registrations/index.html.erb
</span></figcaption><div class="highlight"><pre>   &lt;%= paginate @registrations %&gt;

<span class="gi">+  &lt;p&gt;
+    &lt;%= link_to "æ±‡å‡º CSV", admin_event_registrations_path(:format =&gt; :csv), :class =&gt; "btn btn-default" %&gt;
+  &lt;/p&gt;
</span><span class="err">
</span></pre></div>
</figure>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/TIrYWOETQ52poAPxUF3p_20-1.png" title=""></figure></p>

<p>ç¼–è¾‘ <code>app/controllers/admin/event_registrations_controller.rb</code>ï¼Œåˆ©ç”¨ <code>respond_to</code> é’ˆå¯¹ä¸åŒæ ¼å¼çš„è¯·æ±‚ï¼Œå›åº”ä¸åŒçš„è¾“å‡ºï¼š</p>

<figure class="figure-code code"><figcaption><span>app/controllers/admin/event_registrations_controller.rb
</span></figcaption><div class="highlight"><pre><span class="gi">+  require 'csv'
</span>   class Admin::EventRegistrationsController &lt; AdminController

     before_action :find_event

     def index
       # (ç•¥)

<span class="gi">+      respond_to do |format|
+        format.html
+        format.csv {
+          @registrations = @registrations.reorder("id ASC")
+          csv_string = CSV.generate do |csv|
+            csv &lt;&lt; ["æŠ¥åID", "ç¥¨ç§", "å§“å", "çŠ¶æ€", "Email", "æŠ¥åæ—¶é—´"]
+            @registrations.each do |r|
+              csv &lt;&lt; [r.id, r.ticket.name, r.name, t(r.status, :scope =&gt; "registration.status"), r.email, r.created_at]
+            end
+          end
+          send_data csv_string, :filename =&gt; "#{@event.friendly_id}-registrations-#{Time.now.to_s(:number)}.csv"
+        }
+      end
</span>     end
<span class="err">
</span></pre></div>
</figure>

<p><a href="https://ruby-doc.org/stdlib-2.3.0/libdoc/csv/rdoc/CSV.html">CSV</a> æ˜¯ Ruby å†…å»ºçš„åº“ï¼Œè¿™é‡Œç¬¬ä¸€è¡Œéœ€è¦å…ˆ <code>require</code> å®ƒã€‚ä½¿ç”¨ <code>CSV.generate</code> å¯ä»¥äº§ç”Ÿå‡º <code>csv_string</code> å­—ç¬¦ä¸²ï¼Œä¹Ÿå°±æ˜¯è¦è¾“å‡ºçš„ CSV èµ„æ–™ï¼Œæ¥ç€é€è¿‡ <code>send_data</code> ä¼ ç»™æµè§ˆå™¨è¿›è¡Œæ¡£æ¡ˆä¸‹è½½ã€‚</p>

<p>ç”¨ Apple Number è¯•ç®—è¡¨è½¯ä»¶æ‰“å¼€ï¼š</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/8SSJdTDSQPCLV4CP6d29_20-2.png" title=""></figure></p>

<p>ä½†æ˜¯ CSV æœ‰ä¸ªç¼ºç‚¹ï¼Œå°±æ˜¯ç”¨ Microsoft Excel æ‰“å¼€æ—¶é»˜è®¤ä¼šå˜æˆä¹±ç ã€‚è¿™æ˜¯å› ä¸ºæ±‡å‡ºçš„ CSV çš„å­—ä¸²ç¼–ç æ˜¯ <a href="https://zh.wikipedia.org/zh-tw/UTF-8">UTF-8</a>ï¼Œä½†æ˜¯ Excel é»˜è®¤ä¼šç”¨æœ¬åœ°ç¼–ç ï¼Œä¾‹å¦‚ä¸­å›½å¤§é™†åœ°åŒºç”¨ <a href="https://zh.wikipedia.org/wiki/GB_2312">GB 2312</a>ï¼Œå°æ¹¾åœ°åŒºç”¨ <a href="https://zh.wikipedia.org/wiki/%E5%A4%A7%E4%BA%94%E7%A2%BC">Big5</a>ã€‚è§£å†³åŠæ³•æœ‰äºŒï¼š</p>

<p>æ–¹æ³•ä¸€: ä»¥è®°äº‹æœ¬å¼€å¯åå‚¨å­˜ï¼Œå†ä»¥ Excel å¼€å¯å³å¯æ­£å¸¸æ˜¾ç¤ºã€‚</p>

<p>æ–¹æ³•äºŒ: å¼€å¯ Excel è½¯ä»¶ï¼Œæ–°å¢ç©ºç™½æ´»é¡µç°¿(Workbook)ï¼Œç„¶ååœ¨ä¸Šæ–¹åŠŸèƒ½é€‰é¡¹ä¸­ç‚¹é€‰ã€Œèµ„æ–™(Data)ã€-&gt;ã€Œå–å¾—å¤–éƒ¨èµ„æ–™ Get External Dataã€-&gt;ã€Œä»æ–‡å­—æ¡£ From Text File...ã€â†’ã€Œé€‰æ‹©æ±‡å‡ºçš„ CSV æ¡£æ¡ˆã€â†’ é€‰æ‹©ç¬¦å·åˆ†éš”(Delimited)ã€é€‰æ‹© File origin ç¼–ç æ˜¯ Unicode (UTF-8) â†’ é€‰æ‹©åˆ†éš”ç¬¦å·æ˜¯ Comma é€—ç‚¹ï¼Œå³å¯æ­£å¸¸æ˜¾ç¤ºã€‚</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/YrhK8j7kTh2DVxBmjk5Y_20-3.png" title=""></figure></p>

    </div>
  </div></div><div class='frame'><h1>
      22-2 æ±‡å‡º Excel æ¡£æ¡ˆ
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š22. æ•°æ®æ±‡å‡º</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>å¦‚æœä¸Šè¿° Excel æ‰“å¼€ CSV æ¡£æ¡ˆçš„è§£æ³•æ²¡åŠæ³•æ¥å—çš„è¯ï¼Œé‚£åªå¥½æƒ³åŠæ³•æ±‡å‡º Excel ä¸“ç”¨çš„ xlsx æ ¼å¼äº†ã€‚è¿™éœ€è¦é¢å¤–è£… gemï¼Œè¿™é‡Œç¤ºèŒƒä½¿ç”¨ <a href="https://github.com/straydogstudio/axlsx_rails">axlsx_rails</a> gemã€‚</p>

<p>ç¼–è¾‘ <code>Gemfile</code></p>

<figure class="figure-code code"><figcaption><span>Gemfile
</span></figcaption><div class="highlight"><pre><span class="gi">+  gem 'rubyzip'
+  gem 'axlsx'
+  gem 'axlsx_rails'
</span><span class="err">
</span></pre></div>
</figure>

<p>æ‰§è¡Œ <code>bundle</code>ï¼Œé‡å¯æœåŠ¡å™¨</p>

<p>ç¼–è¾‘ <code>app/views/admin/event_registrations/index.html.erb</code>ï¼ŒåŠ ä¸Šæ±‡å‡ºçš„æŒ‰é’®ï¼ŒæŒ‡å®š format æ ¼å¼æ˜¯ xlsx</p>

<figure class="figure-code code"><figcaption><span>app/views/admin/event_registrations/index.html.erb
</span></figcaption><div class="highlight"><pre>  &lt;%= paginate @registrations %&gt;

  &lt;p&gt;
    &lt;%= link_to "æ±‡å‡º CSV", admin_event_registrations_path(:format =&gt; :csv), :class =&gt; "btn btn-default" %&gt;
<span class="gi">+   &lt;%= link_to "æ±‡å‡º Excel", admin_event_registrations_path(:format =&gt; :xlsx), :class =&gt; "btn btn-default" %&gt;
</span>  &lt;/p&gt;
<span class="err">
</span></pre></div>
</figure>

<p>ç¼–è¾‘ <code>app/controllers/admin/event_registrations_controller.rb</code>ï¼Œæ–°å¢ xlsx æ ¼å¼</p>

<figure class="figure-code code"><figcaption><span>app/controllers/admin/event_registrations_controller.rb
</span></figcaption><div class="highlight"><pre>respond_to do |format|
  format.html
  format.csv {
   # ç•¥
  }
<span class="gi">+     format.xlsx
</span>end
  end
<span class="err">
</span></pre></div>
</figure>

<p>æ–°å¢ <code>app/views/admin/event_registrations/index.xlsx.axlsx</code> æ ·æ¿ï¼š</p>

<figure class="figure-code code"><figcaption><span>app/views/admin/event_registrations/index.xlsx.axlsx
</span></figcaption><div class="highlight"><pre><span class="n">wb</span> <span class="o">=</span> <span class="n">xlsx_package</span><span class="p">.</span><span class="nf">workbook</span>
<span class="n">wb</span><span class="p">.</span><span class="nf">add_worksheet</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"Buttons"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">sheet</span><span class="o">|</span>
  <span class="n">sheet</span><span class="p">.</span><span class="nf">add_row</span> <span class="p">[</span><span class="s2">"æŠ¥åID"</span><span class="p">,</span> <span class="s2">"ç¥¨ç§"</span><span class="p">,</span> <span class="s2">"å§“å"</span><span class="p">,</span> <span class="s2">"çŠ¶æ€"</span><span class="p">,</span> <span class="s2">"Email"</span><span class="p">,</span> <span class="s2">"æŠ¥åæ—¶é—´"</span><span class="p">]</span>
  <span class="vi">@registrations</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span>
    <span class="n">sheet</span><span class="p">.</span><span class="nf">add_row</span> <span class="p">[</span><span class="n">r</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="nf">ticket</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span> <span class="n">t</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">status</span><span class="p">,</span> <span class="ss">:scope</span> <span class="o">=&gt;</span> <span class="s2">"registration.status"</span><span class="p">),</span> <span class="n">r</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="nf">created_at</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span>

</pre></div>
</figure>

<p>è¿™æ ·å°±å¯ä»¥æ±‡å‡º Excel æ ¼å¼çš„æ¡£æ¡ˆäº†ã€‚</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/QllzQDiATQ26prDvZLAp_20-4.png" title=""></figure></p>

    </div>
  </div></div><div class='frame'><h1>
      23-1 å¢åŠ åå°ç®¡ç†å‘˜æƒé™
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š23. ç”¨æˆ·æƒé™æ§ç®¡</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>ç›®å‰åªè¦æœ‰ç™»å…¥å°±å¯ä»¥è¿›å…¥åå°ï¼Œæ¥ä¸‹æ¥å®ä½œåŸºæœ¬çš„æƒé™æ£€æŸ¥(Authorization)å§ï¼Œåªæœ‰ç®¡ç†å‘˜æ‰å¯ä»¥è¿›å…¥åå°ã€‚</p>

<p>åŸºæœ¬çš„åŸç†å¾ˆç®€å•ï¼Œæˆ‘ä»¬åœ¨ User model ä¸Šæ–°å¢ä¸€ä¸ªå­—æ®µæ ‡è®°æ˜¯ä¸æ˜¯ç®¡ç†å‘˜å³å¯ã€‚</p>

<p>æ‰§è¡Œ <code>rails g migration add_role_to_users role:string</code> å¢åŠ ä¸€ä¸ª role å­—ä¸²ç¬¦å­—æ®µåˆ° users table ä¸Šã€‚</p>

<blockquote>
<p>åœ¨ä¹‹å‰çš„è¯¾ç¨‹ä¸­ï¼Œæ˜¯ç”¨ <code>is_admin:boolean</code> å­—æ®µæ¥è¡¨ç¤ºæ˜¯ä¸æ˜¯ç®¡ç†å‘˜ï¼Œåœ¨è¿™é‡Œæ”¹ç”¨ <code>role:string</code>ï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯å¯ä»¥æœ‰è§’è‰²æ‰©å……çš„å¼¹æ€§ã€‚</p>
</blockquote>

<p>æ‰§è¡Œ <code>rake db:migrate</code></p>

<p>ç¼–è¾‘ <code>app/controllers/admin_controller.rb</code>ï¼Œå¢åŠ æƒé™æ£€æŸ¥ <code>current_user</code> çš„ role (è§’è‰²)å¿…é¡»æ˜¯ <code>admin</code>ã€‚</p>

<figure class="figure-code code"><figcaption><span>app/controllers/admin_controller.rb
</span></figcaption><div class="highlight"><pre>  class AdminController &lt; ApplicationController
    protect_from_forgery with: :exception

    before_action :authenticate_user!
<span class="gi">+   before_action :require_admin!
</span>
    layout "admin"

<span class="gi">+   protected
</span>
<span class="gi">+   def require_admin!
+     if current_user.role != "admin"
+       flash[:alert] = "æ‚¨çš„æƒé™ä¸è¶³"
+       redirect_to root_path
+     end
+   end
</span>
  end
<span class="err">
</span></pre></div>
</figure>

<p>è¿™æ—¶å€™ç‚¹é€‰ä¸»é€‰å•çš„åå°é¢æ¿ï¼Œå°±ä¼šå‡ºç°ï¼š</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/w9hAiOVeS96PK3ocy3XJ_23-1.png" title=""></figure></p>

<p>è¿™æ ·å°±è¿›ä¸å»åå°äº†ã€‚</p>

<p>è¦è®¾å®šç¬¬ä¸€ä¸ªç®¡ç†å‘˜ï¼Œåªèƒ½é€è¿‡ rails console äº†ã€‚</p>

<p>æ‰§è¡Œ <code>rails console</code>ï¼Œä¾åºè¾“å…¥ï¼š</p>

<figure class="figure-code code"><div class="highlight"><pre>u = User.find_by_email("admin@example.org")
u.role = "admin"
u.save!
</pre></div>
</figure>

<p>è¿™æ · <code>admin@example.org</code> å°±æœ‰æƒé™å¯ä»¥è¿›å…¥åå°ç®¡ç†ã€‚</p>

    </div>
  </div></div><div class='frame'><h1>
      23-2 å¢åŠ å…¶ä»–è§’è‰²
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š23. ç”¨æˆ·æƒé™æ§ç®¡</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>ç”¨ <code>role</code> çš„è®¾è®¡å¥½å¤„æ˜¯å¯ä»¥æ‰©å……ä¸åŒè§’è‰²ï¼Œè®©æˆ‘ä»¬æ–°è®¾è®¡ä¸€ä¸ª <code>editor</code> è§’è‰²ï¼š</p>

<ul>
<li>
<code>admin</code> æœ‰å…¨éƒ¨åå°æƒé™</li>
<li>
<code>editor</code> å¯ä»¥è¿›å…¥åå°ç®¡ç†æ´»åŠ¨ï¼Œä½†ä¸èƒ½ç®¡ç†ç”¨æˆ·</li>
</ul>

<p>ç¼–è¾‘ <code>app/controllers/admin_controller.rb</code>ï¼Œæ‹¿æ‰æœ¬æ¥åå°éƒ½å¥—ç”¨çš„ <code>before_action :require_admin!</code> æƒé™æ£€æŸ¥ã€‚ç„¶åæ–°å¢ä¸€ä¸ª <code>require_editor!</code> æ–¹æ³•ï¼Œç­‰ä¼šæˆ‘ä»¬å¾—é€ä¸ª controllers ä¸€ä¸ªä¸€ä¸ªåŠ ä¸Šæƒé™æ£€æŸ¥ã€‚</p>

<figure class="figure-code code"><figcaption><span>app/controllers/admin_controller.rb
</span></figcaption><div class="highlight"><pre>  class AdminController &lt; ApplicationController
    protect_from_forgery with: :exception

    before_action :authenticate_user!
<span class="gd">-   before_action :require_admin!
</span>
    layout "admin"

    protected

<span class="gi">+   def require_editor!
+     if current_user.role != "editor" &amp;&amp; current_user.role != "admin"
+       flash[:alert] = "æ‚¨çš„æƒé™ä¸è¶³"
+       redirect_to root_path
+     end
+   end
</span>
    def require_admin!
      if current_user.role != "admin"
        flash[:alert] = "æ‚¨çš„æƒé™ä¸è¶³"
        redirect_to root_path
      end
    end

  end
<span class="err">
</span></pre></div>
</figure>

<p>ç¼–è¾‘ä»¥ä¸‹æ¡£æ¡ˆï¼Œéœ€è¦ editor æƒé™ï¼š</p>

<ul>
<li><code>app/controllers/admin/event_registrations_controller.rb</code></li>
<li><code>app/controllers/admin/event_tickets_controller.rb</code></li>
<li><code>app/controllers/admin/events_controller.rb</code></li>
</ul>

<figure class="figure-code code"><div class="highlight"><pre>+  before_action :require_editor!

</pre></div>
</figure>

<p>ç¼–è¾‘ä»¥ä¸‹æ¡£æ¡ˆï¼Œéœ€è¦ admin æƒé™ï¼š</p>

<ul>
<li><code>app/controllers/admin/user_profiles_controller.rb</code></li>
<li><code>app/controllers/admin/users_controller.rb</code></li>
<li><code>app/controllers/admin/versions_controller.rb</code></li>
</ul>

<figure class="figure-code code"><div class="highlight"><pre>+  before_action :require_admin!

</pre></div>
</figure>

<blockquote>
<p>ä»¥ä¸Šè¿™äº› controller éƒ½åº”è¯¥ç»§æ‰¿è‡ª <code>AdminController</code>ï¼Œä¾‹å¦‚ <code>class Admin::EventsController &lt; AdminController</code>ï¼Œè¿™æ ·æ‰ä¼šæœ‰è¿™ä¸¤ä¸ªæ–¹æ³•å¯ä»¥è°ƒç”¨</p>
</blockquote>

<p>è¿™æ ·å°±å®Œæˆäº†ï¼Œæ¯ä¸ª <code>app/controllers/admin/</code> ç›®å½•ä¸‹çš„ controller éƒ½è¦è®°å¾—åŠ ä¸Šæƒé™æ£€æŸ¥ã€‚</p>

    </div>
  </div></div><div class='frame'><h1>
      23-3 ç¼–è¾‘ç”¨æˆ·è§’è‰²
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š23. ç”¨æˆ·æƒé™æ§ç®¡</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>é™¤äº†ç¬¬ä¸€ä¸ªç®¡ç†å‘˜éœ€è¦è¿›å…¥ rails console ç¼–è¾‘è§’è‰²ä¹‹å¤–ï¼Œåœ¨ç¼–è¾‘ç”¨æˆ·é‚£ä¸€é¡µï¼Œæˆ‘ä»¬å¯ä»¥å®ä½œä¸€ä¸ªä¸‹æ‹‰é€‰å•æ¥ç¼–è¾‘è§’è‰²ã€‚</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/c9Uy1XoTSKYyXzfaI08Q_23-2.png" title=""></figure></p>

<p>ç¼–è¾‘ <code>app/models/user.rb</code></p>

<figure class="figure-code code"><figcaption><span>app/models/user.rb
</span></figcaption><div class="highlight"><pre>  class User &lt; ApplicationRecord

<span class="gi">+   ROLES = ["admin", "editor"]
</span><span class="err">
</span></pre></div>
</figure>

<p>ç¼–è¾‘ <code>app/views/admin/users/edit.html.erb</code></p>

<figure class="figure-code code"><figcaption><span>app/views/admin/users/edit.html.erb
</span></figcaption><div class="highlight"><pre>   &lt;div class="form-group"&gt;
     &lt;%= f.label :email %&gt;
     &lt;%= f.text_field :email, :class =&gt; "form-control" %&gt;
   &lt;/div&gt;

<span class="gi">+  &lt;div class="form-group"&gt;
+    &lt;%= f.label :role %&gt;
+    &lt;%= f.select :role, User::ROLES.map{ |x| [t(x, :scope =&gt; "user.role"), x] }, { :include_blank =&gt; true }, :class =&gt; "form-control" %&gt;
+  &lt;/div&gt;
</span><span class="err">
</span></pre></div>
</figure>

<blockquote>
<p>æ³¨æ„è¿™é‡Œå¤šåŠ äº† <code>:include_blank =&gt; true</code> å‚æ•°ï¼Œè¿™ä¼šè®©ä¸‹æ‹‰é€‰å•å¤šä¸€ä¸ªç©ºçš„ nil ç©ºé€‰é¡¹ã€‚</p>
</blockquote>

<p>ç¼–è¾‘ <code>config/locales/zh-CN.yml</code></p>

<figure class="figure-code code"><figcaption><span>config/locales/zh-CN.yml
</span></figcaption><div class="highlight"><pre>  "zh-CN":
<span class="gi">+   user:
+     role:
+       admin: è¶…çº§ç®¡ç†å‘˜
+       editor: æ´»åŠ¨ç®¡ç†å‘˜
</span><span class="err">
</span></pre></div>
</figure>

<p>ç¼–è¾‘ <code>app/controllers/admin/users_controller.rb</code></p>

<figure class="figure-code code"><figcaption><span>app/controllers/admin/users_controller.rb
</span></figcaption><div class="highlight"><pre>   def user_params
<span class="gd">-    params.require(:user).permit(:email, :group_ids =&gt; [])
</span><span class="gi">+    params.require(:user).permit(:email, :role, :group_ids =&gt; [])
</span>   end
<span class="err">
</span></pre></div>
</figure>

<p>è¿™æ ·å°±å¯ä»¥ç¼–è¾‘ç”¨æˆ·çš„è§’è‰²äº†ã€‚è¯·ç¼–è¾‘ä»»ä¸€ä¸ªç”¨æˆ·å˜æˆ editorï¼Œç„¶åç™»å‡ºï¼Œæ”¹ç”¨é‚£ä¸ªå¸å·ç™»å…¥(å‡ç”¨æˆ·çš„å¯†ç æ˜¯12345678)ï¼Œå°±å¯ä»¥æµ‹è¯•ä¸Šä¸€èŠ‚çš„æƒé™æ£€æŸ¥äº†ï¼šå¯ä»¥æ´»åŠ¨ç®¡ç†ï¼Œä½†æ˜¯ç‚¹ç”¨æˆ·ç®¡ç†ä¼šè·³å‡ºæƒé™ä¸è¶³ã€‚</p>

    </div>
  </div></div><div class='frame'><h1>
      23-4 æƒé™é‡æ„
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š23. ç”¨æˆ·æƒé™æ§ç®¡</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>æ—¢ç„¶ editor æ²¡æœ‰æƒé™å¯ä»¥ç®¡ç†ç”¨æˆ·ï¼Œé‚£ä¹ˆåœ¨ä¸»é€‰å•ä¸Šå°±ä¸åº”è¯¥å‡ºç°ç”¨æˆ·ç®¡ç†çš„è¿ç»“ï¼Œè®©æˆ‘ä»¬å°å°æ”¹è¿›ä¸€ä¸‹ï¼š</p>

<p>ç¼–è¾‘ <code>app/views/layouts/admin.html.erb</code>ï¼Œæ ¹æ®ä¸åŒæƒé™å†³å®šè¦ä¸è¦æ˜¾ç¤ºè¿ç»“ï¼š</p>

<figure class="figure-code code"><figcaption><span>app/views/layouts/admin.html.erb
</span></figcaption><div class="highlight"><pre>  &lt;% if current_user %&gt;
<span class="gi">+   &lt;% if current_user.role == "admin" || current_user.role == "editor" %&gt;
</span>      &lt;li class="active"&gt;&lt;%= link_to('æ´»åŠ¨ç®¡ç†', admin_events_path) %&gt;&lt;/li&gt;
<span class="gi">+   &lt;% end %&gt;
</span>
<span class="gi">+   &lt;% if current_user.role == "admin" %&gt;
</span>      &lt;li&gt;&lt;%= link_to('ç”¨æˆ·ç®¡ç†', admin_users_path) %&gt;&lt;/li&gt;
<span class="gi">+    &lt;% end %&gt;
</span><span class="err">  &lt;% end %&gt;
</span></pre></div>
</figure>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/pixHFFSQViREGemRy8Hg_23-3.png" title=""></figure></p>

<p>ä¸è¿‡è¿™ä¸ª if æ¡ä»¶è·Ÿ <code>admin_controller.rb</code> é‡Œé¢çš„æƒé™æ£€æŸ¥æ¡ä»¶ï¼Œå…¶å®é€»è¾‘æ˜¯ä¸€æ ·çš„ï¼Œä¹Ÿå°±æ˜¯ admin çš„æƒé™åŒ…æ‹¬ editor çš„æƒé™ï¼Œæˆ‘ä»¬è¿›ä¸€æ­¥é‡æ„ä¸€ä¸‹ã€‚</p>

<p>ç¼–è¾‘ <code>app/models/user.rb</code>ï¼ŒåŠ ä¸Šä¸¤ä¸ªæ–¹æ³•åˆ¤æ–­æ˜¯ä¸æ˜¯ admin å’Œ editor</p>

<figure class="figure-code code"><figcaption><span>app/models/user.rb
</span></figcaption><div class="highlight"><pre><span class="gi">+  def is_admin?
+    self.role == "admin"
+  end
+
+  def is_editor?
+    ["admin", "editor"].include?(self.role)  # å¦‚æœæ˜¯ admin çš„è¯ï¼Œå½“ç„¶ä¹Ÿæœ‰ editor çš„æƒé™
+  end
</span><span class="err">
</span></pre></div>
</figure>

<p>ç¼–è¾‘ <code>app/controllers/admin_controller.rb</code>ï¼Œæ”¹æˆç”¨ <code>is_admin?</code> å’Œ <code>is_editor?</code> æ–¹æ³•</p>

<figure class="figure-code code"><div class="highlight"><pre>  protected

  def require_editor!
-   if current_user.role != "editor" &amp;&amp; current_user.role != "admin"
+   unless current_user.is_editor?
      flash[:alert] = "æ‚¨çš„æƒé™ä¸è¶³"
      redirect_to root_path
    end
  end

  def require_admin!
-   if current_user.role != "admin"
+   unless current_user.is_admin?
      flash[:alert] = "æ‚¨çš„æƒé™ä¸è¶³"
      redirect_to root_path
    end
  end

</pre></div>
</figure>

<p>ç¼–è¾‘ <code>app/views/layouts/admin.html.erb</code>ï¼Œæ”¹æˆç”¨ <code>is_admin?</code> å’Œ <code>is_editor?</code> æ–¹æ³•</p>

<figure class="figure-code code"><figcaption><span>app/views/layouts/admin.html.erb
</span></figcaption><div class="highlight"><pre>  &lt;% if current_user %&gt;
<span class="gd">-   &lt;% if current_user.role == "admin" || current_user.role == "editor" %&gt;
</span><span class="gi">+   &lt;% if current_user.is_editor? %&gt;
</span>      &lt;li class="active"&gt;&lt;%= link_to('æ´»åŠ¨ç®¡ç†', admin_events_path) %&gt;&lt;/li&gt;
    &lt;% end %&gt;

<span class="gd">-   &lt;% if current_user.role == "admin" %&gt;
</span><span class="gi">+   &lt;% if current_user.is_admin? %&gt;
</span>      &lt;li&gt;&lt;%= link_to('ç”¨æˆ·ç®¡ç†', admin_users_path) %&gt;&lt;/li&gt;
     &lt;% end %&gt;
  &lt;% end %&gt;
<span class="err">
</span></pre></div>
</figure>

<p>è¿™æ ·å°±å®Œæˆäº†ï¼Œé€è¿‡ User model çš„ <code>is_admin?</code> å’Œ <code>is_editor?</code> æ–¹æ³•é›†ä¸­æƒé™æ£€æŸ¥çš„é€»è¾‘ï¼Œä¹‹åå¦‚æœæ–°å¢ä¸åŒå­æƒé™ï¼Œåªè¦æ”¹ model å°±å¯ä»¥äº†ã€‚</p>

    </div>
  </div></div><div class='frame'><h1>
      23-5 è¡¥å……: pundit å’Œ cancancan
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š23. ç”¨æˆ·æƒé™æ§ç®¡</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>å¦‚æœæƒé™æ£€æŸ¥çš„é€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œæœ‰å¾ˆå¤šè§’è‰²è€Œä¸”ä¸åŒ action åˆæœ‰ä¸åŒæƒé™ï¼Œç”šè‡³æ˜¯ä¸åŒèµ„æ–™æœ‰ä¸åŒæƒé™ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥è€ƒè™‘ä½¿ç”¨ä¸“ç”¨çš„æƒé™æ£€æŸ¥ gemï¼Œå¸®åŠ©æˆ‘ä»¬ç»„ç»‡ä»£ç ï¼Œä¹Ÿé¿å…å¿˜è®°åŠ ä¸Šæƒé™(å‰å‡ èŠ‚çš„å®ä½œï¼Œå¦‚æœå¿˜è®°åŠ ä¸Š <code>before_action</code> ä½ å°±å¿˜è®°æ£€æŸ¥åˆ°å›‰)ã€‚æœ€çŸ¥åçš„æœ‰ä»¥ä¸‹ä¸¤å¥—ï¼š</p>

<ul>
<li><a href="https://github.com/elabs/pundit">Pundit</a></li>
<li><a href="https://github.com/CanCanCommunity/cancancan">Cancancan</a></li>
</ul>

<p>è¯¦ç»†ç”¨æ³•è¯·è‡ªè¡Œå‚è€ƒæ–‡æ¡£ã€‚</p>

    </div>
  </div></div><div class='frame'><h1>
      24-1 å®‰è£… letter_opener
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š24. HTML E-mail å¯„é€</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>åœ¨æœ¬æœºå¼€å‘çš„æ—¶å€™ï¼Œä¸éœ€è¦çœŸçš„å¯„å‡º E-mailï¼Œè¯·å®‰è£… <a href="https://github.com/ryanb/letter_opener">letter_opener</a>ï¼Œè¿™æ · Rails ä¼šåœ¨å¯„ä¿¡æ—¶ï¼Œè‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨è¿›è¡Œé¢„è§ˆã€‚</p>

<p>ç¼–è¾‘ <code>Gemfile</code></p>

<figure class="figure-code code"><figcaption><span>Gemfile
</span></figcaption><div class="highlight"><pre>  group :development do
    gem 'faker'
<span class="gi">+   gem 'letter_opener'
</span>
<span class="err">
</span></pre></div>
</figure>

<p>ç¼–è¾‘ <code>config/environments/development.rb</code> è®¾å®š <code>delivery_method</code></p>

<figure class="figure-code code"><figcaption><span>config/environments/development.rb
</span></figcaption><div class="highlight"><pre><span class="gi">+  config.action_mailer.delivery_method = :letter_opener
</span>   config.action_mailer.default_url_options = { :host =&gt; 'localhost:3000' }
<span class="err">
</span></pre></div>
</figure>

<p>æ‰§è¡Œ <code>bundle</code>ï¼Œé‡å¯æœåŠ¡å™¨</p>

<p>è¦æµ‹è¯• E-mail çš„ä¸€ä¸ªç®€å•æ–¹å¼æ˜¯å»æµ‹è¯•å¿˜è®°å¯†ç æµç¨‹ï¼šè¯·ç™»å‡ºï¼Œç„¶åè¿›å…¥ç™»å…¥ç”»é¢ï¼Œç‚¹é€‰ Forgot your password?</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/BmFako9ZSei1wyIAh6QT_24-1.png" title=""></figure></p>

<p>è¾“å…¥ E-mail åæŒ‰ä¸‹é€å‡ºï¼Œè¿™æ—¶å€™ä¸ä¼šçœŸçš„å¯„å‡º E-mailï¼Œè€Œæ˜¯è‡ªåŠ¨è·³å‡ºæµè§ˆå™¨æµè§ˆä¿¡ä»¶å†…å®¹ï¼š</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/MzLT86PfTbmfFTiWkArc_24-2.png" title=""></figure></p>

    </div>
  </div></div><div class='frame'><h1>
      24-2 å¯„é€æŠ¥åå®Œæˆçš„ E-mail
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š24. HTML E-mail å¯„é€</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>å®ä½œç›®æ ‡ï¼šå®ŒæˆæŠ¥ååï¼Œå¯„å‡ºé€šçŸ¥ E-mail</p>

<p>æ‰§è¡Œ <code>rails g mailer notification</code></p>

<p>ç¼–è¾‘ <code>app/mailers/notification_mailer.rb</code>ï¼Œæ–°å¢ confirmed_registration ä¿¡</p>

<figure class="figure-code code"><figcaption><span>app/mailers/notification_mailer.rb
</span></figcaption><div class="highlight"><pre>  class NotificationMailer &lt; ApplicationMailer

<span class="gi">+   def confirmed_registration(registration)
+     @registration = registration
+     @event = registration.event
+
+     mail( :to =&gt; @registration.email, :subject =&gt;   I18n.t("notification.subject.confirmed_registration", :name =&gt; @event.name) )
+   end
</span>
  end
<span class="err">
</span></pre></div>
</figure>

<p>ç¼–è¾‘ <code>config/locales/zh-CN.yml</code> å¢åŠ  E-mail æ ‡é¢˜çš„ç¿»è¯‘</p>

<figure class="figure-code code"><figcaption><span>config/locales/zh-CN.yml
</span></figcaption><div class="highlight"><pre>  "zh-CN":
<span class="gi">+   notification:
+     subject:
</span><span class="err">+       confirmed_registration: "æŠ¥åæˆåŠŸ: %{name}"
</span></pre></div>
</figure>

<p>æ–°å¢ <code>app/views/notification_mailer/confirmed_registration.text.erb</code> æ˜¯ E-mail æ ·æ¿</p>

<figure class="figure-code code"><figcaption><span>
</span></figcaption><div class="highlight"><pre>Hi <span class="cp">&lt;%=</span> <span class="vi">@registration</span><span class="p">.</span><span class="nf">name</span> <span class="cp">%&gt;</span>,

æ‚¨å·²å®ŒæˆæŠ¥å <span class="cp">&lt;%=</span> <span class="vi">@event</span><span class="p">.</span><span class="nf">name</span> <span class="cp">%&gt;</span> <span class="cp">&lt;%=</span> <span class="n">event_url</span><span class="p">(</span><span class="vi">@event</span><span class="p">)</span> <span class="cp">%&gt;</span>

</pre></div>
</figure>

<blockquote>
<p>åœ¨ E-mail é‡Œé¢çš„ç½‘å€éƒ½å¿…é¡»è¦å†™ç»å¯¹ç½‘å€ <code>xxx_url</code>ï¼Œè€Œä¸æ˜¯ç›¸å¯¹ç½‘å€ <code>xxx_path</code>ã€‚ä¾‹å¦‚ <code>event_url(@event)</code> ä¼šäº§ç”Ÿ <code>http://localhost:3000/events/fullstack-meetup</code>ï¼Œè€Œ <code>event_path(@event)</code> ä¼šäº§ç”Ÿ <code>/events/fullstack-meetup</code>ï¼Œè¿™æ ·åœ¨ E-mail é˜…è¯»å™¨ä¸­ç‚¹è¶…è¿ç»“æ‰èƒ½é¡ºåˆ©è®©æµè§ˆå™¨æ‰“å¼€ç½‘å€ã€‚é‚£ Rails è¦æ€ä¹ˆçŸ¥é“ç½‘ç«™ä½ç½®å‘¢? æˆ‘ä»¬æ›¾åœ¨ <code>config/environments/development.rb</code> å†™è¿‡ <code>config.action_mailer.default_url_options = { :host =&gt; 'localhost:3000' }</code> è¿™å°±æ˜¯ E-mail ä¸­äº§ç”Ÿ <code>xxx_url</code> ç½‘å€æ—¶ï¼Œä¼šç”¨çš„ç½‘ç«™ä½ç½®ã€‚ä¹‹åä¸Š production ä½ ä¹Ÿå¿…é¡»åœ¨ <code>config/environments/production.rb</code> è¿›è¡Œè®¾å®šã€‚</p>
</blockquote>

<p>ç¼–è¾‘ <code>app/controllers/registrations_controller.rb</code> åœ¨æŠ¥åå®Œæˆåå¯„å‡º E-mail</p>

<figure class="figure-code code"><figcaption><span>app/controllers/registrations_controller.rb
</span></figcaption><div class="highlight"><pre>
  def step3_update
    @registration = @event.registrations.find_by_uuid(params[:id])
    @registration.status = "confirmed"
    @registration.current_step = 3

    if @registration.update(registration_params)
      flash[:notice] = "æŠ¥åæˆåŠŸ"

<span class="gi">+     NotificationMailer.confirmed_registration(@registration).deliver_later
</span>
      redirect_to event_registration_path(@event, @registration)
    else
      render "step3"
    end
  end
<span class="err">
</span></pre></div>
</figure>

<p>è¿™æ ·å°±ä¼šåœ¨æŠ¥åå®Œæˆåï¼Œå¯„å‡º E-mail äº†ï¼š</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/zC0XX8WRBSnNQsyKvPGQ_24-3.png" title=""></figure></p>

<p>ä½ ä¹Ÿå¯ä»¥ç›´æ¥åœ¨ rails console ä¸­è¿›è¡Œæµ‹è¯•ï¼š</p>

<p>æ‰§è¡Œ <code>rails console</code>ï¼Œç„¶åè¾“å…¥</p>

<figure class="figure-code code"><div class="highlight"><pre>NotificationMailer.confirmed_registration( Registration.by_status("confirmed").last ).deliver_now
</pre></div>
</figure>

<p>è¿™æ ·å°±ä¼šå¯„å‡ºæœ€åä¸€ç¬”æŠ¥åæˆåŠŸçš„ä¿¡ï¼Œæ–¹ä¾¿æˆ‘ä»¬åå¤ä¿®æ”¹ <code>app/views/notification_mailer/confirmed_registration.text.erb</code> æ ·æ¿ï¼Œè€Œä¸éœ€è¦ç¦»å¼€ rails consoleï¼Œæ¯æ¬¡æ”¹å®Œåªè¦åœ¨ rails console ä¸­å†å¯„ä¸€æ¬¡å°±å¯ä»¥äº†ã€‚</p>

    </div>
  </div></div><div class='frame'><h1>
      24-3 HTML E-mail
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š24. HTML E-mail å¯„é€</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>ä¸Šä¸€èŠ‚ä¸­çš„ E-mail æ ·æ¿ï¼Œé‡‡ç”¨çš„æ˜¯çº¯æ–‡å­— text æ ¼å¼ï¼Œæ‰€ä»¥å‰¯æ¡£åæ˜¯ <code>.text.erb</code>ã€‚</p>

<p>çº¯æ–‡å­—çš„ E-mail å¥½å¤„æ˜¯æ’ç‰ˆç®€å•ï¼Œä¸éœ€è¦çƒ¦æ¼æ ·å¼ã€è€Œä¸”æ‰€æœ‰çš„ Email é˜…è¯»å™¨éƒ½å¯ä»¥é¡ºåˆ©æ‰“å¼€ï¼Œä¸è¿‡ç¼ºç‚¹å°±æ˜¯å› ä¸ºæ²¡æœ‰ HTMLï¼Œæ‰€ä»¥ä¸èƒ½æ”¾è¶…è¿ç»“ï¼Œåªèƒ½ç›´æ¥æ”¾ç½‘å€ (ä¸è¿‡å¤§éƒ¨åˆ†çš„ E-mail é˜…è¯»å™¨éƒ½èƒ½åˆ¤æ–­è¿™æ˜¯ç½‘å€ï¼Œä¾¿ä¼šè‡ªåŠ¨å¸®ä½ åŠ ä¸Šè¶…è¿ç»“)ã€ä¸èƒ½æ”¾ç›´æ¥æ”¾å›¾ç‰‡(img)ã€ä¸èƒ½æ”¾è¡¨æ ¼(table)ç­‰ç­‰ã€‚</p>

<p>å› æ­¤å¦‚æœæƒ³è¦åˆ¶ä½œæ¼‚äº®çš„ E-mailï¼Œå°±éœ€è¦åˆ¶ä½œ HTML æ ¼å¼çš„ E-mailï¼Œè¦æ”¹æˆå¯„å‡º HTML E-mail å¾ˆç®€å•ï¼š</p>

<p>è¯·å°† <code>app/views/notification_mailer/confirmed_registration.text.erb</code> æ¡£åå˜æ›´ä¸º <code>app/views/notification_mailer/confirmed_registration.html.erb</code>ï¼Œæ¥ç€ç¼–è¾‘å®ƒï¼š</p>

<figure class="figure-code code"><figcaption><span>app/views/notification_mailer/confirmed_registration.html.erb
</span></figcaption><div class="highlight"><pre><span class="gd">-   Hi &lt;%= @registration.name %&gt;,
</span><span class="gi">+  &lt;p&gt;Hi &lt;%= @registration.name %&gt;,&lt;/p&gt;
</span>
<span class="gd">-  æ‚¨å·²å®ŒæˆæŠ¥å &lt;%= @event.name %&gt; &lt;%= event_url(@event) %&gt;
</span><span class="gi">+  &lt;p&gt;æ‚¨å·²å®ŒæˆæŠ¥å &lt;%= link_to @event.name, event_url(@event) %&gt;&lt;/p&gt;
</span><span class="err">
</span></pre></div>
</figure>

<p>å†æµ‹è¯•å¯„ä¸€æ¬¡ï¼Œç½‘å€çš„éƒ¨åˆ†å°±å˜æˆè¶…è¿ç»“äº†ï¼š</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/8UtdwuvlSF2RRF8eEIkd_24-4.png" title=""></figure></p>

<blockquote>
<p>Protip: ç”±ç”¨æˆ·è§¦å‘çš„ç³»ç»Ÿä¿¡æ¯”è¾ƒé€‚åˆç”¨ HTML E-mailï¼Œç”¨æˆ·ä¼šæ„Ÿè§‰é‚£æ˜¯ç³»ç»Ÿè‡ªåŠ¨å¯„å‡ºçš„ä¿¡ä»¶ã€‚ä½†å¦‚æœæ˜¯å®¢æœå›ä¿¡æˆ–æ„è§è¯¢é—®ï¼Œç”¨çº¯æ–‡å­— E-mail å¯èƒ½åè€Œæ¯”è¾ƒæœ‰è¯šæ„å–”ã€‚å› ä¸ºç”¨æˆ·ä¼šæ„Ÿè§‰é‚£æ˜¯äººå†™çš„ä¿¡ä»¶ï¼Œè€Œä¸æ˜¯ç³»ç»Ÿè‡ªåŠ¨å¯„å‡ºçš„ä¿¡ã€‚</p>
</blockquote>

    </div>
  </div></div><div class='frame'><h1>
      24-4 E-mail CSS æ ·å¼é—®é¢˜ï¼šå®‰è£… premailer
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š24. HTML E-mail å¯„é€</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>æ—¢ç„¶ç”¨äº† HTML E-mailï¼Œæ¥ä¸‹æ¥ä¼šæƒ³åŠ ä¸€äº› CSS æ ·å¼ä¸Šå»ã€‚ä¸è¿‡è¿™å°±æ˜¯éº»çƒ¦çš„åœ°æ–¹ï¼ŒE-mail é˜…è¯»è½¯ä»¶æ¯”èµ·æµè§ˆå™¨æ›´å¤šæ ·æ›´å¤è€ï¼Œä¾‹å¦‚æœ‰ Outlookã€iPhoneã€Apple Mailã€Yahoo! Mailã€Google Mailã€Androidã€QQ ä¿¡ç®±ç­‰ç­‰ï¼Œè¿™äº› E-mail é˜…è¯»å™¨å¯¹ CSS çš„æ”¯æ´ç¨‹åº¦å¾ˆä¸ä¸€è‡´ã€‚è¯¦æƒ…è¯·å‚è€ƒï¼š</p>

<ul>
<li><a href="https://blog.othree.net/log/2016/08/25/modern-html-email-develop/">Modern HTML Email Development</a></li>
<li><a href="https://www.campaignmonitor.com/css/">The Ultimate Guide to CSS</a></li>
<li><a href="http://templates.mailchimp.com/development/css/">CSS | Email Design Reference</a></li>
</ul>

<p>åŸºæœ¬æ¥è¯´ï¼Œä½ ä¸èƒ½ç”¨ <code>&lt;link&gt;</code> æ ‡ç±¤å»åŠ è½½ CSS æ¡£æ¡ˆã€æœ‰äº› E-mail é˜…è¯»å™¨ä¸èƒ½ç”¨ <code>&lt;style&gt;</code> æ ‡ç±¤å†™ CSS æ ·å¼ï¼Œå½“ç„¶ä¹Ÿä¸å¯èƒ½å†™ JavaScriptã€‚</p>

<p>ä¿é™©çš„ä½œæ³•æ˜¯éœ€è¦å°† CSS ç”¨ Inline (å†…è”)çš„æ–¹å¼åˆ° HTML é‡Œé¢ï¼Œä¾‹å¦‚ä»¥ä¸‹çš„ HTMLï¼š</p>

<figure class="figure-code code"><div class="highlight"><pre>&lt;link rel="stylesheet" media="all" href="/assets/email.css" /&gt;
&lt;style&gt;
  p { color: red }
&lt;/style&gt;
&lt;body&gt;
  &lt;p&gt;TEST&lt;/p&gt;
&lt;/body&gt;
</pre></div>
</figure>

<p>åœ¨å¯„å‡ºçš„ E-mail ä¸­éœ€è¦æ”¹æˆå°† CSS éƒ½é›†ä¸­åˆ°è¯¥æ ‡ç±¤çš„ <code>style</code> å±æ€§ï¼Œè¿™æ · E-mail é˜…è¯»å™¨æ‰ä¼šå¥—ç”¨åˆ° CSS æ ·å¼ã€‚</p>

<figure class="figure-code code"><div class="highlight"><pre>&lt;body&gt;
  &lt;p style="color: red; font-family: 'Helvetica N=
eue', Helvetica, Arial, sans-serif; font-size: 14px; font-weight: normal;"&gt;
&lt;/body&gt;
</pre></div>
</figure>

<p>è¿™æ˜¯ä¸€ä¸ªå¤§è‹¦å·¥å•Šï¼Œæ›´ä½•å†µå†™æˆ inline CSS çš„è¯ï¼Œä»£ç ç»´æŠ¤æ€§ä¼šå˜æˆéå¸¸å·®å¾ˆéš¾æ”¹ã€‚</p>

<p>å¥½åœ¨ Rails æœ‰ä¸ª <a href="https://github.com/fphilipe/premailer-rails">premailer-rails</a> gem å¯ä»¥å¸®æˆ‘ä»¬è‡ªåŠ¨åšå¥½è¿™ä¸ªè½¬æ¢ï¼Œå°±å¯ä»¥ç”¨æœ¬æ¥çš„å†™æ³•ï¼Œå®ƒä¼šè‡ªåŠ¨è½¬æ¢æˆ inline CSS ğŸ‘ğŸ‘ğŸ‘</p>

<p>è¯·ç¼–è¾‘ <code>Gemfile</code></p>

<figure class="figure-code code"><figcaption><span>
</span></figcaption><div class="highlight"><pre>+  gem 'premailer-rails'

</pre></div>
</figure>

<p>æ‰§è¡Œ <code>bundle</code>ï¼Œé‡å¯æœåŠ¡å™¨ï¼Œä¸‹ä¸€èŠ‚æˆ‘ä»¬æ¥å¥—ç‰ˆã€‚</p>

    </div>
  </div></div><div class='frame'><h1>
      24-5 HTML E-mail å¥—ç‰ˆ
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š24. HTML E-mail å¯„é€</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>å› ä¸º E-mail çš„ CSS å±æ€§æ”¯æ´ç¨‹åº¦ä¸ä¸€ï¼Œå¦‚æœè¦å®Œå…¨è‡ªå·±å†™ CSS æµ‹è¯•ä¼šå¾ˆè¾›è‹¦ï¼Œå¥½åœ¨æˆ‘ä»¬æœ‰ç°æˆçš„ Email Responsive Template æ ·æ¿å¯ä»¥å¥—ï¼š</p>

<ul>
<li><a href="http://blog.mailgun.com/transactional-html-email-templates/">Transactional HTML Email Templates</a></li>
<li><a href="https://github.com/leemunroe/responsive-html-email-template">Really Simple Responsive HTML Email Template</a></li>
<li>
<a href="https://htmlemail.io/">Responsive HTML Email Templates</a> USD $49</li>
</ul>

<p>è¯·ä¸‹è½½ç¬¬ä¸€ä¸ª <a href="https://github.com/mailgun/transactional-email-templates/archive/master.zip">Transactional HTML Email Templates çš„ zip å‹ç¼©æ¡£</a>ï¼Œæˆ‘ä»¬æ‹¿å®ƒçš„ <code>templates/action.html</code> æ¥æ”¹ã€‚</p>

<blockquote>
<p>ä½ ä¼šå‘ç°è¿™ä¸ªä»–è¿˜æœ‰æä¾› inlined çš„ç‰ˆæœ¬ï¼ŒæŠŠ style inline è¿›å»åçš„ HTML ä»£ç éå¸¸çš„æ¶å¿ƒï¼Œå¾ˆéš¾ä¿®æ”¹ã€‚å¥½åœ¨æˆ‘ä»¬æœ‰è£… <code>premailer-rails</code> gem äº†ï¼Œæ‰€ä»¥ç”¨ä¸åˆ°ã€‚</p>
</blockquote>

<p>è¯·æŠŠ <code>templates/style.css</code> å¤åˆ¶åˆ°æˆ‘ä»¬é¡¹ç›®ä¸­çš„ <code>app/assets/stylesheets/email.css</code></p>

<p>ç¼–è¾‘ <code>app/views/layouts/mailer.html.erb</code>ï¼ŒæŠŠå†…å®¹å…¨éƒ¨æ¢æˆï¼š</p>

<figure class="figure-code code"><figcaption><span>app/views/layouts/mailer.html.erb
</span></figcaption><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"&gt;</span>
<span class="nt">&lt;html</span> <span class="na">xmlns=</span><span class="s">"http://www.w3.org/1999/xhtml"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"viewport"</span> <span class="na">content=</span><span class="s">"width=device-width"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">"Content-Type"</span> <span class="na">content=</span><span class="s">"text/html; charset=UTF-8"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;title&gt;</span>Notification<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">"email.css"</span> <span class="na">media=</span><span class="s">"all"</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">type=</span><span class="s">"text/css"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/head&gt;</span>

<span class="nt">&lt;body</span> <span class="na">itemscope</span> <span class="na">itemtype=</span><span class="s">"http://schema.org/EmailMessage"</span><span class="nt">&gt;</span>

<span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">"body-wrap"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;td&gt;&lt;/td&gt;</span>
    <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">"container"</span> <span class="na">width=</span><span class="s">"600"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"content"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">"main"</span> <span class="na">width=</span><span class="s">"100%"</span> <span class="na">cellpadding=</span><span class="s">"0"</span> <span class="na">cellspacing=</span><span class="s">"0"</span> <span class="na">itemprop=</span><span class="s">"action"</span> <span class="na">itemscope</span> <span class="na">itemtype=</span><span class="s">"http://schema.org/ConfirmAction"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">"content-wrap"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;meta</span> <span class="na">itemprop=</span><span class="s">"name"</span> <span class="na">content=</span><span class="s">"Confirm Email"</span><span class="nt">/&gt;</span>
              <span class="nt">&lt;table</span> <span class="na">width=</span><span class="s">"100%"</span> <span class="na">cellpadding=</span><span class="s">"0"</span> <span class="na">cellspacing=</span><span class="s">"0"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;tr&gt;</span>
                  <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">"content-block"</span><span class="nt">&gt;</span>
                    <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
                  <span class="nt">&lt;/td&gt;</span>
                <span class="nt">&lt;/tr&gt;</span>
                <span class="nt">&lt;tr&gt;</span>
                  <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">"content-block"</span> <span class="na">itemprop=</span><span class="s">"handler"</span> <span class="na">itemscope</span> <span class="na">itemtype=</span><span class="s">"http://schema.org/HttpActionHandler"</span><span class="nt">&gt;</span>
                    <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="ss">:action</span> <span class="cp">%&gt;</span>
                  <span class="nt">&lt;/td&gt;</span>
                <span class="nt">&lt;/tr&gt;</span>
                <span class="nt">&lt;tr&gt;</span>
                  <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">"content-block"</span><span class="nt">&gt;</span>
                    <span class="ni">&amp;mdash;</span> ä½ çš„åå­—
                  <span class="nt">&lt;/td&gt;</span>
                <span class="nt">&lt;/tr&gt;</span>
              <span class="nt">&lt;/table&gt;</span>
            <span class="nt">&lt;/td&gt;</span>
          <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;/table&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"footer"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;table</span> <span class="na">width=</span><span class="s">"100%"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;tr&gt;</span>
              <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">"aligncenter content-block"</span><span class="nt">&gt;&lt;a</span> <span class="na">href=</span><span class="s">"https://fullstack.xinshengdaxue.com"</span><span class="nt">&gt;</span>æ–°ç”Ÿå¤§å­¦çº¿ä¸Šå…¨æ ˆè¥<span class="nt">&lt;/a&gt;&lt;/td&gt;</span>
            <span class="nt">&lt;/tr&gt;</span>
          <span class="nt">&lt;/table&gt;</span>
        <span class="nt">&lt;/div&gt;&lt;/div&gt;</span>
    <span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;&lt;/td&gt;</span>
  <span class="nt">&lt;/tr&gt;</span>
<span class="nt">&lt;/table&gt;</span>

<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>

</pre></div>
</figure>

<p>å…¶ä¸­ä¸»å†…å®¹æ˜¯ <code>&lt;%= yield %&gt;</code>ï¼Œå¦å¤–è¿˜æŒ–äº†ä¸€ä¸ªæ´æ˜¯ <code>&lt;%= yield :action %&gt;</code>ï¼Œç­‰ä¼šç”¨ <code>content_for :action</code> å¯ä»¥å¡«å†…å®¹è¿›å»ã€‚</p>

<p>ç¼–è¾‘ <code>app/views/notification_mailer/confirmed_registration.html.erb</code></p>

<figure class="figure-code code"><figcaption><span>app/views/notification_mailer/confirmed_registration.html.erb
</span></figcaption><div class="highlight"><pre>   &lt;p&gt;Hi &lt;%= @registration.name %&gt;,&lt;/p&gt;

   &lt;p&gt;æ‚¨å·²å®ŒæˆæŠ¥å &lt;%= link_to @event.name, event_url(@event) %&gt;&lt;/p&gt;

<span class="gi">+  &lt;% content_for :action do %&gt;
+    &lt;%= link_to "æµè§ˆæŠ¥åç»“æœ", event_registration_url(@event, @registration), :class =&gt; "btn-primary", :itemprop =&gt; "url" %&gt;
+  &lt;% end %&gt;
</span><span class="err">
</span></pre></div>
</figure>

<p>å¤šåŠ äº†ä¸€ä¸ªç”¨é€”æ˜¯ Call to Action çš„æŒ‰é’®ï¼Œè¿™æ ·ä¸€å°æ¼‚äº®çš„ E-mail å°±å®Œæˆäº†ã€‚</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Y6WMipPSD6UbhQVqgdWO_24-5.png" title=""></figure></p>

    </div>
  </div></div><div class='frame'><h1>
      25-1 è§£æ CSV æ¡£æ¡ˆ (Rake)
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š25. æ•°æ®æ±‡å…¥</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>æˆ‘ä»¬åœ¨ã€Œç™¾å®ç®± 20-æ•°æ®æ±‡å‡º ã€å®ä½œè¿‡æ±‡å‡º CSV æ ¼å¼ï¼Œä¸€ä¸ªæœ‰è‰¯å¿ƒçš„å¹³å°ä¼šå®ä½œæ±‡å‡ºåŠŸèƒ½ï¼Œæ–¹ä¾¿ç”¨æˆ·è¿›è¡Œåˆ†ææˆ–èµ„æ–™è½¬ç§»ã€‚æˆ–æ˜¯ç”¨ Microsoft Excel æˆ– Apple Numbers è¯•ç®—è¡¨ï¼Œå¯ä»¥ç‚¹é€‰å¦å­˜æ–°æ¡£(Save As...)ä¸º CSV UTF-8 æ ¼å¼æ¥åšæ•°æ®æ±‡å‡ºã€‚</p>

<blockquote>
<p><a href="https://zh.wikipedia.org/wiki/%E9%80%97%E5%8F%B7%E5%88%86%E9%9A%94%E5%80%BC">CSV é€—å·åˆ†éš”å€¼</a> æ ¼å¼é™¤äº†å®¹æ˜“æ±‡å‡ºï¼Œä¹Ÿæ˜¯æœ€å®¹æ˜“æ±‡å…¥å¤„ç†çš„æ ¼å¼ï¼Œè¿™ä¸€ç« ä¼šç”¨ CSV ä¸¾ä¾‹ï¼Œä¸éœ€è¦é¢å¤–è£… gem å°±èƒ½å¤„ç†ã€‚</p>
</blockquote>

<p>å‡è®¾æˆ‘ä»¬æ‹¿åˆ°è¿™æ ·çš„ CSV æ¡£æ¡ˆï¼Œæ¥ä¸‹æ¥è¦å¦‚æœæ±‡å…¥æ•°æ®åº“å‘¢ï¼Ÿæ€»ä¸èƒ½ä¸€ç¬”ä¸€ç¬”è¾“å…¥å¤ªæ…¢äº†ï¼Œå½“ç„¶è¦ç”¨å†™ç¨‹åºçš„æ–¹å¼æ¥åšæ±‡å…¥ã€‚</p>

<p>å¦‚æœæ±‡å…¥æ˜¯ç¨‹åºå‘˜çš„ä¸€æ¬¡æ€§çš„ä»»åŠ¡ï¼Œæˆ‘ä»¬å¯ä»¥ä¸éœ€è¦å®ä½œ Web UIï¼Œåªéœ€è¦ä¸€ä¸ª rake ä»»åŠ¡å¯ä»¥æ‰§è¡Œå°±å¥½äº†ã€‚</p>

<p>è¯·ä¸‹è½½è¿™ä¸€ä¸ª CSV: <a href="https://raw.githubusercontent.com/growthschool/rails-recipes/master/registrations.csv">registrations.csv</a> æ”¾åœ¨é¡¹ç›® <code>tmp</code> ç›®å½•ä¸‹ï¼ˆæŒ‰å³é”®å¦å­˜æ–°æ¡£)</p>

<blockquote>
<p>è¿™æœ‰1000ç¬”æŠ¥åèµ„æ–™ï¼Œå…¶ä¸­æœ‰2ç¬”æ•…æ„ç¼ºå°‘äº† E-mailã€‚</p>
</blockquote>

<p>ç¼–è¾‘ <code>lib/tasks/dev.rake</code>ï¼Œè®©æˆ‘ä»¬æ–°å¢ä¸€ä¸ª <code>import_registration_csv_file</code> ä»»åŠ¡</p>

<figure class="figure-code code"><figcaption><span>lib/tasks/dev.rake
</span></figcaption><div class="highlight"><pre><span class="gi">+ require 'csv'
</span>  namespace :dev do

<span class="gi">+   task :import_registration_csv_file =&gt; :environment do
+     event = Event.find_by_friendly_id("fullstack-meetup")
+     tickets = event.tickets
+
+     success = 0
+     failed_records = []
+
+     CSV.foreach("#{Rails.root}/tmp/registrations.csv") do |row|
+       registration = event.registrations.new( :status =&gt; "confirmed",
+                                    :ticket =&gt; tickets.find{ |t| t.name == row[0] },
+                                    :name =&gt; row[1],
+                                    :email =&gt; row[2],
+                                    :cellphone =&gt; row[3],
+                                    :website =&gt; row[4],
+                                    :bio =&gt; row[5],
+                                    :created_at =&gt; Time.parse(row[6]) )
+
+       if registration.save
+         success += 1
+       else
+         failed_records &lt;&lt; [row, registration]
+       end
+     end
+
+     puts "æ€»å…±æ±‡å…¥ #{success} ç¬”ï¼Œå¤±è´¥ #{failed_records.size} ç¬”"
+
+     failed_records.each do |record|
+       puts "#{record[0]} ---&gt; #{record[1].errors.full_messages}"
+     end
+
+   end
</span><span class="err">
</span></pre></div>
</figure>

<p>æ‰§è¡Œ <code>rake dev:import_registration_csv_file</code> å°±ä¼šæ‰§è¡Œäº†æ±‡å…¥çš„æ“ä½œåˆ° <code>fullstack-meetup</code> è¿™ä¸ªæ´»åŠ¨ã€‚</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/FQqv602eRrGiC0mVt6qa_25-1.png" title=""></figure></p>

<p>è§£è¯´:</p>

<ol>
<li>å’Œæ±‡å‡º CSV ä¸€æ ·ï¼ŒRuby å†…å»ºäº† CSV åº“å¯ä»¥è§£æ CSVï¼Œæ‰€ä»¥ç¬¬ä¸€è¡Œå…ˆ <code>require 'csv'</code>
</li>
<li>
<code>CSV.foreach</code> ä¼šæ‰“å¼€è¿™ä¸ª CSV æ¡£æ¡ˆè·‘å¾ªç¯ï¼Œæ¯ç¬”èµ„æ–™å°±æ˜¯ä¸€è¡Œ <code>row</code>ï¼Œé‚£ä¸€è¡Œçš„ç¬¬ä¸€åˆ—æ˜¯ <code>row[0]</code>ã€ç¬¬äºŒåˆ—æ˜¯ <code>row[1]</code>ã€‚åªè¦ä¾åºå¡ç»™ <code>event.registrations.new</code> å³å¯ã€‚</li>
<li>CSV ä¸­çš„ç¥¨ç§æ˜¯å­—ç¬¦ä¸²ï¼Œä½†æ˜¯è½¬è¿›æˆ‘ä»¬çš„æ•°æ®åº“ä¸­éœ€è¦è½¬æ¢æˆ Ticket modelï¼Œå› æ­¤è¿™é‡Œå†™æˆ <code>tickets.find{ |t| t.name == row[0] }</code> ç”¨ç¥¨ç§åç§°å»æ‰¾æ˜¯å“ªä¸€ä¸ªå¯¹è±¡ã€‚</li>
<li>æ—¶é—´ä¹Ÿæ˜¯ä¸€æ ·ï¼Œé€è¿‡ <code>Time.parse</code> è½¬æˆæ—¶é—´å¯¹è±¡</li>
<li>å› ä¸ºæ±‡å…¥ä¼šä¸€æ¬¡æ±‡å…¥éå¸¸å¤šç¬”ï¼Œæˆ‘ä»¬å¸Œæœ›ä¸ç®¡æ¯ç¬”èµ„æ–™ save æˆåŠŸæˆ–å¤±è´¥ï¼Œéƒ½èƒ½è·‘å®Œå…¨éƒ¨èµ„æ–™ï¼Œæœ€åå°å‡ºä¸€ä¸ªæ€»ç»“ï¼šå‘Šè¯‰æˆ‘ä»¬æ€»å…±å‡ ç¬”æˆåŠŸï¼Œæ€»å…±å‡ ç¬”å¤±è´¥ï¼Œæ˜¯å“ªäº›ç¬”å¤±è´¥åˆæ˜¯ä»€ä¹ˆåŸå› ã€‚</li>
</ol>

    </div>
  </div></div><div class='frame'><h1>
      25-2 è§£æ CSV æ¡£æ¡ˆ (Web UI æ¥å£)
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š25. æ•°æ®æ±‡å…¥</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>éœ€è¦ Web UI å¯ä»¥ä¸Šä¼ æ¡£æ¡ˆçš„è¯ï¼Œè®©æˆ‘ä»¬æ¥å®ä½œä¸€ä¸‹ï¼š</p>

<p>è¯·ç¼–è¾‘ <code>config/routes.rb</code>ï¼Œæ–°å¢ä¸€ä¸ª import è·¯ç”±</p>

<figure class="figure-code code"><figcaption><span>config/routes.rb
</span></figcaption><div class="highlight"><pre>   namespace :admin do
     # ç•¥
     resources :events do
<span class="gd">-      resources :registrations, :controller =&gt; "event_registrations"
</span><span class="gi">+      resources :registrations, :controller =&gt; "event_registrations" do
+        collection do
+          post :import
+        end
+      end
</span><span class="err">
</span></pre></div>
</figure>

<p>ç¼–è¾‘ <code>app/views/admin/event_registrations/index.html.erb</code> åŠ ä¸Šæ¡£æ¡ˆä¸Šä¼ çš„è¾“å…¥æ¡†ï¼š</p>

<figure class="figure-code code"><figcaption><span>app/views/admin/event_registrations/index.html.erb
</span></figcaption><div class="highlight"><pre>   &lt;%= link_to "æ±‡å‡º CSV", admin_event_registrations_path(:format =&gt; :csv), :class =&gt; "btn btn-default" %&gt;
   &lt;%= link_to "æ±‡å‡º Excel", admin_event_registrations_path(:format =&gt; :xlsx), :class =&gt; "btn btn-default" %&gt;
 &lt;/p&gt;
<span class="gi">+
+ &lt;hr&gt;
+
+ &lt;%= form_tag import_admin_event_registrations_path(@event), :multipart =&gt; true do %&gt;
+   &lt;p&gt;&lt;%= file_field_tag "csv_file" %&gt;&lt;/p&gt;
+   &lt;p&gt;&lt;%= submit_tag "æ±‡å…¥CSV", :class =&gt; "btn btn-danger" %&gt;&lt;/p&gt;
+ &lt;% end %&gt;
</span><span class="err">
</span></pre></div>
</figure>

<p>ç¼–è¾‘ <code>app/controllers/admin/event_registrations_controller.rb</code> æ–°å¢ä¸€ä¸ª import actionï¼Œå†…å®¹åŸºæœ¬ä¸Šè·Ÿ rake çš„ç‰ˆæœ¬å·®ä¸å¤š</p>

<figure class="figure-code code"><figcaption><span>app/controllers/admin/event_registrations_controller.rb
</span></figcaption><div class="highlight"><pre><span class="gi">+  def import
+    csv_string = params[:csv_file].read.force_encoding('utf-8')
+
+    tickets = @event.tickets
+
+    success = 0
+    failed_records = []
+
+    CSV.parse(csv_string) do |row|
+      registration = @event.registrations.new( :status =&gt; "confirmed",
+                                   :ticket =&gt; tickets.find{ |t| t.name == row[0] },
+                                   :name =&gt; row[1],
+                                   :email =&gt; row[2],
+                                   :cellphone =&gt; row[3],
+                                   :website =&gt; row[4],
+                                   :bio =&gt; row[5],
+                                   :created_at =&gt; Time.parse(row[6]) )
+
+      if registration.save
+        success += 1
+      else
+        failed_records &lt;&lt; [row, registration]
+        Rails.logger.info("#{row} ----&gt; #{registration.errors.full_messages}")
+      end
+    end
+
+    flash[:notice] = "æ€»å…±æ±‡å…¥ #{success} ç¬”ï¼Œå¤±è´¥ #{failed_records.size} ç¬”"
+    redirect_to admin_event_registrations_path(@event)
+  end
+
</span>   protected
<span class="err">
</span></pre></div>
</figure>

<p>å…¶ä¸­ <code>csv_string</code> å°±æ˜¯ä»ä¸Šä¼ çš„æ¡£æ¡ˆä¸­è¯»å–å†…å®¹ï¼Œæ¥ç€ç”¨ <code>CSV.parse</code> è¿›è¡Œè§£æå¾ªç¯ã€‚</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/YE9m2o1cSwu0nsTPa5Bb_25-2.png" title=""></figure></p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/NrcLkD5gSPW82NN7xD1t_25-3.png" title=""></figure></p>

<p>æ³¨æ„æœ¬æ¥çš„ admin layout ä¸­çš„ flash æ ·å¼æœ‰ç‚¹é—®é¢˜ï¼Œè¯·ä¿®æ”¹ <code>app/views/layouts/admin.html.erb</code> ä¿®æ­£ä¸€ä¸‹ï¼š</p>

<figure class="figure-code code"><figcaption><span>app/views/layouts/admin.html.erb
</span></figcaption><div class="highlight"><pre><span class="gd">-    &lt;div class="container"&gt;
</span><span class="gi">+    &lt;div class="container" style="padding-top: 60px"&gt;
</span>
<span class="gd">-      &lt;p class="notice"&gt;&lt;%= notice %&gt;&lt;/p&gt;
-      &lt;p class="alert"&gt;&lt;%= alert %&gt;&lt;/p&gt;
</span>
<span class="gi">+      &lt;% if notice %&gt;
+        &lt;p class="notice alert-success"&gt;&lt;%= notice %&gt;&lt;/p&gt;
+      &lt;% end %&gt;
</span>
<span class="gi">+      &lt;% if alert %&gt;
+        &lt;p class="alert alert-danger"&gt;&lt;%= alert %&gt;&lt;/p&gt;
</span><span class="err">+      &lt;% end %&gt;
</span></pre></div>
</figure>

    </div>
  </div></div><div class='frame'><h1>
      25-3 æŠŠæ±‡å…¥æ¡£æ¡ˆå­˜ä¸‹æ¥çºªå½•è¿‡ç¨‹
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š25. æ•°æ®æ±‡å…¥</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>ä¸Šä¸€èŠ‚çš„æ–¹å¼æ¯”è¾ƒç®€ç•¥ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰æŠŠä¸Šä¼ çš„æ¡£æ¡ˆå­˜ä¸‹æ¥ï¼Œè€Œæ˜¯ç›´æ¥è¯»å–æ¡£æ¡ˆå†…å®¹è¿›è¡Œå¤„ç†ã€‚</p>

<p>å¦‚æœè¿™æ˜¯ä¸€ä¸ªé¢å‘ç»ˆç«¯ç”¨æˆ·çš„åŠŸèƒ½ï¼Œä¼šéœ€è¦å®ä½œçš„æ›´å®Œæ•´ï¼Œä¾‹å¦‚ï¼š</p>

<ol>
<li>æŠŠä¸Šä¼ çš„æ¡£æ¡ˆå…ˆå­˜ä¸‹æ¥ï¼Œå…ˆç»™ç”¨æˆ·é¢„è§ˆå­—æ®µé¡ºåºæ˜¯å¦æ­£ç¡®ã€æœ‰å¤šå°‘æ•°æ®è¦æ±‡å…¥ã€å“ªäº›æ•°æ®æœ‰é—®é¢˜</li>
<li>ç¡®è®¤åï¼Œæ‰å¼€å§‹æ±‡å…¥æ•°æ®åº“</li>
<li>å¯ä»¥æµè§ˆè¿‡å¾€çš„æ±‡å…¥å†å²çºªå½•</li>
</ol>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬ç¤ºèŒƒå¦‚ä½•æ–°å¢ä¸€ä¸ª Model æŠŠæ¡£æ¡ˆå­˜ä¸‹æ¥å¤„ç†ï¼Œä»¥åŠæ–°å¢ä¸€ä¸ª RegistrationImports controller æ˜¾ç¤ºæ±‡å…¥çš„å†å²çºªå½•ã€‚</p>

<p>æ‰§è¡Œ <code>rails g model registration_import</code>ï¼Œè¿™ä¸ª Model ä¼šå­˜ä¸‹ä¸Šä¼ çš„ CSV æ¡£æ¡ˆï¼Œå¹¶è®°å½•æ±‡å…¥çš„ç»“æœã€‚</p>

<p>ç¼–è¾‘ <code>db/migrate/2017XXXXXX4512_create_registration_imports.rb</code></p>

<figure class="figure-code code"><figcaption><span>db/migrate/2017XXXXXX4512_create_registration_imports.rb
</span></figcaption><div class="highlight"><pre>  class CreateRegistrationImports &lt; ActiveRecord::Migration[5.0]
    def change
      create_table :registration_imports do |t|
<span class="gi">+       t.string :status
+       t.string :csv_file
+       t.integer :event_id, :index =&gt; true
+       t.integer :user_id
+       t.integer :total_count
+       t.integer :success_count
+       t.text :error_messages
</span>        t.timestamps
      end
    end
  end
<span class="err">
</span></pre></div>
</figure>

<p>æ‰§è¡Œ <code>rake db:migrate</code></p>

<p>æ‰§è¡Œ <code>rails g uploader registration_import_csv</code></p>

<p>ç¼–è¾‘ <code>app/models/registration_import.rb</code>ï¼Œå…¶ä¸­çš„ <code>process!</code> æ–¹æ³•å°±æ˜¯è¦æ‰§è¡Œçš„æ±‡å…¥æ“ä½œã€‚</p>

<figure class="figure-code code"><figcaption><span>app/models/registration_import.rb
</span></figcaption><div class="highlight"><pre><span class="gi">+ require 'csv'
</span>  class RegistrationImport &lt; ApplicationRecord

<span class="gi">+   mount_uploader :csv_file, RegistrationImportCsvUploader
+
+   validates_presence_of :csv_file
+
+   belongs_to :event
+   belongs_to :user
+
+   serialize :error_messages, JSON
+
+   def process!
+     csv_string = self.csv_file.read.force_encoding('utf-8')
+     tickets = self.event.tickets
+
+     success = 0
+     failed_records = []
+
+     CSV.parse(csv_string) do |row|
+       registration = self.event.registrations.new( :status =&gt; "confirmed",
+                                    :ticket =&gt; tickets.find{ |t| t.name == row[0] },
+                                    :name =&gt; row[1],
+                                    :email =&gt; row[2],
+                                    :cellphone =&gt; row[3],
+                                    :website =&gt; row[4],
+                                    :bio =&gt; row[5],
+                                    :created_at =&gt; Time.parse(row[6]) )
+
+       if registration.save
+         success += 1
+       else
+         failed_records &lt;&lt; [row, registration.errors.full_messages]
+       end
+     end
+
+     self.status = "imported"
+     self.success_count = success
+     self.total_count = success + failed_records.size
+     self.error_messages = failed_records
+
+     self.save!
+   end
</span>
<span class="err">  end
</span></pre></div>
</figure>

<p>ç¼–è¾‘ <code>app/models/event.rb</code></p>

<figure class="figure-code code"><figcaption><span>app/models/event.rb
</span></figcaption><div class="highlight"><pre>   has_many :registrations, :dependent =&gt; :destroy
<span class="gi">+  has_many :registration_imports, :dependent =&gt; :destroy
</span><span class="err">
</span></pre></div>
</figure>

<p>ç¼–è¾‘ <code>config/routes.rb</code></p>

<figure class="figure-code code"><figcaption><span>config/routes.rb
</span></figcaption><div class="highlight"><pre>  namespace :admin do
     # (ç•¥)
     resources :events do
<span class="gi">+      resources :registration_imports
</span><span class="err">
</span></pre></div>
</figure>

<p>ç¼–è¾‘ <code>app/views/admin/event_registrations/index.html.erb</code> åŠ ä¸Šä¸€ä¸ªæŒ‰é’®</p>

<figure class="figure-code code"><figcaption><span>app/views/admin/event_registrations/index.html.erb
</span></figcaption><div class="highlight"><pre>  &lt;p class="text-right"&gt;
    &lt;%= link_to "New Registration", new_admin_event_registration_path(@event), :class =&gt; "btn btn-primary" %&gt;
<span class="gi">+   &lt;%= link_to "Import Registration", admin_event_registration_imports_path(@event), :class =&gt; "btn btn-primary" %&gt;
</span>   &lt;/p&gt;

<span class="err">
</span></pre></div>
</figure>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Y1o2zIdOTzyKQwJbTcLf_25-4.png" title=""></figure></p>

<p>æ‰§è¡Œ <code>rails g controller admin::registration_imports</code></p>

<p>ç¼–è¾‘ <code>app/controllers/admin/registration_imports_controller.rb</code></p>

<figure class="figure-code code"><figcaption><span>app/controllers/admin/registration_imports_controller.rb
</span></figcaption><div class="highlight"><pre><span class="gd">- class Admin::RegistrationImportsController &lt; ApplicationController
</span><span class="gi">+ class Admin::RegistrationImportsController &lt; AdminController
</span>
<span class="gi">+   before_action :require_editor!
+   before_action :find_event
+
+   def index
+     @imports = @event.registration_imports.order("id DESC")
+   end
+
+   def create
+     @import = @event.registration_imports.new(registration_import_params)
+     @import.status = "pending"
+     @import.user = current_user
+
+     if @import.save
+       @import.process!
+       flash[:notice] = "æ±‡å…¥å®Œæˆ"
+     end
+
+     redirect_to admin_event_registration_imports_path(@event)
+   end
+
+   protected
+
+   def find_event
+     @event = Event.find_by_friendly_id!(params[:event_id])
+   end
+
+   def registration_import_params
+     params.require(:registration_import).permit(:csv_file)
+   end
</span>
  end
<span class="err">
</span></pre></div>
</figure>

<p>å…¶ä¸­åœ¨ <code>@import.save</code> ä¹‹åï¼Œéšå³å‘¼å« <code>process!</code> å¼€å§‹æ±‡å…¥ã€‚</p>

<p>æ–°å¢ <code>app/views/admin/registration_imports/index.html.erb</code> æ˜¾ç¤ºæ¡£æ¡ˆä¸Šä¼ çš„è¾“å…¥æ¡†ï¼Œä»¥åŠå†å²æ±‡å…¥çºªå½•ã€‚</p>

<figure class="figure-code code"><figcaption><span>app/views/admin/registration_imports/index.html.erb
</span></figcaption><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span><span class="cp">&lt;%=</span> <span class="vi">@event</span><span class="p">.</span><span class="nf">name</span> <span class="cp">%&gt;</span> / Registrations Import<span class="nt">&lt;/h1&gt;</span>


<span class="cp">&lt;%=</span> <span class="n">form_for</span> <span class="p">[</span><span class="ss">:admin</span><span class="p">,</span> <span class="vi">@event</span><span class="p">,</span> <span class="no">RegistrationImport</span><span class="p">.</span><span class="nf">new</span><span class="p">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>

  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:csv_file</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">file_field</span> <span class="ss">:csv_file</span><span class="p">,</span> <span class="ss">:required</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:class</span> <span class="o">=&gt;</span> <span class="s2">"form-control"</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">submit</span> <span class="s2">"é€å‡º"</span><span class="p">,</span> <span class="ss">:class</span> <span class="o">=&gt;</span> <span class="s2">"btn btn-primary"</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

<span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">"table"</span><span class="nt">&gt;</span>
<span class="nt">&lt;tr&gt;</span>
  <span class="nt">&lt;th&gt;</span>ID<span class="nt">&lt;/th&gt;</span>
  <span class="nt">&lt;th&gt;</span>çŠ¶æ€<span class="nt">&lt;/th&gt;</span>
  <span class="nt">&lt;th&gt;</span>CSVæ¡£æ¡ˆ<span class="nt">&lt;/th&gt;</span>
  <span class="nt">&lt;th&gt;</span>æ€»ç¬”æ•°<span class="nt">&lt;/th&gt;</span>
  <span class="nt">&lt;th&gt;</span>æ±‡å…¥æˆåŠŸç¬”æ•°<span class="nt">&lt;/th&gt;</span>
  <span class="nt">&lt;th&gt;</span>é”™è¯¯è®¯æ¯<span class="nt">&lt;/th&gt;</span>
<span class="nt">&lt;/tr&gt;</span>
<span class="cp">&lt;%</span> <span class="vi">@imports</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">import</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">import</span><span class="p">.</span><span class="nf">id</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">import</span><span class="p">.</span><span class="nf">status</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">import</span><span class="p">.</span><span class="nf">csv_file</span><span class="p">.</span><span class="nf">url</span><span class="p">,</span> <span class="n">import</span><span class="p">.</span><span class="nf">csv_file</span><span class="p">.</span><span class="nf">url</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">import</span><span class="p">.</span><span class="nf">total_count</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">import</span><span class="p">.</span><span class="nf">success_count</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span>
      <span class="nt">&lt;ul&gt;</span>
      <span class="cp">&lt;%</span> <span class="no">Array</span><span class="p">(</span><span class="n">import</span><span class="p">.</span><span class="nf">error_messages</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="cp">%&gt;</span>
       <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="cp">%&gt;</span> ----&gt; <span class="nt">&lt;strong&gt;</span><span class="cp">&lt;%=</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="cp">%&gt;</span><span class="nt">&lt;/strong&gt;&lt;/li&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/ul&gt;</span>
    <span class="nt">&lt;/td&gt;</span>
  <span class="nt">&lt;/tr&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/table&gt;</span>

</pre></div>
</figure>

<p>è¿™æ ·å°±å®Œå·¥å•¦ã€‚</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/wy7rA3aRrSGT7BtGhFlF_25-5.png" title=""></figure></p>

    </div>
  </div></div><div class='frame'><h1>
      26-1 å‰è¨€å’Œå®‰è£… sidekiq
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š26. å¼‚æ­¥å¤„ç†ä»»åŠ¡</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>æ‰€è°“çš„å¼‚æ­¥å¤„ç†ä»»åŠ¡ï¼Œå°±æ˜¯åœ¨ç”¨æˆ·é€å‡ºæ“ä½œåï¼ŒRails ä¸ä¼šç«‹å³æ‰§è¡Œè¿™ä¸ªä»»åŠ¡ï¼Œè€Œæ˜¯äº¤ç”±å¦ä¸€ä¸ªè¿›ç¨‹(process)åœ¨èƒŒæ™¯è¿›è¡Œå¤„ç†æ‰§è¡Œã€‚</p>

<p>ä½¿ç”¨çš„åœºæ™¯æ˜¯ï¼šå½“ä»»åŠ¡è¦æ‰§è¡Œå¾ˆä¹…çš„æ—¶å€™ï¼Œä¾‹å¦‚æ±‡å‡ºå¤§ç¬”æ•°æ®ã€æ±‡å…¥å¤§ç¬”æ•°æ®ç­‰ï¼Œå½“æ•°æ®é‡ä¸Šä¸‡ç¬”çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šéœ€è¦å¥½å‡ åˆ†é’Ÿæ‰èƒ½æ‰§è¡Œå®Œæˆã€‚è¿™æ—¶å€™å¦‚æœä¸åšå¼‚æ­¥å¤„ç†ï¼Œç”¨æˆ·çš„æµè§ˆå™¨å°±ä¼šåƒå¡ä½ä¸€æ ·ï¼Œéœ€è¦ç­‰æœåŠ¡å™¨å®Œæˆä»»åŠ¡æ‰æœ‰å›åº”ã€‚</p>

<p>ç­‰å¾…æ—¶é—´å¤ªä¹…é™¤äº†è®©ç”¨æˆ·æ„Ÿå—ä¸ä½³ä¹‹å¤–ï¼Œå¯¹äºæœåŠ¡å™¨æ•ˆèƒ½ä¸Šçš„å½±å“ä¹Ÿå¾ˆå·¨å¤§ã€‚ç”¨æˆ·å¯èƒ½ç­‰ä¸åŠåˆé‡æ–°æ•´ç†ä¸€æ¬¡ï¼Œäºæ˜¯ç›¸åŒçš„ä»»åŠ¡åˆåœ¨é‡å¤´æ‰§è¡Œä¸€éã€‚è€Œä¸€ä¸ª HTTP Request å¦‚æœé•¿æ—¶é—´æ‰§è¡Œï¼Œä¹Ÿä¼šè®© Rails æœåŠ¡å™¨æ— æ³•æœåŠ¡å…¶ä»–ç”¨æˆ·ã€‚</p>

<p>å› æ­¤ï¼Œè¿™ç±»å‹çš„ä»»åŠ¡æˆ‘ä»¬ä¼šæ”¹æˆå¼‚æ­¥å¤„ç†ï¼Œç¬¬ä¸€æ—¶é—´ç”¨æˆ·ä¼šå…ˆçœ‹åˆ°ã€Œæ“ä½œæ­£åœ¨æ‰§è¡Œä¸­ï¼Œè¯·ç¨å€™å†å›æ¥ã€æˆ–æ˜¯ã€Œå®Œæˆåä¼š E-mail é€šçŸ¥æ‚¨ã€çš„è®¯æ¯ã€‚</p>

<p>å¸¸ç”¨çš„å¼‚æ­¥å¤„ç†æœ‰ä¸¤å¥— gem:</p>

<ul>
<li>
<a href="https://github.com/collectiveidea/delayed_job">delayed_job</a>: ä½¿ç”¨å…³è”å¼æ•°æ®åº“ï¼Œå®¹æ˜“å®‰è£…ä½¿ç”¨</li>
<li>
<a href="http://sidekiq.org">Sidekiq</a>: ä½¿ç”¨é«˜æ•ˆèƒ½çš„ <a href="https://redis.io">Redis</a> æ•°æ®åº“ï¼Œæ‰§è¡Œæ•ˆç‡æå¥½ï¼Œä¸šç•Œè¾ƒå¸¸ç”¨</li>
</ul>

<p>è¿™ä¸¤å¥— gem çš„ä½œç”¨éƒ½æ˜¯è®© Rails å¯ä»¥å­˜ä¸‹è¦æ‰§è¡Œçš„å¼‚æ­¥å¤„ç†ä»»åŠ¡ï¼Œç„¶åå¯åŠ¨è¿›ç¨‹(process)åœ¨èƒŒæ™¯è¿›è¡Œå¤„ç†æ‰§è¡Œã€‚</p>

<p>è¿™ä¸€ç« å°†ç”¨ Sidekiq ä¸¾ä¾‹ï¼Œæœ¬æœº Mac éœ€è¦å®‰è£… Redis æ•°æ®åº“ï¼š</p>

<p>æ‰§è¡Œ <code>brew install redis</code></p>

<p>å¦å¼€ä¸€ä¸ª Termonal è§†çª—ï¼Œæ‰§è¡Œ <code>redis-server /usr/local/etc/redis.conf</code> å°±ä¼šè·‘èµ·æ¥ Redis æœåŠ¡å™¨</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/dGmddzyTTdqGfcvYuom0_26-2.png" title=""></figure></p>

<p>ç¼–è¾‘ <code>Gemfile</code></p>

<figure class="figure-code code"><figcaption><span>Gemfile
</span></figcaption><div class="highlight"><pre>
<span class="gi">+  gem 'sidekiq'
</span><span class="err">
</span></pre></div>
</figure>

<p>æ‰§è¡Œ <code>bundle</code></p>

<p>ç¼–è¾‘ <code>config/environments/development.rb</code> å’Œ <code>config/environments/production.rb</code> å‘Šè¯‰ Rails è¦ç”¨ sidekiq æ¥åšå¼‚æ­¥å¤„ç†</p>

<figure class="figure-code code"><figcaption><span>config/environments/development.rb
</span></figcaption><div class="highlight"><pre><span class="gi">+ config.active_job.queue_adapter = :sidekiq
</span><span class="err">
</span></pre></div>
</figure>

<p>æ–°å¢ <code>config/sidekiq.yml</code></p>

<figure class="figure-code code"><div class="highlight"><pre>---
:queues:
  - default
  - mailers

</pre></div>
</figure>

<p>é‡å¯æœåŠ¡å™¨</p>

    </div>
  </div></div><div class='frame'><h1>
      26-2 å¼‚æ­¥æ±‡å…¥
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š26. å¼‚æ­¥å¤„ç†ä»»åŠ¡</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>å°±æ‹¿ä¸Šä¸€ç« çš„æ•°æ®æ±‡å…¥æ¥æ”¹å§ï¼Œæœ¬æ¥çš„æ±‡å…¥æœ‰1000ç¬”å…¶å®å°±è¦è·‘ä¸€é˜µå­äº†ï¼Œè¿™æ˜¯ä¸ªæ ‡å‡†æƒ…å†µéœ€è¦æ”¹æˆå¼‚æ­¥å¤„ç†ã€‚</p>

<p>æ‰§è¡Œ <code>rails g job import_worker</code> è¿™ä¼šäº§ç”Ÿä¸€ç§å¼‚æ­¥å¤„ç†ä»»åŠ¡ï¼Œå«åš <code>ImportWorkerJob</code></p>

<figure class="figure-code code"><figcaption><span>app/jobs/import_worker_job.rb
</span></figcaption><div class="highlight"><pre>  class ImportWorkerJob &lt; ApplicationJob
    queue_as :default

<span class="gd">-   def perform(*args)
-     # Do something later
-   end
</span>
<span class="gi">+   def perform(import_id)
+     import = RegistrationImport.find(import_id)
+     import.process!
+   end
</span>
  end
<span class="err">
</span></pre></div>
</figure>

<p>è¿™ä¸ªå¼‚æ­¥å¤„ç†è¦æ€ä¹ˆè°ƒç”¨å‘¢ï¼Ÿæ¥ç€ä¿®æ”¹ <code>app/controllers/admin/registration_imports_controller.rb</code>ï¼Œæ”¹æˆå¼‚æ­¥å¤„ç†ï¼š</p>

<figure class="figure-code code"><figcaption><span>app/controllers/admin/registration_imports_controller.rb
</span></figcaption><div class="highlight"><pre>  def create
    @import = @event.registration_imports.new(registration_import_params)
    @import.status = "pending"
    @import.user = current_user

    if @import.save
<span class="gd">-     @import.process!
</span><span class="gi">+     ImportWorkerJob.perform_later(@import.id)
</span>
<span class="gd">-     flash[:notice] = "æ±‡å…¥å®Œæˆ"
</span><span class="gi">+     flash[:notice] = "æ±‡å…¥å·²åœ¨èƒŒæ™¯æ‰§è¡Œï¼Œè¯·ç¨å€™å†æ¥çœ‹ç»“æœ"
</span>    end

    redirect_to admin_event_registration_imports_path(@event)
  end
<span class="err">
</span></pre></div>
</figure>

<p>æœ¬æ¥æ˜¯ç›´æ¥è°ƒç”¨ <code>@import.process!</code>ï¼Œç°åœ¨æ”¹æˆè°ƒç”¨ <code>ImportWorkerJob.perform_later(@import.id)</code> å°±ä¼šå˜æˆå¼‚æ­¥ã€‚</p>

<p>ä½ å¯ä»¥å›åˆ° 25-3 å®ä½œçš„æ•°æ®æ±‡å…¥ï¼Œä¸Šä¼ ä¸€ä¸ªæ¡£æ¡ˆçœ‹çœ‹ï¼Œä½ ä¼šå‘ç°æœåŠ¡å™¨ç«‹å³å°±å›ä¼ äº†ã€Œæ±‡å…¥å·²åœ¨èƒŒæ™¯æ‰§è¡Œï¼Œè¯·ç¨å€™å†æ¥çœ‹ç»“æœã€è®¯æ¯ã€‚ä¹‹æ‰€ä»¥è¿™ä¹ˆå¿«ï¼Œæ˜¯å› ä¸ºå®ƒæ²¡æœ‰æ‰§è¡Œæ±‡å…¥ï¼Œå®ƒåªæ˜¯è·Ÿ Sidekiq è¯´æœ‰ä¸€ä¸ªä»»åŠ¡è¦æ‰§è¡Œè€Œå·²ã€‚</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/zsarmhrZSnu7WEV9A3E0_26-1.png" title=""></figure></p>

<p>é‚£åˆ°åº•è°å»æ‰§è¡Œè¿™ä¸ªå¼‚æ­¥ä»»åŠ¡å‘¢? æˆ‘ä»¬éœ€è¦å¦å¤–å¯åŠ¨ Sidekiq è¿›ç¨‹ï¼Œè¯·å†å¼€ä¸€ä¸ªæ–°ä¸ª Terminal è§†çª—ï¼Œæ‰§è¡Œ</p>

<p><code>bundle exec sidekiq</code></p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/jZluYz6RS7ClcZCrD7UA_26-4.png" title=""></figure></p>

<p>åªè¦æœ‰å¼‚æ­¥ä»»åŠ¡è¿›æ¥ï¼Œè¿™ä¸ª Sidekiq ä¼šå»å»æ‰§è¡Œå®ƒã€‚</p>

<blockquote>
<p>å¦‚æœè¿› rails console æƒ³è¦å•çº¯æµ‹è¯•è¿™ä¸ªä»»åŠ¡ï¼Œå¯ä»¥ä¸éœ€è¦å¼‚æ­¥ï¼Œæ”¹ç”¨ <code>.perform_now</code> æ–¹æ³•å°±ä¼šé©¬ä¸Šæ‰§è¡Œ</p>
</blockquote>

    </div>
  </div></div><div class='frame'><h1>
      26-3 Sidekiq ç®¡ç† UI
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š26. å¼‚æ­¥å¤„ç†ä»»åŠ¡</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>Sidekiq æœ‰æä¾›ä¸€ä¸ªæ¼‚äº®çš„ç®¡ç† UIï¼Œå¯ä»¥æ¬£èµæœ‰å¤šå°‘å¾…æ‰§è¡Œçš„å¼‚æ­¥ä»»åŠ¡ã€æœ‰å¤šå°‘æ‰§è¡ŒæˆåŠŸå’Œå¤±è´¥(å¤±è´¥sidekiqä¼šé‡è¯•)ï¼Œä¹Ÿå¯ä»¥åˆ é™¤ä»»åŠ¡ã€‚</p>

<p><figure><img src="https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/fu5NgA99TySIWr2WHeYR_26-5.png" title=""></figure></p>

<p>ä¿®æ”¹ <code>config/routes.rb</code></p>

<figure class="figure-code code"><figcaption><span>config/routes.rb
</span></figcaption><div class="highlight"><pre>  Rails.application.routes.draw do

<span class="gi">+   require 'sidekiq/web'
+   authenticate :user, lambda { |u| u.is_admin? } do
+     mount Sidekiq::Web =&gt; '/sidekiq'
+   end
</span><span class="err">
</span></pre></div>
</figure>

<blockquote>
<p>å…¶ä¸­ authenticate æ–¹æ³•ä¼šæ£€æŸ¥æƒé™ï¼Œåˆ©ç”¨æˆ‘ä»¬ä¹‹å‰å†™çš„ User#is_admin? æ–¹æ³•</p>
</blockquote>

<p>æµè§ˆå™¨æµè§ˆ <code>http://localhost:3000/sidekiq</code></p>

    </div>
  </div></div><div class='frame'><h1>
      26-4 å¼‚æ­¥æ±‡å‡º
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š26. å¼‚æ­¥å¤„ç†ä»»åŠ¡</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>æ•°æ®æ±‡å‡ºä¹Ÿæ˜¯ä¸€ä¸ªå¸¸ç”¨å¼‚æ­¥æ¥å¤„ç†çš„ä»»åŠ¡ï¼Œæµç¨‹å’Œæ±‡å…¥å…¶å®87åˆ†åƒï¼š</p>

<ul>
<li>å»ºç«‹ RegistraionExport modelï¼Œè¿™ä¸ª model ä¼šçºªå½•æ˜¯é‚£ä¸ª user åšæ±‡å‡ºã€æ˜¯å“ªä¸ª event è¦æ±‡å‡ºï¼Œä»¥åŠå­˜å‚¨æœ€åæ±‡å‡ºçš„æ¡£æ¡ˆ</li>
<li>å»ºç«‹ä¸€ä¸ª RegistrationExports controllerï¼Œè¿™ä¸ª controller è®©ç”¨æˆ·å¯ä»¥æ–°å¢æ±‡å‡ºçºªå½•ï¼Œä»¥åŠæµè§ˆæ±‡å‡ºçºªå½•</li>
<li>å»ºç«‹ ExportWorkerJobï¼Œè¿™ä¸ªå¼‚æ­¥ä»»åŠ¡ä¼šæ‰§è¡Œæ±‡å‡ºæ“ä½œï¼Œå¹¶å°†æ±‡å‡ºçš„æ¡£æ¡ˆæ”¾åˆ° RegistraionExport model ä¸Š</li>
<li>å¼‚æ­¥ä»»åŠ¡æœ€åå®Œæˆæ—¶ï¼Œå¯ä»¥å¯„ E-mail é€šçŸ¥ç”¨æˆ·æ±‡å‡ºçš„æ¡£æ¡ˆå·²ç»å‡†å¤‡å¥½äº†</li>
</ul>

<p>è¿™é‡Œå°±ä¸ç¤ºèŒƒå®åšäº†ã€‚</p>

<p>æœ€åï¼Œæ±‡å‡ºå’Œæ±‡å…¥çš„åŠŸèƒ½è¦å®Œæ•´å®åšçš„è¯ï¼Œè¿˜éœ€è¦è€ƒè™‘æ¡£æ¡ˆå­˜å‚¨çš„ä½ç½®ã€‚æˆ‘ä»¬ç”¨ carrierwave ä¸Šä¼ çš„æ¡£æ¡ˆï¼Œé»˜è®¤æ˜¯å…¬å¼€çš„ã€‚ä½†æ˜¯æ±‡å‡ºå’Œæ±‡å…¥çš„æ¡£æ¡ˆï¼Œåº”è¯¥ä¹Ÿå¿…é¡»è¦æ£€æŸ¥æœ‰æ²¡æœ‰æƒé™æ‰è¡Œã€‚è¿™éƒ¨åˆ†çš„å®ä½œç‰µæ‰¯åˆ°æˆ‘ä»¬ä½¿ç”¨å“ªç§æ¡£æ¡ˆæœåŠ¡å™¨ï¼š</p>

<ul>
<li>å­˜å‚¨åœ¨æœ¬æœºçš„è¯ï¼Œè¯·å‚è€ƒ <a href="https://github.com/carrierwaveuploader/carrierwave/wiki/how-to:-secure-upload">How To: Secure Upload</a>
</li>
<li>å­˜å‚¨åœ¨ä¸ƒç‰›äº‘ï¼Œè¯·å‚è€ƒ <a href="https://developer.qiniu.com/kodo/manual/1202/download-token">ä¸‹è½½å‡­è¯</a>
</li>
<li>å­˜å‚¨åœ¨ AWS S3ï¼Œè¯·å‚è€ƒ <a href="http://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/PrivateContent.html">Serving Private Content</a>
</li>
</ul>

<p>åœ¨ä¹‹åçš„è¿›é˜¶éƒ¨ç½²è¯¾ç¨‹ä¸­ï¼Œä¼šå†è¿›ä¸€æ­¥ç¤ºèŒƒå¦‚ä½•ä½¿ç”¨ã€‚</p>

    </div>
  </div></div><div class='frame'><h1>
      26-5 æŠ¥å15åˆ†é’Ÿå†…æ²¡å®Œæˆè‡ªåŠ¨å–æ¶ˆ
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š26. å¼‚æ­¥å¤„ç†ä»»åŠ¡</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>å¼‚æ­¥å¤„ç†å¯ä»¥è®¾å®šå»¶è¿Ÿæ—¶é—´ï¼Œä¾‹å¦‚æˆ‘ä»¬æ¥å®ä½œä¸€ä¸ªå°åŠŸèƒ½ï¼šå¦‚æœæŠ¥å15åˆ†é’Ÿå†…æ²¡æœ‰å®Œæˆï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å–æ¶ˆ</p>

<p>æ‰§è¡Œ <code>rails g job check_registration</code></p>

<p>ç¼–è¾‘ <code>app/jobs/check_registration_job.rb</code></p>

<figure class="figure-code code"><figcaption><span>app/jobs/check_registration_job.rb
</span></figcaption><div class="highlight"><pre>  class CheckRegistrationJob &lt; ApplicationJob
    queue_as :default

<span class="gd">-   def perform(*args)
</span><span class="gi">+   def perform(registration_id)
+     registration = Registration.find(registration_id)
+
+     unless registration.status == "confirmed"
+       registration.status = "cancalled"
+       registration.save!
+     end
+
</span>    end
<span class="err">  end
</span></pre></div>
</figure>

<p>ç¼–è¾‘ <code>app/models/registration.rb</code></p>

<figure class="figure-code code"><figcaption><span>app/models/registration.rb
</span></figcaption><div class="highlight"><pre>
<span class="gd">-  STATUS = ["pending", "confirmed"]
</span><span class="gi">+  STATUS = ["pending", "confirmed", "cancalled"]
</span><span class="err">
</span></pre></div>
</figure>

<p>ç¼–è¾‘ <code>config/locales/zh-CN.yml</code></p>

<figure class="figure-code code"><figcaption><span>config/locales/zh-CN.yml
</span></figcaption><div class="highlight"><pre>   registration:
     status:
       pending: æŠ¥åå°šæœªå®Œæˆ
       confirmed: æŠ¥åæˆåŠŸ
<span class="gi">+      cancalled: æŠ¥åå·²å–æ¶ˆ
</span><span class="err">
</span></pre></div>
</figure>

<p>ç¼–è¾‘ <code>app/controllers/registrations_controller.rb</code>ï¼Œåœ¨æ–°å»ºæŠ¥åä¹‹åï¼Œå¢åŠ è¿™ä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œå¹¶ç”¨ <code>set</code> æ–¹æ³•æŒ‡å®šå»¶è¿Ÿæ—¶é—´ã€‚å¦å¤–ï¼Œé‡æ„äº† <code>before_action :set_pending_registration</code> æ£€æŸ¥å¦‚æœæ˜¯ cancalled çŠ¶æ€å°±ä¸èƒ½ç»§ç»­å¡«å†™æŠ¥åèµ„æ–™ã€‚</p>

<figure class="figure-code code"><figcaption><span>app/controllers/registrations_controller.rb
</span></figcaption><div class="highlight"><pre>  class RegistrationsController &lt; ApplicationController

    before_action :find_event
<span class="gi">+   before_action :set_pending_registration, :only =&gt; [:step1, :step1_update, :step2, :step2_update, :step3, :step3_update]
</span>
    def create
      @registration = @event.registrations.new(registration_params)
      @registration.ticket = @event.tickets.find( params[:registration][:ticket_id] )
      @registration.status = "pending"
      @registration.user = current_user
      @registration.current_step = 1

      if @registration.save
<span class="gi">+        CheckRegistrationJob.set( wait: 15.minutes ).perform_later(@registration.id)
</span>
    # ç•¥...

    def step1
<span class="gd">-     @registration = @event.registrations.find_by_uuid(params[:id])
</span>    end

    def step1_update
<span class="gd">-     @registration = @event.registrations.find_by_uuid(params[:id])
</span>
      # ç•¥

    def step2
<span class="gd">-     @registration = @event.registrations.find_by_uuid(params[:id])
</span>    end

    def step2_update
<span class="gd">-     @registration = @event.registrations.find_by_uuid(params[:id])
</span>
      # ç•¥

    def step3
<span class="gd">-     @registration = @event.registrations.find_by_uuid(params[:id])
</span>    end

    def step3_update
<span class="gd">-     @registration = @event.registrations.find_by_uuid(params[:id])
</span>
    # ç•¥

    protected

<span class="gi">+   def set_pending_registration
+     @registration = @event.registrations.find_by_uuid(params[:id])
+
+     if @registration.status == "cancalled"
+       flash[:alert] = "è¯·é‡æ–°æŠ¥å"
+       redirect_to event_path(@event)
+     end
+   end
</span>
<span class="err">    # ç•¥
</span></pre></div>
</figure>

<blockquote>
<p>å¯ä»¥æš‚æ—¶æ”¹æˆç”¨ <code>1.minute</code> è¿›è¡Œæµ‹è¯•</p>
</blockquote>

<p>è¿™æ ·å°±å®Œæˆäº†ã€‚</p>

    </div>
  </div></div><div class='frame'><h1>
      å¼‚æ­¥ E-mail å¯„ä¿¡
    </h1><h4>æ‰€å±ç« èŠ‚ï¼š26. å¼‚æ­¥å¤„ç†ä»»åŠ¡</h4><hr><div class="post group">
    <div class="post-content markdown">
      <p>Rails çš„ E-mail å¯„ä¿¡åŠŸèƒ½ï¼Œå…¶å®ä¹Ÿç”¨äº†å¼‚æ­¥å¤„ç†ä»»åŠ¡ï¼Œå› ä¸ºå¯„ä¿¡ä¼šè°ƒç”¨ç¬¬ä¸‰æ–¹çš„å¯„ä¿¡ SMTP æœåŠ¡å™¨ï¼Œæ‰§è¡Œé€Ÿåº¦ä¸Šæ¯”è¾ƒæ…¢ï¼Œå› æ­¤ä¹Ÿé€‚åˆç”¨å¼‚æ­¥å¤„ç†æ¥åšã€‚</p>

<p>å›æƒ³åœ¨ 24-2 å¯„é€æŠ¥åå®Œæˆçš„ E-mail æ˜¯å¦‚ä½•å¯„é€çš„ï¼š</p>

<figure class="figure-code code"><div class="highlight"><pre>NotificationMailer.confirmed_registration(@registration).deliver_later
</pre></div>
</figure>

<p>è¿™é‡Œçš„ <code>deliver_later</code> æ–¹æ³•ï¼Œå°±ä¼šç”¨è¿™ä¸€ç« è®¾å®šçš„å¼‚æ­¥å¤„ç†æœºåˆ¶å»å¯„ä¿¡ã€‚</p>

<p>å¦‚æœä¸è¦ç”¨å¼‚æ­¥å¤„ç†ï¼Œä¾‹å¦‚æˆ‘ä»¬åœ¨ rails console æµ‹è¯•çš„æ—¶å€™ï¼š</p>

<figure class="figure-code code"><div class="highlight"><pre>NotificationMailer.confirmed_registration( Registration.by_status("confirmed").last ).deliver_now
</pre></div>
</figure>

<p>è¿™é‡Œçš„ <code>deliver_now</code> æ–¹æ³•ï¼Œå°±ä¼šç«‹å³å¯„å‡ºã€‚</p>

    </div>
  </div></div><div class='end'>
              <a href='https://fullstack.qzy.camp/'>
                <img src='https://img.buzzfeed.com/buzzfeed-static/static/2014-10/26/6/enhanced/webdr08/longform-original-14836-1414320930-10.jpg'>
              </a>
              <p>The End</p>
            </div>